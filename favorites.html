{% extends "base.html" %}
{% block content %}


<style>
  .pagination .page-link {
    border-radius: 10px;
    margin: 2px;
    min-width: 32px;
    height: 32px;
    padding: 4px 8px;
    font-size: 0.85rem;
    text-align: center;
  }

  .pagination .page-item.active .page-link {
    background-color: #198754;
    border-color: #198754;
    color: white;
  }

  .pagination {
    flex-wrap: nowrap;
    overflow-x: auto;
  }
</style>

<style>
#favorites-container {
  opacity: 1;
  transition: opacity 0.3s ease-in-out;
}

#favorites-container.fade-out {
  opacity: 0;
}

#favorites-container.fade-in {
  opacity: 1;
}
</style>

<style>
  body { background: linear-gradient(to bottom right, #fff, #ffd4e0); }
</style>



  <!-- Î¤Î¯Ï„Î»Î¿Ï‚ -->
  <div class="text-center mb-3">
    <h2 class="fancy-title">â­ ÎŸÎ¹ Î‘Î³Î±Ï€Î·Î¼Î­Î½ÎµÏ‚ Î¼Î¿Ï… Î£Ï…Î½Ï„Î±Î³Î­Ï‚!</h2>
  </div>

  <!-- ÎšÎ¿Ï…Î¼Ï€Î¹Î¬: Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· (Î±ÏÎ¹ÏƒÏ„ÎµÏÎ¬) / Î”Î¹Î±Î³ÏÎ±Ï†Î® (Î´ÎµÎ¾Î¹Î¬) -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <button class="btn btn-success btn-sm" id="add-fav-btn" onclick="showAddFavorite()">
      <i class="fa fa-plus"></i> Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ·
    </button>
    <button class="btn btn-outline-danger btn-sm" onclick="deleteAllFavorites()">
      <i class="fa fa-trash"></i> Î”Î¹Î±Î³ÏÎ±Ï†Î® ÏŒÎ»Ï‰Î½
    </button>
  </div>

  <!-- Î ÎµÏÎ¹Î¿Ï‡Î® Î³Î¹Î± input Î±Î½Î±Î¶Î®Ï„Î·ÏƒÎ·Ï‚ ÏƒÏ…Î½Ï„Î±Î³Î®Ï‚ (add) -->
  <div id="add-favorite-cell" class="mb-3"></div>

  <!-- Î¦Î¯Î»Ï„ÏÎ± ÏƒÎµ Î´ÏÎ¿ ÏƒÏ„Î®Î»ÎµÏ‚ -->
  <div class="row g-2 mb-2">
    <div class="col-6">
      <select id="filter-chef" class="form-select form-select-sm" onchange="loadFavorites()">
        <option value="">ÎŒÎ»Î¿Î¹ Î¿Î¹ ÏƒÎµÏ†</option>
        <option value="Î†ÎºÎ·Ï‚ Î ÎµÏ„ÏÎµÏ„Î¶Î¯ÎºÎ·Ï‚">Î†ÎºÎ·Ï‚ Î ÎµÏ„ÏÎµÏ„Î¶Î¯ÎºÎ·Ï‚</option>
        <option value="ÎÏ„Î¯Î½Î± ÎÎ¹ÎºÎ¿Î»Î¬Î¿Ï…">ÎÏ„Î¯Î½Î± ÎÎ¹ÎºÎ¿Î»Î¬Î¿Ï…</option>
      </select>
    </div>
    <div class="col-6">
      <select id="filter-time" class="form-select form-select-sm" onchange="loadFavorites()">
        <option value="">ÎŒÎ»Î¿Î¹ Î¿Î¹ Ï‡ÏÏŒÎ½Î¿Î¹</option>
        <option value="30">ÎˆÏ‰Ï‚ 30'</option>
        <option value="60">ÎˆÏ‰Ï‚ 60'</option>
        <option value="120">ÎˆÏ‰Ï‚ 2 ÏÏÎµÏ‚</option>
      </select>
    </div>
    <div class="col-6">
      <select id="filter-category" class="form-select form-select-sm" onchange="loadFavorites()">
        <option value="">ÎŒÎ»ÎµÏ‚ Î¿Î¹ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯ÎµÏ‚</option>
        <option value="Vegan">Vegan</option>
        <option value="ÎšÏÎµÎ±Ï„Î¹ÎºÎ¬">ÎšÏÎµÎ±Ï„Î¹ÎºÎ¬</option>
        <option value="Î˜Î±Î»Î±ÏƒÏƒÎ¹Î½Î¬">Î˜Î±Î»Î±ÏƒÏƒÎ¹Î½Î¬</option>
      </select>
    </div>
    <div class="col-6">
      <select id="filter-method" class="form-select form-select-sm" onchange="loadFavorites()">
        <option value="">ÎŒÎ»ÎµÏ‚ Î¿Î¹ Î¼Î­Î¸Î¿Î´Î¿Î¹</option>
        <option value="Î¦Î¿ÏÏÎ½Î¿Ï‚">Î¦Î¿ÏÏÎ½Î¿Ï‚</option>
        <option value="ÎšÎ±Ï„ÏƒÎ±ÏÏŒÎ»Î±">ÎšÎ±Ï„ÏƒÎ±ÏÏŒÎ»Î±</option>
      </select>
    </div>
  </div>

  <!-- Live Search (ÏƒÎµ Î´Î¹ÎºÎ® Ï„Î¿Ï… Î³ÏÎ±Î¼Î¼Î®) -->
  <div class="mb-3 d-flex">
    <input type="text" id="search-term" class="form-control form-control-sm voice-enabled" placeholder="Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎµ... Î® Ï€Î¬Ï„Î± Ï„Î¿ Î¼Î¹ÎºÏÏŒÏ†Ï‰Î½Î¿:" data-voice-target="favorites" oninput="loadFavorites()">
	<button class="btn btn-outline-secondary btn-sm ms-2" onclick="resetFilters()">
	  <i class="fa fa-rotate-left"></i>
	</button>
  </div>

  <!-- Î£Ï…Î½Ï„Î±Î³Î­Ï‚ -->
  <div id="favorites-container" class="row g-3 mb-3">
    <!-- Cards Ï†Î¿ÏÏ„ÏÎ½Î¿Î½Ï„Î±Î¹ ÎµÎ´Ï -->
  </div>

  <!-- Pagination -->
	<nav aria-label="Î£ÎµÎ»Î¹Î´Î¿Ï€Î¿Î¯Î·ÏƒÎ·" class="mt-3">
	  <ul class="pagination justify-content-center flex-wrap" id="pagination"></ul>
	</nav>



{% endblock %}


{% block modals %}

<div class="modal fade" id="deleteFavoriteModal" tabindex="-1" aria-labelledby="deleteFavoriteModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="border-radius: 16px;">
      <div class="modal-header bg-danger-subtle">
        <h5 class="modal-title" id="deleteFavoriteModalLabel">
          <i class="fa fa-trash text-danger me-2"></i>Î”Î¹Î±Î³ÏÎ±Ï†Î® Î±Î³Î±Ï€Î·Î¼Î­Î½Î·Ï‚ Î£Ï…Î½Ï„Î±Î³Î®Ï‚
        </h5>
      </div>
      <div class="modal-body text-center" id="deleteFavoriteModalBody" style="font-size:1.09em;">
        Î˜Î­Î»ÎµÎ¹Ï‚ ÏƒÎ¯Î³Î¿Ï…ÏÎ± Î½Î± Î±Ï†Î±Î¹ÏÎ­ÏƒÎµÎ¹Ï‚ Î±Ï…Ï„Î® Ï„Î· ÏƒÏ…Î½Ï„Î±Î³Î® Î±Ï€ÏŒ Ï„Î± Î±Î³Î±Ï€Î·Î¼Î­Î½Î±;
      </div>
      <div class="modal-footer d-flex flex-column gap-2">
        <button type="button" class="btn btn-danger btn-lg w-100" id="delete-fav-confirm-btn">Î”Î¹Î±Î³ÏÎ±Ï†Î®</button>
        <button type="button" class="btn btn-secondary btn-lg w-100" data-bs-dismiss="modal">Î†ÎºÏ…ÏÎ¿</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="deleteRecipeModal" tabindex="-1" aria-labelledby="deleteRecipeModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="border-radius: 16px;">
      <div class="modal-header bg-danger-subtle">
        <h5 class="modal-title" id="deleteRecipeModalLabel">
          <i class="fa fa-trash text-danger me-2"></i>Î”Î¹Î±Î³ÏÎ±Ï†Î® Î£Ï…Î½Ï„Î±Î³Î®Ï‚
        </h5>
      </div>
      <div class="modal-body text-center" id="deleteRecipeModalBody" style="font-size:1.09em;">
        Î˜Î­Î»ÎµÎ¹Ï‚ ÎµÏ€Î¯ÏƒÎ·Ï‚ Î½Î± Î´Î¹Î±Î³ÏÎ±Ï†ÎµÎ¯ ÎµÎ½Ï„ÎµÎ»ÏÏ‚ Î· ÏƒÏ…Î½Ï„Î±Î³Î® Î±Ï€ÏŒ Ï„Î· Î²Î¬ÏƒÎ·;
      </div>
      <div class="modal-footer d-flex flex-column gap-2">
        <button type="button" class="btn btn-danger btn-lg w-100" id="delete-recipe-confirm-btn">ÎÎ±Î¹, Î´Î¹Î±Î³ÏÎ±Ï†Î® Î¿ÏÎ¹ÏƒÏ„Î¹ÎºÎ¬</button>
        <button type="button" class="btn btn-secondary btn-lg w-100" id="delete-recipe-only-fav-btn" data-bs-dismiss="modal">ÎŒÏ‡Î¹, Î¼ÏŒÎ½Î¿ Î±Ï€ÏŒ Ï„Î± Î±Î³Î±Ï€Î·Î¼Î­Î½Î±</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}



{% block scripts %}

<script>
let favoriteRecipeIds = []; 
let allRecipes = [];
fetch('/get_recipes_for_autocomplete')
  .then(r => r.json())
  .then(data => { allRecipes = data; });

let pendingDeleteRecipeId = null;
let pendingDeleteRecipeTitle = null;
let pendingDeleteRecipeIsUser = false; // Î±Î½ ÎµÎ¯Î½Î±Î¹ Ï„Î¿Ï… Ï‡ÏÎ®ÏƒÏ„Î·
let deleteAllMode = false;

function deleteFavFromDataAttr(btn) {
  const id = btn.getAttribute('data-id');
  let title = btn.getAttribute('data-title') || '';
  const created = btn.getAttribute('data-createdby');
  deleteFavorite(id, title, created);
}

function deleteFavorite(recipeId, title=null, created_by=0) {
  deleteAllMode = false;
  pendingDeleteRecipeId = recipeId;
  pendingDeleteRecipeTitle = title;
  pendingDeleteRecipeIsUser = created_by != 0;
  document.getElementById('deleteFavoriteModalLabel').innerHTML =
    '<i class="fa fa-trash text-danger me-2"></i>Î”Î¹Î±Î³ÏÎ±Ï†Î® Î‘Î³Î±Ï€Î·Î¼Î­Î½Î·Ï‚';
  document.getElementById('deleteFavoriteModalBody').innerHTML =
    title ?
      'Î˜Î­Î»ÎµÎ¹Ï‚ ÏƒÎ¯Î³Î¿Ï…ÏÎ± Î½Î± Î±Ï†Î±Î¹ÏÎ­ÏƒÎµÎ¹Ï‚ Ï„Î· ÏƒÏ…Î½Ï„Î±Î³Î® <b>"' + title + '"</b> Î±Ï€ÏŒ Ï„Î± Î±Î³Î±Ï€Î·Î¼Î­Î½Î±;'
      : 'Î˜Î­Î»ÎµÎ¹Ï‚ ÏƒÎ¯Î³Î¿Ï…ÏÎ± Î½Î± Î±Ï†Î±Î¹ÏÎ­ÏƒÎµÎ¹Ï‚ Î±Ï…Ï„Î® Ï„Î· ÏƒÏ…Î½Ï„Î±Î³Î® Î±Ï€ÏŒ Ï„Î± Î±Î³Î±Ï€Î·Î¼Î­Î½Î±;';
  var modal = new bootstrap.Modal(document.getElementById('deleteFavoriteModal'));
  modal.show();
}

function deleteAllFavorites() {
  deleteAllMode = true;
  pendingDeleteRecipeId = null;
  document.getElementById('deleteFavoriteModalLabel').innerHTML =
    '<i class="fa fa-trash text-danger me-2"></i>Î”Î¹Î±Î³ÏÎ±Ï†Î® ÎŒÎ»Ï‰Î½';
  document.getElementById('deleteFavoriteModalBody').innerHTML =
    '<b>Î Î¡ÎŸÎ£ÎŸÎ§Î—!</b><br> ÎÎ± Î´Î¹Î±Î³ÏÎ±Ï†Î¿ÏÎ½ <u>ÏŒÎ»ÎµÏ‚</u> Î¿Î¹ Î±Î³Î±Ï€Î·Î¼Î­Î½ÎµÏ‚ ÏƒÏ…Î½Ï„Î±Î³Î­Ï‚;';
  var modal = new bootstrap.Modal(document.getElementById('deleteFavoriteModal'));
  modal.show();
}

// Event handler Î³Î¹Î± Ï„Î¿ Ï€ÏÏÏ„Î¿ modal (Î´Î¹Î±Î³ÏÎ±Ï†Î® Î±Î³Î±Ï€Î·Î¼Î­Î½Î¿Ï…)
document.addEventListener('DOMContentLoaded', function() {
  document.getElementById('delete-fav-confirm-btn').onclick = function() {
    var modal = bootstrap.Modal.getInstance(document.getElementById('deleteFavoriteModal'));
    modal.hide();
    if (deleteAllMode) {
      fetch('/delete_all_favorite_recipes', {method: 'POST'})
        .then(r => r.json())
        .then(() => location.reload());
    } else if (pendingDeleteRecipeId) {
      // Î‘Î½ ÎµÎ¯Î½Î±Î¹ Ï„Î¿Ï… Ï‡ÏÎ®ÏƒÏ„Î·, Î¬Î½Î¿Î¹Î¾Îµ Ï„Î¿ 2Î¿ modal!
      if (pendingDeleteRecipeIsUser) {
        showDeleteRecipeModal();
      } else {
        // Î‘Î»Î»Î¹ÏÏ‚, Î±Ï€Î»Î¬ Î´Î¹Î±Î³ÏÎ±Ï†Î® Î±Ï€ÏŒ Ï„Î± Î±Î³Î±Ï€Î·Î¼Î­Î½Î±
        fetch('/delete_favorite_recipe', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({recipe_id: pendingDeleteRecipeId})
        }).then(r => r.json())
          .then(() => location.reload());
      }
    }
  };

  	// 2Î¿ modal: Î´Î¹Î±Î³ÏÎ±Ï†Î® ÎµÎ½Ï„ÎµÎ»ÏÏ‚ Î±Ï€ÏŒ Ï„Î· Î²Î¬ÏƒÎ· ÎºÎ±Î¹ Î±Ï€ÏŒ Î±Î³Î±Ï€Î·Î¼Î­Î½Î±
	document.getElementById('delete-recipe-confirm-btn').onclick = function() {
	  var modal = bootstrap.Modal.getInstance(document.getElementById('deleteRecipeModal'));
	  modal.hide();
	  if (pendingDeleteRecipeId) {
		fetch('/delete_user_recipe', {
		  method: 'POST',
		  headers: {'Content-Type': 'application/json'},
		  body: JSON.stringify({recipe_id: pendingDeleteRecipeId})
		}).then(r => r.json())
		  .then(() => location.reload());
	  }
	};

	// 2Î¿ modal: Î´Î¹Î±Î³ÏÎ±Ï†Î® Î¼Î¿Î½Î¿ Î±Ï€ÏŒ Ï„Î± Î±Î³Î±Ï€Î·Î¼Î­Î½Î±
	document.getElementById('delete-recipe-only-fav-btn').onclick = function() {
	  var modal = bootstrap.Modal.getInstance(document.getElementById('deleteRecipeModal'));
	  modal.hide();
	  if (pendingDeleteRecipeId) {
		fetch('/delete_favorite_recipe', {
		  method: 'POST',
		  headers: {'Content-Type': 'application/json'},
		  body: JSON.stringify({recipe_id: pendingDeleteRecipeId})
		}).then(r => r.json())
		  .then(() => location.reload());
	  }
	};

});

function showDeleteRecipeModal() {
  document.getElementById('deleteRecipeModalLabel').innerHTML =
    '<i class="fa fa-trash text-danger me-2"></i>Î”Î¹Î±Î³ÏÎ±Ï†Î® Î£Ï…Î½Ï„Î±Î³Î®Ï‚';
  document.getElementById('deleteRecipeModalBody').innerHTML =
    'Î— ÏƒÏ…Î½Ï„Î±Î³Î® Î±Ï…Ï„Î® Î­Ï‡ÎµÎ¹ Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î·Î¸ÎµÎ¯ Î±Ï€ÏŒ <b>ÎµÏƒÎ­Î½Î±!<!b><br><br>' +
    'Î˜Î­Î»ÎµÎ¹Ï‚ Î½Î± Ï„Î· Î´Î¹Î±Î³ÏÎ¬ÏˆÎµÎ¹Ï‚ Î¿ÏÎ¹ÏƒÏ„Î¹ÎºÎ¬ ÎºÎ±Î¹ Î±Ï€ÏŒ Ï„Î· Î²Î¬ÏƒÎ· ÏƒÏ…Î½Ï„Î±Î³ÏÎ½;';
  var modal = new bootstrap.Modal(document.getElementById('deleteRecipeModal'));
  modal.show();
}

// Live search Î³Î¹Î± Ï€ÏÎ¿ÏƒÎ¸Î®ÎºÎ·
function showAddFavorite() {
  let cell = document.getElementById("add-favorite-cell");
  cell.innerHTML =
    '<div class="position-relative w-100">' +
      '<input type="text"' +
        ' id="fav-input"' +
        ' class="form-control voice-enabled"' +
		' data-voice-target="recipe"' + 
        ' placeholder="Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎµ... Î® Ï€Î¬Ï„Î± Ï„Î¿ Î¼Î¹ÎºÏÏŒÏ†Ï‰Î½Î¿:"' +
        ' autocomplete="off"' +
        ' style="width:100%; margin-top: 15px;">' +
      '<div id="fav-autocomplete" class="autocomplete-list"></div>' +
    '</div>';

  let input = document.getElementById("fav-input");
  let listDiv = document.getElementById("fav-autocomplete");

  input.focus();

  // ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿ input Î±Î½ Î³Î¯Î½ÎµÎ¹ click ÎµÎºÏ„ÏŒÏ‚
  function onClickOutside(event) {
    if (!cell.contains(event.target)) {
      cell.innerHTML = "";
      document.removeEventListener('mousedown', onClickOutside);
    }
  }

  setTimeout(() => {
    document.addEventListener('mousedown', onClickOutside);
  }, 0);

  input.addEventListener('input', function() {
    let val = removeTonos(input.value.trim());
    if (val.length < 2) {
      listDiv.innerHTML = "";
      return;
    }
	let found = allRecipes
	  .filter(r =>
		!favoriteRecipeIds.includes(r.id) && (
		removeTonos(r.title).includes(val) ||
		removeTonos(r.tags || "").includes(val) ||
		removeTonos(r.ingredients || "").includes(val) ||
		removeTonos(r.main_dish_tag || "").includes(val)
	  ))
	  .slice(0, 20);
    listDiv.innerHTML = "";
    found.forEach(r => {
      let opt = document.createElement("div");
      opt.className = "autocomplete-option";
      opt.innerHTML = r.title + (r.chef ? ' <span class="text-muted small fst-italic">by ' + r.chef + '</span>' : '');
      opt.style.cursor = "pointer";
      opt.onclick = function() {
        addFavorite(r.id);
      };
      listDiv.appendChild(opt);
    });
  });
  }

function addFavorite(recipeId) {
  fetch('/add_favorite_recipe', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({recipe_id: recipeId})
  })
  .then(r => r.json())
  .then(data => {
    if(data.success) {
      location.reload();
    } else {
      alert("Î£Ï†Î¬Î»Î¼Î± Î® Î®Î´Î· Ï€ÏÎ¿ÏƒÏ„Î­Î¸Î·ÎºÎµ!");
    }
  });
}

document.addEventListener('click', function(e) {
  const input = e.target.closest('.voice-enabled');
  if (!input) return;
  const clickX = e.clientX - input.getBoundingClientRect().left;
  const inputWidth = input.offsetWidth;

  if (clickX >= inputWidth - 36) {
    const target = input.dataset.voiceTarget;
    switch (target) {
      case 'recipe':
        startSpeechForFavorites();
        break;
      case 'favorites':
		startSpeechForSearch();
        break;
      default:
        console.warn('Î†Î³Î½Ï‰ÏƒÏ„Î¿Ï‚ ÏƒÏ„ÏŒÏ‡Î¿Ï‚ Ï†Ï‰Î½Î®Ï‚:', target);
    }
  }
});


function startSpeechForFavorites() {
  const input = document.getElementById("fav-input");
  if (!input || !('webkitSpeechRecognition' in window)) return;

  const recognition = new webkitSpeechRecognition();
  recognition.lang = 'el-GR';
  recognition.continuous = false;
  recognition.interimResults = false;

  recognition.onaudiostart = function() {
    input.classList.add('listening');
    input.placeholderBackup = input.placeholder;
    input.placeholder = "ğŸ™ï¸ ÎœÎ¯Î»Î± Ï„ÏÏÎ±...";
  };

  recognition.onresult = function(event) {
    const transcript = event.results[0][0].transcript.trim();
    input.value = transcript;
    input.dispatchEvent(new Event('input'));
  };

  recognition.onend = function() {
    input.classList.remove('listening');
    if (input.placeholderBackup) {
      input.placeholder = input.placeholderBackup;
      delete input.placeholderBackup;
    }
  };

  recognition.start();
}


function startSpeechForSearch() {
  const input = document.getElementById("search-term");
  if (!input || !('webkitSpeechRecognition' in window)) return;

  const recognition = new webkitSpeechRecognition();
  recognition.lang = 'el-GR';
  recognition.continuous = false;
  recognition.interimResults = false;

  recognition.onaudiostart = function() {
    input.classList.add('listening');
    input.placeholderBackup = input.placeholder;
    input.placeholder = "ğŸ™ï¸ ÎœÎ¯Î»Î± Ï„ÏÏÎ±...";
  };

  recognition.onresult = function(event) {
    const transcript = event.results[0][0].transcript.trim();
    input.value = transcript;
    input.dispatchEvent(new Event('input'));
  };

  recognition.onend = function() {
    input.classList.remove('listening');
    if (input.placeholderBackup) {
      input.placeholder = input.placeholderBackup;
      delete input.placeholderBackup;
    }
  };

  recognition.start();
}

</script>

<script>
window.favoritesOnboarding = {
  step: 0,
  completed: false,
  initialized: false
};

function updateFavoritesOnboardingStep(step) {
  window.favoritesOnboarding.step = step;
  fetch("/api/onboarding_update_step", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ page: "favorites", step })
  });
}

function markFavoritesOnboardingComplete() {
  window.favoritesOnboarding.completed = true;

  fetch("/api/onboarding_mark_completed", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ page: "favorites" })
  });

  document.querySelectorAll(".onboarding-tooltip").forEach(t => {
    t.style.display = "none";
    t.style.visibility = "hidden";
  });

  // âœ… Î¤ÏÏÎ± Î­Î»ÎµÎ³Ï‡Î¿Ï‚ Î±Î½ Î­Ï‡ÎµÎ¹ Î¿Î»Î¿ÎºÎ»Î·ÏÏ‰Î¸ÎµÎ¯ ÎºÎ±Î¹ Ï„Î¿ menu onboarding
  fetch("/api/onboarding_progress")
    .then(res => res.json())
    .then(data => {
      const menu = data["menu"];
      if (!menu || !menu.completed) {
        // ğŸ’¾ Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎµ snapshot ÎºÎ±Î¹ ÎºÎ¬Î½Îµ flip ÎµÏ€Î¹ÏƒÏ„ÏÎ¿Ï†Î® ÏƒÏ„Î¿ /menu
        sessionStorage.setItem("page_snapshot_html", document.documentElement.innerHTML);
        window.location.href = "/page-flip-transition?to=/menu&label=ÎœÎµÎ½Î¿Ï";
      }
    });
}

function nextFavoritesStep(nextStep) {
  updateFavoritesOnboardingStep(nextStep);
  runFavoritesOnboarding();
}

function getFavoritesTargetSelector(step) {
  if (step === 0) return ".card-body";            // Î Î±Î»Î¹Î¬ Î®Ï„Î±Î½ step 1
  if (step === 1) return ".btn-outline-primary"; // Î Î±Î»Î¹Î¬ Î®Ï„Î±Î½ step 2
  if (step === 2) return ".btn-danger";          // Î Î±Î»Î¹Î¬ Î®Ï„Î±Î½ step 3
  if (step === 3) return "button.btn-success";   // Î Î±Î»Î¹Î¬ Î®Ï„Î±Î½ step 4
  return null;
}

function runFavoritesOnboarding() {
  if (!window.favoritesOnboarding.initialized || window.favoritesOnboarding.completed) return;

  const step = window.favoritesOnboarding.step;
  document.querySelectorAll(".onboarding-tooltip").forEach(t => {
    t.style.display = "none";
    t.style.visibility = "hidden";
  });

  const tooltipId = "favoritesTooltip" + (step + 1);
  const tooltip = document.getElementById(tooltipId);
  if (!tooltip) return;

  tooltip.style.display = "block";
  tooltip.style.visibility = "visible";

  if (step === 4) {
    tooltip.style.position = "fixed";
    tooltip.style.bottom = "300px";
    tooltip.style.left = "90px";
    tooltip.style.width = "50vw";
	tooltip.style.fontSize = "20px";
  } else {
	tooltip.style.position = "absolute";
	const selector = getFavoritesTargetSelector(step);
	const target = document.querySelector(selector);
	if (target) {
	  const rect = target.getBoundingClientRect();
	  const tipWidth = tooltip.offsetWidth;

	  const top = rect.bottom + window.scrollY + 10;
	  const left = (window.innerWidth - tipWidth) / 2;

	  tooltip.style.top = `${top}px`;
	  tooltip.style.left = `${left}px`;
	  
	  // arrow offset Ï…Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚
		const tooltipCenter = window.innerWidth / 2;
		const targetCenter = rect.left + rect.width / 2;
		const arrowOffset = tipWidth / 2 + (targetCenter - tooltipCenter);
		const margin = 16; // ÎµÎ»Î¬Ï‡Î¹ÏƒÏ„Î¿ Ï€ÎµÏÎ¹Î¸ÏÏÎ¹Î¿ Î±Ï€ÏŒ Ï„Î± Î¬ÎºÏÎ± Ï„Î¿Ï… tooltip
		const clampedArrowOffset = Math.max(
		  margin,
		  Math.min(tipWidth - margin, arrowOffset)
		);
		tooltip.style.setProperty("--arrow-offset", `${clampedArrowOffset}px`);  
	}
  }
}

document.addEventListener("DOMContentLoaded", function () {
  fetch("/api/onboarding_progress")
    .then(res => res.json())
    .then(data => {
      const f = data["favorites"];
      if (!f || f.completed) return;

      window.favoritesOnboarding.step = f.step;
      window.favoritesOnboarding.completed = f.completed;
      window.favoritesOnboarding.initialized = true;
      runFavoritesOnboarding();
    });
});
</script>

<script>
let currentPage = 1;
let totalPages = 1;
let perPage = 4;

function renderPagination(current, total) {
  const pag = document.getElementById("pagination");

  if (total <= 1) {
    pag.style.display = "none";
    pag.innerHTML = "";
    return;
  }

  pag.style.display = "flex";
  pag.innerHTML = "";

  function createPageItem(label, page, disabled = false, active = false) {
    const li = document.createElement("li");
    li.className = "page-item";
    if (disabled) li.classList.add("disabled");
    if (active) li.classList.add("active");

    const a = document.createElement("a");
    a.className = "page-link small";
    a.href = "#";
    a.innerHTML = label;

    a.onclick = function (e) {
      e.preventDefault();
      if (!disabled && current !== page) loadFavorites(page);
    };

    li.appendChild(a);
    return li;
  }

  function createEllipsis() {
    const li = document.createElement("li");
    li.className = "page-item disabled";
    const span = document.createElement("span");
    span.className = "page-link small";
    span.innerHTML = "...";
    li.appendChild(span);
    return li;
  }

  // Î Î»Î¿Î®Î³Î·ÏƒÎ· Î±ÏÏ‡Î®Ï‚ / Ï€ÏÎ¿Î·Î³Î¿ÏÎ¼ÎµÎ½Î·
  pag.appendChild(createPageItem("&laquo;", 1, current === 1));
  pag.appendChild(createPageItem("&lsaquo;", current - 1, current === 1));

  let start = Math.max(1, current - 1);
  let end = Math.min(total, current + 1);

  if (start > 2) {
    pag.appendChild(createPageItem("1", 1));
    if (start > 3) pag.appendChild(createEllipsis());
  }

  for (let i = start; i <= end; i++) {
    pag.appendChild(createPageItem(i, i, false, i === current));
  }

  if (end < total - 1) {
    pag.appendChild(createEllipsis());
    pag.appendChild(createPageItem(total, total));
  } else if (end === total - 1) {
    pag.appendChild(createPageItem(total, total));
  }

  pag.appendChild(createPageItem("&rsaquo;", current + 1, current === total));
  pag.appendChild(createPageItem("&raquo;", total, current === total));
}

document.addEventListener("DOMContentLoaded", function() {
  fetchFilters();
  loadFavorites();

  // âœ… Swipe gestures Î³Î¹Î± mobile pagination
  let touchStartX = 0;
  let touchEndX = 0;

  document.addEventListener("touchstart", function(e) {
    touchStartX = e.changedTouches[0].screenX;
  }, false);

  document.addEventListener("touchend", function(e) {
    touchEndX = e.changedTouches[0].screenX;
    handleSwipe();
  }, false);

  function handleSwipe() {
    const threshold = 50; // ÎµÎ»Î¬Ï‡Î¹ÏƒÏ„Î· Î±Ï€ÏŒÏƒÏ„Î±ÏƒÎ· Î³Î¹Î± swipe

    if (touchEndX < touchStartX - threshold && currentPage < totalPages) {
      loadFavorites(currentPage + 1); // swipe left â†’ ÎµÏ€ÏŒÎ¼ÎµÎ½Î·
    }

    if (touchEndX > touchStartX + threshold && currentPage > 1) {
      loadFavorites(currentPage - 1); // swipe right â†’ Ï€ÏÎ¿Î·Î³Î¿ÏÎ¼ÎµÎ½Î·
    }
  }
});

function fetchFilters() {
  fetch("/api/favorites/filters")
    .then(function(res) { return res.json(); })
    .then(function(data) {
      populateFilter("filter-chef", data.chefs, "ÎŒÎ»Î¿Î¹ Î¿Î¹ ÏƒÎµÏ†");
      populateFilter("filter-category", data.categories, "ÎŒÎ»ÎµÏ‚ Î¿Î¹ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯ÎµÏ‚");
      populateFilter("filter-method", data.methods, "ÎŒÎ»ÎµÏ‚ Î¿Î¹ Î¼Î­Î¸Î¿Î´Î¿Î¹");
      populateTimeFilter("filter-time", data.times);
    });
}

function loadFavorites(page) {
  if (!page) page = 1;
  currentPage = page;

  const method = document.getElementById("filter-method").value;
  const category = document.getElementById("filter-category").value;
  const chef = document.getElementById("filter-chef").value;
  const time = document.getElementById("filter-time").value;
  const term = document.getElementById("search-term").value;

  if (term && term.trim().length > 0 && term.trim().length < 3) {
    // Î‘Î½ Î¿ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚ Î­Î³ÏÎ±ÏˆÎµ <3 Ï‡Î±ÏÎ±ÎºÏ„Î®ÏÎµÏ‚, Î´ÎµÎ½ ÎºÎ¬Î½Î¿Ï…Î¼Îµ Î±Î½Î±Î¶Î®Ï„Î·ÏƒÎ·
    return;
  }

  const params = new URLSearchParams({
    page: page,
    per_page: perPage,
    method: method,
    category: category,
    chef: chef,
    time: time,
    search: term
  });

  const container = document.getElementById("favorites-container");

  // â¤ 1. Î¾ÎµÎºÎ¹Î½Î¬ Ï„Î¿ fade-out
  container.classList.remove("fade-in");
  container.classList.add("fade-out");

  setTimeout(function () {
    fetch('/api/favorites?' + params.toString())
      .then(function(response) { return response.json(); })
      .then(function(data) {
	    currentPage = data.page;
        totalPages = data.total_pages;
		
		// ğŸ” Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· Ï„Ï‰Î½ IDs
        favoriteRecipeIds = data.recipes.map(r => r.id);
		
        container.innerHTML = "";

        if (data.recipes.length === 0) {
          container.innerHTML = '<div class="col-12 text-center text-muted">Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ ÏƒÏ…Î½Ï„Î±Î³Î­Ï‚.</div>';
          renderPagination(1, 1);
        } else {
          data.recipes.forEach(function(rec) {
            const el = document.createElement("div");
            el.className = "col-12";

            var cardHtml = '';
            cardHtml += '<div class="card shadow-sm h-100" onclick="openRecipeModal(this)" style="cursor: pointer;"';
            cardHtml += ' data-title="' + rec.title + '"';
            cardHtml += ' data-chef="' + (rec.chef || '') + '"';
            cardHtml += ' data-method="' + (rec.method || '') + '"';
            cardHtml += ' data-category="' + (rec.main_dish_tag || '') + '"';
            cardHtml += ' data-tags="' + (rec.tags || '') + '"';
            cardHtml += ' data-url="' + (rec.url || '') + '"';
            cardHtml += ' data-prep="' + (rec.prep_time || '') + '"';
            cardHtml += ' data-cook="' + (rec.cook_time || '') + '"';
            cardHtml += ' data-ingredients="' + (rec.ingredients || '') + '"';
            cardHtml += ' data-instructions="' + (rec.instructions || '') + '">';

            cardHtml += '<div class="card-header d-flex justify-content-between align-items-center no-click" style="padding:2px 10px;">';
            cardHtml += '<span class="fw-bold flex-grow-1 me-2" style="font-size:1.1em;">' + rec.title + '</span>';
            cardHtml += '<div class="d-flex gap-1 flex-shrink-0">';
            cardHtml += '<a href="/favorites/edit/' + rec.id + '" class="btn btn-outline-primary btn-sm no-click" onclick="event.stopPropagation()">';
            cardHtml += '<i class="fa fa-pen"></i></a>';
            cardHtml += '<button class="btn btn-danger btn-sm no-click" data-id="' + rec.id + '" data-title="' + rec.title + '" data-createdby="' + (rec.created_by || 0) + '" onclick="event.stopPropagation(); deleteFavFromDataAttr(this)">';
            cardHtml += '<i class="fa fa-trash"></i></button>';
            cardHtml += '</div></div>';

            cardHtml += '<div class="card-body py-2 d-flex flex-column flex-md-row align-items-start align-items-md-center justify-content-between" style="background-color: beige;">';
            cardHtml += '<div class="d-flex flex-wrap align-items-center gap-2">';
            cardHtml += '<span class="badge bg-info text-dark"><i class="fa fa-user"></i> ' + (rec.chef || '-') + '</span>';
            cardHtml += '<span class="badge bg-success"><i class="fa fa-clock"></i> ' + (rec.total_time || '-') + '\'</span>';
            if (rec.method) {
              cardHtml += '<span class="badge bg-warning text-dark"><i class="fa fa-fire"></i> ' + rec.method + '</span>';
            }
            if (rec.tags) {
              cardHtml += '<span class="badge bg-secondary"><i class="fa fa-tag"></i> ' + rec.tags + '</span>';
            }
            cardHtml += '</div></div>';
            cardHtml += '</div>'; // end card

            el.innerHTML = cardHtml;
            container.appendChild(el);
          });

          renderPagination(data.page, data.total_pages);
        }

        // â¤ 2. Î•Î½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎ· fade-in
        container.classList.remove("fade-out");
        container.classList.add("fade-in");
		
      });
  }, 300); // Î»Î¯Î³Î¿ delay Î³Î¹Î± Î½Î± Ï†Î±Î½ÎµÎ¯ Ï„Î¿ fade-out
}

function populateFilter(selectId, values, defaultLabel) {
  const select = document.getElementById(selectId);
  select.innerHTML = "";
  const opt = document.createElement("option");
  opt.value = "";
  opt.textContent = defaultLabel;
  select.appendChild(opt);

  values.forEach(function(v) {
    const o = document.createElement("option");
    o.value = v;
    o.textContent = v;
    select.appendChild(o);
  });
}

function populateTimeFilter(selectId, timeList) {
  const select = document.getElementById(selectId);
  select.innerHTML = "";
  const opt = document.createElement("option");
  opt.value = "";
  opt.textContent = "ÎŒÎ»Î¿Î¹ Î¿Î¹ Ï‡ÏÏŒÎ½Î¿Î¹";
  select.appendChild(opt);

  const ranges = [
    { label: "ÎˆÏ‰Ï‚ 30'", max: 30 },
    { label: "ÎˆÏ‰Ï‚ 60'", max: 60 },
    { label: "ÎˆÏ‰Ï‚ 90'", max: 90 },
    { label: "ÎˆÏ‰Ï‚ 120'", max: 120 }
  ];

  ranges.forEach(function(r) {
    if (timeList.some(function(t) { return t <= r.max; })) {
      const o = document.createElement("option");
      o.value = r.max;
      o.textContent = r.label;
      select.appendChild(o);
    }
  });
}

function resetFilters() {
  document.getElementById("filter-method").selectedIndex = 0;
  document.getElementById("filter-category").selectedIndex = 0;
  document.getElementById("filter-chef").selectedIndex = 0;
  document.getElementById("filter-time").selectedIndex = 0;
  document.getElementById("search-term").value = "";

  loadFavorites(1);  // Î•Ï€Î±Î½Î±Ï†Î¿ÏÏ„ÏÎ½ÎµÎ¹ Ï„Î± Î±Ï€Î¿Ï„ÎµÎ»Î­ÏƒÎ¼Î±Ï„Î± Î±Ï€ÏŒ Ï„Î·Î½ 1Î· ÏƒÎµÎ»Î¯Î´Î±
}

</script>

{% endblock %}