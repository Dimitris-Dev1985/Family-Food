{% extends "base.html" %}
{% block title %}Œ§Œπ Œ∏Œ± œÜŒ¨ŒºŒµ œÉŒÆŒºŒµœÅŒ±;{% endblock %}
{% block content %}


<!-- =================== Original Design Tokens =================== --> 
<style>
  :root {
    --brand: #218e46;
    --brand-hover: #1a6e38;
    --text: #1b1b1b;
    --surface: #fffaf5;
    --outline: #ddd;
    --shadow: 0 2px 14px rgba(33,142,70,0.08);
    --input-bg: #fff;
    --input-bg-focus: #f0fff4;
    --voice-bg: #ffebee;
    --voice-color: #c62828;
  }
  body {
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    margin: 0;
    padding: 0;
    background: var(--surface);
    font-family: 'Roboto', sans-serif;
    color: var(--text);
  }  
</style>

<!-- =================== Topbar =================== -->
<style>
  .recipe-topbar {
    position: sticky; top: 0; left: 0; right: 0; z-index: 99;
    background: #fff;
    border-bottom: 1.5px solid var(--outline);
    min-height: 54px; height: 54px;
    display: flex; align-items: center; justify-content: space-between;
    padding: 0 10px 0 6px;
    box-shadow: 0 1px 8px rgba(33,142,70,0.05);
    transition: box-shadow 0.16s;
  }
  .recipe-topbar .icon-btn {
    width: 38px; height: 38px;
    border-radius: 50%; border: none;
    display: flex; align-items: center; justify-content: center;
    margin: 0; cursor: pointer;
    background: none; color: var(--brand);
    font-size: 1.32rem;
    transition: background 0.13s;
  }
  .recipe-topbar .icon-btn:active { background: #f4f4f4; }
  .topbar-title {
    flex: 1;
    margin-left: 7px;
    font-size: 1.2rem; font-weight: 700;
    color: var(--text);
    letter-spacing: -0.2px;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    text-align: left;
  }
  .topbar-actions { display: flex; align-items: center; gap: 7px; }
</style>

<!-- =================== Hero =================== -->
<style>
  .recipe-hero {
    position: relative; z-index: 1;
    width: 100vw; max-width: 600px; margin: 0 auto;
    aspect-ratio: 1.1/1;
    border-bottom-left-radius: 2.2rem; border-bottom-right-radius: 2.2rem;
    background: #eee; overflow: hidden;
    display: flex; align-items: flex-end; justify-content: center;
    transition: height 0.4s;
  }
  .recipe-hero img {
    width: 100%; height: 100%; min-height: 220px;
    object-fit: cover;
    border-bottom-left-radius: 2.2rem; border-bottom-right-radius: 2.2rem;
  }
</style>

<!-- =================== Chat Card =================== -->
<style>
  .chatbox-card {
    position: relative; z-index: 2;
    max-width: 560px; min-height: 340px;
    margin: auto auto 22px auto;
    padding: 20px 12px 13px;
    border-radius: 20px;
    background: #fff;
    display: flex; flex-direction: column; align-items: center; gap: 14px;
    box-shadow: var(--shadow), 0 10px 40px rgba(33,142,70,0.15);
    transition: box-shadow 0.16s, margin-top 0.33s cubic-bezier(.4,2,.6,1);
  }
  .chatbox-card.cover-hero {
    position: fixed; left: 0; right: 0; bottom: 0; z-index: 22;
    max-width: 560px; max-height: 75vh;
    display: flex; flex-direction: column; overflow: hidden;
    box-shadow: 0 8px 32px rgba(33,142,70,0.14);
  }
  .chat-intro {
    margin: 0 0 0 0;
    padding-bottom: 2px;
    font-size: 1.7rem; font-weight: 600;
    color: var(--brand-hover);
    text-align: center;
  }
  .chatbox {
    flex: 1 1 auto;
    width: 100%; min-height: 90px;
    display: flex; flex-direction: column; gap: 12px;
    background: none; border-radius: 0; box-shadow: none; padding: 0;
    overflow-y: auto;
  }
</style>

<!-- =================== Chat Bubbles =================== -->
<style>
  .chat-bubble {
    max-width: 75%;
    padding: 10px 14px;
    border-radius: 20px;
    font-size: 0.98rem; line-height: 1.45;
    word-break: break-word; white-space: pre-wrap;
    animation: fadeIn 0.4s ease-out;
  }
  .from-ai {
    align-self: flex-start;
    background: #eafbe7; color: var(--brand);
  }
  .from-user {
    align-self: flex-end;
    background: #d4eaf7; color: #0d5584;
  }
  .typing-indicator {
    align-self: flex-start;
    margin-top: 2px;
    font-size: 0.9rem; font-style: italic;
    color: #999;
  }
</style>

<!-- =================== Quick Replies =================== -->
<style>
  .quick-replies {
    display: flex; flex-wrap: wrap; gap: 8px;
    margin-top: 2px;
    justify-content: flex-start;
    font-weight: 500; letter-spacing: 0.3px;
    transition: min-height 0.22s;
  }
  .quick-reply {
    padding: 7px 16px;
    border-radius: 24px; border: none;
    font-size: 0.98rem; font-weight: 500;
    white-space: nowrap; cursor: pointer;
    background: var(--surface); color: var(--brand-hover);
    box-shadow: 0 1px 4px rgba(33,142,70,0.04);
    opacity: 0; visibility: visible;
    transition: all 0.19s;
    animation: fadeInQuickReply 0.5s cubic-bezier(.41,1.12,.62,1.09) forwards;
    animation-delay: var(--delay, 200ms);
  }
  .quick-reply:hover {
    background: #daf6e5;
    box-shadow: 0 1px 6px rgba(33,142,70,0.09);
  }
  @keyframes fadeInQuickReply {
    to { opacity: 1; transform: translateY(0) scale(1); }
  }
</style>

<!-- =================== Input Row =================== -->
<style>
  .chat-input-row {
    display: flex; align-items: center; gap: 8px;
    width: 100%; max-width: 100%;
    margin: 0; padding: 10px 12px 7px;
    border-radius: 20px; z-index: 10;
    background: #fff;
    border-top: 1.5px solid var(--outline);
    box-shadow: 0 2px 14px rgba(33,142,70,0.07);
  }
  .chat-input-row textarea {
    flex: 1;
    min-height: 44px; max-height: 120px;
    padding: 10px 14px; padding-right: 72px;
    border: 1.5px solid var(--outline); border-radius: 20px;
    font-size: 1rem; resize: none;
    background: var(--input-bg);
    overflow-y: auto;
    transition: background-color 0.2s;
  }
  .chat-input-row textarea:focus {
    outline: none;
    background: var(--input-bg-focus);
  }
  .chat-input-row.voice-active textarea {
    background: var(--voice-bg); color: var(--voice-color);
    font-weight: 500;
  }
  .chat-input-row button {
    border: none; background: none; cursor: pointer; padding: 6px;
  }
  .mui-icon { font-size: 26px; color: var(--brand); }
  .mui-icon:hover { color: var(--brand-hover); }
</style>

<!-- =================== Dish Cards =================== -->
<style>
  .dish-cards-wrapper {
    display: flex; flex-direction: column; gap: 1rem; margin-top: 10px;
  }
  .dish-card {
    display: flex; flex-direction: column; gap: 8px;
    padding: 13px 15px 11px;
    border: 1px solid var(--outline); border-radius: 14px;
    background: #eafbe7;
    font-size: 1.01rem;
    box-shadow: 0 2px 7px rgba(0,0,0,0.04);
    animation: fadeIn 0.32s ease-out;
    transition: box-shadow 0.2s;
  }
  .dish-card:hover { box-shadow: 0 4px 11px rgba(0,0,0,0.11); }
  .dish-title { font-size: 1.11rem; font-weight: 600; color: var(--text); }
  .badge {
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 0.81rem; font-weight: 500;
    background: #f7f5e5; color: #7e7a44;
    white-space: nowrap;
  }
</style>

<!-- =================== Animations =================== -->
<style>
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>

<!-- =================== Responsive =================== -->
<style>
  @media (max-width: 600px) {
    .recipe-hero { max-width: 100vw; border-radius: 0 0 18px 18px; }
    .recipe-hero img { border-radius: 0 0 18px 18px; }
    .chatbox-card { margin-left: 2vw; margin-right: 2vw; }
    .dish-cards-wrapper, .chat-input-row { margin-left: 2vw; margin-right: 2vw; }
  }
</style>



<body style="min-height:100vh; display:flex; flex-direction:column;">

  <div class="recipe-topbar" id="topBar">
    <button class="icon-btn" title="ŒúŒµŒΩŒøœç" onclick="window.location='/profile'"><i class="fa fa-bars"></i></button>
    <div class="topbar-title">Œ§Œπ Œ∏Œ± œÜŒ¨ŒºŒµ œÉŒÆŒºŒµœÅŒ±;</div>
    <div class="topbar-actions">
      <button class="icon-btn" title="Œ†œÅŒøœÜŒØŒª" onclick="window.location='/profile'"><i class="fa fa-user"></i></button>
    </div>
  </div>

  <div class="recipe-hero">
    <img src="{{ url_for('static', filename='main_hero_1.jpg') }}" alt="Featured Food">
  </div>

  <div class="chatbox-card">
      <div class="chat-intro">
        Œ†Œ¨ŒºŒµ ŒΩŒ± Œ≤œÅŒøœçŒºŒµ œÑŒπ Œ∏Œ± ŒºŒ±Œ≥ŒµŒπœÅŒ≠œàŒøœÖŒºŒµ;<br>
      </div>
      <div class="chatbox" id="chatbox">
        <div class="chat-bubble from-ai">üë©‚Äçüç≥ Œ†ŒµœÅŒØœÄŒøœÖ œÄœåœÉŒø œáœÅœåŒΩŒø Œ≠œáŒµŒπœÇ Œ≥ŒπŒ± ŒºŒ±Œ≥ŒµŒØœÅŒµŒºŒ±;</div>
        <div class="quick-replies">
          <button class="quick-reply" onclick="handlePredefinedChoice('time','ŒàœâœÇ 30Œª.')">ŒàœâœÇ 30'</button>
          <button class="quick-reply" onclick="handlePredefinedChoice('time','ŒàœâœÇ 1 œéœÅŒ±')">ŒàœâœÇ 1 œéœÅŒ±</button>
          <button class="quick-reply" onclick="handlePredefinedChoice('time','Œ†Œ¨ŒΩœâ Œ±œÄœå 1,5 œéœÅŒ±')">Œ†Œ¨ŒΩœâ Œ±œÄœå 1,5 œéœÅŒ±</button>
        </div>
      </div>
      <div class="chat-input-row" id="chatInputRow">
        <textarea id="userInput" placeholder="Œ†ŒªŒ∑Œ∫œÑœÅŒøŒªœåŒ≥Œ∑œÉŒµ ŒµŒ¥œé..."></textarea>
        <button onclick="sendMessage()">
          <span class="material-icons mui-icon">send</span>
        </button>
        <button onclick="startSpeechRecognition()">
          <span class="material-icons mui-icon">mic</span>
        </button>
      </div>
    </div>

</body>



{% endblock %}


{% block scripts %}

<script>
// üåê Cooking Assistant ‚Äì localStorage Utilities

const StorageKeys = {
  MAX_TIME: "max_time",
  DISH_CATEGORY: "dish_category",
  MAIN_INGREDIENT: "main_ingredient",
  METHOD_PREFS: "method_prefs",
  EXCLUDED: "excluded",
  AUX_INGREDIENTS: "aux_ingredients"   
};

// ‚û§ ŒëœÉœÜŒ±ŒªŒ≠œÇ setter
function setStorageItem(key, value) {
  try {
    localStorage.setItem(key, JSON.stringify(value));
  } catch (e) {
    console.error(`[ERROR] ‚ùå Failed to save ${key}:`, e);
  }
}

// ‚û§ ŒëœÉœÜŒ±ŒªŒ≠œÇ getter
function getStorageItem(key, fallback = null) {
  try {
    const raw = localStorage.getItem(key);
    return raw ? JSON.parse(raw) : fallback;
  } catch (e) {
    console.warn(`[WARN] Failed to read ${key}, returning fallback.`);
    return fallback;
  }
}

// ‚û§ ŒïŒπŒ¥ŒπŒ∫Œ≠œÇ œÉœÖŒΩŒ±œÅœÑŒÆœÉŒµŒπœÇ Œ≥ŒπŒ± Œ∫Œ¨Œ∏Œµ ŒºŒµœÑŒ±Œ≤ŒªŒ∑œÑŒÆ

function setMaxTime(minutes) {
  setStorageItem(StorageKeys.MAX_TIME, String(minutes));
}

function getMaxTime() {
  return getStorageItem(StorageKeys.MAX_TIME, "30"); // default 30 ŒªŒµœÄœÑŒ¨
}

function setDishCategory(DishCategory) {
  setStorageItem(StorageKeys.DISH_CATEGORY, DishCategory);
}

function getDishCategory() {
  return getStorageItem(StorageKeys.DISH_CATEGORY, null);
}

function setMainIngredient(ingredient) {
  setStorageItem(StorageKeys.MAIN_INGREDIENT, ingredient);
}

function getMainIngredient() {
  return getStorageItem(StorageKeys.MAIN_INGREDIENT, null);
}

function setMethodPrefs(methodsArray) {
  setStorageItem(StorageKeys.METHOD_PREFS, methodsArray);
}

function getMethodPrefs() {
  return getStorageItem(StorageKeys.METHOD_PREFS, [
    'Œ¶ŒøœçœÅŒΩŒøœÇ', 'ŒöŒ±œÑœÉŒ±œÅœåŒªŒ±', 'ŒßœçœÑœÅŒ±', 'Œ§Œ∑Œ≥Œ¨ŒΩŒπ', 'Œ£œáŒ¨œÅŒ±', 'Air-fryer'
  ]);
}

function setExcluded(excludesArray) {
  setStorageItem(StorageKeys.EXCLUDED, excludesArray);
}

function getExcluded() {
  return getStorageItem(StorageKeys.EXCLUDED, []);
}

function setAuxIngredient(auxArray) {
  setStorageItem(StorageKeys.AUX_INGREDIENTS, auxArray);
}

function getAuxIngredient() {
  return getStorageItem(StorageKeys.AUX_INGREDIENTS, []);
}

// ‚û§ Clear All
function clearCookingFilters() {
  Object.values(StorageKeys).forEach(k => localStorage.removeItem(k));
  console.log("[DEBUG] üßπ Cleared all cooking filters from localStorage");
}
</script>

<script>
const input = document.getElementById("userInput");
const inputRow = document.getElementById("chatInputRow");
const originalPlaceholder = input.placeholder;
const DISH_CATEGORIES = ["Brunch","Vegan","ŒñœÖŒºŒ±œÅŒπŒ∫Œ¨","ŒòŒ±ŒªŒ±œÉœÉŒπŒΩŒ¨","ŒöœåŒ∫Œ∫ŒπŒΩŒø Œ∫œÅŒ≠Œ±œÇ","ŒõŒ±Œ¥ŒµœÅŒ¨","ŒåœÉœÄœÅŒπŒ±","Œ†Œ±œÅŒ±Œ¥ŒøœÉŒπŒ±Œ∫Œ¨","Œ†ŒØœÑŒµœÇ","Œ†ŒøœÖŒªŒµœÅŒπŒ∫Œ¨","Œ£ŒøœçœÄŒµœÇ","Œ£Œ±ŒªŒ¨œÑŒµœÇ"];
let moreResultsClicks = 0;
let UserNeedsHelp = false;

function adjustChatboxPosition() {
  const hero = document.querySelector('.recipe-hero');
  const chatboxCard = document.querySelector('.chatbox-card');
  if (!hero || !chatboxCard) return;

  // Œ†Œ¨œÅŒµ œÑŒø œçœàŒøœÇ œÑŒøœÖ hero (œÉŒµ px)
  const heroHeight = hero.offsetHeight;
  // Œ†Œ¨œÅŒµ œÑŒø œçœàŒøœÇ œÑŒøœÖ card
  const cardHeight = chatboxCard.offsetHeight;

  // ŒëŒΩ œÑŒø card "œÜŒøœÖœÉŒ∫œéœÉŒµŒπ" œÄŒ¨ŒΩœâ Œ±œÄœå œÑŒø 80% œÑŒøœÖ hero, ŒΩŒ± Œ±ŒΩŒ≠Œ≤ŒµŒπ!
  if (cardHeight > heroHeight * 0.85) {
    chatboxCard.classList.add('cover-hero');
  } else {
    chatboxCard.classList.remove('cover-hero');
  }
}

// ‚úÖ CLEAR STATE ON PAGE LOAD
window.addEventListener("DOMContentLoaded", () => {
  console.log("[DEBUG] üî• Œ†ŒªŒÆœÅŒ∑œÇ Œ∫Œ±Œ∏Œ±œÅŒπœÉŒºœåœÇ localStorage");
  localStorage.clear();
  initLocalState();
});
			  
input.addEventListener("keydown", function(e) {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
});

input.addEventListener("input", function() {
  input.style.height = "auto";
  input.style.height = input.scrollHeight + "px";
});

window.addEventListener('resize', adjustChatboxPosition);

// ‚úÖ Initialize filters on page load
function initLocalState() {
  if (!localStorage.getItem(StorageKeys.METHOD_PREFS)) setMethodPrefs(getMethodPrefs());
  if (!localStorage.getItem(StorageKeys.EXCLUDED)) setExcluded([]);
  if (!localStorage.getItem(StorageKeys.MAX_TIME)) setMaxTime(180);
  if (!localStorage.getItem(StorageKeys.DISH_CATEGORY)) setDishCategory("");
  if (!localStorage.getItem(StorageKeys.MAIN_INGREDIENT)) setMainIngredient("");
  if (!localStorage.getItem(StorageKeys.AUX_INGREDIENTS)) setAuxIngredient([]);
  console.log("[DEBUG] üå± Local state initialized");
}

// ‚úÖ Time mapping helper
function mapTimeLabelToMinutes(label) {
  const map = {
    "ŒàœâœÇ 30Œª.": 30,
    "ŒàœâœÇ 1 œéœÅŒ±": 60,
    "Œ†Œ¨ŒΩœâ Œ±œÄœå 1,5 œéœÅŒ±": 200
  };
  return map[label] || 90;
}

function sendMessage() {
  const msg = input.value.trim();
  if (!msg) return;

  handleFreeUserMessage(msg);
  input.value = "";
  input.placeholder = originalPlaceholder;
  input.style.height = "auto";
}

// ‚úÖ Render bubbles
function renderUserBubble(text) {
  const chat = document.getElementById("chatbox");
  const userBubble = document.createElement("div");
  userBubble.className = "chat-bubble from-user";
  userBubble.textContent = text;
  chat.appendChild(userBubble);
  chat.scrollTop = chat.scrollHeight;
  adjustChatboxPosition();

  const typing = document.createElement("div");
  typing.className = "typing-indicator";
  typing.textContent = "Family Food œÄŒªŒ∑Œ∫œÑœÅŒøŒªŒøŒ≥ŒµŒØ...";
  typing.id = "typing-indicator";
  chat.appendChild(typing);
  chat.scrollTop = chat.scrollHeight;
  adjustChatboxPosition();
}

function renderAIBubble(text, type = "ai") {
	const chat = document.getElementById("chatbox");
	const bubble = document.createElement("div");
	bubble.className = "chat-bubble from-ai";
	bubble.innerHTML = '<span class="chat-icon">' + (type === "system" ? "üë®‚Äçüç≥ " : "üß† ") + "</span><span>" + text + "</span>";
	chat.appendChild(bubble);
	chat.scrollTop = chat.scrollHeight;
	adjustChatboxPosition();
}

// ‚úÖ Update filters from AI_reply
function updateFiltersFromAIResponse(filters) {
  if (!filters || typeof filters !== "object") return;

  const keys = Object.keys(filters);
  for (let key of keys) {
    console.log(`[DEBUG] üîÑ Updating filter '${key}' ‚Üí`, filters[key]);
    switch (key) {
      case "max_time":
        setMaxTime(filters[key]);
        break;
      case "main_ingredient":
        setMainIngredient(filters[key]);
        break;
      case "aux_ingredients":
        setAuxIngredient(filters[key]);
        break;
      case "cooking_method":
        setMethodPrefs(filters[key]);
        break;
      case "excluded_keywords":
        setExcluded(filters[key]);
        break;
    }
  }
}

// ‚úÖ Predefined choice handler
function handlePredefinedChoice(type, value) {
  
  renderUserBubble(value);

  const maxTime = getMaxTime();
  const DishCategory = getDishCategory();
  const mainIngredient = getMainIngredient();
  
  const quickReplies = document.querySelectorAll(".quick-replies");
  quickReplies.forEach(qr => qr.remove());

  if (type === "time") {
    setMaxTime(mapTimeLabelToMinutes(value));
  }
  if (type === "exclude_method") {
    setMethodPrefs(getMethodPrefs().filter(m => m !== value.trim()));
  }
  if (type === "exclude_ingredient") {
    setExcluded([...getExcluded(), value.toLowerCase()]);
  }
  if (type === "set_dish_category") {
    setDishCategory(value);
    fetch("/api/get_tags_for_category?category=" + encodeURIComponent(value))
      .then(r => r.json())
      .then(data => {
        if (data.tags && data.tags.length > 0) {
          renderAIBubble("ŒòŒµœÇ Œ∫Œ¨œÑŒπ Œ±œÄœå œÑŒ± œÄŒ±œÅŒ±Œ∫Œ¨œÑœâ;", "system");
          setTimeout(() => {
			  renderQuickReplyOptions(
				data.tags.map(tag => ({
				  label: tag,
				  action: "set_main_ingredient"
				}))
			  );
		  }, 500);	  
        } else {
          if (maxTime > 0 && !mainIngredient) {
			console.log("call 1");
            callAISuggest("", 1);
          }
        }
      })
      .catch(err => {
        console.error("[DEBUG] ‚ùå Failed to fetch tags:", err);
        if (maxTime > 0 && !mainIngredient) {
		  console.log("call 2");
          callAISuggest("", 1);
        }
      });
    return;
  }
  if (type === "set_main_ingredient") {
    setMainIngredient(value);
  }
  if (maxTime > 0 && DishCategory && mainIngredient) {
    console.log("call 3");
    callAISuggest("", 1);
  } else if (maxTime > 0 && !mainIngredient && type === "time") {
    document.getElementById("typing-indicator")?.remove();
    renderAIBubble("Œ§Œπ Œ∏Œ± ŒÆŒ∏ŒµŒªŒµœÇ ŒΩŒ± Œ¥ŒøœçŒºŒµ Œ≥ŒπŒ± œÉŒÆŒºŒµœÅŒ±; ŒïœÄŒØŒªŒµŒæŒµ ŒºŒπŒ± Œ∫Œ±œÑŒ∑Œ≥ŒøœÅŒØŒ± Œ≥ŒπŒ± ŒΩŒ± ŒæŒµŒ∫ŒπŒΩŒÆœÉŒøœÖŒºŒµ!", "system");

	setTimeout(() => {
	  renderQuickReplyOptions(
		shuffle(DISH_CATEGORIES).map(label => ({
		  label,
		  action: "set_dish_category"
		}))
	  );
	}, 500);

  }
}

// ‚úÖ Render predefined options
function renderQuickReplyOptions(options = []) {
  const chat = document.getElementById("chatbox");
  const wrapper = document.createElement("div");
  wrapper.className = "quick-replies";

  options.forEach((opt, idx) => {
	  const btn = document.createElement("div");
	  btn.className = "quick-reply";
	  btn.textContent = opt.label;
	  btn.onclick = () => {
		renderUserBubble(opt.label);
		wrapper.remove();

      if (opt.action === "set_dish_category") {
        console.log("[DEBUG] üç¥ User picked dish category:", opt.label);
        setDishCategory(opt.label);
        fetch(`/get_main_tags?category=${encodeURIComponent(opt.label)}`)
          .then(r => r.json())
          .then(data => {
            document.getElementById("typing-indicator")?.remove();
            if (data.tags && data.tags.length > 0) {
              renderAIBubble("Œ§Œπ Œ∏Œ± Œ≠ŒªŒµŒ≥ŒµœÇ Œ≥ŒπŒ± Œ∫Œ¨œÑŒπ œÉŒµ..", "system");
              const tagOptions = data.tags.map(tag => ({
                label: tag,
                action: "set_main_ingredient_from_tag"
              }));
              tagOptions.push({ label: "ŒîŒµŒØŒæŒµ ŒºŒøœÖ Œ∫Œ¨œÑŒπ Œ¨ŒªŒªŒø", action: "ask_alt_from_category" });
              setTimeout(() => {
				renderQuickReplyOptions(tagOptions);
			  }, 500);
            } else {
              renderAIBubble("ŒîŒµŒΩ Œ≤œÅŒÆŒ∫Œ± Œ∫Œ¨œÑŒπ œÉœáŒµœÑŒπŒ∫œå. ŒòŒµœÇ ŒΩŒ± œÄœÅŒøœÑŒµŒØŒΩœâ ŒµŒ≥œé;", "system");
            }
          })
          .catch(err => {
            document.getElementById("typing-indicator")?.remove();
            renderAIBubble("‚ö†Ô∏è ŒîŒµŒΩ Œ∫Œ±œÑŒ¨œÜŒµœÅŒ± ŒΩŒ± œÜŒøœÅœÑœéœÉœâ œÑŒ± tags...", "system");
            console.error("[ERROR] Fetching tags:", err);
          });
      }

      if (opt.action === "set_main_ingredient_from_tag") {
        setMainIngredient(opt.label);
		console.log("call 4");
        callAISuggest(opt.label, 1);
		
      }

      if (opt.action === "ask_alt_from_category") {
        userNeedsHelp = true;
        const selectedCategory = getDishCategory();
        document.getElementById("typing-indicator")?.remove();
        renderAIBubble(`ŒòŒ≠ŒªŒµŒπœÇ ŒΩŒ± œÄŒ±œÅŒ±ŒºŒµŒØŒΩŒµŒπœÇ œÉœÑŒ∑ŒΩ Œ∫Œ±œÑŒ∑Œ≥ŒøœÅŒØŒ± "${selectedCategory}" ;`, "system");
        setTimeout(() => {
			renderQuickReplyOptions([
			  { label: `Œ†Œ±œÅŒ±ŒºŒ≠ŒΩœâ œÉŒµ ${selectedCategory}`, action: "stay_in_category" },
			  { label: "ŒëœÇ Œ¥ŒøœçŒºŒµ Œ∫Œ¨œÑŒπ Œ¨ŒªŒªŒø", action: "switch_category" }
			]);
		}, 500);	
        return;
      }
	  
	   if (opt.action === "stay_in_category") {
        const selectedCategory = getDishCategory();
        document.getElementById("typing-indicator")?.remove();
        renderAIBubble(`Œ†ŒµœÇ ŒºŒøœÖ œÑŒø Œ≤Œ±œÉŒπŒ∫œå œÖŒªŒπŒ∫œå œÄŒøœÖ Œ∏Œ± ŒÆŒ∏ŒµŒªŒµœÇ ŒΩŒ± œáœÅŒ∑œÉŒπŒºŒøœÄŒøŒπŒÆœÉŒµŒπœÇ!`, "system");	
        return;
      }
	  
	   if (opt.action === "switch_category") {
        const selectedCategory = getDishCategory();
        document.getElementById("typing-indicator")?.remove();
        renderAIBubble(`Œ†ŒµœÇ ŒºŒøœÖ œÑŒπ Œ≠œáŒµŒπœÇ œÉœÑŒø ŒºœÖŒ±Œªœå œÉŒøœÖ Œ≥ŒπŒ± œÉŒÆŒºŒµœÅŒ±!`, "system");	
        return;
      }
  
      if (opt.action === "ai_profile_suggest") {
        const payload = {
          message: "suggest to me a main ingredient acc. to my general preferences",
          max_time: getMaxTime(),
          main_ingredient: getMainIngredient(),
          aux_ingredients: getAuxIngredient(),
          preferred_methods: getMethodPrefs(),
          excluded: getExcluded()
        };

        console.log("[DEBUG] üì§ Sending silent profile-suggest payload:", payload);

        fetch("/ai_reply", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        })
          .then(r => r.json())
          .then(data => {
            document.getElementById("typing-indicator")?.remove();
            if (data.filters) updateFiltersFromAIResponse(data.filters);
            if (data.reply) renderAIBubble(data.reply);
          })
          .catch(err => {
            console.error("[DEBUG] ‚ùå AI error:", err);
            document.getElementById("typing-indicator")?.remove();
            renderAIBubble("‚ö†Ô∏è ŒöŒ¨œÑŒπ œÄŒÆŒ≥Œµ œÉœÑœÅŒ±Œ≤Œ¨. Œ†œÅŒøœÉœÄŒ¨Œ∏Œ∑œÉŒµ ŒæŒ±ŒΩŒ¨.", "system");
          });
      }

      if (opt.action === "more_results") {
        console.log("[DEBUG] üîÑ User requested more dish suggestions");
        moreResultsClicks++;
        document.getElementById("typing-indicator")?.remove();
		console.log("call 5");
        callAISuggest(getMainIngredient(), 1);
      }

      if (opt.action === "confirm_choice") {
        document.getElementById("typing-indicator")?.remove();
        renderAIBubble("Œ§Œ≠ŒªŒµŒπŒ±! ŒöŒ±ŒªŒÆ œåœÅŒµŒæŒ∑ Œ∫Œ±Œπ Œ∫Œ±ŒªŒÆ ŒµœÄŒπœÑœÖœáŒØŒ± œÉœÑŒø ŒºŒ±Œ≥ŒµŒØœÅŒµŒºŒ±! üë©‚Äçüç≥", "system");
      }
    };
    btn.style.setProperty('--delay', (idx * 45) + 'ms');
	wrapper.appendChild(btn);
  });

  chat.appendChild(wrapper);
  chat.scrollTop = chat.scrollHeight;
  adjustChatboxPosition();
}

// ‚úÖ Free user message ‚Üí /ai_reply ‚Üí update filters ‚Üí /ai_suggest_dish
function handleFreeUserMessage(text) {
  console.log("[DEBUG] üìù Free user input:", text);
  renderUserBubble(text);

  // reset the moreResults counter œåœÑŒ±ŒΩ Œø œáœÅŒÆœÉœÑŒ∑œÇ Œ≥œÅŒ¨œàŒµŒπ Œ∫Œ¨œÑŒπ Œ¥ŒπŒ∫œå œÑŒøœÖ
//  moreResultsClicks = 0;
//  UserNeedsHelp = false;

  const payload = {
    message: text,
    max_time: getMaxTime(),
    main_ingredient: getMainIngredient(),
    aux_ingredients: getAuxIngredient(),
    preferred_methods: getMethodPrefs(),
    excluded: getExcluded()
  };

  console.log("[DEBUG] üì§ Calling /ai_reply with:", payload);

  fetch("/ai_reply", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  })
    .then(r => r.json())
    .then(data => {
      document.getElementById("typing-indicator")?.remove();

      if (data.logout) {
        renderAIBubble("Œó œÉœÖŒΩŒµŒ¥œÅŒØŒ± œÑŒµœÅŒºŒ±œÑŒØœÉœÑŒ∑Œ∫Œµ Œ≥ŒπŒ± ŒªœåŒ≥ŒøœÖœÇ Œ±œÉœÜŒ±ŒªŒµŒØŒ±œÇ.", "system");
        return setTimeout(() => (window.location.href = "/logout"), 2000);
      }

      if (data.filters) {
        updateFiltersFromAIResponse(data.filters);
      }

      // ŒëŒΩ Œ≠œáŒøœÖŒºŒµ œÄŒªŒ≠ŒøŒΩ œåŒªŒ± œÑŒ± œÜŒØŒªœÑœÅŒ± ‚Üí Œ∫Œ¨ŒΩŒµ œÄœÅœåœÑŒ±œÉŒ∑
      const maxTime = getMaxTime();
      const mainIngredient = getMainIngredient();
      if (maxTime > 0 && mainIngredient) {
	  	console.log("call 6");
        callAISuggest(text, 1);
      } else if (data.reply) {
        renderAIBubble(data.reply);
      }
    })
    .catch(err => {
      console.error("[DEBUG] ‚ùå AI error:", err);
      document.getElementById("typing-indicator")?.remove();
      renderAIBubble("‚ö†Ô∏è ŒöŒ¨œÑŒπ œÄŒÆŒ≥Œµ œÉœÑœÅŒ±Œ≤Œ¨. Œ†œÅŒøœÉœÄŒ¨Œ∏Œ∑œÉŒµ ŒæŒ±ŒΩŒ¨.", "system");
    });
}

// ‚úÖ Dish rendering
function renderDishCards(dishes = []) {
  const chat = document.getElementById("chatbox");
  const wrapper = document.createElement("div");
  wrapper.className = "dish-cards-wrapper d-flex flex-column gap-2 mt-2";
  chat.appendChild(wrapper);
  adjustChatboxPosition();
  
  // Helper Œ≥ŒπŒ± badges
  function makeBadge(params) {
	const icon = params.icon;
	const text = params.text;
	const className = params.className;
	const badge = document.createElement("span");
	badge.className = "badge " + className;
	badge.innerHTML = '<i class="fa ' + icon + '"></i> ' + (text || "-");
	return badge;
	}

  dishes.forEach((dish, index) => {
    console.log('[DEBUG] dish:', dish); // ‚û§ ŒíŒªŒ≠œÄŒµŒπœÇ Œ±Œ∫œÅŒπŒ≤œéœÇ œÑŒπ œÄŒ±ŒØœÅŒΩŒµŒπœÇ Œ≥ŒπŒ± Œ∫Œ¨Œ∏Œµ œÄŒπŒ¨œÑŒø!
	setTimeout(() => {
      const card = document.createElement("div");
      card.className = "dish-card p-3 zoom-fade-card";
	  card.onclick = function() {
	    console.log("recipe page open = ",dish.id);
		window.location.href = '/recipe_page/' + dish.id;
		};
      // --- Œ§ŒØœÑŒªŒøœÇ + Œ∫Œ±œÅŒ¥ŒøœçŒªŒ±
      const title = document.createElement("div");
      title.className = "d-flex align-items-center";
      title.style.gap = "8px";

      const titleText = document.createElement("span");
      titleText.textContent = dish.title;
      titleText.style.fontWeight = "600";
      titleText.style.fontSize = "1.1rem";
      titleText.style.color = "var(--text)";

      const favWrapper = document.createElement("span");
      favWrapper.style.cursor = "pointer";
	  const isFav = dish.is_favorite == 1;

	  favWrapper.innerHTML = '<i class="' + (isFav ? 'fas' : 'far') + ' fa-heart" style="color: ' + (isFav ? '#218e46' : '#218e46') + '; font-size: 18px; vertical-align: -2px;"></i>';
	  favWrapper.onclick = function(e) {
	  e.stopPropagation();
	  toggleFavorite(favWrapper, dish.id);
	  };

      title.appendChild(titleText);
      title.appendChild(favWrapper);
      card.appendChild(title);

      // --- Badges (flex)
      const badgeRow = document.createElement("div");
      badgeRow.className = "d-flex flex-wrap align-items-center gap-2";
      // Œ§œéœÅŒ± œÑŒ± badges œâœÇ config array Œ≥ŒπŒ± ŒµœÖŒµŒªŒπŒæŒØŒ±:
      [
        {icon: "fa-user", text: dish.chef, className: "bg-info text-dark"},
        {icon: "fa-clock", text: (dish.total_time || "-") + "'", className: "bg-success text-white"},
        {icon: "fa-fire", text: dish.method, className: "bg-warning text-dark"},
        // {icon: "fa-tag", text: dish.ingredients, className: "bg-secondary text-white"} // uncomment Œ±ŒΩ œÑŒø Œ∏ŒµœÇ!
      ].forEach(cfg => badgeRow.appendChild(makeBadge(cfg)));
      card.appendChild(badgeRow);

      wrapper.appendChild(card);

      requestAnimationFrame(() => {
        card.classList.add("zoom-fade-in");
      });

      chat.scrollTop = chat.scrollHeight;

      // ‚ûï ŒúœåŒªŒπœÇ œÄœÅŒøœÉœÑŒµŒ∏ŒµŒØ Œ∫Œ±Œπ œÑŒø œÑŒµŒªŒµœÖœÑŒ±ŒØŒø dish, Œ≤Œ¨ŒªŒµ œÑŒ± predefined choices
      if (index === dishes.length - 1) {
        setTimeout(() => {
          renderQuickReplyOptions([
            { label: "ŒòŒ± ŒºŒ±Œ≥ŒµŒπœÅŒ≠œàœâ Œ∫Œ¨œÑŒπ Œ±œÄœå œÑŒ± œÄŒ±œÅŒ±œÄŒ¨ŒΩœâ", action: "confirm_choice" },
            { label: "ŒîŒµŒØŒæŒµ ŒºŒøœÖ Œ∫Œ¨œÑŒπ Œ¨ŒªŒªŒø", action: "more_results" }
          ]);
        }, 500);
      }
    }, index * 500); // <-- Œ±ŒΩ Œ∏ŒµœÇ œÄŒπŒø Œ≥œÅŒÆŒ≥ŒøœÅŒ±, œÄŒ±ŒØŒæŒµ œÑŒø œÄ.œá. 400-600
  });
}

function getPreferredChef() {
  return localStorage.getItem("preferred_chef") || "";
}

// ‚úÖ Call /ai_suggest_dish
function callAISuggest(userMessage = "", step) {
  const filters = {
    max_time: getMaxTime(),
    dish_category: getDishCategory(),
    main_ingredient: getMainIngredient(),
    aux_ingredient: getAuxIngredient(),
    excluded: getExcluded(),
    preferred_methods: getMethodPrefs(),
    chef: getPreferredChef()
  };

  const payload = {
    step: step,
    message: userMessage,
    ...filters
  };

  console.log("[DEBUG] üöÄ Sending payload to /ai_suggest_dish:", payload);

  fetch("/ai_suggest_dish", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  })
    .then(r => r.json())
    .then(data => {
      console.log("[DEBUG] üì© Suggestion response:", data);
      document.getElementById("typing-indicator")?.remove();

      if (data.success === false) {
        renderAIBubble("‚ö†Ô∏è Œ§Œø backend ŒµœÄŒ≠œÉœÑœÅŒµœàŒµ Œ±œÄŒøœÑœÖœáŒØŒ±.", "system");
        return;
      }

      if (data.message) {
        renderAIBubble(data.message);
      }

      if (data.dishes?.length) {
        renderDishCards(data.dishes);
      }

      if (!data.dishes || data.dishes.length === 0) {
        localStorage.clear();
        initLocalState();
      }
    })
    .catch(err => {
      console.error("[DEBUG] ‚ùå Suggestion error:", err);
      document.getElementById("typing-indicator")?.remove();
      renderAIBubble("‚ö†Ô∏è ŒöŒ¨œÑŒπ œÄŒÆŒ≥Œµ œÉœÑœÅŒ±Œ≤Œ¨ œÉœÑŒ∑ŒΩ œÄœÅœåœÑŒ±œÉŒ∑.", "system");
    });
}

</script>

<!--Help functions-->
<script>
    function shuffle(array) {
      let arr = array.slice();
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }
</script>

<!--Speech Regognition-->
<script>
function startSpeechRecognition() {
    if (!('webkitSpeechRecognition' in window)) {
      alert("Œü browser œÉŒøœÖ Œ¥ŒµŒΩ œÖœÄŒøœÉœÑŒ∑œÅŒØŒ∂ŒµŒπ œÜœâŒΩŒ∑œÑŒπŒ∫ŒÆ Œ±ŒΩŒ±Œ≥ŒΩœéœÅŒπœÉŒ∑.");
      return;
    }

    const recognition = new webkitSpeechRecognition();
    recognition.lang = 'el-GR';
    recognition.continuous = false;
    recognition.interimResults = false;

    input.placeholder = "üéôÔ∏è Œ£Œµ Œ±Œ∫Œøœçœâ...";
    inputRow.classList.add("voice-active");

    recognition.onresult = function(event) {
      const transcript = event.results[0][0].transcript.trim();
      input.value = transcript;
      input.dispatchEvent(new Event("input"));
      resetInputUI();
    };

    recognition.onerror = function(event) {
      alert("Œ£œÜŒ¨ŒªŒºŒ± ŒºŒπŒ∫œÅŒøœÜœéŒΩŒøœÖ: " + event.error);
      resetInputUI();
    };

    recognition.onend = function() {
      resetInputUI();
    };

    recognition.start();
  }

function resetInputUI() {
    input.placeholder = originalPlaceholder;
    inputRow.classList.remove("voice-active");
  }

</script>

<!--Favorites-->
<script>
function toggleFavorite(wrapper, recipe_id) {
  fetch('/toggle_favorite_recipe', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ recipe_id: recipe_id })
  })
  .then(r => r.json())
  .then(data => {
    const isAdded = data.status === "added";

    // ‚ú® ŒïœÄŒ±ŒΩŒ±œÜŒ≠œÅŒøœÖŒºŒµ œÑŒø œÄŒµœÅŒπŒµœáœåŒºŒµŒΩŒø œÑŒøœÖ wrapper
	wrapper.innerHTML =
	'<i class="' + (isAdded ? 'fas' : 'far') + ' fa-heart" style="color: ' + (isAdded ? '#218e46' : '#218e46') + '; font-size: 18px; vertical-align: -2px; cursor: pointer;"></i>'

    // ‚ú® ŒæŒ±ŒΩŒ±Œ¥Œ≠ŒΩŒøœÖŒºŒµ œÑŒø event handler œÉœÑŒø ŒΩŒ≠Œø icon
    const icon = wrapper.querySelector("i");
    if (icon) {
      icon.onclick = function(e) {
        e.stopPropagation();
        toggleFavorite(wrapper, recipe_id);
      };
    } else {
      console.warn("‚ö†Ô∏è ŒîŒµŒΩ Œ≤œÅŒ≠Œ∏Œ∑Œ∫Œµ icon Œ≥ŒπŒ± dish id:", recipe_id);
    }
  });
}
</script>


{% endblock %}
