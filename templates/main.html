{% extends "base.html" %}
{% block title %}Î¤Î¹ Î¸Î± Ï†Î¬Î¼Îµ ÏƒÎ®Î¼ÎµÏÎ±;{% endblock %}
{% block content %}

<style>
  :root {
    --brand: #218e46;
    --brand-hover: #1a6e38;
    --text: #1b1b1b;
    --surface: #fffaf5;
    --outline: #ddd;
    --input-bg: #ffffff;
    --input-bg-focus: #f0fff4;
    --voice-bg: #ffebee;
    --voice-color: #c62828;
  }

  body {
    margin: 0;
    padding: 0;
    background-color: var(--surface);
    font-family: 'Roboto', sans-serif;
  }

  .chat-screen {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    height: 100dvh;
    box-sizing: border-box;
    background-color: var(--surface);
  }

  .logo {
    width: 72px;
    height: 72px;
    border-radius: 16px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.08);
    margin-top: 16px;
  }

  .chat-intro {
    font-size: 1.3rem;
    font-weight: 600;
    color: var(--brand);
    text-align: center;
    max-width: 320px;
    margin: 12px 0;
  }

  .chatbox {
    flex: 1;
    width: 100%;
    max-width: 480px;
    background-color: white;
    border-radius: 16px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 12px;
    overflow-y: auto;
  }

  .chat-bubble {
    padding: 10px 14px;
    border-radius: 20px;
    font-size: 0.95rem;
    line-height: 1.4;
    max-width: 75%;
    animation: fadeIn 0.4s ease-out;
    word-break: break-word;
    white-space: pre-wrap;
  }

  .from-ai {
    background-color: #eafbe7;
    color: var(--brand);
    align-self: flex-start;
  }

  .from-user {
    background-color: #d4eaf7;
    color: #0d5584;
    align-self: flex-end;
  }

  .typing-indicator {
    font-style: italic;
    color: #999;
    font-size: 0.9rem;
    align-self: flex-start;
    margin-top: 2px;
  }

  .quick-replies {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 4px;
	justify-content: flex-start;  /* ğŸŸ¢ Î•Î¾Î±ÏƒÏ†Î±Î»Î¯Î¶ÎµÎ¹ Î¿Î¼Î±Î»Î® ÏƒÏ„Î¿Î¯Ï‡Î¹ÏƒÎ· Î±ÏÎ¹ÏƒÏ„ÎµÏÎ¬ */
	font-weight: 500;
	letter-spacing: 0.3px;
  }

  .quick-reply {
    background-color: #f5f5f5;
    color: #333;
    padding: 6px 14px;
    border-radius: 24px;
    border: 1px solid #ccc;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.2s ease;
	white-space: nowrap;           /* ğŸŸ¢ ÎšÏÎ±Ï„Î¬ÎµÎ¹ Ï„Î¿ ÎºÎ¿Ï…Î¼Ï€Î¯ ÏƒÎµ 1 Î³ÏÎ±Î¼Î¼Î® */
    max-width: 100%;               /* âœ… Î“Î¹Î± Î±ÏƒÏ†Î¬Î»ÎµÎ¹Î± ÏƒÎµ Î¼Î¹ÎºÏÎ­Ï‚ Î¿Î¸ÏŒÎ½ÎµÏ‚ */
    overflow: hidden;              /* âœ‚ï¸ Î‘Î½ Ï„Î¿ ÎºÎµÎ¯Î¼ÎµÎ½Î¿ ÎµÎ¯Î½Î±Î¹ Ï„ÎµÏÎ¬ÏƒÏ„Î¹Î¿ */
    text-overflow: ellipsis;      /* â• Î”ÎµÎ¯Ï‡Î½ÎµÎ¹ "..." Î±Î½ Ï‡ÏÎµÎ¹Î±ÏƒÏ„ÎµÎ¯ */
  }

  .quick-reply:hover {
    background-color: #e0e0e0;
    box-shadow: 0 1px 3px rgba(0,0,0,0.15);
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .chat-input-row {
    display: flex;
    gap: 8px;
    width: 100%;
    max-width: 480px;
    align-items: center;
    padding: 10px 12px;
    background: #fff;
    border-top: 1px solid var(--outline);
    position: sticky;
    bottom: 0;
    z-index: 10;
  }

  .chat-input-row textarea {
    flex: 1;
    padding: 10px 14px;
    border-radius: 20px;
    border: 1.5px solid var(--outline);
    font-size: 1rem;
    padding-right: 72px;
    resize: none;
    min-height: 44px;
    max-height: 120px;
    overflow-y: auto;
    background-color: var(--input-bg);
    transition: background-color 0.2s ease;
  }

  .chat-input-row textarea:focus {
    background-color: var(--input-bg-focus);
    outline: none;
  }

  .chat-input-row.voice-active textarea {
    background-color: var(--voice-bg);
    color: var(--voice-color);
    font-weight: 500;
  }

  .chat-input-row button {
    border: none;
    background: none;
    cursor: pointer;
    padding: 6px;
  }

  .mui-icon {
    font-size: 26px;
    color: var(--brand);
  }
  .mui-icon:hover {
    color: var(--brand-hover);
  }

  /* Dish cards */
  .dish-cards-wrapper {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    margin-top: 8px;
  }

  .dish-card {
    background-color: #deb90c30;
    border: 1px solid var(--outline);
    border-radius: 12px;
    padding: 12px 14px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.04);
    font-size: 0.92rem;
    display: flex;
    flex-direction: column;
    gap: 8px;
    animation: fadeIn 0.3s ease-out;
    transition: box-shadow 0.2s ease;
  }
  .dish-card:hover {
    box-shadow: 0 4px 10px rgba(0,0,0,0.08);
  }

  .dish-title {
    font-weight: 600;
    font-size: 1.1rem;
    color: var(--text);
  }

  .badge {
    font-size: 0.8rem;
	margin-left: 0 !important;
    font-weight: 500;
    padding: 4px 10px;
    border-radius: 20px;
    white-space: nowrap;
  }
</style>

<style>
.zoom-fade-card {
  opacity: 0;
  transform: scale(0.9);
}

.zoom-fade-in {
  animation: zoomFadeIn 0.9s ease forwards;
}

@keyframes zoomFadeIn {
  from {
    opacity: 0;
    transform: scale(0.1);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}
</style>

<div class="chat-screen">
  <img src="{{ url_for('static', filename='image.png') }}" alt="Logo" class="logo">
  <div class="chat-intro">
    ÎšÎ±Î»ÏÏ‚ Î®ÏÎ¸ÎµÏ‚ {{ user_name or '' }}! ğŸ‘‹<br>
    Î Î¬Î¼Îµ Î½Î± Î²ÏÎ¿ÏÎ¼Îµ Ï„Î¹ Î¸Î± Î¼Î±Î³ÎµÎ¹ÏÎ­ÏˆÎ¿Ï…Î¼Îµ;
  </div>

  <div class="chatbox" id="chatbox">
    <div class="chat-bubble from-ai">ğŸ‘©â€ğŸ³ Î ÏŒÏƒÎ¿ Ï€ÎµÏÎ¯Ï€Î¿Ï… Ï‡ÏÏŒÎ½Î¿ Î­Ï‡ÎµÎ¹Ï‚ Î³Î¹Î± Î¼Î±Î³ÎµÎ¯ÏÎµÎ¼Î±;</div>
    <div class="quick-replies">
      <div class="quick-reply" onclick="handlePredefinedChoice('time','ÎˆÏ‰Ï‚ 30Î».')">ÎˆÏ‰Ï‚ 30'</div>
      <div class="quick-reply" onclick="handlePredefinedChoice('time','ÎˆÏ‰Ï‚ 1 ÏÏÎ±')">ÎˆÏ‰Ï‚ 1 ÏÏÎ±</div>
      <div class="quick-reply" onclick="handlePredefinedChoice('time','Î Î¬Î½Ï‰ Î±Ï€ÏŒ 1,5 ÏÏÎ±')">Î Î¬Î½Ï‰ Î±Ï€ÏŒ 1,5 ÏÏÎ±</div>
    </div>
  </div>

  <div class="chat-input-row" id="chatInputRow">
    <textarea id="userInput" placeholder="Î Î»Î·ÎºÏ„ÏÎ¿Î»ÏŒÎ³Î·ÏƒÎµ ÎµÎ´Ï..."></textarea>
    <button onclick="sendMessage()">
      <span class="material-icons mui-icon">send</span>
    </button>
    <button onclick="startSpeechRecognition()">
      <span class="material-icons mui-icon">mic</span>
    </button>
  </div>
</div>

{% endblock %}

{% block scripts %}


<script>
// ğŸŒ Cooking Assistant â€“ localStorage Utilities

const StorageKeys = {
  MAX_TIME: "max_time",
  DISH_CATEGORY: "dish_category",
  MAIN_INGREDIENT: "main_ingredient",
  METHOD_PREFS: "method_prefs",
  EXCLUDED: "excluded",
  AUX_INGREDIENTS: "aux_ingredients"   
};

// â¤ Î‘ÏƒÏ†Î±Î»Î­Ï‚ setter
function setStorageItem(key, value) {
  try {
    localStorage.setItem(key, JSON.stringify(value));
  } catch (e) {
    console.error(`[ERROR] âŒ Failed to save ${key}:`, e);
  }
}

// â¤ Î‘ÏƒÏ†Î±Î»Î­Ï‚ getter
function getStorageItem(key, fallback = null) {
  try {
    const raw = localStorage.getItem(key);
    return raw ? JSON.parse(raw) : fallback;
  } catch (e) {
    console.warn(`[WARN] Failed to read ${key}, returning fallback.`);
    return fallback;
  }
}

// â¤ Î•Î¹Î´Î¹ÎºÎ­Ï‚ ÏƒÏ…Î½Î±ÏÏ„Î®ÏƒÎµÎ¹Ï‚ Î³Î¹Î± ÎºÎ¬Î¸Îµ Î¼ÎµÏ„Î±Î²Î»Î·Ï„Î®

function setMaxTime(minutes) {
  setStorageItem(StorageKeys.MAX_TIME, String(minutes));
}

function getMaxTime() {
  return getStorageItem(StorageKeys.MAX_TIME, "30"); // default 30 Î»ÎµÏ€Ï„Î¬
}

function setDishCategory(DishCategory) {
  setStorageItem(StorageKeys.DISH_CATEGORY, DishCategory);
}

function getDishCategory() {
  return getStorageItem(StorageKeys.DISH_CATEGORY, null);
}

function setMainIngredient(ingredient) {
  setStorageItem(StorageKeys.MAIN_INGREDIENT, ingredient);
}

function getMainIngredient() {
  return getStorageItem(StorageKeys.MAIN_INGREDIENT, null);
}

function setMethodPrefs(methodsArray) {
  setStorageItem(StorageKeys.METHOD_PREFS, methodsArray);
}

function getMethodPrefs() {
  return getStorageItem(StorageKeys.METHOD_PREFS, [
    'Î¦Î¿ÏÏÎ½Î¿Ï‚', 'ÎšÎ±Ï„ÏƒÎ±ÏÏŒÎ»Î±', 'Î§ÏÏ„ÏÎ±', 'Î¤Î·Î³Î¬Î½Î¹', 'Î£Ï‡Î¬ÏÎ±', 'Air-fryer'
  ]);
}

function setExcluded(excludesArray) {
  setStorageItem(StorageKeys.EXCLUDED, excludesArray);
}

function getExcluded() {
  return getStorageItem(StorageKeys.EXCLUDED, []);
}

function setAuxIngredient(auxArray) {
  setStorageItem(StorageKeys.AUX_INGREDIENTS, auxArray);
}

function getAuxIngredient() {
  return getStorageItem(StorageKeys.AUX_INGREDIENTS, []);
}

// â¤ Clear All
function clearCookingFilters() {
  Object.values(StorageKeys).forEach(k => localStorage.removeItem(k));
  console.log("[DEBUG] ğŸ§¹ Cleared all cooking filters from localStorage");
}
</script>

<script>
const input = document.getElementById("userInput");
const inputRow = document.getElementById("chatInputRow");
const originalPlaceholder = input.placeholder;
const DISH_CATEGORIES = ["Brunch","Vegan","Î–Ï…Î¼Î±ÏÎ¹ÎºÎ¬","Î˜Î±Î»Î±ÏƒÏƒÎ¹Î½Î¬","ÎšÏŒÎºÎºÎ¹Î½Î¿ ÎºÏÎ­Î±Ï‚","Î›Î±Î´ÎµÏÎ¬","ÎŒÏƒÏ€ÏÎ¹Î±","Î Î±ÏÎ±Î´Î¿ÏƒÎ¹Î±ÎºÎ¬","Î Î¯Ï„ÎµÏ‚","Î Î¿Ï…Î»ÎµÏÎ¹ÎºÎ¬","Î£Î¿ÏÏ€ÎµÏ‚","Î£Î±Î»Î¬Ï„ÎµÏ‚"];
let moreResultsClicks = 0;
let UserNeedsHelp = false;

// âœ… CLEAR STATE ON PAGE LOAD
window.addEventListener("DOMContentLoaded", () => {
  console.log("[DEBUG] ğŸ”¥ Î Î»Î®ÏÎ·Ï‚ ÎºÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚ localStorage");
  localStorage.clear();
  initLocalState();
});
			  
input.addEventListener("keydown", function(e) {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
});

input.addEventListener("input", function() {
  input.style.height = "auto";
  input.style.height = input.scrollHeight + "px";
});

// âœ… Initialize filters on page load
function initLocalState() {
  if (!localStorage.getItem(StorageKeys.METHOD_PREFS)) setMethodPrefs(getMethodPrefs());
  if (!localStorage.getItem(StorageKeys.EXCLUDED)) setExcluded([]);
  if (!localStorage.getItem(StorageKeys.MAX_TIME)) setMaxTime(180);
  if (!localStorage.getItem(StorageKeys.DISH_CATEGORY)) setDishCategory("");
  if (!localStorage.getItem(StorageKeys.MAIN_INGREDIENT)) setMainIngredient("");
  if (!localStorage.getItem(StorageKeys.AUX_INGREDIENTS)) setAuxIngredient([]);
  console.log("[DEBUG] ğŸŒ± Local state initialized");
}

// âœ… Time mapping helper
function mapTimeLabelToMinutes(label) {
  const map = {
    "ÎˆÏ‰Ï‚ 30Î».": 30,
    "ÎˆÏ‰Ï‚ 1 ÏÏÎ±": 60,
    "Î Î¬Î½Ï‰ Î±Ï€ÏŒ 1,5 ÏÏÎ±": 200
  };
  return map[label] || 90;
}

function sendMessage() {
  const msg = input.value.trim();
  if (!msg) return;

  handleFreeUserMessage(msg);
  input.value = "";
  input.placeholder = originalPlaceholder;
  input.style.height = "auto";
}

// âœ… Render bubbles
function renderUserBubble(text) {
  const chat = document.getElementById("chatbox");
  const userBubble = document.createElement("div");
  userBubble.className = "chat-bubble from-user";
  userBubble.textContent = text;
  chat.appendChild(userBubble);
  chat.scrollTop = chat.scrollHeight;

  const typing = document.createElement("div");
  typing.className = "typing-indicator";
  typing.textContent = "Family Food Ï€Î»Î·ÎºÏ„ÏÎ¿Î»Î¿Î³ÎµÎ¯...";
  typing.id = "typing-indicator";
  chat.appendChild(typing);
  chat.scrollTop = chat.scrollHeight;
}

function renderAIBubble(text, type = "ai") {
	const chat = document.getElementById("chatbox");
	const bubble = document.createElement("div");
	bubble.className = "chat-bubble from-ai";
	bubble.innerHTML = '<span class="chat-icon">' + (type === "system" ? "ğŸ‘¨â€ğŸ³ " : "ğŸ§  ") + "</span><span>" + text + "</span>";
	chat.appendChild(bubble);
	chat.scrollTop = chat.scrollHeight;
}

// âœ… Update filters from AI_reply
function updateFiltersFromAIResponse(filters) {
  if (!filters || typeof filters !== "object") return;

  const keys = Object.keys(filters);
  for (let key of keys) {
    console.log(`[DEBUG] ğŸ”„ Updating filter '${key}' â†’`, filters[key]);
    switch (key) {
      case "max_time":
        setMaxTime(filters[key]);
        break;
      case "main_ingredient":
        setMainIngredient(filters[key]);
        break;
      case "aux_ingredients":
        setAuxIngredient(filters[key]);
        break;
      case "cooking_method":
        setMethodPrefs(filters[key]);
        break;
      case "excluded_keywords":
        setExcluded(filters[key]);
        break;
    }
  }
}

// âœ… Predefined choice handler
function handlePredefinedChoice(type, value) {
  renderUserBubble(value);

  const quickReplies = document.querySelectorAll(".quick-replies");
  quickReplies.forEach(qr => qr.remove());

  if (type === "time") {
    setMaxTime(mapTimeLabelToMinutes(value));
  }
  if (type === "exclude_method") {
    setMethodPrefs(getMethodPrefs().filter(m => m !== value.trim()));
  }
  if (type === "exclude_ingredient") {
    setExcluded([...getExcluded(), value.toLowerCase()]);
  }

  const maxTime = getMaxTime();
  const DishCategory = getDishCategory();
  const mainIngredient = getMainIngredient();

  if (type === "set_dish_category") {
    setDishCategory(value);
    fetch("/api/get_tags_for_category?category=" + encodeURIComponent(value))
      .then(r => r.json())
      .then(data => {
        if (data.tags && data.tags.length > 0) {
          renderAIBubble("Î˜ÎµÏ‚ ÎºÎ¬Ï„Î¹ Î±Ï€ÏŒ Ï„Î± Ï€Î±ÏÎ±ÎºÎ¬Ï„Ï‰;", "system");
          renderQuickReplyOptions(
            data.tags.map(tag => ({
              label: tag,
              action: "set_main_ingredient"
            }))
          );
        } else {
          if (maxTime > 0 && !mainIngredient) {
			console.log("call 1");
            callAISuggest("", 1);
          }
        }
      })
      .catch(err => {
        console.error("[DEBUG] âŒ Failed to fetch tags:", err);
        if (maxTime > 0 && !mainIngredient) {
		  console.log("call 2");
          callAISuggest("", 1);
        }
      });
    return;
  }

  if (type === "set_main_ingredient") {
    setMainIngredient(value);
  }

  if (maxTime > 0 && DishCategory && mainIngredient) {
    console.log("call 3");
    callAISuggest("", 1);
  } else if (maxTime > 0 && !mainIngredient && type === "time") {
    document.getElementById("typing-indicator")?.remove();
    renderAIBubble("Î¤Î¹ Ï„ÏÎ±Î²Î¬ÎµÎ¹ Î· ÏŒÏÎµÎ¾Î® ÏƒÎ¿Ï… Î³Î¹Î± ÏƒÎ®Î¼ÎµÏÎ±;", "system");

    function shuffle(array) {
      let arr = array.slice();
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    renderQuickReplyOptions(
      shuffle(DISH_CATEGORIES).map(label => ({
        label,
        action: "set_dish_category"
      }))
    );
  }
}

// âœ… Render predefined options
function renderQuickReplyOptions(options = []) {
  const chat = document.getElementById("chatbox");
  const wrapper = document.createElement("div");
  wrapper.className = "quick-replies";

  options.forEach(opt => {
    const btn = document.createElement("div");
    btn.className = "quick-reply";
    btn.textContent = opt.label;
    btn.onclick = () => {
      renderUserBubble(opt.label);
      wrapper.remove();

      if (opt.action === "set_dish_category") {
        console.log("[DEBUG] ğŸ´ User picked dish category:", opt.label);
        setDishCategory(opt.label);
        fetch(`/get_main_tags?category=${encodeURIComponent(opt.label)}`)
          .then(r => r.json())
          .then(data => {
            document.getElementById("typing-indicator")?.remove();
            if (data.tags && data.tags.length > 0) {
              renderAIBubble("Î˜Î­Î»ÎµÎ¹Ï‚ ÎºÎ¬Ï„Î¹ Î±Ï€ÏŒ Ï„Î± Ï€Î±ÏÎ±ÎºÎ¬Ï„Ï‰;", "system");
              const tagOptions = data.tags.map(tag => ({
                label: tag,
                action: "set_main_ingredient_from_tag"
              }));
              tagOptions.push({ label: "ÎšÎ¬Ï„Î¹ Î¬Î»Î»Î¿", action: "ask_alt_from_category" });
              renderQuickReplyOptions(tagOptions);
            } else {
              renderAIBubble("Î”ÎµÎ½ Î²ÏÎ®ÎºÎ± ÎºÎ¬Ï„Î¹ ÏƒÏ‡ÎµÏ„Î¹ÎºÏŒ. Î˜ÎµÏ‚ Î½Î± Ï€ÏÎ¿Ï„ÎµÎ¯Î½Ï‰ ÎµÎ³Ï;", "system");
            }
          })
          .catch(err => {
            document.getElementById("typing-indicator")?.remove();
            renderAIBubble("âš ï¸ Î”ÎµÎ½ ÎºÎ±Ï„Î¬Ï†ÎµÏÎ± Î½Î± Ï†Î¿ÏÏ„ÏÏƒÏ‰ Ï„Î± tags...", "system");
            console.error("[ERROR] Fetching tags:", err);
          });
      }

      if (opt.action === "set_main_ingredient_from_tag") {
        setMainIngredient(opt.label);
		console.log("call 4");
        callAISuggest(opt.label, 1);
		
      }

      if (opt.action === "ask_alt_from_category") {
        userNeedsHelp = true;
        const selectedCategory = getDishCategory();
        document.getElementById("typing-indicator")?.remove();
        renderAIBubble(`Î˜Î­Î»ÎµÎ¹Ï‚ Î½Î± Ï€Î±ÏÎ±Î¼ÎµÎ¯Î½ÎµÎ¹Ï‚ ÏƒÏ„Î·Î½ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î± "${selectedCategory}" ;`, "system");
        renderQuickReplyOptions([
          { label: `Î Î±ÏÎ±Î¼Î­Î½Ï‰ ÏƒÎµ ${selectedCategory}`, action: "stay_in_category" },
          { label: "Î˜Î­Î»Ï‰ ÎºÎ¬Ï„Î¹ Î¬Î»Î»Î¿", action: "switch_category" }
        ]);
        return;
      }

      if (opt.action === "ai_profile_suggest") {
        const payload = {
          message: "suggest to me a main ingredient acc. to my general preferences",
          max_time: getMaxTime(),
          main_ingredient: getMainIngredient(),
          aux_ingredients: getAuxIngredient(),
          preferred_methods: getMethodPrefs(),
          excluded: getExcluded()
        };

        console.log("[DEBUG] ğŸ“¤ Sending silent profile-suggest payload:", payload);

        fetch("/ai_reply", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        })
          .then(r => r.json())
          .then(data => {
            document.getElementById("typing-indicator")?.remove();
            if (data.filters) updateFiltersFromAIResponse(data.filters);
            if (data.reply) renderAIBubble(data.reply);
          })
          .catch(err => {
            console.error("[DEBUG] âŒ AI error:", err);
            document.getElementById("typing-indicator")?.remove();
            renderAIBubble("âš ï¸ ÎšÎ¬Ï„Î¹ Ï€Î®Î³Îµ ÏƒÏ„ÏÎ±Î²Î¬. Î ÏÎ¿ÏƒÏ€Î¬Î¸Î·ÏƒÎµ Î¾Î±Î½Î¬.", "system");
          });
      }

      if (opt.action === "more_results") {
        console.log("[DEBUG] ğŸ”„ User requested more dish suggestions");
        moreResultsClicks++;
        document.getElementById("typing-indicator")?.remove();
		console.log("call 5");
        callAISuggest(getMainIngredient(), 1);
      }

      if (opt.action === "confirm_choice") {
        console.log("[DEBUG] âœ… User confirmed cooking choice");
        renderAIBubble("Î¤Î­Î»ÎµÎ¹Î±! ÎšÎ±Î»Î® ÏŒÏÎµÎ¾Î· ÎºÎ±Î¹ ÎºÎ±Î»Î® ÎµÏ€Î¹Ï„Ï…Ï‡Î¯Î± ÏƒÏ„Î¿ Î¼Î±Î³ÎµÎ¯ÏÎµÎ¼Î±! ğŸ‘©â€ğŸ³", "system");
      }
    };
    wrapper.appendChild(btn);
  });

  chat.appendChild(wrapper);
  chat.scrollTop = chat.scrollHeight;
}

// âœ… Free user message â†’ /ai_reply â†’ update filters â†’ /ai_suggest_dish
function handleFreeUserMessage(text) {
  console.log("[DEBUG] ğŸ“ Free user input:", text);
  renderUserBubble(text);

  // reset the moreResults counter ÏŒÏ„Î±Î½ Î¿ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚ Î³ÏÎ¬ÏˆÎµÎ¹ ÎºÎ¬Ï„Î¹ Î´Î¹ÎºÏŒ Ï„Î¿Ï…
//  moreResultsClicks = 0;
//  UserNeedsHelp = false;

  const payload = {
    message: text,
    max_time: getMaxTime(),
    main_ingredient: getMainIngredient(),
    aux_ingredients: getAuxIngredient(),
    preferred_methods: getMethodPrefs(),
    excluded: getExcluded()
  };

  console.log("[DEBUG] ğŸ“¤ Calling /ai_reply with:", payload);

  fetch("/ai_reply", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  })
    .then(r => r.json())
    .then(data => {
      document.getElementById("typing-indicator")?.remove();

      if (data.logout) {
        renderAIBubble("Î— ÏƒÏ…Î½ÎµÎ´ÏÎ¯Î± Ï„ÎµÏÎ¼Î±Ï„Î¯ÏƒÏ„Î·ÎºÎµ Î³Î¹Î± Î»ÏŒÎ³Î¿Ï…Ï‚ Î±ÏƒÏ†Î±Î»ÎµÎ¯Î±Ï‚.", "system");
        return setTimeout(() => (window.location.href = "/logout"), 2000);
      }

      if (data.filters) {
        updateFiltersFromAIResponse(data.filters);
      }

      // Î‘Î½ Î­Ï‡Î¿Ï…Î¼Îµ Ï€Î»Î­Î¿Î½ ÏŒÎ»Î± Ï„Î± Ï†Î¯Î»Ï„ÏÎ± â†’ ÎºÎ¬Î½Îµ Ï€ÏÏŒÏ„Î±ÏƒÎ·
      const maxTime = getMaxTime();
      const mainIngredient = getMainIngredient();
      if (maxTime > 0 && mainIngredient) {
	  	console.log("call 6");
        callAISuggest(text, 1);
      } else if (data.reply) {
        renderAIBubble(data.reply);
      }
    })
    .catch(err => {
      console.error("[DEBUG] âŒ AI error:", err);
      document.getElementById("typing-indicator")?.remove();
      renderAIBubble("âš ï¸ ÎšÎ¬Ï„Î¹ Ï€Î®Î³Îµ ÏƒÏ„ÏÎ±Î²Î¬. Î ÏÎ¿ÏƒÏ€Î¬Î¸Î·ÏƒÎµ Î¾Î±Î½Î¬.", "system");
    });
}

// âœ… Dish rendering
function renderDishCards(dishes = []) {
  const chat = document.getElementById("chatbox");
  const wrapper = document.createElement("div");
  wrapper.className = "dish-cards-wrapper d-flex flex-column gap-2 mt-2";
  chat.appendChild(wrapper);
  
  // Helper Î³Î¹Î± badges
  function makeBadge({icon, text, className}) {
    const badge = document.createElement("span");
    badge.className = "badge " + className;
    badge.innerHTML = `<i class="fa ${icon}"></i> ${text || "-"}`;
    return badge;
  }

  dishes.forEach((dish, index) => {
    console.log('[DEBUG] dish:', dish); // â¤ Î’Î»Î­Ï€ÎµÎ¹Ï‚ Î±ÎºÏÎ¹Î²ÏÏ‚ Ï„Î¹ Ï€Î±Î¯ÏÎ½ÎµÎ¹Ï‚ Î³Î¹Î± ÎºÎ¬Î¸Îµ Ï€Î¹Î¬Ï„Î¿!
	setTimeout(() => {
      const card = document.createElement("div");
      card.className = "dish-card p-3 zoom-fade-card";

      // --- Î¤Î¯Ï„Î»Î¿Ï‚ + ÎºÎ±ÏÎ´Î¿ÏÎ»Î±
      const title = document.createElement("div");
      title.className = "d-flex align-items-center";
      title.style.gap = "8px";

      const titleText = document.createElement("span");
      titleText.textContent = dish.title;
      titleText.style.fontWeight = "600";
      titleText.style.fontSize = "1.1rem";
      titleText.style.color = "var(--text)";

      const favWrapper = document.createElement("span");
      favWrapper.style.cursor = "pointer";
	  const isFav = dish.is_favorite == 1;
	  console.log('[DEBUG] dish.title=', dish.title, '| is_favorite=', dish.is_favorite, '| isFav=', isFav);
	  favWrapper.innerHTML = `<i class="${isFav ? "fas" : "far"} fa-heart" style="color: ${isFav ? "#c33" : "gray"}; font-size: 18px; vertical-align: -2px;"></i>`;
      favWrapper.onclick = function(e) {
        e.stopPropagation();
        toggleFavorite(favWrapper, dish.id);
      };

      title.appendChild(titleText);
      title.appendChild(favWrapper);
      card.appendChild(title);

      // --- Badges (flex)
      const badgeRow = document.createElement("div");
      badgeRow.className = "d-flex flex-wrap align-items-center gap-2";
      // Î¤ÏÏÎ± Ï„Î± badges Ï‰Ï‚ config array Î³Î¹Î± ÎµÏ…ÎµÎ»Î¹Î¾Î¯Î±:
      [
        {icon: "fa-user", text: dish.chef, className: "bg-info text-dark"},
        {icon: "fa-clock", text: (dish.total_time || "-") + "'", className: "bg-success text-white"},
        {icon: "fa-fire", text: dish.method, className: "bg-warning text-dark"},
        // {icon: "fa-tag", text: dish.ingredients, className: "bg-secondary text-white"} // uncomment Î±Î½ Ï„Î¿ Î¸ÎµÏ‚!
      ].forEach(cfg => badgeRow.appendChild(makeBadge(cfg)));
      card.appendChild(badgeRow);

      wrapper.appendChild(card);

      requestAnimationFrame(() => {
        card.classList.add("zoom-fade-in");
      });

      chat.scrollTop = chat.scrollHeight;

	  card.onclick = function(e) {
	  // ÎœÎ·Î½ Î±Î½Î¿Î¯Î³ÎµÎ¹ Ï„Î¿ modal Î±Î½ Ï€Î±Ï„Î¬Ï‚ Ï„Î·Î½ ÎºÎ±ÏÎ´Î¿ÏÎ»Î±
		  if (e.target.closest('.fa-heart')) return;
		  openRecipeModal(dish);
		};

      // â• ÎœÏŒÎ»Î¹Ï‚ Ï€ÏÎ¿ÏƒÏ„ÎµÎ¸ÎµÎ¯ ÎºÎ±Î¹ Ï„Î¿ Ï„ÎµÎ»ÎµÏ…Ï„Î±Î¯Î¿ dish, Î²Î¬Î»Îµ Ï„Î± predefined choices
      if (index === dishes.length - 1) {
        setTimeout(() => {
          renderQuickReplyOptions([
            { label: "Î˜Î± Î¼Î±Î³ÎµÎ¹ÏÎ­ÏˆÏ‰ ÎºÎ¬Ï„Î¹ Î±Ï€ÏŒ Ï„Î± Ï€Î±ÏÎ±Ï€Î¬Î½Ï‰", action: "confirm_choice" },
            { label: "Î”ÎµÎ¯Î¾Îµ Î¼Î¿Ï… ÎºÎ¬Ï„Î¹ Î¬Î»Î»Î¿", action: "more_results" }
          ]);
        }, 1000);
      }
    }, index * 1000); // <-- Î±Î½ Î¸ÎµÏ‚ Ï€Î¹Î¿ Î³ÏÎ®Î³Î¿ÏÎ±, Ï€Î±Î¯Î¾Îµ Ï„Î¿ Ï€.Ï‡. 400-600
  });
}



function getPreferredChef() {
  return localStorage.getItem("preferred_chef") || "";
}

// âœ… Call /ai_suggest_dish
function callAISuggest(userMessage = "", step) {
  const filters = {
    max_time: getMaxTime(),
    dish_category: getDishCategory(),
    main_ingredient: getMainIngredient(),
    aux_ingredient: getAuxIngredient(),
    excluded: getExcluded(),
    preferred_methods: getMethodPrefs(),
    chef: getPreferredChef()
  };

  const payload = {
    step: step,
    message: userMessage,
    ...filters
  };

  console.log("[DEBUG] ğŸš€ Sending payload to /ai_suggest_dish:", payload);

  fetch("/ai_suggest_dish", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  })
    .then(r => r.json())
    .then(data => {
      console.log("[DEBUG] ğŸ“© Suggestion response:", data);
      document.getElementById("typing-indicator")?.remove();

      if (data.success === false) {
        renderAIBubble("âš ï¸ Î¤Î¿ backend ÎµÏ€Î­ÏƒÏ„ÏÎµÏˆÎµ Î±Ï€Î¿Ï„Ï…Ï‡Î¯Î±.", "system");
        return;
      }

      if (data.message) {
        renderAIBubble(data.message);
      }

      if (data.dishes?.length) {
        renderDishCards(data.dishes);
      }

      if (!data.dishes || data.dishes.length === 0) {
        localStorage.clear();
        initLocalState();
      }
    })
    .catch(err => {
      console.error("[DEBUG] âŒ Suggestion error:", err);
      document.getElementById("typing-indicator")?.remove();
      renderAIBubble("âš ï¸ ÎšÎ¬Ï„Î¹ Ï€Î®Î³Îµ ÏƒÏ„ÏÎ±Î²Î¬ ÏƒÏ„Î·Î½ Ï€ÏÏŒÏ„Î±ÏƒÎ·.", "system");
    });
}

</script>

<!--Speech Regognition-->
<script>
function startSpeechRecognition() {
    if (!('webkitSpeechRecognition' in window)) {
      alert("ÎŸ browser ÏƒÎ¿Ï… Î´ÎµÎ½ Ï…Ï€Î¿ÏƒÏ„Î·ÏÎ¯Î¶ÎµÎ¹ Ï†Ï‰Î½Î·Ï„Î¹ÎºÎ® Î±Î½Î±Î³Î½ÏÏÎ¹ÏƒÎ·.");
      return;
    }

    const recognition = new webkitSpeechRecognition();
    recognition.lang = 'el-GR';
    recognition.continuous = false;
    recognition.interimResults = false;

    input.placeholder = "ğŸ™ï¸ Î£Îµ Î±ÎºÎ¿ÏÏ‰...";
    inputRow.classList.add("voice-active");

    recognition.onresult = function(event) {
      const transcript = event.results[0][0].transcript.trim();
      input.value = transcript;
      input.dispatchEvent(new Event("input"));
      resetInputUI();
    };

    recognition.onerror = function(event) {
      alert("Î£Ï†Î¬Î»Î¼Î± Î¼Î¹ÎºÏÎ¿Ï†ÏÎ½Î¿Ï…: " + event.error);
      resetInputUI();
    };

    recognition.onend = function() {
      resetInputUI();
    };

    recognition.start();
  }

function resetInputUI() {
    input.placeholder = originalPlaceholder;
    inputRow.classList.remove("voice-active");
  }

</script>

<!--Favorites-->
<script>
function toggleFavorite(wrapper, recipe_id) {
  fetch('/toggle_favorite_recipe', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ recipe_id: recipe_id })
  })
  .then(r => r.json())
  .then(data => {
    const isAdded = data.status === "added";

    // âœ¨ Î•Ï€Î±Î½Î±Ï†Î­ÏÎ¿Ï…Î¼Îµ Ï„Î¿ Ï€ÎµÏÎ¹ÎµÏ‡ÏŒÎ¼ÎµÎ½Î¿ Ï„Î¿Ï… wrapper
    wrapper.innerHTML = `
      <i class="${isAdded ? 'fas' : 'far'} fa-heart"
         style="color: ${isAdded ? '#c33' : 'gray'}; font-size: 18px; vertical-align: -2px; cursor: pointer;"></i>
    `;

    // âœ¨ Î¾Î±Î½Î±Î´Î­Î½Î¿Ï…Î¼Îµ Ï„Î¿ event handler ÏƒÏ„Î¿ Î½Î­Î¿ icon
    const icon = wrapper.querySelector("i");
    if (icon) {
      icon.onclick = function(e) {
        e.stopPropagation();
        toggleFavorite(wrapper, recipe_id);
      };
    } else {
      console.warn("âš ï¸ Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ icon Î³Î¹Î± dish id:", recipe_id);
    }
  });
}
</script>

{% endblock %}
