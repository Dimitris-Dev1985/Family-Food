{% extends "base.html" %}
{% block title %}Î¤Î¹ Î¸Î± Ï†Î¬Î¼Îµ ÏƒÎ®Î¼ÎµÏÎ±;{% endblock %}
{% block content %}

<style>
  :root {
    --brand: #218e46;
    --brand-hover: #1a6e38;
    --text: #1b1b1b;
    --surface: #fffaf5;
    --outline: #ddd;
    --input-bg: #ffffff;
    --input-bg-focus: #f0fff4;
    --voice-bg: #ffebee;
    --voice-color: #c62828;
  }

  body {
    margin: 0;
    padding: 0;
    background-color: var(--surface);
    font-family: 'Roboto', sans-serif;
  }

  .chat-screen {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    padding: 24px 16px;
    min-height: 100dvh;
    box-sizing: border-box;
    gap: 16px;
    background-color: var(--surface);
  }

  .logo {
    width: 72px;
    height: 72px;
    border-radius: 16px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.08);
  }

  .chat-intro {
    font-size: 1.3rem;
    font-weight: 600;
    color: var(--brand);
    text-align: center;
    max-width: 320px;
    margin-top: 8px;
  }

  .chatbox {
    width: 100%;
    max-width: 480px;
    background-color: white;
    border-radius: 16px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 12px;
    overflow-y: auto;
    max-height: 60dvh;
  }

  .chat-bubble {
    padding: 10px 14px;
    border-radius: 16px;
    font-size: 0.95rem;
    line-height: 1.4;
    max-width: 75%;
    animation: fadeIn 0.4s ease-out;
    word-break: break-word;
    white-space: pre-wrap;
  }

  .from-ai {
    background-color: #eafbe7;
    color: var(--brand);
    align-self: flex-start;
  }

  .from-user {
    background-color: #d4eaf7;
    color: #0d5584;
    align-self: flex-end;
  }

  .typing-indicator {
    font-style: italic;
    color: #999;
    font-size: 0.9rem;
    align-self: flex-start;
    margin-top: 2px;
  }

  .quick-replies {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 8px;
  }

  .quick-reply {
    background-color: #f0f0f0;
    color: #333;
    padding: 6px 12px;
    border-radius: 20px;
    border: 1px solid #ccc;
    font-size: 0.9rem;
    cursor: pointer;
    transition: background-color 0.2s ease;
  }

  .quick-reply:hover {
    background-color: #e0e0e0;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .chat-input-row {
    display: flex;
    gap: 8px;
    width: 100%;
    max-width: 480px;
    align-items: center;
    position: relative;
  }

  .chat-input-row textarea {
    flex: 1;
    padding: 10px 14px;
    border-radius: 12px;
    border: 1.5px solid var(--outline);
    font-size: 1rem;
    padding-right: 72px;
    resize: none;
    min-height: 44px;
    max-height: 120px;
    overflow-y: auto;
    background-color: var(--input-bg);
    transition: background-color 0.2s ease;
  }

  .chat-input-row textarea:focus {
    background-color: var(--input-bg-focus);
    outline: none;
  }

  .chat-input-row.voice-active textarea {
    background-color: var(--voice-bg);
    color: var(--voice-color);
    font-weight: 500;
  }

  .chat-input-row button {
    border: none;
    background: none;
    cursor: pointer;
    padding: 0 8px;
  }

  .mui-icon {
    font-size: 24px;
    color: var(--brand);
  }
  .mui-icon:hover {
    color: var(--brand-hover);
  }
</style>

<style>
  .dish-cards-wrapper {
    display: flex;
    flex-direction: column;
    padding: 12px 0;
	flex-wrap: wrap;
    gap: 1rem;
    justify-content: flex-start;
  }

  .mui-card {
    border-radius: 16px;
    padding: 16px;
    background: #fff;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    font-size: 0.9rem;
	transition: box-shadow 0.3s ease-in-out;
  }

  .mui-card:hover {
	box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }
  
  .mui-card h4 {
    margin: 0 0 6px;
    font-size: 1.1rem;
    color: #2e7d32;
  }

  .mui-card .icon {
    margin-right: 6px;
    color: #555;
  }

  .mui-card p {
    margin: 4px 0;
  }
  
  .dish-card {
  background-color: var(--input-bg);
  border: 1px solid var(--outline);
  border-radius: 12px;
  padding: 10px 14px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.04);
  font-size: 0.92rem;
  display: flex;
  flex-direction: column;
  gap: 6px;
  animation: fadeIn 0.3s ease-out;
}

.dish-title {
  font-weight: 500;
  color: var(--text);
}

.dish-time {
  color: #777;
  font-size: 0.85rem;
}

.dish-link {
  font-size: 0.85rem;
  font-weight: 500;
  background-color: var(--brand);
  color: white;
  padding: 6px 12px;
  border-radius: 8px;
  text-decoration: none;
  white-space: nowrap;
  transition: background-color 0.2s ease;
}

.dish-link:hover {
  background-color: var(--brand-hover);
}


</style>

<style>
.badge {
  margin-left: 0px!important;
  font-size: 0.8rem;
  font-weight: 500;
  padding: 4px 10px;
  border-radius: 20px;
  white-space: nowrap;
}

.dish-card a.btn {
  padding: 6px 12px;
  font-size: 0.85rem;
  font-weight: 500;
  white-space: nowrap;
}
</style>

<div class="chat-screen">
  <img src="{{ url_for('static', filename='image.png') }}" alt="Logo" class="logo">
  <div class="chat-intro">
    ÎšÎ±Î»ÏÏ‚ Î®ÏÎ¸ÎµÏ‚ {{ user_name or '' }}! ğŸ‘‹<br>
    Î Î¬Î¼Îµ Î½Î± Î²ÏÎ¿ÏÎ¼Îµ Ï„Î¹ Î¸Î± Î¼Î±Î³ÎµÎ¹ÏÎ­ÏˆÎ¿Ï…Î¼Îµ;
  </div>

  <div class="chatbox" id="chatbox">
    <div class="chat-bubble from-ai">ğŸ‘©â€ğŸ³ Î ÏŒÏƒÎ¿ Ï€ÎµÏÎ¯Ï€Î¿Ï… Ï‡ÏÏŒÎ½Î¿ Î­Ï‡ÎµÎ¹Ï‚ Î³Î¹Î± Î¼Î±Î³ÎµÎ¯ÏÎµÎ¼Î±;</div>
    <div class="quick-replies">
      <div class="quick-reply" onclick="handlePredefinedChoice('time','Î•Ï‰Ï‚ 30'')">Î•Ï‰Ï‚ 30'</div>
      <div class="quick-reply" onclick="handlePredefinedChoice('time','ÎˆÏ‰Ï‚ 1 ÏÏÎ±')">ÎˆÏ‰Ï‚ 1 ÏÏÎ±</div>
      <div class="quick-reply" onclick="handlePredefinedChoice('time','Î Î¬Î½Ï‰ Î±Ï€ÏŒ 1,5 ÏÏÎ±')">Î Î¬Î½Ï‰ Î±Ï€ÏŒ 1,5 ÏÏÎ±</div>
    </div>
  </div>

  <div class="chat-input-row" id="chatInputRow">
    <textarea id="userInput" placeholder="Î Î»Î·ÎºÏ„ÏÎ¿Î»ÏŒÎ³Î·ÏƒÎµ ÎµÎ´Ï..."></textarea>
    <button onclick="sendMessage()">
      <span class="material-icons mui-icon">send</span>
    </button>
    <button onclick="startSpeechRecognition()">
      <span class="material-icons mui-icon">mic</span>
    </button>
  </div>
</div>

<!--
{% if session.pop('login_success', None) %}
  <script type="module">
    import { trackLoginSuccess } from "{{ url_for('static', filename='js/analytics-events.js') }}";
    trackLoginSuccess('email');
  </script>
{% endif %}
-->

{% endblock %}


{% block scripts %}

<script src="/static/js/utils.js"></script>

<script>
// âœ… CLEAR STATE ON PAGE LOAD
window.addEventListener("DOMContentLoaded", () => {
  console.log("[DEBUG] ğŸ”¥ Î Î»Î®ÏÎ·Ï‚ ÎºÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚ localStorage");
  localStorage.clear();
  initLocalState();
});

const input = document.getElementById("userInput");
const inputRow = document.getElementById("chatInputRow");
const originalPlaceholder = input.placeholder;
			  
input.addEventListener("keydown", function(e) {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
});

input.addEventListener("input", function() {
  input.style.height = "auto";
  input.style.height = input.scrollHeight + "px";
});
</script>

<script>
// âœ… Initialize filters on page load
function initLocalState() {
  if (!localStorage.getItem(StorageKeys.METHOD_PREFS)) setMethodPrefs(getMethodPrefs());
  if (!localStorage.getItem(StorageKeys.EXCLUDED)) setExcluded([]);
  if (!localStorage.getItem(StorageKeys.MAX_TIME)) setMaxTime(0);
  if (!localStorage.getItem(StorageKeys.MAIN_INGREDIENT)) setMainIngredient("");
  console.log("[DEBUG] ğŸŒ± Local state initialized");
}

// âœ… Time mapping helper
function mapTimeLabelToMinutes(label) {
  const map = {
    "Î•Ï‰Ï‚ 30'": 30,
    "ÎˆÏ‰Ï‚ 1 ÏÏÎ±": 60,
    "Î Î¬Î½Ï‰ Î±Ï€ÏŒ 1,5 ÏÏÎ±": 200
  };
  return map[label] || 90;
}

function sendMessage() {
  const msg = input.value.trim();
  if (!msg) return;

  handleFreeUserMessage(msg);  // ğŸ‘ˆ Î±Ï†Î±Î¹ÏÎ­Î¸Î·ÎºÎµ Ï„Î¿ renderUserBubble
  input.value = "";
  input.placeholder = originalPlaceholder;
  input.style.height = "auto";
}

// âœ… Main functions
function renderUserBubble(text) {
  const chat = document.getElementById("chatbox");
  const userBubble = document.createElement("div");
  userBubble.className = "chat-bubble from-user";
  userBubble.textContent = text;
  chat.appendChild(userBubble);
  chat.scrollTop = chat.scrollHeight;

  const typing = document.createElement("div");
  typing.className = "typing-indicator";
  typing.textContent = "Family Food Ï€Î»Î·ÎºÏ„ÏÎ¿Î»Î¿Î³ÎµÎ¯...";
  typing.id = "typing-indicator";
  chat.appendChild(typing);
  chat.scrollTop = chat.scrollHeight;
}

function handlePredefinedChoice(type, value) {
  renderUserBubble(value);

  if (type === "time") {
    setMaxTime(mapTimeLabelToMinutes(value));
  }

  if (type === "exclude_method") {
    setMethodPrefs(getMethodPrefs().filter(m => m !== value.trim()));
  }

  if (type === "exclude_ingredient") {
    setExcluded([...getExcluded(), value.toLowerCase()]);
  }

  const maxTime = getMaxTime();
  const mainIngredient = getMainIngredient();

  if (maxTime > 0 && mainIngredient) {
    handleAISuggestionV2({
      max_time: maxTime,
      main_ingredient: mainIngredient,
      preferredMethod: getMethodPrefs(),
      excluded: getExcluded(),
      chef: getPreferredChef()
    });
  } 
  else if (maxTime > 0 && !mainIngredient && type === "time") {
    document.getElementById("typing-indicator")?.remove();
    renderAIBubble("Î¤Î­Î»ÎµÎ¹Î±! ÎˆÏ‡ÎµÎ¹Ï‚ ÎºÎ¬Ï€Î¿Î¹Î¿ Î²Î±ÏƒÎ¹ÎºÏŒ Ï…Î»Î¹ÎºÏŒ ÏƒÏ„Î¿ Î¼Ï…Î±Î»ÏŒ ÏƒÎ¿Ï…; ğŸ…ğŸ¥©ğŸŸ Î‘Î½ ÏŒÏ‡Î¹ Î´Îµ Ï€ÎµÎ¹ÏÎ±Î¶ÎµÎ¹, Î¸Î± Î²ÏÎ¿ÏÎ¼Îµ Î¼Î±Î¶Î¯ ÎºÎ¬Ï„Î¹!", "system");
  }
}

function handleFreeUserMessage(text) {
  renderUserBubble(text);
  console.log("[DEBUG] ğŸ“¤ Calling /ai_reply with:", {
    message: text,
    time: getMaxTime(),
    ingredient: getMainIngredient()
  });

  fetch("/ai_reply", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      message: text,
      time: getMaxTime(),
      ingredient: getMainIngredient()
    })
  })
    .then(r => r.json())
    .then(data => {
      document.getElementById("typing-indicator")?.remove();

      if (data.logout) {
        renderAIBubble("Î— ÏƒÏ…Î½ÎµÎ´ÏÎ¯Î± Ï„ÎµÏÎ¼Î±Ï„Î¯ÏƒÏ„Î·ÎºÎµ Î³Î¹Î± Î»ÏŒÎ³Î¿Ï…Ï‚ Î±ÏƒÏ†Î±Î»ÎµÎ¯Î±Ï‚.", "system");
        return setTimeout(() => (window.location.href = "/logout"), 2000);
      }

      let suggestionTriggered = false; // ğŸ‘ˆ flag

      if (data.filters) {
        if (data.filters.max_time) {
          setMaxTime(parseInt(data.filters.max_time, 10));
        }
        if (data.filters.main_ingredient) {
          setMainIngredient(data.filters.main_ingredient);
        }
        if (data.filters.cooking_method) {
          setMethodPrefs(data.filters.cooking_method.split(",").map(m => m.trim()));
        }
        if (data.filters.exclude_keywords) {
          setExcluded(data.filters.exclude_keywords);
        }

        const maxTime = getMaxTime();
        const mainIngredient = getMainIngredient();

        if (maxTime > 0 && mainIngredient) {
          handleAISuggestionV2({
            max_time: maxTime,
            ingredient: mainIngredient, // ğŸ‘‰ Ï€Î±ÏÎ±Î¼Î­Î½ÎµÎ¹ ÏŒÏ€Ï‰Ï‚ Ï„Î¿ Î­Ï‡ÎµÎ¹Ï‚
            preferredMethod: getMethodPrefs(),
            excluded: getExcluded(),
            chef: getPreferredChef()
          });
          suggestionTriggered = true;
        }
      }

      // âœ… Î´ÎµÎ¯Ï‡Î½Î¿Ï…Î¼Îµ Ï„Î¿ reply Î¼ÏŒÎ½Î¿ Î±Î½ Î´ÎµÎ½ Î­Î³Î¹Î½Îµ Ï€ÏÏŒÏ„Î±ÏƒÎ·
      if (!suggestionTriggered && data.reply) {
        renderAIBubble(data.reply);
      }
    })
    .catch(err => {
      console.error("[DEBUG] âŒ AI error:", err);
      document.getElementById("typing-indicator")?.remove();
      renderAIBubble("âš ï¸ ÎšÎ¬Ï„Î¹ Ï€Î®Î³Îµ ÏƒÏ„ÏÎ±Î²Î¬. Î ÏÎ¿ÏƒÏ€Î¬Î¸Î·ÏƒÎµ Î¾Î±Î½Î¬.", "system");
    });
}

function handleAISuggestionV2({ max_time, ingredient, preferredMethod, excluded, chef }) {
  console.log("[DEBUG] ğŸš€ Calling /ai_suggest_dish with:", {
    max_time, ingredient, preferredMethod, excluded, chef
  });

  fetch("/ai_suggest_dish", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      step: 3,
      filters: {
        max_time,
        main_ingredient: ingredient,
        excluded: excluded,
		preferredMethod: preferredMethod,
        chef: chef
      }
    })
  })
    .then(r => r.json())
    .then(data => {
      document.getElementById("typing-indicator")?.remove();

      // âœ… ÎœÎŸÎÎŸ Ï„Î¿ Î¼Î®Î½Ï…Î¼Î± Ï€Î¿Ï… Î­ÏÏ‡ÎµÏ„Î±Î¹ Î±Ï€ÏŒ Ï„Î¿ backend
      if (data.message) {
        renderAIBubble(data.message);
      }

      if (data.dishes?.length) {
        renderDishCards(data.dishes);
      }
    })
    .catch(err => {
      console.error("[DEBUG] âŒ Suggestion error:", err);
      document.getElementById("typing-indicator")?.remove();
      renderAIBubble("âš ï¸ ÎšÎ¬Ï„Î¹ Ï€Î®Î³Îµ ÏƒÏ„ÏÎ±Î²Î¬ ÏƒÏ„Î·Î½ Ï€ÏÏŒÏ„Î±ÏƒÎ·.", "system");
    });
}

function renderAIBubble(text, type = "ai") {
  const chat = document.getElementById("chatbox");
  const bubble = document.createElement("div");
  bubble.className = "chat-bubble from-ai";
  bubble.innerHTML = `<span class="chat-icon">${type === "system" ? "ğŸ‘¨â€ğŸ³" : "ğŸ§ "}</span><span>${text}</span>`;
  chat.appendChild(bubble);
  chat.scrollTop = chat.scrollHeight;
}

function renderDishCards(dishes = []) {
  const chat = document.getElementById("chatbox");

  const wrapper = document.createElement("div");
  wrapper.className = "dish-cards-wrapper d-flex flex-column gap-2 mt-2";

  dishes.forEach(dish => {
    const card = document.createElement("div");
    card.className = "dish-card p-3";
    card.style.border = "1px solid var(--outline)";
    card.style.borderRadius = "12px";
    card.style.backgroundColor = "var(--input-bg)";
    card.style.boxShadow = "0 1px 4px rgba(0,0,0,0.04)";
    card.style.fontSize = "0.95rem";
    card.style.display = "flex";
    card.style.flexDirection = "column";
    card.style.gap = "8px";

    const title = document.createElement("div");
    title.className = "d-flex align-items-center";
    title.style.gap = "8px";

    const titleText = document.createElement("span");
    titleText.textContent = dish.title;
    titleText.style.fontWeight = "600";
    titleText.style.fontSize = "1.1rem";
    titleText.style.color = "var(--text)";
    titleText.style.lineHeight = "1.2";

    const favWrapper = document.createElement("span");
    favWrapper.style.cursor = "pointer";

    favWrapper.innerHTML = `
      <i class="${dish.favorite ? 'fas' : 'far'} fa-heart"
         style="color: ${dish.favorite ? '#c33' : 'gray'}; font-size: 18px; vertical-align: -2px;"></i>
    `;

    favWrapper.onclick = function(e) {
      e.stopPropagation();
      toggleFavorite(favWrapper, dish.id); 
    };

    title.appendChild(titleText);
    title.appendChild(favWrapper);
    card.appendChild(title);

    const badgeRow = document.createElement("div");
    badgeRow.className = "d-flex flex-wrap align-items-center gap-2";

    const badgeChef = document.createElement("span");
    badgeChef.className = "badge bg-info text-dark";
    badgeChef.innerHTML = `<i class="fa fa-user"></i> ${dish.chef || "-"}`;

    const badgeTime = document.createElement("span");
    badgeTime.className = "badge bg-success text-white";
    badgeTime.innerHTML = `<i class="fa fa-clock"></i> ${dish.total_time || "-"}'`;

    const badgeMethod = document.createElement("span");
    badgeMethod.className = "badge bg-warning text-dark";
    badgeMethod.innerHTML = `<i class="fa fa-fire"></i> ${dish.method || "-"}`;

    const badgeTag = document.createElement("span");
    badgeTag.className = "badge bg-secondary text-white";
    badgeTag.innerHTML = `<i class="fa fa-tag"></i> ${dish.tags || "-"}`;

    badgeRow.appendChild(badgeChef);
    badgeRow.appendChild(badgeTime);
    badgeRow.appendChild(badgeMethod);
    badgeRow.appendChild(badgeTag);
    card.appendChild(badgeRow);

    const linkRow = document.createElement("div");
    linkRow.style.marginTop = "4px";

    const link = document.createElement("a");
    link.href = dish.link;
    link.target = "_blank";
    link.className = "dish-link";
    link.textContent = "Î”ÎµÏ‚ Ï„Î· ÏƒÏ…Î½Ï„Î±Î³Î® âœ";

    // linkRow.appendChild(link);

    card.appendChild(linkRow);
    wrapper.appendChild(card);
  });
	
  chat.appendChild(wrapper);

  const quickReplies = document.createElement("div");
  quickReplies.className = "quick-replies mt-2";

  const btn1 = document.createElement("button");
  btn1.className = "quick-reply";
  btn1.textContent = "Î˜Î± Î¼Î±Î³ÎµÎ¹ÏÎ­ÏˆÏ‰ ÎºÎ¬Ï„Î¹ Î±Ï€ÏŒ Ï„Î± Ï€Î±ÏÎ±Ï€Î¬Î½Ï‰";
  btn1.onclick = function () {
    quickReplies.remove();
    renderUserBubble("Î˜Î± Î¼Î±Î³ÎµÎ¹ÏÎ­ÏˆÏ‰ ÎºÎ¬Ï„Î¹ Î±Ï€ÏŒ Ï„Î± Ï€Î±ÏÎ±Ï€Î¬Î½Ï‰");
    document.getElementById("typing-indicator")?.remove();
  };

  const btn2 = document.createElement("button");
  btn2.className = "quick-reply";
  btn2.textContent = "Î”ÎµÎ¯Î¾Îµ Î¼Î¿Ï… ÎºÎ¬Ï„Î¹ Î¬Î»Î»Î¿";
  btn2.onclick = function () {
    quickReplies.remove();
    const chat = document.getElementById("chatbox");
    const userBubble = document.createElement("div");
    userBubble.className = "chat-bubble from-user";
    userBubble.textContent = "Î”ÎµÎ¯Î¾Îµ Î¼Î¿Ï… ÎºÎ¬Ï„Î¹ Î¬Î»Î»Î¿";
    chat.appendChild(userBubble);
    document.getElementById("typing-indicator")?.remove();
    renderAIBubble("Î ÎµÏ‚ Î¼Î¿Ï… Ï„Î¹ Î¸Î± Î®Î¸ÎµÎ»ÎµÏ‚ Î½Î± Î±Î»Î»Î¬Î¾Î¿Ï…Î¼Îµ ÏƒÏ„Î± Ï…Î»Î¹ÎºÎ¬, ÏƒÏ„Î¿ Ï‡ÏÏŒÎ½Î¿, Î® ÏƒÎµ Î¿Ï„Î¹Î´Î®Ï€Î¿Ï„Îµ Î¬Î»Î»Î¿!","system");
  };

  quickReplies.appendChild(btn1);
  quickReplies.appendChild(btn2);
  chat.appendChild(quickReplies);
  chat.scrollTop = chat.scrollHeight;
}

function getPreferredChef() {
  return localStorage.getItem("preferred_chef") || "";
}
</script>

<!--Speech Regognition-->
<script>
function startSpeechRecognition() {
    if (!('webkitSpeechRecognition' in window)) {
      alert("ÎŸ browser ÏƒÎ¿Ï… Î´ÎµÎ½ Ï…Ï€Î¿ÏƒÏ„Î·ÏÎ¯Î¶ÎµÎ¹ Ï†Ï‰Î½Î·Ï„Î¹ÎºÎ® Î±Î½Î±Î³Î½ÏÏÎ¹ÏƒÎ·.");
      return;
    }

    const recognition = new webkitSpeechRecognition();
    recognition.lang = 'el-GR';
    recognition.continuous = false;
    recognition.interimResults = false;

    input.placeholder = "ğŸ™ï¸ Î£Îµ Î±ÎºÎ¿ÏÏ‰...";
    inputRow.classList.add("voice-active");

    recognition.onresult = function(event) {
      const transcript = event.results[0][0].transcript.trim();
      input.value = transcript;
      input.dispatchEvent(new Event("input"));
      resetInputUI();
    };

    recognition.onerror = function(event) {
      alert("Î£Ï†Î¬Î»Î¼Î± Î¼Î¹ÎºÏÎ¿Ï†ÏÎ½Î¿Ï…: " + event.error);
      resetInputUI();
    };

    recognition.onend = function() {
      resetInputUI();
    };

    recognition.start();
  }

function resetInputUI() {
    input.placeholder = originalPlaceholder;
    inputRow.classList.remove("voice-active");
  }

</script>

<!--Favorites-->
<script>
function toggleFavorite(wrapper, recipe_id) {
  fetch('/toggle_favorite_recipe', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ recipe_id: recipe_id })
  })
  .then(r => r.json())
  .then(data => {
    const isAdded = data.status === "added";

    // âœ¨ Î•Ï€Î±Î½Î±Ï†Î­ÏÎ¿Ï…Î¼Îµ Ï„Î¿ Ï€ÎµÏÎ¹ÎµÏ‡ÏŒÎ¼ÎµÎ½Î¿ Ï„Î¿Ï… wrapper
    wrapper.innerHTML = `
      <i class="${isAdded ? 'fas' : 'far'} fa-heart"
         style="color: ${isAdded ? '#c33' : 'gray'}; font-size: 18px; vertical-align: -2px; cursor: pointer;"></i>
    `;

    // âœ¨ Î¾Î±Î½Î±Î´Î­Î½Î¿Ï…Î¼Îµ Ï„Î¿ event handler ÏƒÏ„Î¿ Î½Î­Î¿ icon
    const icon = wrapper.querySelector("i");
    if (icon) {
      icon.onclick = function(e) {
        e.stopPropagation();
        toggleFavorite(wrapper, recipe_id);
      };
    } else {
      console.warn("âš ï¸ Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ icon Î³Î¹Î± dish id:", recipe_id);
    }
  });
}
</script>

{% endblock %}
