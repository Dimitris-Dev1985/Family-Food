{% extends "base.html" %}
{% block title %}Œ§Œπ Œ∏Œ± œÜŒ¨ŒºŒµ œÉŒÆŒºŒµœÅŒ±;{% endblock %}
{% block content %}


<!-- =================== Topbar =================== -->
<style>
  .recipe-topbar {
    position: sticky; top: 0; left: 0; right: 0; z-index: 99;
    background: #fff;
    border-bottom: 1.5px solid var(--outline);
    min-height: 54px; height: 54px;
    display: flex; align-items: center; justify-content: space-between;
    padding: 0 10px 0 6px;
    box-shadow: 0 1px 8px rgba(33,142,70,0.05);
    transition: box-shadow 0.16s;
  }
  .recipe-topbar .icon-btn {
    width: 38px; height: 38px;
    border-radius: 50%; border: none;
    display: flex; align-items: center; justify-content: center;
    margin: 0; cursor: pointer;
    background: none; color: var(--brand);
    font-size: 1.32rem;
    transition: background 0.13s;
  }
  .recipe-topbar .icon-btn:active { background: #f4f4f4; }
  .topbar-title {
    flex: 1;
    margin-left: 7px;
    font-size: 1.2rem; font-weight: 700;
    color: var(--text);
    letter-spacing: -0.2px;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    text-align: left;
  }
  .topbar-actions { display: flex; align-items: center; gap: 7px; }
</style>

<!-- =================== Hero =================== -->
<style>
  .recipe-hero {
    position: relative; z-index: 1;
    width: 100vw; max-width: 600px; margin: 0 auto;
    aspect-ratio: 1.1/1;
    border-bottom-left-radius: 2.2rem; border-bottom-right-radius: 2.2rem;
    background: #eee; overflow: hidden;
    display: flex; align-items: flex-end; justify-content: center;
    transition: height 0.4s;
  }
  .recipe-hero img {
    width: 100%; height: 100%; min-height: 220px;
    object-fit: cover;
    border-bottom-left-radius: 2.2rem; border-bottom-right-radius: 2.2rem;
  }
</style>

<!-- =================== Chat Card =================== -->
<style>
  .chatbox-card {
    position: relative; z-index: 2;
    max-width: 560px;
    margin: auto auto 22px auto;
    padding: 20px 12px 13px;
    border-radius: 20px;
	min-height: 250px !important;
    height: auto !important;
    background: #fff;
    display: flex; flex-direction: column; align-items: stretch; gap: 14px;
    box-shadow: var(--shadow), 0 10px 40px rgba(33,142,70,0.15);
    transition: box-shadow 0.16s, margin-top 0.33s cubic-bezier(.4,2,.6,1);
  }
  .chatbox-card.cover-hero {
    position: fixed; left: 0; right: 0; bottom: 0; z-index: 22;
    max-width: 560px; max-height: 75vh;
    display: flex; flex-direction: column; overflow-y: auto !important; overflow-x: hidden;
    box-shadow: 0 8px 32px rgba(33,142,70,0.14);
  }
  .chat-intro {
    margin: 0 0 0 0;
    padding-bottom: 2px;
    font-size: 1.85rem; font-weight: 600;
    color: var(--brand-hover);
    text-align: center;
  }
  .chatbox {
    flex: 1 1 auto;
    width: 100%;
    display: flex; flex-direction: column; gap: 12px;
    background: none; border-radius: 0; box-shadow: none; padding: 0;
    height: auto !important;
    max-height: none !important;
    padding-bottom: 12px !important;
  }
</style>

<!-- =================== Chat Bubbles =================== -->
<style>
  .chatbox {
    display: flex;
    flex-direction: column;
    gap: 12px;
    padding: 10px 0 10px 0;
  }
  .chat-bubble {
    align-items: flex-start;
    max-width: 76%;
    padding: 12px 16px;
    border-radius: 20px;
    font-size: 1.1rem;
    line-height: 1.5;
    box-shadow: 0 2px 8px rgba(0,0,0,0.03);
    word-break: break-word;
    white-space: pre-wrap;
    position: relative;
    margin-bottom: 1px;
    margin-top: 0;
    animation: fadeIn 0.3s;
  }
  .from-ai {
    align-self: flex-start;
    background: #cff7c8;
    color: var(--brand-hover);
    margin-right: auto;
    border-top-left-radius: 0px;
    border-top-right-radius: 18px;
    border-bottom-right-radius: 18px;
    border-bottom-left-radius: 18px;
  }
  .from-user {
    align-self: flex-end;
    background: #e5f1fa;
    color: #195885;
    margin-left: auto;
    border-top-left-radius: 18px;
    border-top-right-radius: 0px;
    border-bottom-right-radius: 18px;
    border-bottom-left-radius: 18px;
  }
  .chat-bubble .bubble-icon {
    margin-right: 7px;
    font-size: 1.15em;
    line-height: 1;
    flex-shrink: 0;
    margin-top: 1px;
  }
  .from-user .bubble-icon {
    margin-left: 7px;
    margin-right: 0;
    order: 2;
  }
  .typing-indicator {
    align-self: flex-start;
    margin-left: 20px;
    font-size: 0.97rem;
    font-style: italic;
    color: #999;
  }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(14px);}
    to   { opacity: 1; transform: translateY(0);}
  }
</style>

<!-- =================== Quick Replies =================== -->
<style>
  .quick-replies {
    display: flex; flex-wrap: wrap; gap: 8px;
    margin-top: 2px;
    justify-content: flex-start;
    font-weight: 500; letter-spacing: 0.3px;
    transition: min-height 0.22s;
  }
  .quick-reply {
    padding: 7px 16px;
    border-radius: 24px; border: none;
    font-size: 1.1rem; font-weight: 500;
    white-space: nowrap; cursor: pointer;
    background: var(--surface); color: var(--brand-hover);
    box-shadow: 0 1px 4px rgba(33,142,70,0.04);
    opacity: 0; visibility: visible;
    transition: all 0.19s;
    animation: fadeInQuickReply 0.5s cubic-bezier(.41,1.12,.62,1.09) forwards;
    animation-delay: var(--delay, 200ms);
  }
  .quick-reply:hover {
    background: #daf6e5;
    box-shadow: 0 1px 6px rgba(33,142,70,0.09);
  }
  @keyframes fadeInQuickReply {
    to { opacity: 1; transform: translateY(0) scale(1); }
  }
</style>

<!-- =================== Input Row =================== -->
<style>
  .chat-input-row {
    display: flex; align-items: center; gap: 8px;
    width: 100%; max-width: 100%;
    margin: 0; padding: 10px 12px 7px;
    border-radius: 20px; z-index: 10;
    background: #fff;
    border-top: 1.5px solid var(--outline);
    box-shadow: 0 2px 14px rgba(33,142,70,0.07);
  }
  .chat-input-row textarea {
    flex: 1;
    min-height: 44px; max-height: 120px;
    padding: 0 20px 0 10px;
    border: 1.5px solid var(--outline); border-radius: 20px;
    font-size: 0.9rem; resize: none;
    background: var(--input-bg);
    overflow-y: auto;
    transition: background-color 0.2s;
	align-content: center;
  }
  .chat-input-row textarea:focus {
    outline: none;
    background: var(--input-bg-focus);
  }
  .chat-input-row.voice-active textarea {
    background: var(--voice-bg); color: var(--voice-color);
    font-weight: 500;
  }
  .chat-input-row button {
    border: none; background: none; cursor: pointer; padding-top: inherit;
  }
  .mui-icon { font-size: 26px; color: var(--brand); }
  .mui-icon:hover { color: var(--brand-hover); }
</style>

<!-- =================== Animations =================== -->
<style>
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>

<!-- =================== Responsive =================== -->
<style>
  @media (max-width: 600px) {
    .recipe-hero { max-width: 100vw; border-radius: 0 0 18px 18px; }
    .recipe-hero img { border-radius: 0 0 18px 18px; }
    .chatbox-card { margin-left: 2vw; margin-right: 2vw; }
    .dish-cards-wrapper, .chat-input-row { margin-left: 2vw; margin-right: 2vw; }
  }
</style>



<body style="min-height:100vh; display:flex; flex-direction:column;">

  <div class="recipe-topbar" id="topBar">
    <button class="icon-btn" title="ŒúŒµŒΩŒøœç" onclick="window.location='/profile'"><i class="fa fa-bars"></i></button>
    <div class="topbar-title">Œ§Œπ Œ∏Œ± œÜŒ¨ŒºŒµ œÉŒÆŒºŒµœÅŒ±;</div>
    <div class="topbar-actions">
      <button class="icon-btn" title="Œ†œÅŒøœÜŒØŒª" onclick="window.location='/profile'"><i class="fa fa-user"></i></button>
    </div>
  </div>

  <div class="recipe-hero">
    <img src="{{ url_for('static', filename='main_hero_1.jpg') }}" alt="Featured Food">
  </div>

  <div class="chatbox-card">
    <div class="chat-intro">
        Œ†Œ¨ŒºŒµ ŒΩŒ± Œ≤œÅŒøœçŒºŒµ œÑŒπ Œ∏Œ± ŒºŒ±Œ≥ŒµŒπœÅŒ≠œàŒøœÖŒºŒµ;<br>
      </div>
	<div class="chatbox" id="chatbox">
	  <div class="chat-bubble from-ai">üë©‚Äçüç≥ Œ†ŒµœÅŒØœÄŒøœÖ œÄœåœÉŒø œáœÅœåŒΩŒø Œ≠œáŒµŒπœÇ Œ≥ŒπŒ± ŒºŒ±Œ≥ŒµŒØœÅŒµŒºŒ±;</div>
	</div>
    <div class="chat-input-row" id="chatInputRow">
        <textarea id="userInput" placeholder="Œ†ŒµœÇ ŒºŒøœÖ œÑŒπ œÉŒ∫Œ≠œÜœÑŒµœÉŒ±Œπ..."></textarea>
        <button onclick="sendMessage()">
          <span class="material-icons mui-icon">send</span>
        </button>
        <button onclick="startSpeechRecognition()">
          <span class="material-icons mui-icon">mic</span>
        </button>
      </div>
    </div>

</body>



{% endblock %}


{% block scripts %}

<script>


const StorageKeys = {
  MAX_TIME: "max_time",
  DISH_CATEGORY: "dish_category",
  MAIN_INGREDIENT: "main_ingredient",
  METHOD_PREFS: "method_prefs",
  EXCLUDED: "excluded",
  AUX_INGREDIENTS: "aux_ingredients"
};
function setStorageItem(key, value) { try { localStorage.setItem(key, JSON.stringify(value)); } catch (e) {} }
function getStorageItem(key, fallback = null) { try { const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : fallback; } catch (e) { return fallback; } }
function setMaxTime(minutes) { setStorageItem(StorageKeys.MAX_TIME, String(minutes)); }
function getMaxTime() { return getStorageItem(StorageKeys.MAX_TIME, "30"); }
function setDishCategory(DishCategory) { setStorageItem(StorageKeys.DISH_CATEGORY, DishCategory); }
function getDishCategory() { return getStorageItem(StorageKeys.DISH_CATEGORY, null); }
function setMainIngredient(ingredient) { setStorageItem(StorageKeys.MAIN_INGREDIENT, ingredient); }
function getMainIngredient() { return getStorageItem(StorageKeys.MAIN_INGREDIENT, null); }
function setMethodPrefs(methodsArray) { setStorageItem(StorageKeys.METHOD_PREFS, methodsArray); }
function getMethodPrefs() { return getStorageItem(StorageKeys.METHOD_PREFS, [ 'Œ¶ŒøœçœÅŒΩŒøœÇ', 'ŒöŒ±œÑœÉŒ±œÅœåŒªŒ±', 'ŒßœçœÑœÅŒ±', 'Œ§Œ∑Œ≥Œ¨ŒΩŒπ', 'Œ£œáŒ¨œÅŒ±', 'Air-fryer' ]); }
function setExcluded(excludesArray) { setStorageItem(StorageKeys.EXCLUDED, excludesArray); }
function getExcluded() { return getStorageItem(StorageKeys.EXCLUDED, []); }
function setAuxIngredient(auxArray) { setStorageItem(StorageKeys.AUX_INGREDIENTS, auxArray); }
function getAuxIngredient() { return getStorageItem(StorageKeys.AUX_INGREDIENTS, []); }
function clearCookingFilters() { Object.values(StorageKeys).forEach(k => localStorage.removeItem(k)); }

const input = document.getElementById("userInput");
const inputRow = document.getElementById("chatInputRow");
const originalPlaceholder = input.placeholder;
const DISH_CATEGORIES = ["Brunch","Leftovers","Vegan","ŒñœÖŒºŒ±œÅŒπŒ∫Œ¨","ŒòŒ±ŒªŒ±œÉœÉŒπŒΩŒ¨","ŒöœåŒ∫Œ∫ŒπŒΩŒø Œ∫œÅŒ≠Œ±œÇ","ŒõŒ±Œ¥ŒµœÅŒ¨","ŒåœÉœÄœÅŒπŒ±","Œ†Œ±œÅŒ±Œ¥ŒøœÉŒπŒ±Œ∫Œ¨","Œ†ŒØœÑŒµœÇ","Œ†ŒØœÑœÉŒ±","Œ†ŒøœÖŒªŒµœÅŒπŒ∫Œ¨","Œ£ŒøœçœÄŒµœÇ","Œ£Œ±ŒªŒ¨œÑŒµœÇ"];
let moreResultsClicks = 0;
let userNeedsHelp = false;

function adjustChatboxPosition() {
  const hero = document.querySelector('.recipe-hero');
  const chatboxCard = document.querySelector('.chatbox-card');
  if (!hero || !chatboxCard) return;
  const heroHeight = hero.offsetHeight;
  const cardHeight = chatboxCard.offsetHeight;
  if (cardHeight > heroHeight * 0.85) chatboxCard.classList.add('cover-hero');
  else chatboxCard.classList.remove('cover-hero');
}

function scrollChatToBottom() {
  // Œ†œÅœéœÑŒ± Œ≤œÅŒµœÇ œÑŒø œÉœâœÉœÑœå element (chatbox-card ŒÆ chatbox)
  var chatCard = document.querySelector('.chatbox-card');
  if (!chatCard) return;

  // Œ†Œ¨œÅŒµ ŒüŒõŒïŒ£ œÑŒπœÇ ŒµŒπŒ∫œåŒΩŒµœÇ ŒºŒ≠œÉŒ± œÉœÑŒø chatCard œÄŒøœÖ Œ¥ŒµŒΩ Œ≠œáŒøœÖŒΩ œÜŒøœÅœÑœéœÉŒµŒπ Œ±Œ∫œåŒºŒ±
  var images = chatCard.querySelectorAll('img');
  var unloaded = Array.from(images).filter(img => !img.complete);

  if (unloaded.length === 0) {
    chatCard.scrollTop = chatCard.scrollHeight;
  } else {
    // ŒúœåŒªŒπœÇ œÜŒøœÅœÑœéœÉŒµŒπ Œ∫Œ±Œπ Œ∑ œÑŒµŒªŒµœÖœÑŒ±ŒØŒ± ŒµŒπŒ∫œåŒΩŒ±, scroll œÉœÑŒø œÑŒ≠ŒªŒøœÇ!
    let loaded = 0;
    unloaded.forEach(img => {
      img.addEventListener('load', function() {
        loaded++;
        if (loaded === unloaded.length) {
          chatCard.scrollTop = chatCard.scrollHeight;
        }
      });
      img.addEventListener('error', function() {
        loaded++;
        if (loaded === unloaded.length) {
          chatCard.scrollTop = chatCard.scrollHeight;
        }
      });
    });
  }
}

window.addEventListener("DOMContentLoaded", () => {
  //localStorage.clear();
  if (!localStorage.getItem(StorageKeys.METHOD_PREFS)) setMethodPrefs(getMethodPrefs());
  if (!localStorage.getItem(StorageKeys.EXCLUDED)) setExcluded([]);
  if (!localStorage.getItem(StorageKeys.MAX_TIME)) setMaxTime(180);
  if (!localStorage.getItem(StorageKeys.DISH_CATEGORY)) setDishCategory("");
  if (!localStorage.getItem(StorageKeys.MAIN_INGREDIENT)) setMainIngredient("");
  if (!localStorage.getItem(StorageKeys.AUX_INGREDIENTS)) setAuxIngredient([]);
  if (sessionStorage.getItem('chatHistory')) {
    restoreChatHistory();
    // ŒúŒóŒù ŒæŒ±ŒΩŒ±œÄœÅŒøœÉŒ∏Œ≠œÑŒµŒπœÇ quick replies!
    return;
  }
  if (!document.querySelector('#chatbox .quick-replies')) {
	  renderQuickReplyOptions([
		{ label: "ŒàœâœÇ 30'", action: "time" },
		{ label: "ŒàœâœÇ 1 œéœÅŒ±", action: "time" },
		{ label: "Œ†Œ¨ŒΩœâ Œ±œÄœå 1,5 œéœÅŒ±", action: "time" }
	  ]);
	}
});

window.addEventListener('storage', function(e) {
  if (e.key === 'favorite_recipe_ids') {
    refreshFavorites();
  }
});

input.addEventListener("keydown", function(e) {
  if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); sendMessage(); }
});

input.addEventListener("input", function() {
  input.style.height = "auto"; input.style.height = input.scrollHeight + "px";
});

window.addEventListener('resize', adjustChatboxPosition);

function saveChatHistory() { sessionStorage.setItem('chatHistory', document.getElementById('chatbox').innerHTML); }

function restoreChatHistory() {
  let hist = sessionStorage.getItem('chatHistory');
  if (hist) {
    document.getElementById('chatbox').innerHTML = hist;
    document.getElementById('chatbox').scrollTop = document.getElementById('chatbox').scrollHeight;
	refreshFavorites();
    rebindQuickReplyButtons();
	rebindDishCardClicks();
	rebindFavoriteHearts();
	adjustChatboxPosition();
	setTimeout(scrollChatToBottom, 5); // ŒªŒØŒ≥Œø delay Œ≥ŒπŒ± ŒΩŒ± ŒæŒµŒ∫ŒπŒΩŒÆœÉŒøœÖŒΩ ŒΩŒ± œÜŒøœÅœÑœéŒΩŒøœÖŒΩ œÑŒ± images
  }
}

function clearChatHistory() { sessionStorage.removeItem('chatHistory'); document.getElementById('chatbox').innerHTML = ''; }

function shuffle(array) { let arr = array.slice(); for (let i = arr.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [arr[i], arr[j]] = [arr[j], arr[i]]; } return arr; }

function mapTimeLabelToMinutes(label) { const map = {"ŒàœâœÇ 30Œª.": 30, "ŒàœâœÇ 1 œéœÅŒ±": 60, "Œ†Œ¨ŒΩœâ Œ±œÄœå 1,5 œéœÅŒ±": 200}; return map[label] || 90; }

function getPreferredChef() { return localStorage.getItem("preferred_chef") || ""; }

function renderUserBubble(text) {
  const chat = document.getElementById("chatbox");
  const userBubble = document.createElement("div");
  userBubble.className = "chat-bubble from-user";
  userBubble.textContent = text;
  chat.appendChild(userBubble);
  chat.scrollTop = chat.scrollHeight;
  adjustChatboxPosition();
  const typing = document.createElement("div");
  typing.className = "typing-indicator";
  typing.textContent = "Family Food œÄŒªŒ∑Œ∫œÑœÅŒøŒªŒøŒ≥ŒµŒØ...";
  typing.id = "typing-indicator";
  chat.appendChild(typing);
  chat.scrollTop = chat.scrollHeight;
  adjustChatboxPosition();
  saveChatHistory();
}

function renderAIBubble(text, type = "ai") {
  const chat = document.getElementById("chatbox");
  const bubble = document.createElement("div");
  bubble.className = "chat-bubble from-ai";
  bubble.innerHTML = '<span class="chat-icon">' + (type === "system" ? "üë®‚Äçüç≥ " : "üß† ") + "</span><span>" + text + "</span>";
  chat.appendChild(bubble);
  chat.scrollTop = chat.scrollHeight;
  adjustChatboxPosition();
  scrollChatToBottom();
  saveChatHistory();
}

function renderQuickReplyOptions(options = []) {
  // Œ£Œ≤ŒÆŒΩŒµŒπ ŒúŒüŒùŒü œÑŒ± œÄœÅŒøŒ∑Œ≥ŒøœçŒºŒµŒΩŒ± quick replies, ŒüŒßŒô œÑŒø carousel!
  document.querySelectorAll('#chatbox .quick-replies').forEach(qr => qr.remove());

  const chat = document.getElementById("chatbox");
  const wrapper = document.createElement("div");
  wrapper.className = "quick-replies";
  options.forEach((opt, idx) => {
    const btn = document.createElement("div");
    btn.className = "quick-reply";
    btn.textContent = opt.label;
    btn.setAttribute('data-action', opt.action);
    btn.setAttribute('data-value', opt.label);
    btn.onclick = function() {
      handleQuickReply(this);
      wrapper.remove();
    };
    btn.style.setProperty('--delay', (idx * 45) + 'ms');
    wrapper.appendChild(btn);
  });
  chat.appendChild(wrapper);

  setTimeout(() => {
    chat.scrollTop = chat.scrollHeight;
  }, 10);

  adjustChatboxPosition();
  scrollChatToBottom();
  saveChatHistory();
}

function handleQuickReply(btn) {
  const action = btn.getAttribute('data-action');
  const value = btn.getAttribute('data-value');

  console.log("value = ", value);

  if (!action) return;

  // Œ†Œ¨ŒΩœÑŒ± Œ∫Œ±Œ∏Œ¨œÅŒπœÉŒµ œÑŒ± œÄŒ±ŒªŒπŒ¨ quick replies
  document.querySelectorAll(".quick-replies").forEach(qr => qr.remove());

  if (action === "set_dish_category") {
    renderUserBubble(value);
    setDishCategory(value);

    fetch(`/get_main_tags?category=${encodeURIComponent(value)}`)
      .then(r => r.json())
      .then(data => {
        document.getElementById("typing-indicator")?.remove();
        if (data.tags && data.tags.length > 0) {
          renderAIBubble("Œ§Œπ Œ∏Œ± Œ≠ŒªŒµŒ≥ŒµœÇ Œ≥ŒπŒ± Œ∫Œ¨œÑŒπ œÉŒµ..", "system");          
		  const tagOptions = data.tags.map(tag => ({
            label: tag,
            action: "set_main_ingredient_from_tag"
          }));
          tagOptions.push({ label: "ŒîŒµŒØŒæŒµ ŒºŒøœÖ Œ∫Œ¨œÑŒπ Œ¨ŒªŒªŒø", action: "ask_alt_from_category" });
          setTimeout(() => {
            renderQuickReplyOptions(tagOptions);
          }, 500);
        } else {
          renderAIBubble("ŒîŒµŒΩ Œ≤œÅŒÆŒ∫Œ± Œ∫Œ¨œÑŒπ œÉœáŒµœÑŒπŒ∫œå. ŒòŒµœÇ ŒΩŒ± œÄœÅŒøœÑŒµŒØŒΩœâ ŒµŒ≥œé;", "system");
        }
      })
      .catch(err => {
        document.getElementById("typing-indicator")?.remove();
        renderAIBubble("‚ö†Ô∏è ŒîŒµŒΩ Œ∫Œ±œÑŒ¨œÜŒµœÅŒ± ŒΩŒ± œÜŒøœÅœÑœéœÉœâ œÑŒ± tags...", "system");
        console.error("[ERROR] Fetching tags:", err);
      });
    return;
  }

  if (action === "set_main_ingredient_from_tag") {
    setMainIngredient(value);
    renderUserBubble(value);
	console.log("call 1");
    callAISuggest(value, 1);
    return;
  }

  if (action === "ask_alt_from_category") {
    userNeedsHelp = true;
    const selectedCategory = getDishCategory();
    document.getElementById("typing-indicator")?.remove();
    renderAIBubble(`ŒòŒ≠ŒªŒµŒπœÇ ŒΩŒ± œÄŒ±œÅŒ±ŒºŒµŒØŒΩŒµŒπœÇ œÉœÑŒ∑ŒΩ Œ∫Œ±œÑŒ∑Œ≥ŒøœÅŒØŒ± "${selectedCategory}" ;`, "system");
    setTimeout(() => {
      renderQuickReplyOptions([
        { label: `Œ†Œ±œÅŒ±ŒºŒ≠ŒΩœâ œÉŒµ ${selectedCategory}`, action: "stay_in_category" },
        { label: "ŒëœÇ Œ¥ŒøœçŒºŒµ Œ∫Œ¨œÑŒπ Œ¨ŒªŒªŒø", action: "switch_category" }
      ]);
    }, 500);
    return;
  }

  if (action === "stay_in_category") {
    const selectedCategory = getDishCategory();
    document.getElementById("typing-indicator")?.remove();
    renderAIBubble(`Œ†ŒµœÇ ŒºŒøœÖ œÑŒø Œ≤Œ±œÉŒπŒ∫œå œÖŒªŒπŒ∫œå œÄŒøœÖ Œ∏Œ± ŒÆŒ∏ŒµŒªŒµœÇ ŒΩŒ± œáœÅŒ∑œÉŒπŒºŒøœÄŒøŒπŒÆœÉŒµŒπœÇ!`, "system");
    return;
  }

  if (action === "switch_category") {
    const selectedCategory = getDishCategory();
    document.getElementById("typing-indicator")?.remove();
    renderAIBubble(`Œ†ŒµœÇ ŒºŒøœÖ œÑŒπ Œ≠œáŒµŒπœÇ œÉœÑŒø ŒºœÖŒ±Œªœå œÉŒøœÖ Œ≥ŒπŒ± œÉŒÆŒºŒµœÅŒ±!`, "system");
    return;
  }

  if (action === "set_main_ingredient") {
    setMainIngredient(value);
    renderUserBubble(value);
    callAISuggest("", 1);
    return;
  }

  if (action === "ai_profile_suggest") {
    const payload = {
      message: "suggest to me a main ingredient acc. to my general preferences",
      max_time: getMaxTime(),
      main_ingredient: getMainIngredient(),
      aux_ingredients: getAuxIngredient(),
      preferred_methods: getMethodPrefs(),
      excluded: getExcluded()
    };
    fetch("/ai_reply", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    })
      .then(r => r.json())
      .then(data => {
        document.getElementById("typing-indicator")?.remove();
        if (data.filters) updateFiltersFromAIResponse(data.filters);
        if (data.reply) renderAIBubble(data.reply);
      })
      .catch(err => {
        document.getElementById("typing-indicator")?.remove();
        renderAIBubble("‚ö†Ô∏è ŒöŒ¨œÑŒπ œÄŒÆŒ≥Œµ œÉœÑœÅŒ±Œ≤Œ¨. Œ†œÅŒøœÉœÄŒ¨Œ∏Œ∑œÉŒµ ŒæŒ±ŒΩŒ¨.", "system");
      });
    return;
  }

  if (action === "more_results") {
    renderUserBubble(value);
    moreResultsClicks++;
    document.getElementById("typing-indicator")?.remove();
	console.log("call 2");
    callAISuggest(getMainIngredient(), 1);
    return;
  }

  if (action === "confirm_choice") {
    document.getElementById("typing-indicator")?.remove();
    renderAIBubble("....to be continued", "system");
    return;
  }

  if (action === "time") {
    renderUserBubble(value);
    setMaxTime(mapTimeLabelToMinutes(value));
    const maxTime = getMaxTime();
    const DishCategory = getDishCategory();
    const mainIngredient = getMainIngredient();
    if (maxTime > 0 && DishCategory && mainIngredient) {
      callAISuggest("", 1);
    } else if (maxTime > 0 && !mainIngredient && action === "time") {
      document.getElementById("typing-indicator")?.remove();
      renderAIBubble("Œ§Œπ Œ∏Œ± ŒÆŒ∏ŒµŒªŒµœÇ ŒΩŒ± Œ¥ŒøœçŒºŒµ Œ≥ŒπŒ± œÉŒÆŒºŒµœÅŒ±; ŒïœÄŒØŒªŒµŒæŒµ ŒºŒπŒ± Œ∫Œ±œÑŒ∑Œ≥ŒøœÅŒØŒ± Œ≥ŒπŒ± ŒΩŒ± ŒæŒµŒ∫ŒπŒΩŒÆœÉŒøœÖŒºŒµ!", "system");
      setTimeout(() => {
        renderQuickReplyOptions(
          shuffle(DISH_CATEGORIES).map(label => ({
            label,
            action: "set_dish_category"
          }))
        );
      }, 500);
    }
    return;
  }

  if (action === "exclude_method") {
    setMethodPrefs(getMethodPrefs().filter(m => m !== value.trim()));
    return;
  }
  if (action === "exclude_ingredient") {
    setExcluded([...getExcluded(), value.toLowerCase()]);
    return;
  }
}

function rebindQuickReplyButtons() {
  const quickReplies = document.querySelectorAll("#chatbox .quick-reply");
  quickReplies.forEach(btn => {
    btn.onclick = function() {
      handleQuickReply(this);
      if (btn.parentNode && btn.parentNode.classList.contains('quick-replies')) {
        btn.parentNode.remove();
      }
    };
  });
}

function rebindDishCardClicks() {
  const cards = document.querySelectorAll('#chatbox .similar-card-item');
  cards.forEach(card => {
    const recipeId = card.getAttribute('data-recipe-id');
    if (recipeId) {
      card.onclick = function() {
        window.location.href = '/recipe_page/' + recipeId;
      };
    }
  });
}

function rebindFavoriteHearts() {
  // ŒíœÅŒµœÇ ŒüŒõŒë œÑŒ± hearts œÄŒøœÖ ŒµŒØŒΩŒ±Œπ "Œ∫Œ±œÅŒ¥ŒøœçŒªŒµœÇ favorite"
  document.querySelectorAll('.similar-card-item span[style*="position: absolute"]').forEach(favWrapper => {
    const card = favWrapper.closest('.similar-card-item');
    if (!card) return;
    const recipeId = card.getAttribute('data-recipe-id');
    if (!recipeId) return;
    favWrapper.onclick = function(e) {
      e.stopPropagation();
	  refreshFavorites();
      toggleFavorite(favWrapper, recipeId);
    };
  });
}

function renderDishCards(dishes = []) {
  document.querySelectorAll('#chatbox .chat-carousel-row').forEach(e => e.remove());

  const chatbox = document.getElementById("chatbox");
  const carouselRow = document.createElement("div");
  carouselRow.className = "chat-carousel-row";
  const wrapper = document.createElement("div");
  wrapper.className = "similar-swiper";
  carouselRow.appendChild(wrapper);

  dishes.forEach((dish) => {
    const item = document.createElement('div');
    item.className = 'similar-card-item';
    item.setAttribute('data-recipe-id', dish.id);
    item.style.position = "relative";
    item.onclick = function() {
      window.location = '/recipe_page/' + dish.id;
    };

    var imgSrc = '/static/images/recipes/' + dish.id + '.jpg';
    var html = ''
      + '<img class="card-main-img" src="' + imgSrc + '" alt="' + dish.title + '" onerror="this.src=\'/static/images/placeholder.jpg\'">'
      + '<div class="similar-card-item-title">' + dish.title + '</div>'
      + '<div class="similar-card-item-meta">'
        + '<i class="fa fa-clock"></i>'
        + '<span class="similar-card-item-time-val">' + (dish.total_time ? dish.total_time + "'" : "-") + '</span>'
        + '<span class="chef-by-label">by</span>'
        + '<img class="chef-avatar-inline" src="/static/images/avatars/default.jpg" alt="Chef">'
      + '</div>';

    item.innerHTML = html;

    const favWrapper = document.createElement("span");
    favWrapper.style.position = "absolute";
    favWrapper.style.top = "7px";
    favWrapper.style.right = "11px";
    favWrapper.style.zIndex = "10";
    favWrapper.style.cursor = "pointer";
    favWrapper.innerHTML =
      '<i class="' + (isFavorite(dish.id) ? 'fas' : 'far') + ' fa-heart" style="color: #1a6e38; font-size: 20px; filter: drop-shadow(0 2px 5px #fff2);"></i>';
    favWrapper.onclick = function(e) {
      e.stopPropagation();
      toggleFavorite(favWrapper, dish.id);
    };
    item.appendChild(favWrapper);

    wrapper.appendChild(item);
	
  });

  // === ŒïŒîŒ© Œ∑ Œ±œÉœÜŒ±ŒªŒÆœÇ ŒµŒ∫Œ¥ŒøœáŒÆ ===
  const inputRow = document.getElementById("chatInputRow");
  if (inputRow && inputRow.parentNode === chatbox) {
    chatbox.insertBefore(carouselRow, inputRow);
  } else {
    chatbox.appendChild(carouselRow);
  }

	setTimeout(function() {
	  renderQuickReplyOptions([
		{ label: "ŒòŒ± ŒºŒ±Œ≥ŒµŒπœÅŒ≠œàœâ Œ∫Œ¨œÑŒπ Œ±œÄœå œÑŒ± œÄŒ±œÅŒ±œÄŒ¨ŒΩœâ", action: "confirm_choice" },
		{ label: "ŒîŒµŒØŒæŒµ ŒºŒøœÖ Œ∫Œ¨œÑŒπ Œ¨ŒªŒªŒø", action: "more_results" }
	  ], carouselRow);
	}, 350);

  scrollChatToBottom();
  saveChatHistory();
}

function updateFiltersFromAIResponse(filters) {
  if (!filters || typeof filters !== "object") return;
  const keys = Object.keys(filters);
  for (let key of keys) {
    switch (key) {
      case "max_time": setMaxTime(filters[key]); break;
      case "main_ingredient": setMainIngredient(filters[key]); break;
      case "aux_ingredients": setAuxIngredient(filters[key]); break;
      case "cooking_method": setMethodPrefs(filters[key]); break;
      case "excluded_keywords": setExcluded(filters[key]); break;
    }
  }
}

function sendMessage() {
  const msg = input.value.trim();
  if (!msg) return;
  handleFreeUserMessage(msg);
  input.value = "";
  input.placeholder = originalPlaceholder;
  input.style.height = "auto";
}

function handleFreeUserMessage(text) {
  renderUserBubble(text);
  const payload = {
    message: text,
    max_time: getMaxTime(),
    main_ingredient: getMainIngredient(),
    aux_ingredients: getAuxIngredient(),
    preferred_methods: getMethodPrefs(),
    excluded: getExcluded()
  };
  fetch("/ai_reply", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  })
    .then(r => r.json())
    .then(data => {
      document.getElementById("typing-indicator")?.remove();
      if (data.logout) {
        renderAIBubble("Œó œÉœÖŒΩŒµŒ¥œÅŒØŒ± œÑŒµœÅŒºŒ±œÑŒØœÉœÑŒ∑Œ∫Œµ Œ≥ŒπŒ± ŒªœåŒ≥ŒøœÖœÇ Œ±œÉœÜŒ±ŒªŒµŒØŒ±œÇ.", "system");
        return setTimeout(() => (window.location.href = "/logout"), 2000);
      }
      if (data.filters) updateFiltersFromAIResponse(data.filters);
      const maxTime = getMaxTime();
      const mainIngredient = getMainIngredient();
      if (maxTime > 0 && mainIngredient) {
        callAISuggest(text, 1);
      } else if (data.reply) {
        renderAIBubble(data.reply);
      }
    })
    .catch(err => {
      document.getElementById("typing-indicator")?.remove();
      renderAIBubble("‚ö†Ô∏è ŒöŒ¨œÑŒπ œÄŒÆŒ≥Œµ œÉœÑœÅŒ±Œ≤Œ¨. Œ†œÅŒøœÉœÄŒ¨Œ∏Œ∑œÉŒµ ŒæŒ±ŒΩŒ¨.", "system");
    });
}

function callAISuggest(userMessage = "", step) {
  const filters = {
    max_time: getMaxTime(),
    dish_category: getDishCategory(),
    main_ingredient: getMainIngredient(),
    aux_ingredient: getAuxIngredient(),
    excluded: getExcluded(),
    preferred_methods: getMethodPrefs(),
    chef: getPreferredChef()
  };
  const payload = {
    step: step,
    message: userMessage,
    ...filters
  };
  fetch("/ai_suggest_dish", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  })
    .then(r => r.json())
    .then(data => {
      document.getElementById("typing-indicator")?.remove();
      if (data.success === false) {
        renderAIBubble("‚ö†Ô∏è Œ§Œø backend ŒµœÄŒ≠œÉœÑœÅŒµœàŒµ Œ±œÄŒøœÑœÖœáŒØŒ±.", "system");
        return;
      }
      if (data.message) renderAIBubble(data.message);
      if (data.dishes?.length) renderDishCards(data.dishes);
      if (!data.dishes || data.dishes.length === 0) {
        //localStorage.clear();
        if (typeof initLocalState === "function") initLocalState();
      }
    })
    .catch(err => {
	  console.log(err);
      document.getElementById("typing-indicator")?.remove();
      renderAIBubble("‚ö†Ô∏è ŒöŒ¨œÑŒπ œÄŒÆŒ≥Œµ œÉœÑœÅŒ±Œ≤Œ¨ œÉœÑŒ∑ŒΩ œÄœÅœåœÑŒ±œÉŒ∑.", "system");
    });
}

function startSpeechRecognition() {
  if (!('webkitSpeechRecognition' in window)) {
    alert("Œü browser œÉŒøœÖ Œ¥ŒµŒΩ œÖœÄŒøœÉœÑŒ∑œÅŒØŒ∂ŒµŒπ œÜœâŒΩŒ∑œÑŒπŒ∫ŒÆ Œ±ŒΩŒ±Œ≥ŒΩœéœÅŒπœÉŒ∑.");
    return;
  }
  const recognition = new webkitSpeechRecognition();
  recognition.lang = 'el-GR';
  recognition.continuous = false;
  recognition.interimResults = false;
  input.placeholder = "üéôÔ∏è Œ£Œµ Œ±Œ∫Œøœçœâ...";
  inputRow.classList.add("voice-active");
  recognition.onresult = function(event) {
    const transcript = event.results[0][0].transcript.trim();
    input.value = transcript;
    input.dispatchEvent(new Event("input"));
    resetInputUI();
  };
  recognition.onerror = function(event) {
    alert("Œ£œÜŒ¨ŒªŒºŒ± ŒºŒπŒ∫œÅŒøœÜœéŒΩŒøœÖ: " + event.error);
    resetInputUI();
  };
  recognition.onend = function() { resetInputUI(); };
  recognition.start();
}

function resetInputUI() {
  input.placeholder = originalPlaceholder;
  inputRow.classList.remove("voice-active");
}

<!------------- Fanorites Handling ------------->
function toggleFavorite(wrapper, recipe_id) {
  // ŒíŒµŒ≤Œ±ŒπœéœÉŒøœÖ œåœÑŒπ œÑŒø recipe_id ŒµŒØŒΩŒ±Œπ Œ†ŒëŒùŒ§Œë Œ±œÅŒπŒ∏ŒºœåœÇ!
  recipe_id = Number(recipe_id);

  let favIds = [];
  try {
    favIds = JSON.parse(localStorage.getItem('favorite_recipe_ids') || '[]');
  } catch (e) {}

  // ŒïŒΩŒ∑ŒºŒ≠œÅœâœÉŒ∑ backend
  fetch('/toggle_favorite_recipe', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ recipe_id: recipe_id })
  })
  .then(r => r.json())
  .then(data => {
    const isAdded = data.status === "added";

    // === ŒïŒΩŒ∑ŒºŒ≠œÅœâœÉŒµ œÑŒø localStorage (œÄŒ¨ŒΩœÑŒ± œâœÇ Œ±œÅŒπŒ∏ŒºŒøŒØ!) ===
    let idx = favIds.findIndex(x => Number(x) === recipe_id);
    if (isAdded && idx === -1) {
      favIds.push(recipe_id);
    } else if (!isAdded && idx !== -1) {
      favIds.splice(idx, 1);
    }
    localStorage.setItem('favorite_recipe_ids', JSON.stringify(favIds));

    // === ŒïŒΩŒ∑ŒºŒ≠œÅœâœÉŒµ œÑŒø ŒµŒπŒ∫ŒøŒΩŒØŒ¥ŒπŒø ===
    wrapper.innerHTML = '<i class="' + (isAdded ? 'fas' : 'far') + ' fa-heart" style="color: var(--brand); font-size: 18px; vertical-align: -2px; cursor: pointer;"></i>';
    const icon = wrapper.querySelector("i");
    if (icon) {
      icon.onclick = function(e) {
        e.stopPropagation();
        toggleFavorite(wrapper, recipe_id);
      };
    }
  });
}

function isFavorite(recipe_id) {
  recipe_id = Number(recipe_id);
  try {
    const favIds = JSON.parse(localStorage.getItem('favorite_recipe_ids') || '[]');
    return favIds.map(x => Number(x)).includes(recipe_id);
  } catch (e) {
    return false;
  }
}

function refreshFavorites() {
  console.log('[refreshFavorites] ŒûŒµŒ∫ŒπŒΩŒ¨ŒºŒµ refresh...');
  const allCards = document.querySelectorAll('.similar-card-item');
  console.log('[refreshFavorites] ŒíœÅŒ≠Œ∏Œ∑Œ∫Œ±ŒΩ', allCards.length, 'dish cards œÉœÑŒø DOM');

  allCards.forEach(card => {
    const recipeId = card.getAttribute('data-recipe-id');
    console.log('[refreshFavorites] Card ŒºŒµ id:', recipeId);

    const favWrapper = card.querySelector('span[style*="position: absolute"]');
    if (!favWrapper) {
      console.log('[refreshFavorites] ŒîŒïŒù Œ≤œÅŒ≠Œ∏Œ∑Œ∫Œµ favWrapper Œ≥ŒπŒ± card', recipeId);
      return;
    }

    const fav = isFavorite(recipeId);
    console.log('[refreshFavorites] isFavorite(', recipeId, ') =', fav);

    favWrapper.innerHTML =
      '<i class="' + (fav ? 'fas' : 'far') + ' fa-heart" style="color: #1a6e38; font-size: 20px; filter: drop-shadow(0 2px 5px #fff2);"></i>';

    const icon = favWrapper.querySelector("i");
    if (icon) {
      icon.onclick = function(e) {
        e.stopPropagation();
        toggleFavorite(favWrapper, recipeId);
      };
      console.log('[refreshFavorites] OnClick set for card', recipeId);
    } else {
      console.log('[refreshFavorites] ŒîŒïŒù Œ≤œÅŒ≠Œ∏Œ∑Œ∫Œµ icon Œ≥ŒπŒ± card', recipeId);
    }
  });
  console.log('[refreshFavorites] Œ§Œ≠ŒªŒøœÇ refresh');
}


</script>

{% endblock %}
