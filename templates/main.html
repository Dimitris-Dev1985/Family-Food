{% extends "base.html" %}
{% block title %}Î¤Î¹ Î¸Î± Ï†Î¬Î¼Îµ ÏƒÎ®Î¼ÎµÏÎ±;{% endblock %}
{% block content %}



<!-- =================== Hero =================== -->
<style>
  .recipe-hero {
    position: relative; z-index: 1;
    width: 100vw; max-width: 600px; margin: 0 auto;
    aspect-ratio: 1.1/1;
    border-bottom-left-radius: 2.2rem; border-bottom-right-radius: 2.2rem;
    background: #eee; overflow: hidden;
    display: flex; align-items: flex-end; justify-content: center;
    transition: height 0.4s;
  }
  .recipe-hero img {
    width: 100%; height: 100%; min-height: 220px;
    object-fit: cover;
    border-bottom-left-radius: 2.2rem; border-bottom-right-radius: 2.2rem;
  }
</style>

<!-- =================== Chat Card =================== -->
<style>
  .chatbox-card {
    position: relative; z-index: 2;
    max-width: 560px;
    margin: auto auto 22px auto;
    padding: 20px 12px 13px;
    border-radius: 20px;
	min-height: 250px !important;
    height: auto !important;
    background: #fff;
    display: flex; flex-direction: column; align-items: stretch; gap: 14px;
    box-shadow: var(--shadow), 0 10px 40px rgba(33,142,70,0.15);
    transition: box-shadow 0.16s, margin-top 0.33s cubic-bezier(.4,2,.6,1);
  }
  .chatbox-card.cover-hero {
    position: fixed; left: 0; right: 0; bottom: 0; z-index: 22;
    max-width: 560px; max-height: 75vh;
    display: flex; flex-direction: column; overflow-y: auto !important; overflow-x: hidden;
    box-shadow: 0 8px 32px rgba(33,142,70,0.14);
  }
  .chat-intro {
    margin: 0 0 0 0;
    padding-bottom: 2px;
    font-size: 1.85rem; font-weight: 600;
    color: var(--brand-hover);
    text-align: center;
  }
  .chatbox {
    flex: 1 1 auto;
    width: 100%;
    display: flex; flex-direction: column; gap: 12px;
    background: none; border-radius: 0; box-shadow: none; padding: 0;
    height: auto !important;
    max-height: none !important;
    padding-bottom: 12px !important;
  }
</style>

<!-- =================== Chat Bubbles =================== -->
<style>
  .chatbox {
    display: flex;
    flex-direction: column;
    gap: 12px;
    padding: 10px 0 10px 0;
  }
  .chat-bubble {
    align-items: flex-start;
    max-width: 76%;
    padding: 12px 16px;
    border-radius: 20px;
    font-size: 1.1rem;
    line-height: 1.5;
    box-shadow: 0 2px 8px rgba(0,0,0,0.03);
    word-break: break-word;
    white-space: pre-wrap;
    position: relative;
    margin-bottom: 1px;
    margin-top: 0;
    animation: fadeIn 0.3s;
  }
  .from-ai {
    align-self: flex-start;
    background: #cff7c8;
    color: var(--brand-hover);
    margin-right: auto;
    border-top-left-radius: 0px;
    border-top-right-radius: 18px;
    border-bottom-right-radius: 18px;
    border-bottom-left-radius: 18px;
  }
  .from-user {
    align-self: flex-end;
    background: #e5f1fa;
    color: #195885;
    margin-left: auto;
    border-top-left-radius: 18px;
    border-top-right-radius: 0px;
    border-bottom-right-radius: 18px;
    border-bottom-left-radius: 18px;
  }
  .chat-bubble .bubble-icon {
    margin-right: 7px;
    font-size: 1.15em;
    line-height: 1;
    flex-shrink: 0;
    margin-top: 1px;
  }
  .from-user .bubble-icon {
    margin-left: 7px;
    margin-right: 0;
    order: 2;
  }
  .typing-indicator {
    align-self: flex-start;
    margin-left: 20px;
    font-size: 0.97rem;
    font-style: italic;
    color: #999;
  }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(14px);}
    to   { opacity: 1; transform: translateY(0);}
  }
</style>

<!-- =================== Quick Replies =================== -->
<style>
  .quick-replies {
    display: flex; flex-wrap: wrap; gap: 8px;
    margin-top: 2px;
    justify-content: flex-start;
    font-weight: 500; letter-spacing: 0.3px;
    transition: min-height 0.22s;
  }
  .quick-reply {
    padding: 7px 16px;
    border-radius: 24px; border: none;
    font-size: 1.1rem; font-weight: 500;
    cursor: pointer;
    background: var(--bg-badge); color: var(--brand);
    box-shadow: 0 1px 4px rgba(33,142,70,0.04);
    opacity: 0; visibility: visible;
    transition: all 0.19s;
    animation: fadeInQuickReply 0.5s cubic-bezier(.41,1.12,.62,1.09) forwards;
    animation-delay: var(--delay, 200ms);
  }
  .quick-reply:hover {
    background: #daf6e5;
    box-shadow: 0 1px 6px rgba(33,142,70,0.09);
  }
  @keyframes fadeInQuickReply {
    to { opacity: 1; transform: translateY(0) scale(1); }
  }
</style>

<!-- =================== Input Row =================== -->
<style>
  .chat-input-row {
    display: flex; align-items: center; gap: 5px;
    width: 100%; max-width: 100%;
    margin: 0!important; padding: 10px 12px 7px;
    border-radius: 20px; z-index: 10;
    background: #fff;
    border: 1.5px solid var(--outline);
    box-shadow: 0 2px 14px rgba(33,142,70,0.07);
  }
  .chat-input-row textarea {
    flex: 1;
    min-height: 44px; max-height: 120px;
    padding: 0 5px 0 10px;
    border: 1.5px solid var(--outline); border-radius: 20px;
    font-size: 0.9rem; resize: none;
    background: var(--input-bg);
    overflow-y: auto;
    transition: background-color 0.2s;
	align-content: center;
	margin-right: 5px;
  }
  .chat-input-row textarea:focus {
    outline: none;
    background: var(--input-bg-focus);
  }
  .chat-input-row.voice-active textarea {
    background: var(--voice-bg); color: var(--voice-color);
    font-weight: 500;
  }
  .chat-input-row button {
    border: none; background: none; cursor: pointer; padding-top: inherit;
  }
  .mui-icon { font-size: 26px; color: var(--brand); }
  .mui-icon:hover { color: var(--brand-hover); }
</style>

<!-- =================== Animations =================== -->
<style>
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>

<!-- =================== Responsive =================== -->
<style>
  @media (max-width: 600px) {
    .recipe-hero { max-width: 100vw; border-radius: 0 0 18px 18px; }
    .recipe-hero img { border-radius: 0 0 18px 18px; }
    .chatbox-card { margin-left: 2vw; margin-right: 2vw; }
    .dish-cards-wrapper, .chat-input-row { margin-left: 2vw; margin-right: 2vw; }
  }
</style>

<!-- =================== OFFCANVAS =================== -->
<style>
.offcanvas-menu {
  position: fixed;
  top: 0; left: 0;
  width: 83vw; max-width: 340px;
  height: 100vh;
  background: var(--surface, #fffaf5);
  box-shadow: 2px 0 20px 2px rgba(33,142,70,0.08), 0 6px 48px 2px rgba(33,142,70,0.08);
  z-index: 120;
  transform: translateX(-105%);
  transition: transform 0.27s cubic-bezier(.44,.13,.46,.87), box-shadow 0.17s;
  display: flex;
  flex-direction: column;
  border-top-right-radius: 28px;      /* ÏƒÏ„ÏÎ¿Î³Î³Ï…Î»ÎµÎ¼Î­Î½Î· Ï€Î¬Î½Ï‰ */
  border-bottom-right-radius: 22px;   /* ÏƒÏ„ÏÎ¿Î³Î³Ï…Î»ÎµÎ¼Î­Î½Î· ÎºÎ¬Ï„Ï‰ */
  border-right: none;
  overflow: hidden;
}

.offcanvas-menu.open { transform: translateX(0); }

.offcanvas-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 22px 22px 12px 19px;      /* extra Î¼Î±Î¾Î¹Î»Î±ÏÎ¬ÎºÎ¹ Ï€Î¬Î½Ï‰ */
  border-bottom: 1px solid var(--outline, #eee);
  min-height: 62px;
}
.offcanvas-logo {
  height: 38px;
  width: auto;
  display: block;
  margin-right: 3px;
  user-select: none;
  filter: drop-shadow(0 1px 0 #eafbe7);
}
.close-btn {
  background: none;
  border: none;
  color: var(--brand);
  font-size: 1.4rem;
  padding: 5px 7px;
  border-radius: 50%;
  cursor: pointer;
  transition: background 0.11s;
}
.close-btn:hover { background: #eafbe7; }

.offcanvas-content {
  display: flex;
  flex-direction: column;
  padding: 22px 14px 18px 13px;      /* extra Î¼Î±Î¾Î¹Î»Î±ÏÎ¬ÎºÎ¹ ÎºÎ¬Ï„Ï‰ */
  overflow-y: auto;
  flex: 1;
}
.offcanvas-link {
  display: flex;
  align-items: center;
  gap: 20px;
  font-size: 1.2rem;
  font-family: 'Inter', 'Montserrat', sans-serif;
  color: var(--text, #222);
  background: none;
  border: none;
  border-radius: 10px;
  padding: 13px 12px 13px 10px;
  cursor: pointer;
  transition: background 0.15s, box-shadow 0.17s;
  text-align: left;
  font-weight: 500;
  outline: none;
  min-height: 48px;
  box-shadow: none;
}
.offcanvas-link .offcanvas-text {
  font-weight: 500;
  font-size: 1.09em;
  letter-spacing: -0.1px;
}
.offcanvas-link i {
  font-size: 1.26em;
  min-width: 25px;
  text-align: center;
  position: relative; top: 2px;
}
.offcanvas-link:hover, .offcanvas-link:focus {
  background: #eafbe7;
  box-shadow: 0 2px 12px 0 rgba(33,142,70,0.08);
}
.offcanvas-exit {
  color: var(--pink, #ef2d6a);
  font-weight: 600;
  margin-top: 20px;
  font-size: 1.1rem;
}
.offcanvas-exit i { color: var(--pink, #ef2d6a) !important; }

.icon-green { color: var(--brand, #218e46) !important; }
.icon-brand { color: var(--brand-hover, #1a6e38) !important; }
.icon-pink { color: var(--pink, #ef2d6a) !important; }

/* Ï€Î¹Î¿ soft box-shadow ÎºÎ±Î¹ Ï€Î¹Î¿ â€œfriendyâ€ ÎµÎ¼Ï†Î±Î½Î¹ÏƒÎ· */
.offcanvas-backdrop {
  display: none;
  position: fixed;
  inset: 0;
  z-index: 110;
  background: rgba(33, 55, 33, 0.11);
  backdrop-filter: blur(1.2px);
  transition: opacity 0.19s;
}
.offcanvas-backdrop.open { display: block; opacity: 1; }

@media (max-width: 480px) {
  .offcanvas-menu { max-width: 97vw; border-top-right-radius: 19px; border-bottom-right-radius: 14px; }
  .offcanvas-logo { height: 50px; }
  .offcanvas-content { padding: 13px 5px 13px 6px; }
}

.upgrade-offcanvas-btn {
  background: linear-gradient(270deg, #e9c891 0%, #b89c52 50%, #9c864a 100%);
  color: #fff !important;
  border-radius: 22px;
  font-weight: 700;
  padding: 12px 0 12px 0;
  font-size: 1.1rem;
  margin-bottom: 18px;
  border: none;
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 2px 8px rgba(33,142,70,0.14);
  transition: background 0.18s;
}
.upgrade-offcanvas-btn:hover {
  background: linear-gradient(90deg,#1a6e38,var(--brand));
}

</style>

<!-- =================== RESTART BUTTON =================== -->
<style>
.restart-chat-btn {
  background: none;
  border: none;
  color: var(--brand);
  font-size: 1.5rem;
  padding: 6px 8px 6px 6px;
  border-radius: 50%;
  cursor: pointer;
  transition: background 0.14s, color 0.14s;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  min-width: 36px;
  min-height: 36px;
}
.restart-chat-btn:active,

.restart-chat-btn:{
  background: #eafbe7;
  color: var(--brand);
}
</style>

<!-- =================== PREMIUM MODAL =================== -->
<style>

.modal-card {
  background: #fff;
  border-radius: 18px;
  box-shadow: 0 6px 32px rgba(33,142,70,0.13);
  padding: 32px 26px 22px 26px;
  min-width: 330px;
  max-width: 92vw;
  text-align: center;
  position: relative;
}
.modal-title {
  font-weight: 700;
  font-size: 1.3rem;
  margin-bottom: 10px;
  color: var(--brand);
  display: flex;
  align-items: center;
  gap: 7px;
  justify-content: center;
}
.modal-title .fa-gem,
.modal-title .svg-inline--fa.fa-gem {
  color: #40c4ff !important;
  font-size: 1.17em;
}
.modal-close {
  position: absolute; top: 10px; right: 14px;
  border: none; background: none; font-size: 1.33em;
  color: var(--brand); cursor: pointer;
  padding: 0px 5px;
}
.modal-close:hover { color: #218e46; }

.modal-cancel-btn {
  background: var(--pink);
  border: none;
  color: #fff;
  border-radius: 10px;
  padding: 8px 26px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.13s;
}
.modal-cancel-btn:hover {
  background: #ffe6b3;
  color: #f57c00;
}
</style>

<!-- =================== CANCEL SUBSCRIPTION MODAL =================== -->
<style>
#cancelConfirmModal {
  position: fixed;
  inset: 0;
  width: 100vw;
  height: 100vh;
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1300;
  background: rgba(44,54,60,0.16);
  animation: fadeIn 0.21s;
}
#cancelConfirmModal.open {
  display: flex;
}
#cancelConfirmModal .modal-dialog {
  width: 96vw;
  max-width: 350px;
  margin: 0 auto;
  animation: scaleIn 0.19s;
}
#cancelConfirmModal .modal-content {
  background: #fff;
  border-radius: 18px;
  box-shadow: 0 4px 24px rgba(33,142,70,0.12);
  padding: 32px 16px 20px 16px;
  position: relative;
  text-align: center;
}

#cancelConfirmModal .cancel-modal-icon {
  font-size: 44px;
  margin-bottom: 14px;
  filter: drop-shadow(0 1px 0 #ffd1d1);
  animation: shake 0.32s;
}

@keyframes shake {
  10%, 90% { transform: translateX(-2px);}
  20%, 80% { transform: translateX(4px);}
  30%, 50%, 70% { transform: translateX(-6px);}
  40%, 60% { transform: translateX(6px);}
  100% { transform: none;}
}

#cancelConfirmModal .cancel-modal-title {
  color: var(--red);
  font-weight: bold;
  font-size: 1.11rem;
  margin-bottom: 6px;
}
#cancelConfirmModal .cancel-modal-desc {
  color: #555;
  font-size: 0.99rem;
  margin-bottom: 16px;
}

#cancelConfirmModal .cancel-actions {
  display: flex;
  gap: 10px;
  justify-content: center;
}

#confirmCancelBtn {
  background: var(--pink);
  color: #fff;
  font-weight: 700;
  border: none;
  border-radius: 13px;
  padding: 10px 10px;
  font-size: 1rem;
  min-width: 115px;
  transition: background 0.17s, box-shadow 0.17s;
  box-shadow: 0 2px 8px rgba(220,50,50,0.11);
}
#confirmCancelBtn:hover {
  background: var(--pink);
}

#undoCancelBtn {
  background: var(--brand);
  border: none;
  color: #fff;
  font-weight: 700;
  border-radius: 13px;
  padding: 10px 20px;
  font-size: 1.1rem;
  min-width: 115px;
  transition: background 0.13s, color 0.13s;
  box-shadow: 0 2px 7px rgba(33,142,70,0.08);
}
#undoCancelBtn:hover {
  background: var(--brand);
  color: #fff;
}

@media (max-width: 480px) {
  #cancelConfirmModal .modal-dialog {
    max-width: 96vw;
  }
  #cancelConfirmModal .modal-content {
    padding: 22px 5vw 16px 5vw;
  }
}

.modal-resume-btn{
  background: var(--brand);
  border: none;
  color: #fff;
  font-weight: 700;
  border-radius: 13px;
  padding: 10px 20px;
  font-size: 1.1rem;
  min-width: 115px;
  transition: background 0.13s, color 0.13s;
  box-shadow: 0 2px 7px rgba(33,142,70,0.08);
}

</style>

<!-- =================== CHOOSE DISH MODAL =================== -->
<style>
/* ---------- Modal Container ---------- */
.modal-choose-dish {
  max-width: 420px;
}
.choose-dish-modal-content {
  background: #fffaf5;
  border-radius: 15px;
  box-shadow: 0 6px 24px rgba(33,142,70,0.17);
}
.choose-dish-modal-header {
  border-bottom: 1px solid #e0e0e0;
}
.choose-dish-modal-body {
  padding: 20px;
}
.choose-dish-modal-footer {
  border-top: 1px solid #e0e0e0;
  display: flex;
  gap: 12px;
  justify-content: center;
}

/* ---------- Î•Ï€Î¹Î»Î¿Î³Î® Î·Î¼Î­ÏÎ±Ï‚ (Badges) ---------- */
.dish-day-row {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-bottom: 34px;
  justify-content: center;
}
.dish-day-badge {
  background: var(--bg-badge, #f8faf7);
  color: var(--brand, #218e46);
  border: 1.3px solid #dbdbdb;
  border-radius: 24px;
  font-size: 1.2em;
  padding: 4px 16px;
  cursor: pointer;
  transition: background 0.13s, color 0.13s, border 0.13s;
  outline: none;
  font-weight: 500;
  user-select: none;
}
.dish-day-badge.selected,
.dish-day-badge:active {
  background: #e4f6e8;
  color: #1a6e38;
  border: 1.8px solid var(--brand);
}

/* ---------- Î•Ï€Î¹Î»Î¿Î³Î® Ï€Î¹Î¬Ï„Î¿Ï… (Options) ---------- */
.dish-options {
  display: flex;
  flex-direction: column;
  gap: 11px;
}
.dish-option {
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: #fff;
  border: 1.6px solid #dbdbdb;
  border-radius: 16px;
  padding: 13px 15px;
  transition: border 0.15s, background 0.12s;
  cursor: pointer;
  position: relative;
}

.dish-option {
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: #fff;
  border: 1.6px solid #dbdbdb;
  border-radius: 16px;
  padding: 13px 15px;
  transition: border 0.15s, background 0.12s;
  cursor: pointer;
  position: relative;
}

/* ÎœÎŸÎÎŸ Ï„Î¿ .selected ÎºÎ¬Î½ÎµÎ¹ highlight */
.dish-option.selected {
  background: #f6fbf6;
  border-color: #218e46;
}

/* Î¤Î¿ input radio Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Î¼ÎµÎ¯Î½ÎµÎ¹ hidden, ÎµÎºÏ„ÏŒÏ‚ Î±Î½ Î¸ÎµÏ‚ Î½Î± Ï†Î±Î¯Î½ÎµÏ„Î±Î¹ */
.dish-option input[type="radio"] {
  accent-color: var(--brand, #218e46);
  width: 18px;
  height: 18px;
  margin-right: 12px;
}


/* ----------- Î Î¹Î¬Ï„Î¿: Î•Î¹ÎºÏŒÎ½Î± & Î¤Î¯Ï„Î»Î¿Ï‚ ----------- */
.dish-label {
  display: flex;
  flex-direction: column;
  flex: 1;
}
.dish-img-title-wrap {
  display: flex;
  align-items: center;
}
.dish-img {
  width: 45px;
  height: 45px;
  object-fit: cover;
  border-radius: 10px;
  margin-right: 11px;
}

/* ----------- Î Î¹Î¬Ï„Î¿: ÎšÎµÎ¯Î¼ÎµÎ½Î¿ ----------- */
.dish-title {
  font-weight: 500;
  font-size: 1.10em;
  color: #234a26;
}
.dish-desc {
  font-size: 0.96em;
  color: #788484;
}

/* ----------- Option Icon ----------- */
.dish-icon {
  font-size: 1.75em;
  margin-left: 12px;
  min-width: 32px;
  text-align: right;
  opacity: 0.94;
  transition: filter 0.15s;
}
.dish-option.selected .dish-icon {
  filter: drop-shadow(0 1px 3px #1a6e3830);
}


.btn-close {
  /* ÎšÏÏÎ²ÎµÎ¹ Ï„Î¿ default icon ÎºÎ±Î¹ Î²Î¬Î¶ÎµÎ¹ custom SVG X ÏƒÎµ #218e46 */
  background: none;
  width: 1.3em;
  height: 1.3em;
  opacity: 1;
  border: none;
  padding: 0.25em 0.25em;
  /* Î•Î¼Ï†Î¬Î½Î¹ÏƒÎ· custom X */
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='none' stroke='%23218e46' stroke-width='2' viewBox='0 0 16 16'%3E%3Cpath stroke-linecap='round' d='M4 4l8 8M12 4l-8 8'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: center;
  background-size: 1em 1em;
}
.btn-close:hover,
.btn-close:focus {
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='none' stroke='%231a6e38' stroke-width='2' viewBox='0 0 16 16'%3E%3Cpath stroke-linecap='round' d='M4 4l8 8M12 4l-8 8'/%3E%3C/svg%3E");
  opacity: 0.95;
}

</style>

<!-- =================== CÎŸÎÎ¤Î‘CT MODAL =================== -->
<style>
.contact-modal-content {
  max-width: 96vw;
  width: 370px;
  margin: 1vw;
  box-shadow: var(--shadow);
  border: 1.5px solid var(--outline);
  position: relative;
  background: #fff;
  border-radius: 18px;
  padding: 30px 20px 28px 20px;
  text-align: center;
}
.contact-modal-title {
  font-weight: 700;
  font-size: 1.19em;
  color: var(--brand);
  margin: 0 10px 20px 10px;
  display: flex;
  align-items: center;
}
.contact-close {
  position: absolute;
  top: 14px;
  right: 15px;
  font-size: 1.7em;
  color: var(--brand);
  font-weight: bold;
  background: none;
  border: none;
  z-index: 10;
  transition: color 0.13s;
  line-height: 1.1;
}
.contact-close:hover, .contact-close:focus {
  color: var(--brand-hover);
}
.contact-modal-content .form-group {
  margin-bottom: 14px;
  text-align: left;
}
.contact-modal-content label {
  display: block;
  font-weight: 600;
  font-size: 0.94em;
  color: var(--text-dim);
  margin-bottom: 10px;
}
.contact-modal-content input,
.contact-modal-content textarea {
  width: 100%;
  border: 1.4px solid var(--outline);
  border-radius: 10px;
  padding: 8px 10px;
  font-size: 0.96em;
  font-family: inherit;
  transition: border-color 0.2s, box-shadow 0.2s;
}
.contact-modal-content input:focus,
.contact-modal-content textarea:focus {
  outline: none;
  border-color: var(--brand);
  box-shadow: 0 0 0 2px #218e4622;
}
.contact-submit {
  background: var(--brand);
  color: white;
  border: none;
  border-radius: 12px;
  padding: 10px 16px;
  font-size: 1em;
  font-weight: 600;
  cursor: pointer;
  width: 100%;
  transition: background 0.2s;
}
.contact-submit:hover {
  background: var(--brand-hover);
}
.voice-btn {
  position: absolute;
  right: 12px;
  bottom: 10px;
  background: none;
  border: none;
  color: var(--brand);
  font-size: 1.25em;
  cursor: pointer;
  transition: color 0.2s;
}
.voice-btn:hover { color: var(--brand-hover); }
.voice-active { color: var(--red) !important; }
.textarea-wrapper {
  position: relative;
}
</style>

<!-- ======== Î ÎµÎ´Î¯Î¿ ÎœÎ·Î½ÏÎ¼Î±Ï„Î¿Ï‚ Î¼Îµ Î¦Ï‰Î½Î·Ï„Î¹ÎºÎ® Î•Î¹ÏƒÎ±Î³Ï‰Î³Î® ======== -->
<style>
.textarea-wrapper {
  position: relative;
}
.voice-btn {
  position: absolute;
  right: 12px;
  bottom: 10px;
  background: none;
  border: none;
  color: var(--brand);
  font-size: 1.25em;
  cursor: pointer;
  transition: color 0.2s;
}
.voice-btn:hover { color: var(--brand-hover); }
.voice-active { color: var(--red) !important; }
</style>



<body style="min-height:100vh; display:flex; flex-direction:column;">

  <div class="recipe-topbar" id="topBar">
    <button class="icon-btn" title="ÎœÎµÎ½Î¿Ï" onclick="window.location='/profile'"><i class="fa fa-bars"></i></button>
    <div class="topbar-title">Î¤Î¹ Î¸Î± Ï†Î¬Î¼Îµ ÏƒÎ®Î¼ÎµÏÎ±;</div>
    <div class="topbar-actions">
      <button class="icon-btn" title="Î ÏÎ¿Ï†Î¯Î»" onclick="window.location='/profile'"><i class="fa fa-user"></i></button>
    </div>
  </div>

  <div class="recipe-hero">
    <img src="{{ url_for('static', filename='/images/heros/main_hero.jpg') }}" alt="Featured Food">
  </div>

  <div class="chatbox-card">
    <div class="chat-intro">
        Î Î¬Î¼Îµ Î½Î± Î²ÏÎ¿ÏÎ¼Îµ Ï„Î¹ Î¸Î± Î¼Î±Î³ÎµÎ¹ÏÎ­ÏˆÎ¿Ï…Î¼Îµ;<br>
      </div>
	<div class="chatbox" id="chatbox">
	  <div class="chat-bubble from-ai">ğŸ‘©â€ğŸ³ Î ÎµÏÎ¯Ï€Î¿Ï… Ï€ÏŒÏƒÎ¿ Ï‡ÏÏŒÎ½Î¿ Î­Ï‡ÎµÎ¹Ï‚ Î³Î¹Î± Î¼Î±Î³ÎµÎ¯ÏÎµÎ¼Î±;</div>
	</div>
    <div class="chat-input-row" id="chatInputRow">
        <button id="restartChatBtn" class="restart-chat-btn" title="Î•Ï€Î±Î½Î±Ï†Î¿ÏÎ¬ ÏƒÏ…Î½Î¿Î¼Î¹Î»Î¯Î±Ï‚" onclick="restartChat()" style="display:none;">
		  <i class="fa fa-undo"></i>
		</button>
		<textarea id="userInput" placeholder="Î ÎµÏ‚ Î¼Î¿Ï… Ï„Î¹ ÏƒÎºÎ­Ï†Ï„ÎµÏƒÎ±Î¹..."></textarea>
        <button onclick="sendMessage()">
          <span class="material-icons mui-icon">send</span>
        </button>
        <button onclick="startSpeechRecognition()">
          <span class="material-icons mui-icon">mic</span>
        </button>
      </div>
    </div>


<!-- === OFFCANVAS MENU ===  -->
<div id="offcanvas" class="offcanvas-menu">
  <div class="offcanvas-header">
    <img src="/static/images/logo.png" alt="Family Food" class="offcanvas-logo" />
    <button class="close-btn" onclick="closeOffcanvas()" aria-label="ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿ Î¼ÎµÎ½Î¿Ï">
      <i class="fa fa-times"></i>
    </button>
  </div>
  <div class="offcanvas-content">

	{% if is_premium %}
	  <!-- ÎšÎ¿Ï…Î¼Ï€Î¯ "Premium ÏƒÏ…Î½Î´ÏÎ¿Î¼Î®" ÏƒÏ„Î¿ Offcanvas -->
	  <button class="offcanvas-link upgrade-offcanvas-btn" id="offcanvasPremiumBtn" onclick="openPremiumModal()" style="margin-bottom: 10px;">
		<i class="fa fa-gem" style="color:#40c4ff;margin-right:1px;"></i>
		<span style="font-weight:600;">Premium ÏƒÏ…Î½Î´ÏÎ¿Î¼Î®</span>
	  </button>
	{% else %}
	  <!-- ÎšÎ¿Ï…Î¼Ï€Î¯ Î‘Î½Î±Î²Î¬Î¸Î¼Î¹ÏƒÎ·Ï‚ Î¼Îµ Î´Î¹Î±Î¼Î±Î½Ï„Î¬ÎºÎ¹ ÏƒÏ„Î¿ Offcanvas -->
	  <button class="offcanvas-link upgrade-offcanvas-btn" id="offcanvasUpgradeBtn" onclick="openUpgradeModal()" style="margin-bottom: 10px;">
		<i class="fa fa-gem" style="color:#40c4ff;margin-right:1px;"></i>
		<span style="font-weight:600;">Î‘Î½Î±Î²Î¬Î¸Î¼Î¹ÏƒÎ· ÏƒÎµ Premium</span>
	  </button>
	{% endif %}


    <button class="offcanvas-link" id="favRecipesBtn">
	  <i class="fa fa-heart icon-green"></i> Î‘Î³Î±Ï€Î·Î¼Î­Î½ÎµÏ‚ ÏƒÏ…Î½Ï„Î±Î³Î­Ï‚
	</button>
    <button class="offcanvas-link" id="PantryBtn">
      <i class="fa fa-lemon icon-brand"></i> Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· Ï…Î»Î¹ÎºÏÎ½
    </button>
    <button class="offcanvas-link" data-href="/history">
      <i class="fa fa-history icon-brand"></i> Î™ÏƒÏ„Î¿ÏÎ¹ÎºÏŒ Î¼Î±Î³ÎµÎ¹ÏÎµÎ¼Î­Î½Ï‰Î½ Ï€Î¹Î¬Ï„Ï‰Î½
    </button>
    <button class="offcanvas-link" id="WeeklyMenuBtn">
      <i class="fa fa-calendar-week icon-brand"></i> Î•Î²Î´Î¿Î¼Î±Î´Î¹Î±Î¯Î¿ Î¼ÎµÎ½Î¿Ï
    </button>
    
		
	<!-- === ÎšÎŸÎ¥ÎœÎ Î™ FAQS === -->
	<button class="offcanvas-link" onclick="loadAndOpenFaqModal()" style="margin-top:30px;">
	  <i class="fa fa-question-circle icon-brand"></i> Î£Ï…Ï‡Î½Î­Ï‚ Î•ÏÏ‰Ï„Î®ÏƒÎµÎ¹Ï‚ (FAQs)
	</button>

	<!-- === ÎšÎŸÎ¥ÎœÎ Î™ Î¥Î ÎŸÎ£Î¤Î—Î¡Î™ÎÎ— === -->
	<button class="offcanvas-link" onclick="openContactModal()" style="margin-top:7px;">
	  <i class="fa fa-envelope icon-brand"></i> Î•Ï€Î¹ÎºÎ¿Î¹Î½Ï‰Î½Î¯Î± / Î¥Ï€Î¿ÏƒÏ„Î®ÏÎ¹Î¾Î·
	</button>

	<button class="offcanvas-link offcanvas-exit" onclick="logoutUser()" style="margin-top:30px;">
	  <i class="fa fa-sign-out-alt icon-pink"></i> ÎˆÎ¾Î¿Î´Î¿Ï‚
	</button>
  </div>
</div>

<div id="offcanvas-backdrop" class="offcanvas-backdrop" onclick="closeOffcanvas()"></div>


</body>



{% endblock %}

{% block modals %}

<div id="premiumModal" class="modal-backdrop" style="display:none;">
  <div class="modal-card">
    <button class="modal-close" onclick="closePremiumModal()" title="ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿">Ã—</button>
    <div class="modal-title"><i class="fa fa-gem"></i> Premium ÏƒÏ…Î½Î´ÏÎ¿Î¼Î®</div>
    <div class="modal-body">
      <div style="margin-bottom:12px;">
        <b>Î•Î½ÎµÏÎ³Î® ÏƒÏ…Î½Î´ÏÎ¿Î¼Î®!</b><br>
        Î— ÏƒÏ…Î½Î´ÏÎ¿Î¼Î® ÏƒÎ¿Ï… ÎµÎ¯Î½Î±Î¹ ÎµÎ½ÎµÏÎ³Î® Î¼Î­Ï‡ÏÎ¹ 
        <span id="premiumExpires">{{ formatted_expires|default('-') }}</span>.
      </div>
		{% if is_pending_cancel %}
		  <div class="pending-cancel-msg" style="color:#d82e2e; font-weight:600; margin:10px 0 0 0;">
			ğŸ”” Î— Î±ÎºÏÏÏ‰ÏƒÎ· Ï„Î·Ï‚ ÏƒÏ…Î½Î´ÏÎ¿Î¼Î®Ï‚ ÏƒÎ¿Ï… Î­Ï‡ÎµÎ¹ Î®Î´Î· Ï€ÏÎ¿Î³ÏÎ±Î¼Î¼Î±Ï„Î¹ÏƒÏ„ÎµÎ¯.
		  </div>
		  <button id="resumeSubBtn" class="modal-resume-btn mt-3">Î•Ï€Î±Î½ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎ· ÏƒÏ…Î½Î´ÏÎ¿Î¼Î®Ï‚</button>
		{% else %}
		  <button id="cancelSubBtn" class="modal-cancel-btn mt-3">Î‘ÎºÏÏÏ‰ÏƒÎ· ÏƒÏ…Î½Î´ÏÎ¿Î¼Î®Ï‚</button>
		{% endif %}

    </div>
  </div>
</div>

<div id="cancelConfirmModal">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="cancel-modal-icon">ğŸ’”</div>
      <h5 class="cancel-modal-title">Î£Î¯Î³Î¿Ï…ÏÎ± Î¸Î­Î»ÎµÎ¹Ï‚ Î½Î± Î±ÎºÏ…ÏÏÏƒÎµÎ¹Ï‚ Ï„Î· ÏƒÏ…Î½Î´ÏÎ¿Î¼Î®;</h5>
      <div class="cancel-modal-desc">
        Î˜Î± Ï‡Î¬ÏƒÎµÎ¹Ï‚ ÏŒÎ»Î± Ï„Î± Premium Ï€ÏÎ¿Î½ÏŒÎ¼Î¹Î±.<br>Î¤Î¿ Family Food Î¸Î± ÎµÎ¯Î½Î±Î¹ Ï€Î¬Î½Ï„Î± Î´Î¯Ï€Î»Î± ÏƒÎ¿Ï… ÏŒ,Ï„Î¹ ÎºÎ±Î¹ Î½Î± ÎµÏ€Î¹Î»Î­Î¾ÎµÎ¹Ï‚!
      </div>
      <div class="cancel-actions">
        <button id="confirmCancelBtn">ÎÎ±Î¹, Î±ÎºÏÏÏ‰ÏƒÎ·</button>
        <button id="undoCancelBtn">MÎ­Î½Ï‰ Premium!</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="chooseDishModal" tabindex="-1" aria-labelledby="chooseDishLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-choose-dish">
    <div class="modal-content choose-dish-modal-content">
      <div class="modal-header choose-dish-modal-header">
        <h5 class="modal-title" id="chooseDishLabel" style="margin-bottom:0;">
          ÎœÎ±Î³ÎµÎ¹ÏÎµÏÏ‰ Î³Î¹Î±...
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿"></button>
      </div>
      <div class="modal-body choose-dish-modal-body">
        <!-- Î•Ï€Î¹Î»Î¿Î³Î® Î·Î¼Î­ÏÎ±Ï‚ (BADGES) -->
        <div class="dish-day-row">
          <span class="dish-day-badge selected" id="choose-today-badge">Î£Î®Î¼ÎµÏÎ±</span>
          <span class="dish-day-badge" id="choose-tomorrow-badge">Î‘ÏÏÎ¹Î¿</span>
          <span class="dish-day-badge" id="choose-overmorrow-badge">ÎœÎµÎ¸Î±ÏÏÎ¹Î¿</span>
        </div>
        <!-- Î›Î¯ÏƒÏ„Î± Ï€Î¹Î¬Ï„Ï‰Î½ (OPTIONS) -->
        <form id="chooseDishForm">
          <div class="dish-options">
            <!-- Î•Î”Î© Î¤Î‘ Î Î™Î‘Î¤Î‘ Î˜Î‘ ÎœÎ Î‘Î™ÎÎŸÎ¥Î Î”Î¥ÎÎ‘ÎœÎ™ÎšÎ‘ Î‘Î ÎŸ JS -->
          </div>
        </form>
      </div>
      <div class="modal-footer choose-dish-modal-footer">
        <button type="button" class="onboarding-next-btn" id="confirmDishBtn" disabled>Î•Ï€Î¹Î²ÎµÎ²Î±Î¯Ï‰ÏƒÎ·</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="cookedDishExistsModal" tabindex="-1" aria-labelledby="cookedDishExistsLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-choose-dish">
    <div class="modal-content choose-dish-modal-content">
      <div class="modal-header choose-dish-modal-header">
        <h5 class="modal-title" id="cookedDishExistsLabel" style="margin-bottom:0;">
          ÎŸÏ…Ï€Ï‚..
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿"></button>
      </div>
      <div class="modal-body choose-dish-modal-body">
        <div style="font-size:1.1em;">
          Î¥Ï€Î¬ÏÏ‡ÎµÎ¹ Î®Î´Î· ÎºÎ±Ï„Î±Ï‡Ï‰ÏÎ·Î¼Î­Î½Î¿ Î¼Î±Î³ÎµÎ¹ÏÎµÎ¼Î­Î½Î¿ Ï€Î¹Î¬Ï„Î¿ Î³Î¹Î± Î±Ï…Ï„Î® Ï„Î· Î¼Î­ÏÎ±.<br><br>
          Î¤Î¹ Î¸Î± Î®Î¸ÎµÎ»ÎµÏ‚ Î½Î± ÎºÎ¬Î½ÎµÎ¹Ï‚;
        </div>
        <form id="conflictActionForm" style="margin-top: 18px;">
          <div class="dish-options">
            <label class="dish-option conflict-option">
              <input type="radio" name="conflictAction" value="replace" style="margin-right:12px;" checked>
              <span class="dish-label">
                <span class="dish-title">Î‘Î½Ï„Î¹ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ· Ï„Î¿Ï… Ï€Î¹Î¬Ï„Î¿Ï… Î¼Îµ Î±Ï…Ï„ÏŒ</span>
                <span class="dish-desc">Î¤Î¿ Ï€ÏÎ¿Î·Î³Î¿ÏÎ¼ÎµÎ½Î¿ Ï€Î¹Î¬Ï„Î¿ Î¸Î± Î±Ï†Î±Î¹ÏÎµÎ¸ÎµÎ¯</span>
              </span>
            </label>
            <label class="dish-option conflict-option">
              <input type="radio" name="conflictAction" value="keep_old" style="margin-right:12px;">
              <span class="dish-label">
                <span class="dish-title">Î”Î¹Î±Ï„Î®ÏÎ·ÏƒÎ· Ï„Î¿Ï… Ï€ÏÎ¿Î·Î³Î¿ÏÎ¼ÎµÎ½Î¿Ï…</span>
                <span class="dish-desc">Î¤Î¿ Î½Î­Î¿ Ï€Î¹Î¬Ï„Î¿ Î´ÎµÎ½ Î¸Î± ÎºÎ±Ï„Î±Ï‡Ï‰ÏÎ·Î¸ÎµÎ¯</span>
              </span>
            </label>
            <label class="dish-option conflict-option">
              <input type="radio" name="conflictAction" value="keep_both" style="margin-right:12px;">
              <span class="dish-label">
                <span class="dish-title">Î”Î¹Î±Ï„Î®ÏÎ·ÏƒÎ· ÎºÎ±Î¹ Ï„Ï‰Î½ 2 Ï€Î¹Î¬Ï„Ï‰Î½</span>
                <span class="dish-desc">ÎšÎ±Î¹ Ï„Î± Î´ÏÎ¿ Ï€Î¹Î¬Ï„Î± Î¸Î± Î±Ï€Î¿Î¸Î·ÎºÎµÏ…Ï„Î¿ÏÎ½ Î³Î¹Î± Ï„Î· Î¼Î­ÏÎ±</span>
              </span>
            </label>
          </div>
        </form>
      </div>
      <div class="modal-footer choose-dish-modal-footer">
        <button type="button" class="onboarding-next-btn" id="conflictActionConfirmBtn" disabled>Î£Ï…Î½Î­Ï‡ÎµÎ¹Î±</button>
      </div>
    </div>
  </div>
</div>

<!-- =================== Contact Modal =================== -->
<div id="contactModal" class="modal" style="display:none;">
  <div class="contact-modal-content">
    <button class="contact-close" onclick="closeContactModal()" title="ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿">&times;</button>
    <div class="contact-modal-title">
      <i class="fa fa-envelope" style="color:var(--brand);margin-right:6px;font-size:1.2em;"></i>
      Î•Ï€Î¹ÎºÎ¿Î¹Î½Ï‰Î½Î¯Î±/Î¥Ï€Î¿ÏƒÏ„Î®ÏÎ¹Î¾Î·
    </div>

    <form id="contactForm" onsubmit="sendContactForm(event)">
	  <div class="form-group">
		  <label for="contactMessage">ÎœÎ®Î½Ï…Î¼Î±</label>
		  <div class="textarea-wrapper">
			<textarea id="contactMessage" name="message" rows="4" required
			  placeholder="Î Î»Î·ÎºÏ„ÏÎ¿Î»ÏŒÎ³Î·ÏƒÎµ Î® Ï…Ï€Î±Î³ÏŒÏÎµÏ…ÏƒÎµ Ï„Î¿ Î¼Î®Î½Ï…Î¼Î¬ ÏƒÎ¿Ï…..."></textarea>
			<button type="button" class="voice-btn" onclick="toggleVoiceInput(this)" title="Î¦Ï‰Î½Î·Ï„Î¹ÎºÎ® ÎµÎ¹ÏƒÎ±Î³Ï‰Î³Î®">
			  <i class="fa fa-microphone"></i>
			</button>
		  </div>
		</div>
      <button type="submit" class="contact-submit">
        <i class="fa fa-paper-plane" style="margin-right:6px;"></i> Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î®
      </button>
    </form>
  </div>
</div>




{% endblock %}


{% block scripts %}


<!------------- Backend Init ------------->
<script>
window.BACKEND_FAVORITE_RECIPE_IDS = {{ favorite_recipe_ids|tojson }};
window.cookingMethodsFromBackend = {{ cooking_methods|tojson }};
window.is_premium = {{ is_premium|tojson }};

/* === GLOBAL: Î¤Î± Ï€Î¹Î¬Ï„Î± Ï„Î·Ï‚ Ï„ÎµÎ»ÎµÏ…Ï„Î±Î¯Î±Ï‚ Ï€ÏÏŒÏ„Î±ÏƒÎ·Ï‚ AI === */
window.lastAISuggestedDishes = [];

</script>

<!------------- Main Logic ------------->
<script>

const StorageKeys = {
  MAX_TIME: "max_time",
  DISH_CATEGORY: "dish_category",
  MAIN_INGREDIENT: "main_ingredient",
  METHOD_PREFS: "method_prefs",
  EXCLUDED: "excluded",
  AUX_INGREDIENTS: "aux_ingredients"
};
function setStorageItem(key, value) { try { localStorage.setItem(key, JSON.stringify(value)); } catch (e) {} }
function getStorageItem(key, fallback = null) { try { const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : fallback; } catch (e) { return fallback; } }
function setMaxTime(minutes) { setStorageItem(StorageKeys.MAX_TIME, String(minutes)); }
function getMaxTime() { return getStorageItem(StorageKeys.MAX_TIME, "500"); }
function setDishCategory(DishCategory) { setStorageItem(StorageKeys.DISH_CATEGORY, DishCategory); }
function getDishCategory() { return getStorageItem(StorageKeys.DISH_CATEGORY, null); }
function setMainIngredient(ingredient) { setStorageItem(StorageKeys.MAIN_INGREDIENT, ingredient); }
function getMainIngredient() { return getStorageItem(StorageKeys.MAIN_INGREDIENT, null); }
function setMethodPrefs(methodsArray) { setStorageItem(StorageKeys.METHOD_PREFS, methodsArray); }

function getMethodPrefs() {
  if (window.cookingMethodsFromBackend && Array.isArray(window.cookingMethodsFromBackend)) {
    return window.cookingMethodsFromBackend;
  }
  return getStorageItem(StorageKeys.METHOD_PREFS, [ 'Î¦Î¿ÏÏÎ½Î¿Ï‚', 'ÎšÎ±Ï„ÏƒÎ±ÏÏŒÎ»Î±', 'Î§ÏÏ„ÏÎ±', 'Î¤Î·Î³Î¬Î½Î¹', 'Î£Ï‡Î¬ÏÎ±', 'Air-fryer' ]);
}

function setExcluded(excludesArray) { setStorageItem(StorageKeys.EXCLUDED, excludesArray); }
function getExcluded() { return getStorageItem(StorageKeys.EXCLUDED, []); }
function setAuxIngredient(auxArray) { setStorageItem(StorageKeys.AUX_INGREDIENTS, auxArray); }
function getAuxIngredient() { return getStorageItem(StorageKeys.AUX_INGREDIENTS, []); }
function clearCookingFilters() { Object.values(StorageKeys).forEach(k => localStorage.removeItem(k)); }

const input = document.getElementById("userInput");
const inputRow = document.getElementById("chatInputRow");
const originalPlaceholder = input.placeholder;
let moreResultsClicks = 0;
let showAllRecipes = false;
let userNeedsHelp = false;

function adjustChatboxPosition() {
  const hero = document.querySelector('.recipe-hero');
  const chatboxCard = document.querySelector('.chatbox-card');
  if (!hero || !chatboxCard) return;
  const heroHeight = hero.offsetHeight;
  const cardHeight = chatboxCard.offsetHeight;
  if (cardHeight > heroHeight * 0.85) chatboxCard.classList.add('cover-hero');
  else chatboxCard.classList.remove('cover-hero');
}

function scrollChatToBottom() {
  // Î ÏÏÏ„Î± Î²ÏÎµÏ‚ Ï„Î¿ ÏƒÏ‰ÏƒÏ„ÏŒ element (chatbox-card Î® chatbox)
  var chatCard = document.querySelector('.chatbox-card');
  if (!chatCard) return;

  // Î Î¬ÏÎµ ÎŸÎ›Î•Î£ Ï„Î¹Ï‚ ÎµÎ¹ÎºÏŒÎ½ÎµÏ‚ Î¼Î­ÏƒÎ± ÏƒÏ„Î¿ chatCard Ï€Î¿Ï… Î´ÎµÎ½ Î­Ï‡Î¿Ï…Î½ Ï†Î¿ÏÏ„ÏÏƒÎµÎ¹ Î±ÎºÏŒÎ¼Î±
  var images = chatCard.querySelectorAll('img');
  var unloaded = Array.from(images).filter(img => !img.complete);

  if (unloaded.length === 0) {
    chatCard.scrollTop = chatCard.scrollHeight;
  } else {
    // ÎœÏŒÎ»Î¹Ï‚ Ï†Î¿ÏÏ„ÏÏƒÎµÎ¹ ÎºÎ±Î¹ Î· Ï„ÎµÎ»ÎµÏ…Ï„Î±Î¯Î± ÎµÎ¹ÎºÏŒÎ½Î±, scroll ÏƒÏ„Î¿ Ï„Î­Î»Î¿Ï‚!
    let loaded = 0;
    unloaded.forEach(img => {
      img.addEventListener('load', function() {
        loaded++;
        if (loaded === unloaded.length) {
          chatCard.scrollTop = chatCard.scrollHeight;
        }
      });
      img.addEventListener('error', function() {
        loaded++;
        if (loaded === unloaded.length) {
          chatCard.scrollTop = chatCard.scrollHeight;
        }
      });
    });
  }
}

window.addEventListener("DOMContentLoaded", () => {

	if (window.BACKEND_FAVORITE_RECIPE_IDS) {
		localStorage.setItem('favorite_recipe_ids', JSON.stringify(window.BACKEND_FAVORITE_RECIPE_IDS.map(Number)));
	  }

  if (!localStorage.getItem(StorageKeys.METHOD_PREFS)) setMethodPrefs(getMethodPrefs());
  if (!localStorage.getItem(StorageKeys.EXCLUDED)) setExcluded([]);
  if (!localStorage.getItem(StorageKeys.MAX_TIME)) setMaxTime(180);
  if (!localStorage.getItem(StorageKeys.DISH_CATEGORY)) setDishCategory("");
  if (!localStorage.getItem(StorageKeys.MAIN_INGREDIENT)) setMainIngredient("");
  if (!localStorage.getItem(StorageKeys.AUX_INGREDIENTS)) setAuxIngredient([]);
  if (sessionStorage.getItem('chatHistory')) {
    restoreChatHistory();
    return;
  }
  if (!document.querySelector('#chatbox .quick-replies')) {
	  renderQuickReplyOptions([
		{ label: "ÎˆÏ‰Ï‚ 30'", action: "time" },
		{ label: "ÎˆÏ‰Ï‚ 1 ÏÏÎ±", action: "time" },
		{ label: "Î Î¬Î½Ï‰ Î±Ï€ÏŒ 1,5 ÏÏÎ±", action: "time" }
	  ]);
	}
});

window.addEventListener('storage', function(e) {
  if (e.key === 'favorite_recipe_ids') {
    refreshFavorites();
  }
});

input.addEventListener("keydown", function(e) {
  if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); sendMessage(); }
});

input.addEventListener("input", function() {
  input.style.height = "auto"; input.style.height = input.scrollHeight + "px";
});

window.addEventListener('resize', adjustChatboxPosition);


function clearSuggestions() {
  fetch('/clear_suggestions', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
      // Î‘Î½ Î±Ï€Î±Î¹Ï„ÎµÎ¯Ï„Î±Î¹ CSRF token, Ï€ÏÎ¿ÏƒÎ¸ÎµÏƒÎµ Ï„Î¿ ÎµÎ´Ï
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.status === "ok") {
      console.log("Suggestions cleared!");
      // Î•Î´Ï Î²Î¬Î»Îµ ÏŒ,Ï„Î¹ Î¬Î»Î»Î¿ Î¸ÎµÏ‚ Î½Î± ÎºÎ¬Î½ÎµÎ¹Ï‚ Î¼ÎµÏ„Î¬ (Ï€.Ï‡. ÎµÎ½Î·Î¼Î­ÏÏ‰ÏƒÎ· UI)
    }
  })
  .catch(error => {
    console.error("Error clearing suggestions:", error);
  });
}


function saveChatHistory() { sessionStorage.setItem('chatHistory', document.getElementById('chatbox').innerHTML); }

function restoreChatHistory() {
  let hist = sessionStorage.getItem('chatHistory');
  if (hist) {
    document.getElementById('chatbox').innerHTML = hist;
    document.getElementById('chatbox').scrollTop = document.getElementById('chatbox').scrollHeight;
	refreshFavorites();
    rebindQuickReplyButtons();
	rebindDishCardClicks();
	rebindFavoriteHearts();
	adjustChatboxPosition();
	setTimeout(scrollChatToBottom, 5); // Î»Î¯Î³Î¿ delay Î³Î¹Î± Î½Î± Î¾ÎµÎºÎ¹Î½Î®ÏƒÎ¿Ï…Î½ Î½Î± Ï†Î¿ÏÏ„ÏÎ½Î¿Ï…Î½ Ï„Î± images
  }
}

function clearChatHistory() { sessionStorage.removeItem('chatHistory'); document.getElementById('chatbox').innerHTML = ''; }

function shuffle(array) { let arr = array.slice(); for (let i = arr.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [arr[i], arr[j]] = [arr[j], arr[i]]; } return arr; }

function mapTimeLabelToMinutes(label) { const map = {"ÎˆÏ‰Ï‚ 30'": 30, "ÎˆÏ‰Ï‚ 1 ÏÏÎ±": 60, "Î Î¬Î½Ï‰ Î±Ï€ÏŒ 1,5 ÏÏÎ±": 200}; return map[label] || 90; }

function getPreferredChef() { return localStorage.getItem("preferred_chef") || ""; }

function renderUserBubble(text) {
  const chat = document.getElementById("chatbox");
  const userBubble = document.createElement("div");
  userBubble.className = "chat-bubble from-user";
  userBubble.textContent = text;
  chat.appendChild(userBubble);
  chat.scrollTop = chat.scrollHeight;
  adjustChatboxPosition();
  const typing = document.createElement("div");
  typing.className = "typing-indicator";
  typing.textContent = "Family Food Ï€Î»Î·ÎºÏ„ÏÎ¿Î»Î¿Î³ÎµÎ¯...";
  typing.id = "typing-indicator";
  chat.appendChild(typing);
  chat.scrollTop = chat.scrollHeight;
  adjustChatboxPosition();
  saveChatHistory();
}

function renderAIBubble(text, type = "ai") {
  const chat = document.getElementById("chatbox");
  const bubble = document.createElement("div");
  bubble.className = "chat-bubble from-ai";
  bubble.innerHTML = '<span class="chat-icon">' + (type === "system" ? "ğŸ‘¨â€ğŸ³ " : "ğŸ§  ") + "</span><span>" + text + "</span>";
  chat.appendChild(bubble);
  chat.scrollTop = chat.scrollHeight;
  adjustChatboxPosition();
  scrollChatToBottom();
  saveChatHistory();
}

function renderQuickReplyOptions(options = []) {
  // Î£Î²Î®Î½ÎµÎ¹ ÎœÎŸÎÎŸ Ï„Î± Ï€ÏÎ¿Î·Î³Î¿ÏÎ¼ÎµÎ½Î± quick replies, ÎŸÎ§Î™ Ï„Î¿ carousel!
  //document.querySelectorAll('#chatbox .quick-replies').forEach(qr => qr.remove());

  const chat = document.getElementById("chatbox");
  const wrapper = document.createElement("div");
  wrapper.className = "quick-replies";
  options.forEach((opt, idx) => {
    const btn = document.createElement("div");
    btn.className = "quick-reply";
    btn.textContent = opt.label;
    btn.setAttribute('data-action', opt.action);
    btn.setAttribute('data-value', opt.label);
    btn.onclick = function() {
      handleQuickReply(this);
      wrapper.remove();
    };
    btn.style.setProperty('--delay', (idx * 45) + 'ms');
    wrapper.appendChild(btn);
  });
  chat.appendChild(wrapper);

  setTimeout(() => {
    chat.scrollTop = chat.scrollHeight;
  }, 10);

  adjustChatboxPosition();
  scrollChatToBottom();
  saveChatHistory();
}

function handleQuickReply(btn) {
  const action = btn.getAttribute('data-action');
  const value = btn.getAttribute('data-value');

  console.log("value = ", value);

  if (!action) return;

  // Î Î¬Î½Ï„Î± ÎºÎ±Î¸Î¬ÏÎ¹ÏƒÎµ Ï„Î± Ï€Î±Î»Î¹Î¬ quick replies
  //document.querySelectorAll(".quick-replies").forEach(qr => qr.remove());

  if (action === "set_dish_category") {
    renderUserBubble(value);
    setDishCategory(value);

    fetch(`/get_main_tags?category=${encodeURIComponent(value)}`)
      .then(r => r.json())
      .then(data => {
        document.getElementById("typing-indicator")?.remove();
        if (data.tags && data.tags.length > 0) {
          renderAIBubble("Î¤Î¹ Î¸Î± Î­Î»ÎµÎ³ÎµÏ‚ Î³Î¹Î± ÎºÎ¬Ï„Î¹ ÏƒÎµ..", "system");          
		  const tagOptions = data.tags.map(tag => ({
            label: tag,
            action: "set_main_ingredient_from_tag"
          }));
          tagOptions.push({ label: "Î”ÎµÎ¯Î¾Îµ Î¼Î¿Ï… ÎºÎ¬Ï„Î¹ Î¬Î»Î»Î¿", action: "ask_alt_from_category" });
          setTimeout(() => {
            renderQuickReplyOptions(tagOptions);
          }, 500);
        } else {
          renderAIBubble("Î”ÎµÎ½ Î²ÏÎ®ÎºÎ± ÎºÎ¬Ï„Î¹ ÏƒÏ‡ÎµÏ„Î¹ÎºÏŒ. Î˜ÎµÏ‚ Î½Î± Ï€ÏÎ¿Ï„ÎµÎ¯Î½Ï‰ ÎµÎ³Ï;", "system");
        }
      })
      .catch(err => {
        document.getElementById("typing-indicator")?.remove();
        renderAIBubble("âš ï¸ Î”ÎµÎ½ ÎºÎ±Ï„Î¬Ï†ÎµÏÎ± Î½Î± Ï†Î¿ÏÏ„ÏÏƒÏ‰ Ï„Î± tags...", "system");
        console.error("[ERROR] Fetching tags:", err);
      });
    return;
  }

  if (action === "set_main_ingredient_from_tag") {
    setMainIngredient(value);
    renderUserBubble(value);
	console.log("call 0");
    callAISuggest("", 0);
    return;
  }

  if (action === "ask_alt_from_category") {
    userNeedsHelp = true;
    const selectedCategory = getDishCategory();
    document.getElementById("typing-indicator")?.remove();
    renderAIBubble(`Î˜Î­Î»ÎµÎ¹Ï‚ Î½Î± Ï€Î±ÏÎ±Î¼ÎµÎ¯Î½ÎµÎ¹Ï‚ ÏƒÏ„Î·Î½ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î± "${selectedCategory}" ;`, "system");
    setTimeout(() => {
      renderQuickReplyOptions([
        { label: `Î Î±ÏÎ±Î¼Î­Î½Ï‰ ÏƒÎµ ${selectedCategory}`, action: "stay_in_category" },
        { label: "Î‘Ï‚ Î´Î¿ÏÎ¼Îµ ÎºÎ¬Ï„Î¹ Î¬Î»Î»Î¿", action: "switch_category" }
      ]);
    }, 500);
    return;
  }

  if (action === "stay_in_category") {
    const selectedCategory = getDishCategory();
    document.getElementById("typing-indicator")?.remove();
    renderAIBubble(`Î ÎµÏ‚ Î¼Î¿Ï… Ï„Î¿ Î²Î±ÏƒÎ¹ÎºÏŒ Ï…Î»Î¹ÎºÏŒ Ï€Î¿Ï… Î¸Î± Î®Î¸ÎµÎ»ÎµÏ‚ Î½Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®ÏƒÎµÎ¹Ï‚!`, "system");
    return;
  }

  if (action === "switch_category") {
    const selectedCategory = getDishCategory();
    document.getElementById("typing-indicator")?.remove();
    renderAIBubble(`Î ÎµÏ‚ Î¼Î¿Ï… Ï„Î¹ Î­Ï‡ÎµÎ¹Ï‚ ÏƒÏ„Î¿ Î¼Ï…Î±Î»ÏŒ ÏƒÎ¿Ï… Î³Î¹Î± ÏƒÎ®Î¼ÎµÏÎ±!`, "system");
    return;
  }

  if (action === "set_main_ingredient") {
    setMainIngredient(value);
    renderUserBubble(value);
	console.log("call 1");
    callAISuggest("", 1);
    return;
  }

  if (action === "ai_profile_suggest") {
    const payload = {
      message: "suggest to me a main ingredient acc. to my general preferences",
      max_time: getMaxTime(),
      main_ingredient: getMainIngredient(),
      aux_ingredients: getAuxIngredient(),
      preferred_methods: getMethodPrefs(),
      excluded: getExcluded()
    };
    fetch("/ai_reply", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    })
      .then(r => r.json())
      .then(data => {
        document.getElementById("typing-indicator")?.remove();
        if (data.filters) updateFiltersFromAIResponse(data.filters);
        if (data.reply) renderAIBubble(data.reply);
      })
      .catch(err => {
        document.getElementById("typing-indicator")?.remove();
        renderAIBubble("âš ï¸ ÎšÎ¬Ï„Î¹ Ï€Î®Î³Îµ ÏƒÏ„ÏÎ±Î²Î¬. Î ÏÎ¿ÏƒÏ€Î¬Î¸Î·ÏƒÎµ Î¾Î±Î½Î¬.", "system");
      });
    return;
  }

  if (action === "more_results") {
	  renderUserBubble(value);
	  moreResultsClicks++;
	  document.getElementById("typing-indicator")?.remove();

	  if (showAllRecipes === true) {
		console.log("shown all");
		renderAIBubble(`Î”Îµ Î¼Ï€Î¿ÏÎ­ÏƒÎ±Î¼Îµ Î½Î± Î²ÏÎ¿ÏÎ¼Îµ Î¬Î»Î»ÎµÏ‚ ÏƒÏ…Î½Ï„Î±Î³Î­Ï‚ Î¼Îµ ${getMainIngredient()}.. Î˜Î± Î®Î¸ÎµÎ»ÎµÏ‚ Î½Î± ÏˆÎ¬Î¾Î¿Ï…Î¼Îµ ÎºÎ¬Ï„Î¹ Î¬Î»Î»Î¿; Î ÎµÏ‚ Î¼Î¿Ï…, Ï€ÏŒÏƒÎ¿ Ï‡ÏÏŒÎ½Î¿ Î­Ï‡ÎµÎ¹Ï‚ ÎºÎ±Î¹ Ï„Î¹ Ï…Î»Î¹ÎºÏŒ Î¸Î± Î®Î¸ÎµÎ»ÎµÏ‚ Î½Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®ÏƒÎµÎ¹Ï‚;`,"system");
		setDishCategory("");
		setMainIngredient(""); 	
		setAuxIngredient("");
		clearSuggestions();
		showAllRecipes = false;
		console.log("showAllRecipes = ",showAllRecipes);
		return;
	  }
	  const more2show = localStorage.getItem("More2ShowfromAI_0");
	  if (more2show === "1") {
		// ÎšÎ¬Î»ÎµÏƒÎµ Î¼Îµ step=0 (Î´Î·Î». ÏƒÏ…Î½Î­Ï‡Î¹ÏƒÎµ Î±Ï€ÏŒ Ï„Î¿ Branch 0)
		console.log("call 0");
		callAISuggest("", 0);
	  } else {
		// Î”ÎµÎ½ Î­Ï‡ÎµÎ¹ Î¬Î»Î»Î± ÏƒÏ„Î¿ Branch 0, ÏƒÏ…Î½Î­Ï‡Î¹ÏƒÎµ Î¼Îµ step=1
		console.log("call 1");
		callAISuggest(getMainIngredient(), 1);
	  }

	  return;
	}

  if (action === "confirm_choice") {
	  var typingIndicator = document.getElementById("typing-indicator");
	  if (typingIndicator) typingIndicator.remove();
	  showChooseDishModal(); // <-- Î‘Î½Î¿Î¯Î³ÎµÎ¹ Ï„Î¿ modal ÎºÎ±Î¹ Î³ÎµÎ¼Î¯Î¶ÎµÎ¹ Ï„Î± Ï€Î¹Î¬Ï„Î±
	  return;
	}

  if (action === "time") {
    renderUserBubble(value);
    setMaxTime(mapTimeLabelToMinutes(value));
    const maxTime = getMaxTime();
    const DishCategory = getDishCategory();
    const mainIngredient = getMainIngredient();
    if (maxTime > 0 && DishCategory && mainIngredient) {
		console.log("call 1");
      callAISuggest("", 1);
    } else if (maxTime > 0 && !mainIngredient && action === "time") {
      document.getElementById("typing-indicator")?.remove();
      renderAIBubble("Î¤Î¹ Î¸Î± Î®Î¸ÎµÎ»ÎµÏ‚ Î½Î± Î´Î¿ÏÎ¼Îµ Î³Î¹Î± ÏƒÎ®Î¼ÎµÏÎ±; Î•Ï€Î¯Î»ÎµÎ¾Îµ Î¼Î¹Î± ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î± Î±Ï€ÏŒ Ï„Î¹Ï‚ Ï€Î±ÏÎ±ÎºÎ¬Ï„Ï‰, Î® Î³ÏÎ¬ÏˆÎµ ÏƒÏ„Î¿ chat Ï„Î¹ Î­Ï‡ÎµÎ¹Ï‚ ÏƒÏ„Î¿ Î¼Ï…Î±Î»ÏŒ ÏƒÎ¿Ï…!", "system");
      setTimeout(() => {
         fetchDishCategoriesAndRenderQuickReplies()
      }, 500);
    }
    return;
  }

  if (action === "exclude_method") {
    setMethodPrefs(getMethodPrefs().filter(m => m !== value.trim()));
    return;
  }
  
  if (action === "exclude_ingredient") {
    setExcluded([...getExcluded(), value.toLowerCase()]);
    return;
  }

  if (action === "show_all_by_time") {
	  renderUserBubble(value);
	  setDishCategory("");
	  setAuxIngredient("");
	  setMainIngredient("");
	  console.log("call 1");
	  callAISuggest("", 1);
	  return;
	}

  if (action === "show_all_recipes") {
	  renderUserBubble(value);
	  showAllRecipes = true
	  localStorage.removeItem("max_time");
	  console.log("call 1");
	  callAISuggest(getMainIngredient(), 1);
	  return;
	}

}

function fetchDishCategoriesAndRenderQuickReplies() {
  fetch('/api/dish_categories')
    .then(r => r.json())
    .then(data => {
      const categories = Array.isArray(data.categories) ? data.categories : [];
      renderQuickReplyOptions(
        shuffle(categories).map(label => ({
          label,
          action: "set_dish_category"
        }))
      );
    })
    .catch(err => {
      console.error('[ERROR] Failed to fetch dish categories:', err);
      renderQuickReplyOptions([]);
    });
}

function rebindQuickReplyButtons() {
  const quickReplies = document.querySelectorAll("#chatbox .quick-reply");
  quickReplies.forEach(btn => {
    btn.onclick = function() {
      handleQuickReply(this);
      if (btn.parentNode && btn.parentNode.classList.contains('quick-replies')) {
        btn.parentNode.remove();
      }
    };
  });
}

function rebindDishCardClicks() {
  const cards = document.querySelectorAll('#chatbox .similar-card-item');
  cards.forEach(card => {
    const recipeId = card.getAttribute('data-recipe-id');
    if (recipeId) {
      card.onclick = function() {
        window.location.href = '/recipe_page/' + recipeId;
      };
    }
  });
}

function rebindFavoriteHearts() {
  // Î’ÏÎµÏ‚ ÎŸÎ›Î‘ Ï„Î± hearts Ï€Î¿Ï… ÎµÎ¯Î½Î±Î¹ "ÎºÎ±ÏÎ´Î¿ÏÎ»ÎµÏ‚ favorite"
  document.querySelectorAll('.similar-card-item span[style*="position: absolute"]').forEach(favWrapper => {
    const card = favWrapper.closest('.similar-card-item');
    if (!card) return;
    const recipeId = card.getAttribute('data-recipe-id');
    if (!recipeId) return;
    favWrapper.onclick = function(e) {
      e.stopPropagation();
	  refreshFavorites();
      toggleFavorite(favWrapper, recipeId);
    };
  });
}

function renderDishCards(dishes = []) {
  //document.querySelectorAll('#chatbox .chat-carousel-row').forEach(e => e.remove());

  const chatbox = document.getElementById("chatbox");
  const carouselRow = document.createElement("div");
  carouselRow.className = "chat-carousel-row";
  const wrapper = document.createElement("div");
  wrapper.className = "similar-swiper";
  carouselRow.appendChild(wrapper);

  dishes.forEach((dish) => {
    const item = document.createElement('div');
    item.className = 'similar-card-item';
    item.setAttribute('data-recipe-id', dish.id);
    item.style.position = "relative";
    item.onclick = function() {
      window.location = '/recipe_page/' + dish.id;
    };

	var imgSrc = dish.image_url || '/static/images/placeholder.jpg';
	var chefAvatar = dish.chef_avatar || '/static/images/avatars/default.jpg';
	var html = ''
	  + '<img class="card-main-img" src="' + imgSrc + '" alt="' + dish.title + '" onerror="this.src=\'/static/images/placeholder.jpg\'">'
	  + '<div class="similar-card-item-title">' + dish.title + '</div>'
	  + '<div class="similar-card-item-meta">'
		+ '<i class="fa fa-clock"></i>'
		+ '<span class="similar-card-item-time-val">' + (dish.total_time ? dish.total_time + "'" : "-") + '</span>'
		+ '<span class="chef-by-label">by</span>'
		+ '<img class="chef-avatar-inline" src="' + chefAvatar + '" alt="Chef" onerror="this.src=\'/static/images/avatars/default.jpg\'">'
	  + '</div>';


    item.innerHTML = html;

    const favWrapper = document.createElement("span");
    favWrapper.style.position = "absolute";
    favWrapper.style.top = "7px";
    favWrapper.style.right = "11px";
    favWrapper.style.zIndex = "10";
    favWrapper.style.cursor = "pointer";
    favWrapper.innerHTML =
      '<i class="' + (isFavorite(dish.id) ? 'fas' : 'far') + ' fa-heart" style="color: #1a6e38; font-size: 20px; filter: drop-shadow(0 2px 5px #fff2);"></i>';
    favWrapper.onclick = function(e) {
      e.stopPropagation();
      toggleFavorite(favWrapper, dish.id);
    };
    item.appendChild(favWrapper);

    wrapper.appendChild(item);
	
  });

  // === Î•Î”Î© Î· Î±ÏƒÏ†Î±Î»Î®Ï‚ ÎµÎºÎ´Î¿Ï‡Î® ===
  const inputRow = document.getElementById("chatInputRow");
  if (inputRow && inputRow.parentNode === chatbox) {
    chatbox.insertBefore(carouselRow, inputRow);
  } else {
    chatbox.appendChild(carouselRow);
  }

	setTimeout(function() {
	  renderQuickReplyOptions([
		{ label: "Î˜Î± Î¼Î±Î³ÎµÎ¹ÏÎ­ÏˆÏ‰ ÎºÎ¬Ï„Î¹ Î±Ï€ÏŒ Ï„Î± Ï€Î±ÏÎ±Ï€Î¬Î½Ï‰", action: "confirm_choice" },
		{ label: "Î˜Î± Î®Î¸ÎµÎ»Î± Î½Î± Î´Ï‰ ÎºÎ¬Ï„Î¹ Î¬Î»Î»Î¿", action: "more_results" }
	  ], carouselRow);
	}, 350);

  scrollChatToBottom();
  saveChatHistory();
}

function updateFiltersFromAIResponse(filters) {
  if (!filters || typeof filters !== "object") return;
  const keys = Object.keys(filters);
  for (let key of keys) {
    switch (key) {
      case "max_time": setMaxTime(filters[key]); break;
      case "main_ingredient": setMainIngredient(filters[key]); break;
      case "aux_ingredients": setAuxIngredient(filters[key]); break;
      case "cooking_method": setMethodPrefs(filters[key]); break;
      case "excluded_keywords": setExcluded(filters[key]); break;
    }
  }
}

function sendMessage() {
  const msg = input.value.trim();
  if (!msg) return;
  handleFreeUserMessage(msg);
  input.value = "";
  input.placeholder = originalPlaceholder;
  input.style.height = "auto";
}

function handleFreeUserMessage(text) {
  renderUserBubble(text);
  const payload = {
    message: text,
    max_time: getMaxTime(),
    main_ingredient: getMainIngredient(),
    aux_ingredients: getAuxIngredient(),
    preferred_methods: getMethodPrefs(),
    excluded: getExcluded()
  };
  fetch("/ai_reply", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  })
    .then(r => r.json())
    .then(data => {
      document.getElementById("typing-indicator")?.remove();
      if (data.logout) {
        renderAIBubble("Î— ÏƒÏ…Î½ÎµÎ´ÏÎ¯Î± Ï„ÎµÏÎ¼Î±Ï„Î¯ÏƒÏ„Î·ÎºÎµ Î³Î¹Î± Î»ÏŒÎ³Î¿Ï…Ï‚ Î±ÏƒÏ†Î±Î»ÎµÎ¯Î±Ï‚.", "system");
        return setTimeout(() => (window.location.href = "/logout"), 2000);
      }
      if (data.filters) updateFiltersFromAIResponse(data.filters);
      const maxTime = getMaxTime();
      const mainIngredient = getMainIngredient();
      if (maxTime > 0 && mainIngredient) {
	  	console.log("call 1");
        callAISuggest(text, 1);
      } else if (data.reply) {
        renderAIBubble(data.reply);
      }
    })
    .catch(err => {
      document.getElementById("typing-indicator")?.remove();
      renderAIBubble("âš ï¸ ÎšÎ¬Ï„Î¹ Ï€Î®Î³Îµ ÏƒÏ„ÏÎ±Î²Î¬. Î ÏÎ¿ÏƒÏ€Î¬Î¸Î·ÏƒÎµ Î¾Î±Î½Î¬.", "system");
    });
}

function callAISuggest(userMessage = "", step) {
  const filters = {
    max_time: getMaxTime(),
    dish_category: getDishCategory(),
    main_ingredient: getMainIngredient(),
    aux_ingredient: getAuxIngredient(),
    excluded: getExcluded(),
    preferred_methods: getMethodPrefs(),
    chef: getPreferredChef()
  };
  
  
  // ÎšÏÎ±Ï„Î¬ÎµÎ¹ Î¼ÏŒÎ½Î¿ Ï„Î± Ï†Î¯Î»Ï„ÏÎ± Ï€Î¿Ï… Î­Ï‡Î¿Ï…Î½ Ï€ÏÎ±Î³Î¼Î±Ï„Î¹ÎºÎ® Ï„Î¹Î¼Î® (ÏŒÏ‡Î¹ undefined, "", null Î® [])
  const filteredFilters = {};
  Object.keys(filters).forEach(k => {
    const val = filters[k];
    if (Array.isArray(val)) {
      if (val.length > 0) filteredFilters[k] = val;
    } else if (val !== undefined && val !== null && val !== "") {
      filteredFilters[k] = val;
    }
  });
  
  
  const payload = {
    step: step,
    message: userMessage,
    ...filters
  };
  
  console.log(payload);
  
  fetch("/ai_suggest_dish", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  })
    .then(r => r.json())
    .then(data => {
	  console.log("AI_suggest return = ", data);
      document.getElementById("typing-indicator")?.remove();
      
	  if (data.success === false && data.step === 0) {
        renderAIBubble(`Î”Îµ Î²ÏÎ­Î¸Î·ÎºÎµ ÎºÎ¬Ï€Î¿Î¹Î¿ Î¬Î»Î»Î¿ Ï€Î¹Î¬Ï„Î¿ Î¼Îµ ${filters.main_ingredient} Ï€Î¿Ï… Î½Î± Ï„Î±Î¹ÏÎ¹Î¬Î¶ÎµÎ¹ ÏƒÏ„Î¹Ï‚ Ï€ÏÎ¿Ï„Î¹Î¼Î®ÏƒÎµÎ¹Ï‚ ÏƒÎ¿Ï….. Î ÏÏ‚ Î¸Î± Î®Î¸ÎµÎ»ÎµÏ‚ Î½Î± ÏƒÏ…Î½ÎµÏ‡Î¯ÏƒÎ¿Ï…Î¼Îµ;`, "system");
		console.log("data.step = ",data.step);
		setTimeout(() => {
		  renderQuickReplyOptions([
			{ label: `Î”ÎµÎ¯Î¾Îµ Î¼Î¿Ï… ÏŒÎ»ÎµÏ‚ Ï„Î¹Ï‚ ÏƒÏ…Î½Ï„Î±Î³Î­Ï‚ Î¼Îµ ${filters.main_ingredient}`, action: "show_all_recipes" },
			{ label: `Î”ÎµÎ¯Î¾Îµ Î¼Î¿Ï… Î¬Î»Î»ÎµÏ‚ ÏƒÏ…Î½Ï„Î±Î³Î­Ï‚ Î²Î¬ÏƒÎµÎ¹ Ï„Ï‰Î½ Ï€ÏÎ¿Ï„Î¹Î¼Î®ÏƒÎµÏÎ½ Î¼Î¿Ï…`, action: "show_all_by_time" }
		  ]);
		}, 500);
		clearSuggestions();
		
        return;
      }
	 
      if (data.success === false && data.step === 1) {
        renderAIBubble("Î”Ï…ÏƒÏ„Ï…Ï‡ÏÏ‚ Î´Îµ Î²ÏÎ­Î¸Î·ÎºÎµ ÎºÎ¬Ï€Î¿Î¹Î¿ Ï€Î¹Î¬Ï„Î¿ Ï€Î¿Ï… Î½Î± Ï„Î±Î¹ÏÎ¹Î¬Î¶ÎµÎ¹ ÏƒÏ„Î¹Ï‚ Ï€ÏÎ¿Ï„Î¹Î¼Î®ÏƒÎµÎ¹Ï‚ ÏƒÎ¿Ï…. Î˜ÎµÏ‚ Î½Î± Ï„Î¿ Î¾Î±Î½Î±Ï€ÏÎ¿ÏƒÏ€Î±Î¸Î®ÏƒÎ¿Ï…Î¼Îµ; Î ÎµÏ‚ Î¼Î¿Ï… Ï€ÏŒÏƒÎ¿ Ï‡ÏÏŒÎ½Î¿ Î­Ï‡ÎµÎ¹Ï‚ ÏƒÏ„Î· Î´Î¹Î¬Î¸ÎµÏƒÎ® ÏƒÎ¿Ï… ÎºÎ±Î¹ Ï„Î¹ Ï…Î»Î¹ÎºÏŒ Î¸Î± Î®Î¸ÎµÎ»ÎµÏ‚ Î½Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®ÏƒÎµÎ¹Ï‚;", "system");
		setMaxTime(500);
	    setDishCategory("");
	    setAuxIngredient("");
	    setMainIngredient("");
	    return;
	  }

	  
      if (data.message) renderAIBubble(data.message);
	  console.log("dishes = ",data.dishes);
      
	  if (data.dishes?.length) {
		  window.lastAISuggestedDishes = data.dishes
		  renderDishCards(data.dishes); 
		}
      
	  if (!data.dishes || data.dishes.length === 0) {
        if (typeof initLocalState === "function") initLocalState();
      }
	  
	    // === ÎÎ•ÎŸ: ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î³Î¹Î± Ï€ÎµÏÎ¹ÏƒÏƒÏŒÏ„ÎµÏÎ± Î±Ï€Î¿Ï„ÎµÎ»Î­ÏƒÎ¼Î±Ï„Î± ÏƒÏ„Î¿ step=0 ===
	  if (data.matches_count !== undefined && data.dishes && typeof step !== "undefined" && step === 0) {
		if (data.matches_count > data.dishes.length) {
		  localStorage.setItem("More2ShowfromAI_0", "1");
		  localStorage.setItem("More2ShowfromAI_0_total", data.matches_count);
		} else {
		  localStorage.setItem("More2ShowfromAI_0", "0");
		  localStorage.setItem("More2ShowfromAI_0_total", data.matches_count || "0");
		}
	  }     
    })
    .catch(err => {
	  console.log(err);
      document.getElementById("typing-indicator")?.remove();
      renderAIBubble("âš ï¸ ÎšÎ¬Ï„Î¹ Ï€Î®Î³Îµ ÏƒÏ„ÏÎ±Î²Î¬ ÏƒÏ„Î·Î½ Ï€ÏÏŒÏ„Î±ÏƒÎ·.", "system");
    });
}

function startSpeechRecognition() {
  if (!('webkitSpeechRecognition' in window)) {
    alert("ÎŸ browser ÏƒÎ¿Ï… Î´ÎµÎ½ Ï…Ï€Î¿ÏƒÏ„Î·ÏÎ¯Î¶ÎµÎ¹ Ï†Ï‰Î½Î·Ï„Î¹ÎºÎ® Î±Î½Î±Î³Î½ÏÏÎ¹ÏƒÎ·.");
    return;
  }
  const recognition = new webkitSpeechRecognition();
  recognition.lang = 'el-GR';
  recognition.continuous = false;
  recognition.interimResults = false;
  input.placeholder = "ğŸ™ï¸ Î£Îµ Î±ÎºÎ¿ÏÏ‰...";
  inputRow.classList.add("voice-active");
  recognition.onresult = function(event) {
    const transcript = event.results[0][0].transcript.trim();
    input.value = transcript;
    input.dispatchEvent(new Event("input"));
    resetInputUI();
  };
  recognition.onerror = function(event) {
    alert("Î£Ï†Î¬Î»Î¼Î± Î¼Î¹ÎºÏÎ¿Ï†ÏÎ½Î¿Ï…: " + event.error);
    resetInputUI();
  };
  recognition.onend = function() { resetInputUI(); };
  recognition.start();
}

function resetInputUI() {
  input.placeholder = originalPlaceholder;
  inputRow.classList.remove("voice-active");
}

</script>

<!------------ OffCanvas ------------->
<script>
// === OFFCANVAS LOGIC ===

// Î†Î½Î¿Î¹Î³Î¼Î± Î±Ï€ÏŒ Ï„Î¿ hamburger button
document.querySelector('.fa-bars').closest('button').onclick = openOffcanvas;

function openOffcanvas() {
  document.getElementById('offcanvas').classList.add('open');
  document.getElementById('offcanvas-backdrop').classList.add('open');
  document.body.style.overflow = 'hidden'; // Î³Î¹Î± Î½Î± Î¼Î·Î½ scrollÎ¬ÏÎµÎ¹ Ï„Î¿ body
}

function closeOffcanvas() {
  document.getElementById('offcanvas').classList.remove('open');
  document.getElementById('offcanvas-backdrop').classList.remove('open');
  document.body.style.overflow = '';
}

// Î ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÎ¬: ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿ Î¼Îµ ESC
document.addEventListener('keydown', function(e) {
  if (e.key === "Escape") closeOffcanvas();
});

document.addEventListener('DOMContentLoaded', function() {
  var historyBtn = document.querySelector('button.offcanvas-link[data-href="/history"]');
  if (!historyBtn) return;

  historyBtn.addEventListener('click', function(e) {
    // Î£Ï„Î±Î¼Î¬Ï„Î± ÎšÎ‘Î˜Î• Î¬Î»Î»Î¿ click handler/redirect:
    e.preventDefault();
    e.stopImmediatePropagation();

    if ( window.is_premium === false ) {
      var modal = document.getElementById("upgradeModal");
      var backdrop = document.getElementById("upgradeModalBackdrop");
      if (modal && backdrop) {
        modal.style.display = "flex";
        backdrop.style.display = "block";
      }
      return false;
    }
    // Î‘Î½ ÎµÎ¯Î½Î±Î¹ premium ÎºÎ¬Î½Îµ redirect
	if (typeof closeOffcanvas === "function") closeOffcanvas();
    window.location.href = "/history";
  }, true); // <-- Î£Î—ÎœÎ•Î™Î©Î£Î—: Î”ÎµÏ‚ Ï„Î¿ true! (useCapture)

});

document.addEventListener('DOMContentLoaded', function() {
  var btn = document.getElementById('favRecipesBtn');
  if(btn) {
    btn.addEventListener('click', function() {
      if (typeof closeOffcanvas === "function") closeOffcanvas();
	  window.location = "/fav_recipes";
    });
  }
});

document.addEventListener('DOMContentLoaded', function() {
  var btn = document.getElementById('PantryBtn');
  if(btn) {
    btn.addEventListener('click', function() {
      if (typeof closeOffcanvas === "function") closeOffcanvas();
	  window.location = "/pantry";
    });
  }
});

</script>

<!------------ Logout ------------->
<script>

// === LOGOUT CONFIRM LOGIC (Î”Î¥ÎÎ‘ÎœÎ™ÎšÎŸ MODAL) ===
function logoutUser() {
  // Î‘Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Î®Î´Î·, Î¼Î·Î½ Ï„Î¿ Î¾Î±Î½Î±Î²Î¬Î»ÎµÎ¹Ï‚
  if (document.getElementById('logoutConfirmModal')) return;

  // Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± backdrop
  const backdrop = document.createElement('div');
  backdrop.id = 'logoutModalBackdrop';
  backdrop.className = 'modal-logout-backdrop open';
  backdrop.onclick = closeLogoutModal;

  // Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± modal
  const modal = document.createElement('div');
  modal.id = 'logoutConfirmModal';
  modal.className = 'modal-logout open';
  modal.innerHTML = `
    <div class="modal-logout-content">
      <div class="modal-logout-title">
        <i class="fa fa-sign-out-alt"></i> Î‘Ï€Î¿ÏƒÏÎ½Î´ÎµÏƒÎ·;
      </div>
      <div class="modal-logout-msg">
        Î•Ï€Î¹Î¸Ï…Î¼ÎµÎ¯Ï‚ ÏƒÎ¯Î³Î¿Ï…ÏÎ± Î½Î± Î±Ï€Î¿ÏƒÏ…Î½Î´ÎµÎ¸ÎµÎ¯Ï‚;<br>
        <span style="color:var(--red); font-weight:600;">ÎŸÎ¹ Ï€ÏÎ¿Ï„Î¹Î¼Î®ÏƒÎµÎ¹Ï‚ ÏƒÎ¿Ï… Î³Î¹Î± ÏƒÎ®Î¼ÎµÏÎ± Î¸Î± Î´Î¹Î±Î³ÏÎ±Ï†Î¿ÏÎ½!</span>
      </div>
      <div class="modal-logout-actions">
        <button class="btn-logout-cancel" onclick="closeLogoutModal()">Î‘ÎºÏÏÏ‰ÏƒÎ·</button>
        <button class="btn-logout-confirm" onclick="confirmLogout()">Î‘Ï€Î¿ÏƒÏÎ½Î´ÎµÏƒÎ·</button>
      </div>
    </div>
  `;

  document.body.appendChild(backdrop);
  document.body.appendChild(modal);
  document.body.style.overflow = 'hidden';

  // ÎšÎ»ÎµÎ¯ÏƒÎµ Ï„Î¿ offcanvas Î±Î½ ÎµÎ¯Î½Î±Î¹ Î±Î½Î¿Î¹Ï‡Ï„ÏŒ
  if (typeof closeOffcanvas === 'function') closeOffcanvas();
}

function closeLogoutModal() {
  const modal = document.getElementById('logoutConfirmModal');
  const backdrop = document.getElementById('logoutModalBackdrop');
  if (modal) modal.remove();
  if (backdrop) backdrop.remove();
  document.body.style.overflow = '';
}

function confirmLogout() {
  localStorage.clear();
  window.location.href = '/logout';
}

// Î ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÎ¬: ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿ Î¼Îµ Escape
document.addEventListener('keydown', function(e) {
  if (e.key === "Escape") closeLogoutModal();
});
</script>

<!------------- Fanorites Handling ------------->
<script>
function toggleFavorite(wrapper, recipe_id) {
  // Î’ÎµÎ²Î±Î¹ÏÏƒÎ¿Ï… ÏŒÏ„Î¹ Ï„Î¿ recipe_id ÎµÎ¯Î½Î±Î¹ Î Î‘ÎÎ¤Î‘ Î±ÏÎ¹Î¸Î¼ÏŒÏ‚!
  recipe_id = Number(recipe_id);

  let favIds = [];
  try {
    favIds = JSON.parse(localStorage.getItem('favorite_recipe_ids') || '[]');
  } catch (e) {}

  // Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· backend
  fetch('/toggle_favorite_recipe', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ recipe_id: recipe_id })
  })
  .then(r => {
    return r.json();
  })
  .then(data => {

    const isAdded = data.status === "added";
    let idx = favIds.findIndex(x => Number(x) === recipe_id);

    if (isAdded && idx === -1) {
      favIds.push(recipe_id);
    } else if (!isAdded && idx !== -1) {
      favIds.splice(idx, 1);
    }
    localStorage.setItem('favorite_recipe_ids', JSON.stringify(favIds));

    // === Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎµ Ï„Î¿ ÎµÎ¹ÎºÎ¿Î½Î¯Î´Î¹Î¿ ===
    wrapper.innerHTML = '<i class="' + (isAdded ? 'fas' : 'far') + ' fa-heart" style="color: var(--brand); font-size: 18px; vertical-align: -2px; cursor: pointer;"></i>';
    const icon = wrapper.querySelector("i");
    if (icon) {
      icon.onclick = function(e) {
        e.stopPropagation();
        toggleFavorite(wrapper, recipe_id);
      };
    }
  })
  .catch(err => {
    console.error('toggleFavorite error:', err);
  });
}

function isFavorite(recipe_id) {
  recipe_id = Number(recipe_id);
  try {
    const favIds = JSON.parse(localStorage.getItem('favorite_recipe_ids') || '[]');
    return favIds.map(x => Number(x)).includes(recipe_id);
  } catch (e) {
    return false;
  }
}

function refreshFavorites() {
  const allCards = document.querySelectorAll('.similar-card-item');

  allCards.forEach(card => {
    const recipeId = card.getAttribute('data-recipe-id');

    const favWrapper = card.querySelector('span[style*="position: absolute"]');
    if (!favWrapper) {
      return;
    }

    const fav = isFavorite(recipeId);

    favWrapper.innerHTML =
      '<i class="' + (fav ? 'fas' : 'far') + ' fa-heart" style="color: #1a6e38; font-size: 20px; filter: drop-shadow(0 2px 5px #fff2);"></i>';

    const icon = favWrapper.querySelector("i");
    if (icon) {
      icon.onclick = function(e) {
        e.stopPropagation();
        toggleFavorite(favWrapper, recipeId);
      };
    } else {
    }
  });
}

</script>

<!------------ Restart Chat ------------->
<script>

window.addEventListener("DOMContentLoaded", function() {
  const btn = document.getElementById("restartChatBtn");
  if (!btn) return;
  const hasHistory = !!sessionStorage.getItem('chatHistory');
  btn.style.display = hasHistory ? 'inline-flex' : 'none';
});

function restartChat() {
  showRestartModal();
}

function showRestartModal() {
  // Î‘Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Î®Î´Î·, Î¼Î·Î½ Ï„Î¿ Î¾Î±Î½Î±Î²Î¬Î»ÎµÎ¹Ï‚
  if (document.getElementById('restartConfirmModal')) return;

  // Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± backdrop
  const backdrop = document.createElement('div');
  backdrop.id = 'restartModalBackdrop';
  backdrop.className = 'modal-logout-backdrop open';
  backdrop.onclick = closeRestartModal;

  // Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± modal
  const modal = document.createElement('div');
  modal.id = 'restartConfirmModal';
  modal.className = 'modal-logout open';
  modal.innerHTML = `
    <div class="modal-logout-content">
      <div class="modal-logout-title">
        <i class="fa fa-undo"></i> Î•Ï€Î±Î½Î±Ï†Î¿ÏÎ¬ ÏƒÏ…Î½Î¿Î¼Î¹Î»Î¯Î±Ï‚;
      </div>
      <div class="modal-logout-msg">
        Î˜Î­Î»ÎµÎ¹Ï‚ ÏƒÎ¯Î³Î¿Ï…ÏÎ± Î½Î± ÎµÏ€Î±Î½Î±Ï†Î­ÏÎµÎ¹Ï‚ Ï„Î¿ Î¹ÏƒÏ„Î¿ÏÎ¹ÎºÏŒ Ï„Î·Ï‚ ÏƒÏ…Î½Î¿Î¼Î¹Î»Î¯Î±Ï‚;<br>
        <span style="color:var(--red); font-weight:600;">ÎŸÎ¹ Ï€ÏÎ¿Ï„Î¹Î¼Î®ÏƒÎµÎ¹Ï‚ ÏƒÎ¿Ï… Î³Î¹Î± ÏƒÎ®Î¼ÎµÏÎ± Î¸Î± Î´Î¹Î±Î³ÏÎ±Ï†Î¿ÏÎ½!</span>
      </div>
      <div class="modal-logout-actions">
        <button class="btn-logout-cancel" onclick="closeRestartModal()">Î‘ÎºÏÏÏ‰ÏƒÎ·</button>
        <button class="btn-logout-confirm" onclick="confirmRestart()">Î•Ï€Î±Î½Î±Ï†Î¿ÏÎ¬</button>
      </div>
    </div>
  `;

  document.body.appendChild(backdrop);
  document.body.appendChild(modal);
  document.body.style.overflow = 'hidden';
}

function closeRestartModal() {
  const modal = document.getElementById('restartConfirmModal');
  const backdrop = document.getElementById('restartModalBackdrop');
  if (modal) modal.remove();
  if (backdrop) backdrop.remove();
  document.body.style.overflow = '';
}

function confirmRestart() {
  clearChatHistory();
  localStorage.removeItem("aux_ingredients");
  localStorage.removeItem("dish_category");
  localStorage.removeItem("excluded");
  localStorage.removeItem("main_ingredient");
  localStorage.removeItem("max_time");
  localStorage.removeItem("method_prefs");
  location.reload();
}

// ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿ Î¼Îµ Escape
document.addEventListener('keydown', function(e) {
  if (e.key === "Escape") closeRestartModal();
});
</script>

<!------------ Premium modal ------------->
<script>
// Î†Î½Î¿Î¹Î³Î¼Î± Ï„Î¿Ï… Î¯Î´Î¹Î¿Ï… Upgrade modal ÏŒÏ€Ï‰Ï‚ ÏƒÏ„Î¿ Ï€ÏÎ¿Ï†Î¯Î» (Î±Î½ Î­Ï‡ÎµÎ¹Ï‚ Î®Î´Î· Ï„Î¿ modal ÏƒÏ„Î· ÏƒÎµÎ»Î¯Î´Î±)
var btn = document.getElementById("offcanvasUpgradeBtn");
if (btn) {
  btn.addEventListener("click", function() {
    if (typeof closeOffcanvas === "function") closeOffcanvas();
    document.getElementById("upgradeModal").style.display = "flex";
    document.getElementById("upgradeModalBackdrop").style.display = "block";
  });
}

document.getElementById("closeUpgradeModalBtn").addEventListener("click", function() {
  document.getElementById("upgradeModal").style.display = "none";
  document.getElementById("upgradeModalBackdrop").style.display = "none";
});

function openPremiumModal() {
  document.getElementById('premiumModal').style.display = 'flex';
}
function closePremiumModal() {
  document.getElementById('premiumModal').style.display = 'none';
}

</script>

<!------------ Premium cancellation ------------->
<script>
var cancelBtn = document.getElementById('cancelSubBtn');
var modal = document.getElementById('cancelConfirmModal');
var confirmBtn = document.getElementById('confirmCancelBtn');
var undoBtn = document.getElementById('undoCancelBtn');

// Î†Î½Î¿Î¹Î³Î¼Î± Ï„Î¿Ï… custom modal ÏŒÏ„Î±Î½ Ï€Î±Ï„Î¬Ï‚ Ï„Î¿ ÎºÎ¿Ï…Î¼Ï€Î¯ Î±ÎºÏÏÏ‰ÏƒÎ·Ï‚
if (cancelBtn && modal) {
  cancelBtn.addEventListener('click', function(e) {
     if (typeof closePremiumModal === "function") closePremiumModal();
	e.preventDefault();
    modal.classList.add('open');
  });
}

// ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿ modal ÏŒÏ„Î±Î½ Ï€Î±Ï„Î¬ÎµÎ¹ "Î†ÏƒÏ„Î¿, Î¼Î­Î½Ï‰ Plus!"
if (undoBtn && modal) {
  undoBtn.addEventListener('click', function() {
    modal.classList.remove('open');
    // Î•Ï€Î±Î½Î±Ï†Î­ÏÎ¿Ï…Î¼Îµ Ï„Î¿ ÎºÎ¿Ï…Î¼Ï€Î¯ Î±ÎºÏÏÏ‰ÏƒÎ·Ï‚ (ÏƒÎµ Ï€ÎµÏÎ¯Ï€Ï„Ï‰ÏƒÎ· Ï€Î¿Ï… Î±ÎºÏÏÏ‰ÏƒÎµ Ï€ÏÎ¹Î½)
    if (confirmBtn) {
      confirmBtn.disabled = false;
      confirmBtn.textContent = "ÎÎ±Î¹, Î±ÎºÏÏÏ‰ÏƒÎ·";
    }
  });
}

// ÎšÎ¿Ï…Î¼Ï€Î¯ ÎµÏ€Î¹Î²ÎµÎ²Î±Î¯Ï‰ÏƒÎ·Ï‚ Î±ÎºÏÏÏ‰ÏƒÎ·Ï‚
if (confirmBtn && modal) {
  confirmBtn.addEventListener('click', function() {
    if (confirmBtn.disabled) return; // Î±Ï€Î¿Ï†Ï…Î³Î® Î´Î¹Ï€Î»ÏÎ½ clicks
    confirmBtn.disabled = true;
    confirmBtn.textContent = "Î“Î¯Î½ÎµÏ„Î±Î¹ Î±ÎºÏÏÏ‰ÏƒÎ·â€¦";
    fetch('/cancel_subscription', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
    })
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        modal.classList.remove('open');
        showFlash('success', 'Î— ÏƒÏ…Î½Î´ÏÎ¿Î¼Î® ÏƒÎ¿Ï… Î±ÎºÏ…ÏÏÎ¸Î·ÎºÎµ Î¼Îµ ÎµÏ€Î¹Ï„Ï…Ï‡Î¯Î±!');
        setTimeout(() => {
          window.location.reload();
        }, 1500); // reload Î¼ÎµÏ„Î¬ Î±Ï€ÏŒ 1.5s Î³Î¹Î± Î½Î± Ï€ÏÎ¿Î»Î¬Î²ÎµÎ¹ Î½Î± ÎµÎ¼Ï†Î±Î½Î¹ÏƒÏ„ÎµÎ¯ Ï„Î¿ flash
      } else {
        showFlash('error', 'Î£Ï†Î¬Î»Î¼Î± Î±ÎºÏÏÏ‰ÏƒÎ·Ï‚: ' + (data.error || 'Î”Î¿ÎºÎ¯Î¼Î±ÏƒÎµ Î¾Î±Î½Î¬.'));
        confirmBtn.disabled = false;
        confirmBtn.textContent = "ÎÎ±Î¹, Î±ÎºÏÏÏ‰ÏƒÎ·";
      }
    })
    .catch(() => {
      showFlash('error', 'Î ÏÏŒÎ²Î»Î·Î¼Î± ÎµÏ€Î¹ÎºÎ¿Î¹Î½Ï‰Î½Î¯Î±Ï‚. Î”Î¿ÎºÎ¯Î¼Î±ÏƒÎµ Î¾Î±Î½Î¬!');
      confirmBtn.disabled = false;
      confirmBtn.textContent = "ÎÎ±Î¹, Î±ÎºÏÏÏ‰ÏƒÎ·";
    });
  });
}

var resumeBtn = document.getElementById('resumeSubBtn');
if (resumeBtn) {
  resumeBtn.addEventListener('click', function() {
    resumeBtn.disabled = true;
    resumeBtn.textContent = "Î•Ï€Î±Î½ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎ·â€¦";
    fetch('/resume_subscription', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
    })
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        showFlash('success', 'Î— ÏƒÏ…Î½Î´ÏÎ¿Î¼Î® ÏƒÎ¿Ï… ÎµÏ€Î±Î½ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¹Î®Î¸Î·ÎºÎµ Î¼Îµ ÎµÏ€Î¹Ï„Ï…Ï‡Î¯Î±!');
        setTimeout(function() {
          window.location.reload();
        }, 1500); // reload Î¼ÎµÏ„Î¬ Î±Ï€ÏŒ 1.5s Î³Î¹Î± Î½Î± Ï€ÏÎ¿Î»Î¬Î²ÎµÎ¹ Î½Î± ÎµÎ¼Ï†Î±Î½Î¹ÏƒÏ„ÎµÎ¯ Ï„Î¿ flash
      } else {
        showFlash('error', 'Î£Ï†Î¬Î»Î¼Î±: ' + (data.error || 'Î”Î¿ÎºÎ¯Î¼Î±ÏƒÎµ Î¾Î±Î½Î¬.'));
        resumeBtn.disabled = false;
        resumeBtn.textContent = "Î•Ï€Î±Î½ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎ· ÏƒÏ…Î½Î´ÏÎ¿Î¼Î®Ï‚";
      }
    })
    .catch(() => {
      showFlash('error', 'Î ÏÏŒÎ²Î»Î·Î¼Î± ÎµÏ€Î¹ÎºÎ¿Î¹Î½Ï‰Î½Î¯Î±Ï‚. Î”Î¿ÎºÎ¯Î¼Î±ÏƒÎµ Î¾Î±Î½Î¬!');
      resumeBtn.disabled = false;
      resumeBtn.textContent = "Î•Ï€Î±Î½ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎ· ÏƒÏ…Î½Î´ÏÎ¿Î¼Î®Ï‚";
    });
  });
}

</script>

<!------------ Dish Select Modal ------------->
<script>
/* === Î£Ï…Î¼Ï€Î»Î®ÏÏ‰ÏƒÎ· Ï„Î¿Ï… modal Î¼Îµ Ï„Î± Ï€Î¹Î¬Ï„Î± === */
function fillDishModalOptions(dishes) {
  const container = document.querySelector("#chooseDishModal .dish-options");
  if (!container) return;
  container.innerHTML = "";

  (dishes || []).forEach((dish, i) => {
    const label = document.createElement("label");
    label.className = "dish-option";
    label.innerHTML = `
      <input type="radio" name="selectedDish" value="${dish.id}">
      <span class="dish-label">
        <span class="dish-img-title-wrap">
          <img class="dish-img" src="${dish.image_url || '/static/images/recipes/noimg.jpg'}" alt="${dish.title}">
          <span>
            <span class="dish-title">${dish.title}</span><br>
            <span class="dish-desc">${dish.desc || ""}</span>
          </span>
        </span>
      </span>
    `;
    container.appendChild(label);
  });

  // Î ÎµÏÎ¹Î¼Î­Î½Î¿Ï…Î¼Îµ Î»Î¯Î³Î¿ Ï€ÏÎ¹Î½ Ï€ÏÎ¿ÏƒÎ¸Î­ÏƒÎ¿Ï…Î¼Îµ Ï„Î¿ selected (Î³Î¹Î± render)
  setTimeout(() => {
    const firstLabel = container.querySelector('.dish-option');
    const firstRadio = container.querySelector('input[type="radio"]');
    if (firstLabel) firstLabel.classList.add('selected');
    if (firstRadio) {
      firstRadio.checked = true;
      firstRadio.dispatchEvent(new Event('change', { bubbles: true }));
    }
    const confirmBtn = document.getElementById("confirmDishBtn");
    if (confirmBtn) confirmBtn.disabled = false;
  }, 0);
}

/* === Î†Î½Î¿Î¹Î³Î¼Î± modal & ÏƒÏ…Î¼Ï€Î»Î®ÏÏ‰ÏƒÎ· === */
function showChooseDishModal() {
  fillDishModalOptions(window.lastAISuggestedDishes || []);
  var modalElem = document.getElementById('chooseDishModal');
  if (modalElem) {
    var modal = bootstrap.Modal.getOrCreateInstance(modalElem);
    modal.show();
  }
}


/* === Î•Î½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎ· badges Î·Î¼Î­ÏÎ±Ï‚ & ÎµÏ€Î¹Î»Î¿Î³Î® Ï€Î¹Î¬Ï„Î¿Ï… === */
document.addEventListener("DOMContentLoaded", function() {
  // Badge selection (Î·Î¼Î­ÏÎ±)
  document.querySelectorAll('.dish-day-badge').forEach(function(badge) {
    badge.addEventListener('click', function() {
      document.querySelectorAll('.dish-day-badge').forEach(b => b.classList.remove('selected'));
      badge.classList.add('selected');
    });
  });

  // Option selection (Ï€Î¹Î¬Ï„Î¿)
  const dishOptionsParent = document.querySelector("#chooseDishModal .dish-options");
  if (dishOptionsParent) {
    dishOptionsParent.addEventListener("change", function(e) {
      if (e.target.name === "selectedDish") {
        document.querySelectorAll("#chooseDishModal .dish-option").forEach(function(opt) {
          opt.classList.remove('selected');
        });
        const selected = e.target.closest(".dish-option");
        if (selected) selected.classList.add('selected');
        document.getElementById("confirmDishBtn").disabled = false;
      }
    });
  }

  // Modal ÎµÏ€Î¹Î»Î¿Î³Î®Ï‚ ÎµÎ½Î­ÏÎ³ÎµÎ¹Î±Ï‚ ÏƒÎµ conflict (radio highlight)
  const conflictForm = document.getElementById('conflictActionForm');
  const conflictBtn = document.getElementById('conflictActionConfirmBtn');
  if (conflictForm && conflictBtn) {
    conflictForm.addEventListener('change', function() {
      const checked = conflictForm.querySelector('input[name="conflictAction"]:checked');
      document.querySelectorAll("#cookedDishExistsModal .dish-option").forEach(function(opt) {
        opt.classList.remove('selected');
      });
      if (checked) {
        checked.closest(".dish-option").classList.add('selected');
        conflictBtn.disabled = false;
      }
    });
  }

  if (conflictBtn) {
    conflictBtn.addEventListener('click', function() {
      const checked = conflictForm.querySelector('input[name="conflictAction"]:checked');
      if (!checked) return;
      if (checked.value === "replace") {
        // Î‘Î½Ï„Î¹ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·: fetch ÏƒÏ„Î¿ /api/cooked_dish_replace
        fetch("/api/cooked_dish_replace", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(window.pendingCookedDish)
        })
        .then(r => r.json())
        .then(data => { if (data.success) showFlash('success', 'Î¤Î¿ Ï€Î¹Î¬Ï„Î¿ Î±Î½Ï„Î¹ÎºÎ±Ï„Î±ÏƒÏ„Î¬Î¸Î·ÎºÎµ!'); });
      } else if (checked.value === "keep_both") {
        // ÎÎ­Î± ÎµÎ³Î³ÏÎ±Ï†Î® Ï‡Ï‰ÏÎ¯Ï‚ Î½Î± ÏƒÎ²Î®Î½ÎµÎ¹Ï‚ Ï„Î¿ Ï€ÏÎ¿Î·Î³Î¿ÏÎ¼ÎµÎ½Î¿
        fetch("/api/cooked_dish", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ ...window.pendingCookedDish, force: true })
        })
        .then(r => r.json())
        .then(data => { if (data.success) showFlash('success', 'Î ÏÎ¿ÏƒÏ„Î­Î¸Î·ÎºÎ±Î½ ÎºÎ±Î¹ Ï„Î± Î´ÏÎ¿ Ï€Î¹Î¬Ï„Î±!'); });
      }
      // ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿ conflict modal (ÏŒÏ€Î¿Î¹Î± ÎµÏ€Î¹Î»Î¿Î³Î® ÎºÎ±Î¹ Î½Î± ÎºÎ¬Î½ÎµÎ¹Ï‚)
      var modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('cookedDishExistsModal'));
      modal.hide();
    });
  }

  // Î‘Î½ Î³Î¹Î± Î¿Ï€Î¿Î¹Î¿Î´Î®Ï€Î¿Ï„Îµ Î»ÏŒÎ³Î¿ Ï„Î¿ modal Î±Î½Î¿Î¯Î³ÎµÎ¹ Î¼Îµ JS, Ï„Î¿ button Î¾ÎµÎºÎ¹Î½Î¬ÎµÎ¹ disabled
  const confirmBtn = document.getElementById("confirmDishBtn");
	confirmBtn.addEventListener('click', function() {
	  const selectedRadio = document.querySelector("#chooseDishModal input[name='selectedDish']:checked");
	  const day =
		document.getElementById('choose-today-badge')?.classList.contains('selected') ? "today"
		: document.getElementById('choose-tomorrow-badge')?.classList.contains('selected') ? "tomorrow"
		: "overmorrow";

	  if (selectedRadio) {
		// === Î•Î›Î•Î“Î§ÎŸÎ£ PREMIUM ===
		if (window.is_premium === false) {
		  var modal = document.getElementById("upgradeModal");
		  var backdrop = document.getElementById("upgradeModalBackdrop");
		  if (modal && backdrop) {
			modal.style.display = "flex";
			backdrop.style.display = "block";
		  }
		  // ÎšÎ»ÎµÎ¯ÏƒÎµ Ï„Î¿ chooseDishModal Î±Ï†Î¿Ï Î¶Î·Ï„Î®ÏƒÎµÎ¹Ï‚ upgrade
		  var chooseDish = bootstrap.Modal.getOrCreateInstance(document.getElementById('chooseDishModal'));
		  chooseDish.hide();
		  return false;
		}

		// === Î‘Î½ ÎµÎ¯Î½Î±Î¹ premium, Ï€ÏÎ¿Ï‡ÏÏÎ± ÎºÎ±Î½Î¿Î½Î¹ÎºÎ¬ ===
		const selectedDishId = selectedRadio.value;
		const selectedMethod = ""; // Î® ÏƒÏ…Î¼Ï€Î»Î®ÏÏ‰ÏƒÎµ Î±Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹
		const servings = "";       // Î® ÏƒÏ…Î¼Ï€Î»Î®ÏÏ‰ÏƒÎµ Î±Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹

		fetch("/api/cooked_dish", {
		  method: "POST",
		  headers: { "Content-Type": "application/json" },
		  body: JSON.stringify({
			recipe_id: selectedDishId,
			day: day,
			method: selectedMethod,
			servings: servings
		  })
		})
		.then(r => r.json())
		.then(data => {
		  if (data.success) {
			showFlash('success', 'Î¤Î¿ Ï€Î¹Î¬Ï„Î¿ ÎºÎ±Ï„Î±Ï‡Ï‰ÏÎ®Î¸Î·ÎºÎµ ÎµÏ€Î¹Ï„Ï…Ï‡ÏÏ‚ ÏƒÏ„Î± Î¼Î±Î³ÎµÎ¹ÏÎµÎ¼Î­Î½Î±!');
		  } else if (data.exists) {
			window.pendingCookedDish = {
			  recipe_id: selectedDishId,
			  day: day,
			  method: selectedMethod,
			  servings: servings
			};
			setTimeout(function() {
			  var conflictModal = bootstrap.Modal.getOrCreateInstance(document.getElementById('cookedDishExistsModal'));
			  conflictModal.show();
			}, 250);
		  }
		});

		// ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿ modal
		var modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('chooseDishModal'));
		modal.hide();
	  }
	});

  // Reset confirm button ÏŒÏ„Î±Î½ Î¾Î±Î½Î±Î½Î¿Î¯Î³ÎµÎ¹ Ï„Î¿ modal
  document.getElementById('chooseDishModal')?.addEventListener('show.bs.modal', function() {
    document.getElementById("confirmDishBtn").disabled = true;
    document.querySelectorAll("#chooseDishModal .dish-option").forEach(function(opt) {
      opt.classList.remove('selected');
    });
    document.querySelectorAll("#chooseDishModal input[name='selectedDish']").forEach(function(inp) {
      inp.checked = false;
    });
  });

  // Reset conflict modal ÏƒÏ„Î¿ Î¬Î½Î¿Î¹Î³Î¼Î± (Ï€Î¬Î½Ï„Î± Î· Ï€ÏÏÏ„Î· ÎµÏ€Î¹Î»Î¿Î³Î®)
  document.getElementById('cookedDishExistsModal')?.addEventListener('show.bs.modal', function() {
    document.querySelectorAll("#cookedDishExistsModal .dish-option").forEach(function(opt, i) {
      opt.classList.toggle('selected', i === 0);
      opt.querySelector('input[type=\"radio\"]').checked = (i === 0);
    });
    const conflictBtn = document.getElementById('conflictActionConfirmBtn');
    if (conflictBtn) conflictBtn.disabled = false;
  });
});
</script>

<!------------ FAQs Modal ------------->
<script>
function loadAndOpenFaqModal() {
  closeOffcanvas();
  if (document.getElementById('faqModal')) {
    document.getElementById('faqModal').style.display = 'flex';
    return;
  }
  fetch('/static/html/faq_modal.html')
    .then(res => res.text())
    .then(html => {
      var div = document.createElement('div');
      div.innerHTML = html;
      document.body.appendChild(div.firstElementChild);
      document.getElementById('faqModal').style.display = 'flex';
    });
}
function closeFaqModal() {
  var modal = document.getElementById('faqModal');
  if (modal) modal.style.display = 'none';
}
function toggleFaq(btn) {
  var item = btn.parentElement;
  item.classList.toggle('open');
}
</script>

<!------------ Contact Modal ------------->
<script>
function openContactModal() {
  closeOffcanvas();
  document.getElementById("contactModal").style.display = "flex";
}
function closeContactModal() {
  document.getElementById("contactModal").style.display = "none";
}

async function sendContactForm(e) {
  e.preventDefault();
  const form = e.target;
  const data = {
//    name: form.name.value.trim(),
//    email: form.email.value.trim(),
    message: form.message.value.trim()
  };

  if (!data.message)
    return alert("Î£Ï…Î¼Ï€Î»Î®ÏÏ‰ÏƒÎµ ÏŒÎ»Î± Ï„Î± Ï€ÎµÎ´Î¯Î±.");

  try {
    const res = await fetch("/send_message", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message: data.message })
    });

    const result = await res.json();
    if (result.success) {
      showFlash('success','âœ… Î¤Î¿ Î¼Î®Î½Ï…Î¼Î¬ ÏƒÎ¿Ï… ÏƒÏ„Î¬Î»Î¸Î·ÎºÎµ ÎµÏ€Î¹Ï„Ï…Ï‡ÏÏ‚, ÏƒÏÎ½Ï„Î¿Î¼Î± Î¸Î± ÎµÏ€Î¹ÎºÎ¿Î¹Î½Ï‰Î½Î®ÏƒÎ¿Ï…Î¼Îµ Î¼Î±Î¶Î¯ ÏƒÎ¿Ï…!');
      closeContactModal();
      form.reset();
    } else {
      showFlash('error','âŒ Î£Ï†Î¬Î»Î¼Î±: ' + (result.error || 'Î‘Ï€Î¿Ï„Ï…Ï‡Î¯Î± Î±Ï€Î¿ÏƒÏ„Î¿Î»Î®Ï‚.'));
    }
  } catch (err) {
    console.error(err);
    showFlash('error','âŒ Î£Ï†Î¬Î»Î¼Î± ÏƒÏÎ½Î´ÎµÏƒÎ·Ï‚ Î¼Îµ Ï„Î¿Î½ Î´Î¹Î±ÎºÎ¿Î¼Î¹ÏƒÏ„Î®.');
  }
}


</script>

<!------------ Contact message voice recognition ------------->
<script>
let recognition;
let isListening = false;
let defaultPlaceholder = "Î Î»Î·ÎºÏ„ÏÎ¿Î»ÏŒÎ³Î·ÏƒÎµ Î® Ï…Ï€Î±Î³ÏŒÏÎµÏ…ÏƒÎµ Ï„Î¿ Î¼Î®Î½Ï…Î¼Î¬ ÏƒÎ¿Ï…...";

function initVoiceRecognition() {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRecognition) {
    alert("Î— Ï†Ï‰Î½Î·Ï„Î¹ÎºÎ® Î±Î½Î±Î³Î½ÏÏÎ¹ÏƒÎ· Î´ÎµÎ½ Ï…Ï€Î¿ÏƒÏ„Î·ÏÎ¯Î¶ÎµÏ„Î±Î¹ ÏƒÎµ Î±Ï…Ï„ÏŒÎ½ Ï„Î¿Î½ browser.");
    return null;
  }
  const recog = new SpeechRecognition();
  recog.lang = "el-GR"; // Î•Î»Î»Î·Î½Î¹ÎºÎ¬
  recog.continuous = false;
  recog.interimResults = false;
  return recog;
}

function toggleVoiceInput(btn) {
  if (!recognition) recognition = initVoiceRecognition();
  if (!recognition) return;

  const textarea = document.getElementById("contactMessage");

  if (!isListening) {
    btn.classList.add("voice-active");
    textarea.placeholder = "ğŸ™ï¸ Î‘ÎºÎ¿ÏÏ‰...";
    recognition.start();
    isListening = true;
  } else {
    btn.classList.remove("voice-active");
    textarea.placeholder = defaultPlaceholder;
    recognition.stop();
    isListening = false;
  }

  recognition.onresult = function(event) {
    const transcript = event.results[0][0].transcript;
    textarea.value += (textarea.value ? " " : "") + transcript;
  };

  recognition.onerror = function() {
    btn.classList.remove("voice-active");
    textarea.placeholder = defaultPlaceholder;
    isListening = false;
  };

  recognition.onend = function() {
    btn.classList.remove("voice-active");
    textarea.placeholder = defaultPlaceholder;
    isListening = false;
  };
}
</script>


{% endblock %}
