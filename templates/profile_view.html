{% extends "base.html" %}
{% block title %}Î ÏÎ¿Ï†Î¯Î»{% endblock %}
{% block content %}



<style>
#onboardingBackdrop {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
  z-index: 1020;
}
  
.onboarding-highlight {
  box-shadow: 0 0 0 4px #ffe28a;
  border-radius: 6px;
}
</style>

<style>

#onboardingTooltip6::after {
  width: 12px;
  height: 12px;
  background: #fbc6d7;
  transform: rotate(45deg);
  position: absolute;
  bottom: -6px;
  left: 20px;
  box-shadow: 1px 1px 3px rgba(0,0,0,0.1);
}

.onboarding-tooltip {
  font-family: 'Indie Flower', cursive, Arial, sans-serif;
  position: absolute;
  width: 70vw;
  width: auto;
  max-width: 300px;
  background: #fbc6d7;
  padding: 10px 14px;
  border-radius: 10px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  font-size: 15px;
  text-align: center;
  animation: pulse 1.5s infinite;
  z-index: 1050;
  word-wrap: break-word;
  overflow-wrap: break-word;
  box-sizing: border-box;
}

.onboarding-tooltip .arrow-down {
  width: 12px;
  height: 12px;
  background: #fbc6d7;
  transform: rotate(45deg);
  position: absolute;
  bottom: -6px;
  left: 20px;
  box-shadow: 1px 1px 3px rgba(0,0,0,0.1);
}

.onboarding-tooltip .arrow-down-right {
  width: 12px;
  height: 12px;
  background: #fbc6d7;
  transform: rotate(45deg);
  position: absolute;
  bottom: -6px;
  right: 20px;
  box-shadow: 1px 1px 3px rgba(0,0,0,0.1);
}

</style>

<style>
body {
  font-family: 'Inter', sans-serif;
  background: #eef4fb;
}
.container {
  max-width: 480px;
  margin: 0 auto;
}
.card {
  border: none;
  border-radius: 16px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
  background-color: #fff;
  margin-bottom: 1.2rem;
}
.card-section-title {
  background: #00c6ff;
  background: linear-gradient(to right, #00c6ff, #0072ff);
  color: white;
  font-weight: 600;
  font-size: 1em;
  padding: 8px 16px;
  border-top-left-radius: 16px;
  border-top-right-radius: 16px;
}
.card-body {
  padding: 1rem 1.2rem;
}
#profile-completion-bar {
  height: 10px;
  border-radius: 5px;
  background: #d6d6d6;
  overflow: hidden;
  margin: 0.5rem 0 1rem;
}
#profile-completion-fill {
  width: 0%;
  height: 100%;
  background: linear-gradient(to right, #9be15d, #00e3ae);
  transition: width 0.8s ease;
}
.badge {
  font-size: 0.8em;
  border-radius: 10px;
  padding: 4px 10px;
  background-color: #ffecb3;
  color: #444;
}
.table {
  background: #fcfcfc;
  border-radius: 12px;
  vertical-align: middle;
}
</style>


<div class="container py-3">

  <div class="sticky-top bg-white pt-3 pb-2 shadow-sm" style="z-index: 1021; background-color:rgb(250 255 236)!important; border-radius: 16px;margin-bottom:1.2rem;">
	  <h4 class="fw-bold text-center mb-2">ğŸ‘¤ Î¤Î¿ Î ÏÎ¿Ï†Î¯Î» Î¼Î¿Ï…</h4>
	  <div id="profile-completion-bar" class="mx-3">
		<div id="profile-completion-fill"></div>
	  </div>
	</div>

  <div class="card">
	  <div class="card-section-title">Î£Ï„Î¿Î¹Ï‡ÎµÎ¯Î± Î§ÏÎ®ÏƒÏ„Î·</div>
	  <div class="card-body">
	   	<p id="profile-name"><i class="fa fa-user-circle fa-lg"></i> {{ profile.first_name or ''}} {{ profile.family_name or ''}}</p>	
		<p><i class="fa fa-map-marker-alt text-muted"></i> <strong>Î”Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ·:</strong> <span id="profile-address">{{ profile.address or '-' }}</span></p>
		{% if profile.alt_address %}
		<p><i class="fa fa-home text-muted"></i> <strong>Î•Î½Î±Î»Î»Î±ÎºÏ„Î¹ÎºÎ®:</strong> <span id="profile-alt-address">{{ profile.alt_address or '-'}}</span></p>
		{% endif %}
		<p><i class="fa fa-star text-warning"></i><strong>&nbsp;Î‘Î³Î±Ï€Î·Î¼Î­Î½Î¿Ï‚ Chef:</strong>
		  {% if profile.chef %}
			<span id="profile-chef">{{ profile.chef or '-'}}</span>
		  {% else %}
			<span id="profile-chef" class="text-muted">-</span>
		  {% endif %}
		</p>
		<p><i class="fa fa-calendar-alt"></i><strong>&nbsp;Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Î¼ÎµÎ½Î¿Ï:</strong>&nbsp;
		  {% if profile.menu_day %}
			<span id="profile-menu-day">{{ profile.menu_day or ''}}</span>
		  {% else %}
			<span id="profile-menu-day" class="text-muted"></span>
		  {% endif %}
		  &nbsp;
		  {% if profile.menu_hour %}
			<i class="fa fa-clock"></i>&nbsp;<span id="profile-menu-hour">{{ profile.menu_hour or ''}}</span>
		  {% else %}
			<span id="profile-menu-hour" class="text-muted"></span>
		  {% endif %}
		</p>		
		 <p>
		  <i class="fa fa-fire"></i>
		  <strong>Î ÏÎ¿Ï„Î¹Î¼ÏÎ¼ÎµÎ½Î¿Ï‚ Ï„ÏÏŒÏ€Î¿Ï‚ Î¼Î±Î³ÎµÎ¹ÏÎ­Î¼Î±Ï„Î¿Ï‚:</strong>
			<span id="profile-cooking-method">
			  {% if profile.cooking_method %}
				{% for m in profile.cooking_method.split(',') %}
				  <span class="badge bg-warning text-dark me-1"><i class="fa fa-fire"></i> {{ m.strip() }}</span>
				{% endfor %}
			  {% else %}
				<span class="text-muted">-</span>
			  {% endif %}
			</span>
		</p>
	  
	  	<div class="text-end mt-2">
		  <button class="btn btn-outline-primary btn-sm" onclick="editProfileInfo()" id="edit-profile-button" style="background-color: white!important;">
			<i class="fa fa-pen"></i> Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î± Ï€ÏÎ¿Ï†Î¯Î»
		  </button>
		</div>
	  
	  </div>
  </div>

  <div class="card">
    <div class="card-section-title">Î”Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î¿Ï‚ Î§ÏÏŒÎ½Î¿Ï‚ ÎœÎ±Î³ÎµÎ¹ÏÎ­Î¼Î±Ï„Î¿Ï‚</div>
    <div class="card-body">
      <table class="table table-sm w-100 mb-2 text-center" style="font-size:0.85em">
        <tr>
          {% for d, gr in [('mon','Î”'),('tue','Î¤'),('wed','Î¤'),('thu','Î '),('fri','Î '),('sat','Î£'),('sun','Îš')] %}
            <td><strong>{{ gr }}</strong><br><span id="cooktime-{{d}}-display">{{ profile['cooktime_' ~ d] or '-' }} Î».</span></td>
          {% endfor %}
        </tr>
      </table>
		<div class="text-end mt-2">
		  <button class="btn btn-outline-primary btn-sm" id="edit-cook-times" onclick="editCookingTimes()" style="position:sticky; background-color: white!important;">
			<i class="fa fa-pen"></i> Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î±
		  </button>
		</div>
    </div>
  </div>

  <div class="card">
    <div class="card-section-title">ÎœÎ­Î»Î· ÎŸÎ¹ÎºÎ¿Î³Î­Î½ÎµÎ¹Î±Ï‚</div>
    <div class="card-body">
		  <table class="table table-striped align-middle table-sm mb-2 text-center" style="font-size:0.8em">
			<tbody id="members-list">
			  {% for m in members %}
			  <tr data-memberid="{{ m.id }}">
				<td>
				  <div class="d-flex justify-content-left align-items-center flex-wrap gap-1 mb-0" style="gap:6px;">
					<i class="fa fa-user-friends text-secondary"></i>
					<strong>{{ m.name }}</strong>
					<span class="text-muted">({{ m.age }} ÎµÏ„ÏÎ½)</span>
					<button class="btn btn-outline-primary btn-sm ms-1" style="margin-bottom: 1px !important;" title="Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î±" onclick="editMember({{ m.id }}, this)">
					  <i class="fa fa-pen"></i>
					</button>
					<button type="button" class="btn btn-outline-danger btn-sm ms-1" style="margin-bottom: 1px !important;" title="Î”Î¹Î±Î³ÏÎ±Ï†Î®" onclick="deleteMember({{ m.id }}, this)">
					  <i class="fa fa-trash"></i>
					</button>
				  </div>
					{% if m.allergies %}
					  <div class="mt-1 text-start">
						<span class="badge bg-warning" title="Î‘Î»Î»ÎµÏÎ³Î¯ÎµÏ‚">
						  <i class="fa fa-exclamation-triangle"></i> {{ m.allergies }}
						</span>
					  </div>
					{% endif %}

				</td>
			  </tr>
			  {% else %}
			  <tr>
				<td class="text-muted">Î”ÎµÎ½ Î­Ï‡Î¿Ï…Î½ Ï€ÏÎ¿ÏƒÏ„ÎµÎ¸ÎµÎ¯ Î¼Î­Î»Î·.</td>
			  </tr>
			  {% endfor %}
			</tbody>
		  </table>
      <div class="text-left">
        <button class="btn btn-success btn-sm" id="add-member" onclick="openAddMemberModal()">
          <i class="fa fa-plus"></i> Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· Î¼Î­Î»Î¿Ï…Ï‚
        </button>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-section-title">Î£Ï„ÏŒÏ‡Î¿Î¹ Î•Î²Î´Î¿Î¼Î¬Î´Î±Ï‚</div>
    <div class="card-body">
      <table class="table table-sm mb-2 text-center" style="font-size:0.85em">
        <thead>
          <tr><th>ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î±</th><th>Î¤ÏÏ€Î¿Ï‚</th><th></th></tr>
        </thead>
        <tbody id="goals-tbody">
          {% for row in weekly_goals %}
          <tr data-goalid="{{ row['id'] }}">
            <td>{{ row['category'] }}</td>
            <td>
              {% if row['min_times'] != row['max_times'] %}
                Î‘Ï€ÏŒ {{ row['min_times'] }} Î­Ï‰Ï‚ {{ row['max_times'] }} Ï†Î¿ÏÎ­Ï‚
              {% else %}
                Î‘ÎºÏÎ¹Î²ÏÏ‚ {{ row['min_times'] }} Ï†Î¿ÏÎ¬{{ 'Ï‚' if row['min_times'] > 1 else '' }}
              {% endif %}
            </td>
            <td>
              <button class="btn btn-outline-primary btn-sm" onclick="editGoal({{ row['id'] }}, '{{ row['category'] }}', {{ row['min_times'] }}, {{ row['max_times'] }})"><i class="fa fa-pen"></i></button>
              <button class="btn btn-outline-danger btn-sm" onclick="deleteGoal({{ row['id'] }})"><i class="fa fa-trash"></i></button>
            </td>
          </tr>
          {% endfor %}
          {% if weekly_goals|length == 0 %}
          <tr><td colspan="3" class="text-muted">Î”ÎµÎ½ Î­Ï‡ÎµÎ¹Ï‚ Î¿ÏÎ¯ÏƒÎµÎ¹ ÏƒÏ„ÏŒÏ‡Î¿Ï…Ï‚.</td></tr>
          {% endif %}
        </tbody>
      </table>
      <div class="d-flex justify-content-between">
        <button class="btn btn-success btn-sm" id="add-goal-btn" onclick="addGoalRow()"><i class="fa fa-plus"></i> Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· ÏƒÏ„ÏŒÏ‡Î¿Ï…</button>
        {% if weekly_goals|length > 0 %}
        <button id="deleteAllBtn" class="btn btn-outline-danger btn-sm" onclick="deleteAllGoals()">
          <i class="fa fa-trash"></i> Î”Î¹Î±Î³ÏÎ±Ï†Î® ÏŒÎ»Ï‰Î½
        </button>
        {% endif %}
      </div>
    </div>
  </div>
</div>



<!-- BACKDROP: ÎµÎ¼Ï†Î±Î½Î¯Î¶ÎµÏ„Î±Î¹ ÏƒÎµ ÏŒÎ»Î± Ï„Î± Î²Î®Î¼Î±Ï„Î± -->
<div id="onboardingBackdrop" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0;background:rgba(0, 0, 0, 0.5); z-index:1020;"></div>

<div id="onboardingTooltip2" class="onboarding-tooltip no-arrow" style="display:none;">
    Î Î¬Ï„Î± ÎµÎ´Ï! ğŸ‘‡
    <div class="arrow-down-right"></div>
</div>

<!-- Tooltip 3 - Î§ÏÏŒÎ½Î¿Î¹ Î¼Î±Î³ÎµÎ¹ÏÎ­Î¼Î±Ï„Î¿Ï‚ -->
<div id="onboardingTooltip3" class="onboarding-tooltip no-arrow" style="display:none;">
  â±ï¸ Î ÎµÏ‚ Î¼Î¿Ï… Ï€ÏŒÏƒÎ¿ Ï‡ÏÏŒÎ½Î¿ Î¼Ï€Î¿ÏÎµÎ¯Ï‚ Î½Î± Î±Ï†Î¹ÎµÏÏÏƒÎµÎ¹Ï‚ ÎºÎ¬Î¸Îµ Î¼Î­ÏÎ± Î³Î¹Î± Î¼Î±Î³ÎµÎ¯ÏÎµÎ¼Î±! Î˜Î± Ï„Î¿ Î»Î¬Î²Ï‰ Ï…Ï€ÏŒÏˆÎ¹Î½!
  <div class="arrow-down-right"></div>
</div>

<!-- Tooltip 4 - ÎœÎ­Î»Î· -->
<div id="onboardingTooltip4" class="onboarding-tooltip no-arrow" style="display:none;">
  ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Î ÏÏŒÏƒÎ¸ÎµÏƒÎµ Ï„Î± Î¼Î­Î»Î· Ï„Î·Ï‚ Î¿Î¹ÎºÎ¿Î³Î­Î½ÎµÎ¹Î¬Ï‚ ÏƒÎ¿Ï…! Î•Î¯Î½Î±Î¹ ÏƒÎ·Î¼Î±Î½Ï„Î¹ÎºÎ¬!
  <div class="arrow-down"></div>
</div>

<!-- Tooltip 5 - Î£Ï„ÏŒÏ‡Î¿Î¹ -->
<div id="onboardingTooltip5" class="onboarding-tooltip no-arrow" style="display:none;">
  ğŸ¯ Î•Î´Ï Î¼Ï€Î¿ÏÎµÎ¯Ï‚ Î½Î± Ï€ÏÎ¿ÏƒÎ¸Î­ÏƒÎµÎ¹Ï‚ Ï„Î¿Ï…Ï‚ Î´Î¹Î±Ï„ÏÎ¿Ï†Î¹ÎºÎ¿ÏÏ‚ ÏƒÎ¿Ï… ÏƒÏ„ÏŒÏ‡Î¿Ï…Ï‚! Î˜Î± Î¼Îµ Î²Î¿Î·Î¸Î®ÏƒÎµÎ¹ Î½Î± ÏƒÎ¿Ï… Ï€ÏÎ¿Ï„ÎµÎ¯Î½Ï‰ Ï€Î¹Î¬Ï„Î±!
  <div class="arrow-down"></div>
</div>

<div id="onboardingTooltip6" class="onboarding-tooltip no-arrow" style="display:none;">
 ğŸ‘‡ Î Î¬Ï„Î± ÎµÎ´Ï Î³Î¹Î± Î½Î± Î´ÎµÎ¹Ï‚ Ï„Î¿ ÎµÎ²Î´Î¿Î¼Î±Î´Î¹Î±Î¯Î¿ Ï€Î»Î¬Î½Î¿ ÏƒÎ¿Ï…!
  <div class="arrow-down"></div>
</div>


{% endblock %}

{% block modals %}

<div class="modal fade" id="editProfileModal" tabindex="-1" aria-labelledby="editProfileModalLabel" aria-hidden="true">
  <div class="modal-dialog"><div class="modal-content">
    <form id="profile-info-form">
      <div class="modal-header"><h5 class="modal-title" id="editProfileModalLabel">Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î± Î£Ï„Î¿Î¹Ï‡ÎµÎ¯Ï‰Î½ Î ÏÎ¿Ï†Î¯Î»</h5></div>
      <div class="modal-body">
        <div class="mb-2">
          <label>ÎŒÎ½Î¿Î¼Î±</label>
          <input name="first_name" class="form-control" required value="{{ profile.first_name or '' }}">
        </div>
        <div class="mb-2">
          <label>Î•Ï€ÏÎ½Ï…Î¼Î¿</label>
          <input name="family_name" class="form-control" value="{{ profile.family_name or '' }}">
        </div>
        <div class="mb-2">
          <label>Î”Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ·</label>
          <input name="address" class="form-control" value="{{ profile.address or ''}}">
        </div>
        <div class="mb-2">
          <label>Î‘Î³Î±Ï€Î·Î¼Î­Î½Î¿Ï‚ Î£ÎµÏ†</label>	  
          <select name="chef" id="profile-chef-select" class="form-select" >
		  <option disabled selected hidden>-- Î•Ï€Î¹Î»Î­Î¾Ï„Îµ --</option>
            {% for chef in chef_options %}
              <option value="{{ chef }}" {% if chef == profile.chef %}selected{% endif %}>{{ chef }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="row">
		<label>Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± ÎµÎ²Î´Î¿Î¼Î±Î´Î¹Î±Î¯Î¿Ï… Î¼ÎµÎ½Î¿Ï</label>
          <div class="col mb-2">         
            <select name="menu_day" id="profile-menu-day-select" class="form-select">
			<option disabled selected hidden>-- ÎœÎ­ÏÎ± --</option>
              {% for day in ['Î”ÎµÏ…Ï„Î­ÏÎ±','Î¤ÏÎ¯Ï„Î·','Î¤ÎµÏ„Î¬ÏÏ„Î·','Î Î­Î¼Ï€Ï„Î·','Î Î±ÏÎ±ÏƒÎºÎµÏ…Î®','Î£Î¬Î²Î²Î±Ï„Î¿','ÎšÏ…ÏÎ¹Î±ÎºÎ®'] %}
                <option value="{{ day }}" {% if profile.menu_day == day %}selected{% endif %}>{{ day }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col mb-2">          
            <select name="menu_hour" id="profile-menu-hour-select" class="form-select">
			<option disabled selected hidden>-- ÎÏÎ± --</option>
              {% for h in range(7,24) %}
                <option value="{{ "%02d:00"|format(h) }}" {% if profile.menu_hour == "%02d:00"|format(h) %}selected{% endif %}>{{ "%02d:00"|format(h) }}</option>
                <option value="{{ "%02d:30"|format(h) }}" {% if profile.menu_hour == "%02d:30"|format(h) %}selected{% endif %}>{{ "%02d:30"|format(h) }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
        <div class="mb-2">
          <label>Î ÏÎ¿Ï„Î¹Î¼ÏÎ¼ÎµÎ½Î¿Î¹ Ï„ÏÏŒÏ€Î¿Î¹ Î¼Î±Î³ÎµÎ¹ÏÎ­Î¼Î±Ï„Î¿Ï‚</label>
          <select id="cooking-methods-select" name="cooking_methods" class="form-control" multiple>
            {% set cooking_options = ['Î¦Î¿ÏÏÎ½Î¿Ï‚','ÎšÎ±Ï„ÏƒÎ±ÏÏŒÎ»Î±','Î§ÏÏ„ÏÎ±','Î¤Î·Î³Î¬Î½Î¹','Î£Ï‡Î¬ÏÎ±','Air-fryer'] %}
            {% for opt in cooking_options %}
              <option value="{{ opt }}" {% if profile.cooking_method and opt in profile.cooking_method.split(',') %}selected{% endif %}>{{ opt }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-success">Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Î†ÎºÏ…ÏÎ¿</button>
      </div>
    </form>
  </div></div>
</div>

<div class="modal fade" id="editCookTimesModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog"><div class="modal-content">
    <form id="cook-times-form">
      <div class="modal-header"><h5 class="modal-title">Î˜Î± Î¼Ï€Î¿ÏÎ¿ÏÏƒÎ± Î½Î± Î´Î¹Î±Î¸Î­ÏƒÏ‰ Î³Î¹Î± Î¼Î±Î³ÎµÎ¯ÏÎµÎ¼Î±:</h5></div>
      <div class="modal-body">
        <div class="row">
			{% for d, gr in [('mon','Î”ÎµÏ…Ï„Î­ÏÎ±'),('tue','Î¤ÏÎ¯Ï„Î·'),('wed','Î¤ÎµÏ„Î¬ÏÏ„Î·'),('thu','Î Î­Î¼Ï€Ï„Î·'),('fri','Î Î±ÏÎ±ÏƒÎºÎµÏ…Î®'),('sat','Î£Î¬Î²Î²Î±Ï„Î¿'),('sun','ÎšÏ…ÏÎ¹Î±ÎºÎ®')] %}
			  <div class="col d-flex flex-column align-items-center" style="min-width:90px;">
				<label>{{ gr }}</label>
				<div class="d-flex align-items-center justify-content-center" style="gap:2px;">
				  <span style="font-size:1.4em;padding-right:3px;padding-bottom:10px;">~</span>
				  <input type="number" class="form-control text-center mb-1" min="0" style="width:50px;"
					id="cooktime-{{d}}-input"
					name="cooktime_{{d}}"
					value="{{ profile['cooktime_' ~ d] or '' }}">
				  <span style="font-size:1em;padding-left:3px;padding-bottom:5px;"> Î».</span>
				</div>
			  </div>
			{% endfor %}
        </div>
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-success">Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Î†ÎºÏ…ÏÎ¿</button>
      </div>
    </form>
  </div></div>
</div>

<div class="modal fade" id="memberModal" tabindex="-1" aria-labelledby="memberModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="member-form">
        <input type="hidden" name="member_id" id="member-id">
        <div class="modal-header">
          <h5 class="modal-title" id="memberModalLabel">ÎœÎ­Î»Î¿Ï‚</h5>
        </div>
        <div class="modal-body">
          <div class="mb-2">
            <label>ÎŒÎ½Î¿Î¼Î±</label>
            <input name="name" id="member-name" class="form-control" required>
          </div>
          <div class="mb-2">
            <label>Î—Î»Î¹ÎºÎ¯Î±</label>
            <input name="age" id="member-age" type="number" class="form-control" min="0" required>
          </div>
		  <div class="mb-2">
			  <label>Î‘Î»Î»ÎµÏÎ³Î¯ÎµÏ‚</label>
			  <select id="member-allergies-select" name="allergies" class="form-control" multiple>
				{% for a in all_allergs %}
				  <option value="{{ a }}">{{ a }}</option>
				{% endfor %}
				<option value="__other__">Î†Î»Î»Î¿...</option>
			  </select>
			  <input name="allergies_other" id="member-allergies-other" class="form-control mt-2" style="display:none;" placeholder="Î ÏÎ¿ÏƒÎ¸Î­ÏƒÏ„Îµ Î¬Î»Î»Î· Î±Î»Î»ÎµÏÎ³Î¯Î±...">
		  </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success" id="member-save-btn">Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Î†ÎºÏ…ÏÎ¿</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="modal fade" id="addGoalModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog" style="width:240px">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addGoalModalLabel">Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· Î£Ï„ÏŒÏ‡Î¿Ï…</h5>
      </div>
      <div class="modal-body">
        <div id="goalError" class="alert alert-danger fade goalerror-alert"></div>
        <form id="goalForm">
			<div class="mb-2">
			  <label>ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î±:</label>
			  <select class="form-select" id="goalCategory" required data-all="{{ categories|join(',') }}">
				{% for c in categories %}
				  <option value="{{ c }}">{{ c }}</option>
				{% endfor %}
			  </select>
			</div>
          <div class="mb-2 row">
            <div class="col d-flex justify-content-center flex-column align-items-center">
              <label class="mb-1">Î‘Ï€ÏŒ (min):</label>
              <button type="button" class="btn btn-outline-primary btn-sm ms-1" style="width:40px;" onclick="changeGoalTimes('goalMinTimes', 1, 0, 7)">+</button>
              <input type="number" min="0" max="7" class="form-control text-center mb-1" id="goalMinTimes" value="1" required style="width:45px;">
              <button type="button" class="btn btn-outline-primary btn-sm ms-1" style="width:36px;" onclick="changeGoalTimes('goalMinTimes', -1, 0, 7)">-</button>
            </div>
            <div class="col d-flex flex-column align-items-center">
              <label class="mb-1">ÎˆÏ‰Ï‚ (max):</label>
              <button type="button" class="btn btn-outline-primary btn-sm ms-1" style="width:36px;" onclick="changeGoalTimes('goalMaxTimes', 1, 1, 7)">+</button>
              <input type="number" min="1" max="7" class="form-control text-center mb-1" id="goalMaxTimes" value="1" required style="width:45px;">
              <button type="button" class="btn btn-outline-primary btn-sm ms-1" style="width:36px;" onclick="changeGoalTimes('goalMaxTimes', -1, 1, 7)">-</button>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-primary" form="goalForm">ÎšÎ±Ï„Î±Ï‡ÏÏÎ·ÏƒÎ·</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Î†ÎºÏ…ÏÎ¿</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmModalTitle">Î•Ï€Î¹Î²ÎµÎ²Î±Î¯Ï‰ÏƒÎ·</h5>
      </div>
      <div class="modal-body" id="confirmModalBody">
        Î£Î¯Î³Î¿Ï…ÏÏƒ;
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Î†ÎºÏ…ÏÎ¿</button>
        <button type="button" class="btn btn-danger" id="confirmModalYesBtn">ÎÎ±Î¹!</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="profileCompleteModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content text-center">
      <div class="modal-body py-4">
        <h4 class="mb-2">ğŸ‰ Î£Ï…Î³Ï‡Î±ÏÎ·Ï„Î®ÏÎ¹Î±!</h4>
        <p>ÎŸÎ»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎµÏ‚ Ï„Î¿ Ï€ÏÎ¿Ï†Î¯Î» ÏƒÎ¿Ï….<br>Î¦ÏÎ³Î±Î¼Îµ Î³Î¹Î± Ï„Î· ÎºÎ¿Ï…Î¶Î¯Î½Î±;</p>
        <button class="btn btn-success mt-3" style="font-size:1em!important; padding:10px 15px;" data-bs-dismiss="modal">Î Î¬Î¼Îµ!</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}



{% block scripts %}

<script>

function updateProfileCompletionBar() {
  fetch("/profile_completion_percent")
    .then(res => res.json())
    .then(data => {
      const val = data.completion || 0;
      const bar = document.getElementById("profile-completion-fill");
      if (bar) {
        bar.style.width = val + "%";
      }
	const splashShown = localStorage.getItem("profileSplashShown") === "true";
      // Î‘Î½ Ï†Ï„Î¬ÏƒÎµÎ¹ 100% ÎºÎ±Î¹ Î´ÎµÎ½ Î­Ï‡ÎµÎ¹ Î¾Î±Î½Î±Î³Î¯Î½ÎµÎ¹ splash
      if (val >= 100 && !splashShown) {
        
        // ğŸ‰ Confetti
        confetti({
          particleCount: 150,
          spread: 120,
          origin: { y: 0.6 },
          scalar: 1.1
        });

        // ğŸª© Splash modal
        const modal = new bootstrap.Modal(document.getElementById("profileCompleteModal"));
        modal.show();
		// âœ… Î˜Ï…Î¼Î¬Ï„Î±Î¹ ÏŒÏ„Î¹ ÎµÎ¼Ï†Î±Î½Î¯ÏƒÏ„Î·ÎºÎµ
        localStorage.setItem("profileSplashShown", "true");
      }
    });
}

window.addEventListener("DOMContentLoaded", updateProfileCompletionBar);

function openGoalModal(mode, id, category, min, max) {
  const modal = new bootstrap.Modal(document.getElementById('addGoalModal'));
  document.getElementById('goalError').style.display = 'none';
  document.getElementById('goalError').innerText = '';

  const select = document.getElementById('goalCategory');

  if (mode === 'edit') {
    document.getElementById('addGoalModalLabel').innerText = 'Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î± Î£Ï„ÏŒÏ‡Î¿Ï…';
    document.getElementById('goalCategory').value = category;
    document.getElementById('goalMinTimes').value = min;
    document.getElementById('goalMaxTimes').value = max;
    document.getElementById('goalCategory').disabled = true; // Î”ÎµÎ½ Î±Î»Î»Î¬Î¶ÎµÎ¹Ï‚ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î±
  } else {
    document.getElementById('addGoalModalLabel').innerText = 'Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· Î£Ï„ÏŒÏ‡Î¿Ï…';
    document.getElementById('goalForm').reset();
    document.getElementById('goalCategory').disabled = false;

    // Î•Ï€Î±Î½Î±Ï†Î­ÏÏ‰ ÎŸÎ›Î•Î£ Ï„Î¹Ï‚ ÎµÏ€Î¹Î»Î¿Î³Î­Ï‚ Î±ÏÏ‡Î¹ÎºÎ¬ (ÏÏƒÏ„Îµ Î½Î± ÎºÎ±Î¸Î±ÏÎ¯ÏƒÎµÎ¹ Î±Ï€ÏŒ Ï€ÏÎ¿Î·Î³Î¿ÏÎ¼ÎµÎ½Î±)
    const allCats = [...select.dataset.all.split(',')];
    select.innerHTML = '';
    
    allCats.forEach(cat => {
      // Î‘Î½ Î· ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î± Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Î®Î´Î· ÏƒÏ„Î¿Î½ Ï€Î¯Î½Î±ÎºÎ±, Î¼Î· Ï„Î· Î²Î¬Î»ÎµÎ¹Ï‚
      const exists = document.querySelector(`#goals-tbody tr td:first-child`) && 
                     [...document.querySelectorAll(`#goals-tbody tr td:first-child`)]
                     .some(td => td.textContent === cat);
      if (!exists) {
        const opt = document.createElement('option');
        opt.value = cat;
        opt.textContent = cat;
        select.appendChild(opt);
      }
    });

    // Î‘Î½ Î´ÎµÎ½ Î­Î¼ÎµÎ¹Î½Îµ Ï„Î¯Ï€Î¿Ï„Î± Î½Î± Î´Î¹Î±Î»Î­Î¾ÎµÎ¹Ï‚
    if (select.options.length === 0) {
      showGoalError("ÎˆÏ‡ÎµÎ¹Ï‚ Î®Î´Î· Ï€ÏÎ¿ÏƒÎ¸Î­ÏƒÎµÎ¹ ÏŒÎ»Î¿Ï…Ï‚ Ï„Î¿Ï…Ï‚ Î´Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î¿Ï…Ï‚ ÏƒÏ„ÏŒÏ‡Î¿Ï…Ï‚.", 3000);
      return;
    }
  }

  modal.show();

  document.getElementById('goalForm').onsubmit = function(e) {
    e.preventDefault();
    var minVal = parseInt(document.getElementById('goalMinTimes').value);
    var maxVal = parseInt(document.getElementById('goalMaxTimes').value);
    var selectedCat = document.getElementById('goalCategory').value;

    if (minVal > maxVal) {
      showGoalError('Î¤Î¿ "Î‘Ï€ÏŒ" Î´ÎµÎ½ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± ÎµÎ¯Î½Î±Î¹ Î¼ÎµÎ³Î±Î»ÏÏ„ÎµÏÎ¿ Î±Ï€ÏŒ Ï„Î¿ "ÎˆÏ‰Ï‚".', 2000);
      return;
    }

    if (mode === 'edit') {
      fetch('/edit_weekly_goal', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ id: id, min_times: minVal, max_times: maxVal })
      })
      .then(r => r.json())
      .then(data => {
        if (data.status === 'ok') {
          bootstrap.Modal.getInstance(document.getElementById('addGoalModal')).hide();
          updateGoalInTable(id, minVal, maxVal);
		  updateProfileCompletionBar(); // âœ… live ÎµÎ½Î·Î¼Î­ÏÏ‰ÏƒÎ·
        } else {
          showGoalError(data.msg || 'Î£Ï†Î¬Î»Î¼Î±!' , 2000);
        }
      });
    } else {
      fetch('/add_weekly_goal', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ category: selectedCat, min_times: minVal, max_times: maxVal })
      })
      .then(r => r.json())
      .then(data => {
        if (data.status === 'ok') {
          bootstrap.Modal.getInstance(document.getElementById('addGoalModal')).hide();
          addGoalToTable(selectedCat, minVal, maxVal, data.id);
		  updateProfileCompletionBar(); // âœ… live ÎµÎ½Î·Î¼Î­ÏÏ‰ÏƒÎ·
        } else {
          showGoalError(data.msg || 'Î£Ï†Î¬Î»Î¼Î±!', 2000);
        }
      });
    }
  };
}

function addGoalRow() {
  openGoalModal('add');
}

function changeGoalTimes(inputId, delta, min, max) {
  let inp = document.getElementById(inputId);
  let val = parseInt(inp.value) || min;
  val += delta;
  if (val < min) val = min;
  if (val > max) val = max;
  inp.value = val;
}

function editGoal(id, category, min, max) {
  openGoalModal('edit', id, category, min, max);
}

function updateGoalInTable(id, min, max) {
  var row = document.querySelector('tr[data-goalid="' + id + '"]');
  if (row) {
    var typeStr = (min == max)
      ? 'Î‘ÎºÏÎ¹Î²ÏÏ‚ ' + min + ' Ï†Î¿ÏÎ­Ï‚'
      : 'Î‘Ï€ÏŒ ' + min + ' Î­Ï‰Ï‚ ' + max + ' Ï†Î¿ÏÎ­Ï‚';
    // Î¤Î¿ Ï€ÏÏÏ„Î¿ td ÎµÎ¯Î½Î±Î¹ Î· ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î± ÎºÎ±Î¹ Î´ÎµÎ½ Î±Î»Î»Î¬Î¶ÎµÎ¹
    row.children[1].textContent = typeStr;
    // Î‘Î½ Î­Ï‡ÎµÎ¹Ï‚ ÏƒÏ„Î®Î»Î· "Ï†Î¿ÏÎ­Ï‚" ÎºÎ±Î¹ Ï„Î·Î½ ÎºÏÎ±Ï„Î¬Ï‚, Ï„ÏŒÏ„Îµ row.children[2].textContent = min + 'â€“' + max;
  }
}

function showGoalError(msg, duration=2000) {
  const alertDiv = document.getElementById('goalError');
  alertDiv.textContent = msg;
  alertDiv.style.display = '';
  alertDiv.classList.add('show');
  setTimeout(() => {
    alertDiv.classList.remove('show');
    setTimeout(()=>{alertDiv.style.display='none';}, 1000); // Ï€ÎµÏÎ¯Î¼ÎµÎ½Îµ Ï„Î¿ fade
  }, duration);
}

function addGoalToTable(category, min, max, id) {
  var tbody = document.getElementById('goals-tbody');
  var emptyRow = tbody.querySelector('tr td.text-muted');
  if (emptyRow) emptyRow.parentNode.remove();

  var tr = document.createElement('tr');
  tr.setAttribute('data-goalid', id);

  // Î•Î»Î»Î·Î½Î¹ÎºÎ® Î´Î¹Î±Ï„ÏÏ€Ï‰ÏƒÎ·:
  var typeStr = '';
  if (min != max) {
    typeStr = 'Î‘Ï€ÏŒ ' + min + ' Î­Ï‰Ï‚ ' + max + ' Ï†Î¿ÏÎ­Ï‚';
  } else {
    if (min == 1) {
      typeStr = 'Î‘ÎºÏÎ¹Î²ÏÏ‚ 1 Ï†Î¿ÏÎ¬';
    } else {
      typeStr = 'Î‘ÎºÏÎ¹Î²ÏÏ‚ ' + min + ' Ï†Î¿ÏÎ­Ï‚';
    }
  }

  var html = '';
  html += '<td>' + category + '</td>';
  html += '<td>' + typeStr + '</td>';
  html += '<td>';
  html += '<button class="btn btn-outline-primary btn-sm me-1" onclick="editGoal('
      + id + ',\'' + category.replace(/'/g, "\\'") + '\',' + min + ',' + max + ')">'
      + '<i class="fa fa-pen"></i></button>';
  html += '<button class="btn btn-outline-danger btn-sm" onclick="deleteGoal(' + id + ')">'
      + '<i class="fa fa-trash"></i></button>';
  html += '</td>';

  tr.innerHTML = html;
  tbody.appendChild(tr);
  // Î•Î¼Ï†Î¬Î½Î¹ÏƒÎµ Ï„Î¿ ÎºÎ¿Ï…Î¼Ï€Î¯ "Î”Î¹Î±Î³ÏÎ±Ï†Î® ÏŒÎ»Ï‰Î½"
  document.getElementById('deleteAllBtn')?.style.setProperty('display', 'inline-block');
}

function confirmAction(message, onConfirm, title = 'Î•Ï€Î¹Î²ÎµÎ²Î±Î¯Ï‰ÏƒÎ·') {
  document.getElementById('confirmModalTitle').innerText = title;
  document.getElementById('confirmModalBody').innerText = message;

  const modalEl = document.getElementById('confirmModal');
  const modal = new bootstrap.Modal(modalEl);
  modal.show();

  const yesBtn = document.getElementById('confirmModalYesBtn');
  // ÎšÎ±Î¸Î±ÏÎ¯Î¶Î¿Ï…Î¼Îµ Ï€ÏÎ¿Î·Î³Î¿ÏÎ¼ÎµÎ½Î± listeners
  const newBtn = yesBtn.cloneNode(true);
  yesBtn.parentNode.replaceChild(newBtn, yesBtn);

  newBtn.addEventListener('click', function() {
    modal.hide();
    onConfirm();
  });
}

function deleteGoal(goal_id) {
  confirmAction(
    'Î•Î¯ÏƒÎ±Î¹ ÏƒÎ¯Î³Î¿Ï…ÏÎ¿Ï‚ ÏŒÏ„Î¹ Î¸Î­Î»ÎµÎ¹Ï‚ Î½Î± Î´Î¹Î±Î³ÏÎ¬ÏˆÎµÎ¹Ï‚ Î±Ï…Ï„ÏŒÎ½ Ï„Î¿Î½ ÏƒÏ„ÏŒÏ‡Î¿;',
    function() {
      fetch('/delete_weekly_goal', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id: goal_id })
      }).then(r => r.json()).then(data => {
        if (data.status === 'ok') {
		updateProfileCompletionBar(); // âœ… live ÎµÎ½Î·Î¼Î­ÏÏ‰ÏƒÎ·
          const row = document.querySelector('tr[data-goalid="' + goal_id + '"]');
          if (row) {
            const cat = row.children[0].textContent;
            row.remove();

            // Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· Ï€Î¯ÏƒÏ‰ ÏƒÏ„Î¿ select
            const select = document.getElementById('goalCategory');
            if (select && ![...select.options].some(opt => opt.value === cat)) {
              const opt = document.createElement('option');
              opt.value = cat;
              opt.textContent = cat;
              select.appendChild(opt);
            }
          }

          const tbody = document.getElementById('goals-tbody');
          if (tbody.querySelectorAll('tr[data-goalid]').length === 0) {
            const tr = document.createElement('tr');
            tr.innerHTML = '<td colspan="3" class="text-muted">Î”ÎµÎ½ Î­Ï‡ÎµÎ¹Ï‚ Î¿ÏÎ¯ÏƒÎµÎ¹ ÏƒÏ„ÏŒÏ‡Î¿Ï…Ï‚.</td>';
            tbody.appendChild(tr);

            // Î‘Ï€ÏŒÎºÏÏ…ÏˆÎµ Ï„Î¿ ÎºÎ¿Ï…Î¼Ï€Î¯ "Î”Î¹Î±Î³ÏÎ±Ï†Î® ÏŒÎ»Ï‰Î½"
            document.getElementById('deleteAllBtn')?.style.setProperty('display', 'none');
          }
        } else {
          alert(data.msg || 'Î£Ï†Î¬Î»Î¼Î± ÏƒÏ„Î· Î´Î¹Î±Î³ÏÎ±Ï†Î®.');
        }
      });
    },
    'Î”Î¹Î±Î³ÏÎ±Ï†Î® Î£Ï„ÏŒÏ‡Î¿Ï…'
  );
}

function deleteAllGoals() {
  confirmAction(
    'Î˜Î± Î´Î¹Î±Î³ÏÎ±Ï†Î¿ÏÎ½ ÏŒÎ»Î¿Î¹ Î¿Î¹ ÏƒÏ„ÏŒÏ‡Î¿Î¹ ÏƒÎ¿Ï…. Î˜Î­Î»ÎµÎ¹Ï‚ Î½Î± ÏƒÏ…Î½ÎµÏ‡Î¯ÏƒÎµÎ¹Ï‚;',
    function() {
      fetch('/delete_all_weekly_goals', { method: 'POST' })
        .then(r => r.json())
        .then(data => {
          if (data.status === 'ok') {
		    updateProfileCompletionBar(); // âœ… live ÎµÎ½Î·Î¼Î­ÏÏ‰ÏƒÎ·
            const tbody = document.getElementById('goals-tbody');
            tbody.innerHTML = '<tr><td colspan="3" class="text-muted">Î”ÎµÎ½ Î­Ï‡ÎµÎ¹Ï‚ Î¿ÏÎ¯ÏƒÎµÎ¹ ÏƒÏ„ÏŒÏ‡Î¿Ï…Ï‚.</td></tr>';

            // Î‘Ï€ÏŒÎºÏÏ…ÏˆÎµ Ï„Î¿ ÎºÎ¿Ï…Î¼Ï€Î¯ "Î”Î¹Î±Î³ÏÎ±Ï†Î® ÏŒÎ»Ï‰Î½"
            document.getElementById('deleteAllBtn')?.style.setProperty('display', 'none');

            // Î•Ï€Î±Î½Î±Ï†Î¿ÏÎ¬ ÏŒÎ»Ï‰Î½ Ï„Ï‰Î½ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¹ÏÎ½ ÏƒÏ„Î¿ dropdown
            const select = document.getElementById('goalCategory');
            const allCats = select.dataset.all.split(',');
            select.innerHTML = '';
            allCats.forEach(cat => {
              const opt = document.createElement('option');
              opt.value = cat;
              opt.textContent = cat;
              select.appendChild(opt);
            });
          } else {
            alert(data.msg || 'Î£Ï†Î¬Î»Î¼Î± ÏƒÏ„Î· Î´Î¹Î±Î³ÏÎ±Ï†Î®.');
          }
        });
    },
    'Î”Î¹Î±Î³ÏÎ±Ï†Î® ÎŒÎ»Ï‰Î½ Ï„Ï‰Î½ Î£Ï„ÏŒÏ‡Ï‰Î½'
  );
}

function deleteMember(member_id, btn) {
  if (!confirm('Î˜Î­Î»ÎµÎ¹Ï‚ ÏƒÎ¯Î³Î¿Ï…ÏÎ± Î½Î± Î´Î¹Î±Î³ÏÎ¬ÏˆÎµÎ¹Ï‚ Î±Ï…Ï„ÏŒ Ï„Î¿ Î¼Î­Î»Î¿Ï‚;')) return;
  fetch('/delete_family_member', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ member_id: member_id })
  })
  .then(function(r) { return r.json(); })
  .then(function(res) {
    if (res.status === 'ok') {
	  // âœ… Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· completion bar
      updateProfileCompletionBar();
      // Î’ÏÎµÏ‚ Ï„Î¿ <tr> Ï„Î¿Ï… Î¼Î­Î»Î¿Ï…Ï‚ ÎºÎ±Î¹ Î±Ï†Î±Î¯ÏÎµÏƒÎ­ Ï„Î¿
      var row = btn.closest('tr[data-memberid]');
      if (row) row.remove();

      // Î‘Î½ Î´ÎµÎ½ Î­Î¼ÎµÎ¹Î½Îµ ÎºÎ±Î½Î­Î½Î± Î¼Î­Î»Î¿Ï‚, ÎµÎ¼Ï†Î¬Î½Î¹ÏƒÎµ Ï„Î¿ "Î”ÎµÎ½ Î­Ï‡Î¿Ï…Î½ Ï€ÏÎ¿ÏƒÏ„ÎµÎ¸ÎµÎ¯ Î¼Î­Î»Î·."
      var tbody = document.getElementById('members-list');
      if (!tbody.querySelector('tr')) {
        var tr = document.createElement('tr');
        var td = document.createElement('td');
        td.className = "text-muted";
        td.colSpan = 1;
        td.innerText = "Î”ÎµÎ½ Î­Ï‡Î¿Ï…Î½ Ï€ÏÎ¿ÏƒÏ„ÎµÎ¸ÎµÎ¯ Î¼Î­Î»Î·.";
        tr.appendChild(td);
        tbody.appendChild(tr);
      }
    }
  });
}

function openAddMemberModal() {
  document.getElementById('memberModalLabel').innerText = 'Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· ÎœÎ­Î»Î¿Ï…Ï‚';
  document.getElementById('member-form').reset();
  document.getElementById('member-id').value = '';
  document.getElementById('member-allergies-other').style.display = 'none';
  bootstrap.Modal.getOrCreateInstance(document.getElementById('memberModal')).show();
}

function editMember(member_id, btn) {
  // Î’ÏÎµÏ‚ Ï„Î¿ ÏƒÏ‰ÏƒÏ„ÏŒ <tr>
  var row = btn.closest('tr[data-memberid]');
  if (!row) return;

  document.getElementById('memberModalLabel').innerText = 'Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î± ÎœÎ­Î»Î¿Ï…Ï‚';
  document.getElementById('member-id').value = member_id;

  // Î’ÏÎµÏ‚ Ï„Î¿ td (Ï€ÏÏÏ„Î¿ ÎºÎµÎ»Î¯)
  var td = row.querySelector('td');
  if (!td) return;

  // ÎŒÎ½Î¿Î¼Î±
  var nameEl = td.querySelector('strong');
  document.getElementById('member-name').value = nameEl ? nameEl.innerText.trim() : '';

  // Î—Î»Î¹ÎºÎ¯Î± (Î±Î½Î±Î¶Î®Ï„Î·ÏƒÎµ span Î¼Îµ class "text-muted", Ï€.Ï‡. "(35 ÎµÏ„ÏÎ½)")
  var ageEl = td.querySelector('.text-muted');
  var ageVal = '';
  if (ageEl) {
    var match = ageEl.innerText.match(/(\d+)/);
    if (match) ageVal = match[1];
  }
  document.getElementById('member-age').value = ageVal;

  // Î‘Î»Î»ÎµÏÎ³Î¯ÎµÏ‚ (Î±Î½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½)
  var allergies = '';
  var allergyEl = td.querySelector('.badge.bg-warning, .badge.bg-danger');
  if (allergyEl) {
    // Î‘Ï†Î±Î¹ÏÎ¿ÏÎ¼Îµ Ï„Î¿ ÎµÎ¹ÎºÎ¿Î½Î¯Î´Î¹Î¿ ÎºÎ±Î¹ ÎºÎµÎ½Î¬
    var allergyText = allergyEl.innerText.replace(/^Î‘Î»Î»ÎµÏÎ³Î¯ÎµÏ‚:? ?/, '').trim();
    allergies = allergyText;
  }

  // Î“Î­Î¼Î¹ÏƒÎµ Ï„Î¿ select + input "Î¬Î»Î»Î¿"
  var choices = window.choicesAllergies;
  choices.removeActiveItems();
  document.getElementById('member-allergies-other').value = '';
  document.getElementById('member-allergies-other').style.display = 'none';

  if (allergies) {
    // Î£Ï€Î¬ÏƒÎµ Î¼Îµ ÎºÏŒÎ¼Î¼Î±, Î±Ï†Î±Î¯ÏÎµÏƒÎµ ÎºÎµÎ½Î¬
    var tags = allergies.split(',').map(function(t){return t.trim();});
    tags.forEach(function(tag) {
      var optExists = Array.from(document.getElementById('member-allergies-select').options).some(function(opt) {
        return opt.value === tag;
      });
      if (optExists) {
        choices.setChoiceByValue(tag);
      } else if (tag) {
        choices.setChoiceByValue('__other__');
        document.getElementById('member-allergies-other').value = tag;
        document.getElementById('member-allergies-other').style.display = '';
      }
    });
  }
  // Î•Î¼Ï†Î¬Î½Î¹ÏƒÎµ Ï„Î¿ modal
  bootstrap.Modal.getOrCreateInstance(document.getElementById('memberModal')).show();
}

document.getElementById('member-form').onsubmit = function(e) {
  e.preventDefault();
  var form = e.target;
  var sel = document.getElementById('member-allergies-select');
  var other = document.getElementById('member-allergies-other');
  var selected = [];
  for (var i = 0; i < sel.options.length; ++i)
    if (sel.options[i].selected && sel.options[i].value != '__other__') selected.push(sel.options[i].value);
  var otherVal = other.value.trim();
  if (other.style.display !== 'none' && otherVal) selected.push(otherVal);

  var allergiesString = selected.join(', ');

  var data = {
    member_id: form.member_id.value,
    name: form.name.value.trim(),
    age: form.age.value,
    allergies: allergiesString
  };

  var url = data.member_id ? '/edit_family_member' : '/add_family_member';
  fetch(url, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(data)
  })
  .then(function(r) { return r.json(); })
  .then(function(res) {
    if (res.status === 'ok') {
	  // âœ… Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· completion bar
      updateProfileCompletionBar();
      // EDIT Ï…Ï€Î¬ÏÏ‡Î¿Î½ Î¼Î­Î»Î¿Ï‚
      if (data.member_id) {
        var row = document.querySelector('tr[data-memberid="' + data.member_id + '"]');
        if (row) {
          var td = row.querySelector('td');
          td.innerHTML =
            '<div class="d-flex justify-content-left align-items-center flex-wrap gap-1 mb-0" style="gap:6px;">' +
              '<i class="fa fa-user-friends text-secondary"></i> <strong>' + data.name + '</strong>' +
              '<span class="text-muted">(' + data.age + ' ÎµÏ„ÏÎ½)</span>' +
              '<button class="btn btn-outline-primary btn-sm ms-1" title="Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î±" onclick="editMember(' + data.member_id + ', this)">' +
                '<i class="fa fa-pen"></i>' +
              '</button>' +
              '<button type="button" class="btn btn-outline-danger btn-sm ms-1" title="Î”Î¹Î±Î³ÏÎ±Ï†Î®" onclick="deleteMember(' + data.member_id + ', this)">' +
                '<i class="fa fa-trash"></i>' +
              '</button>' +
            '</div>' +
            (data.allergies
              ? '<div class="mt-1 text-start" style="width:100%;"><span class="badge bg-warning" title="Î‘Î»Î»ÎµÏÎ³Î¯ÎµÏ‚"><i class="fa fa-exclamation-triangle"></i> ' + data.allergies + '</span></div>'
              : ''
            );
        }
      } else {
        // ADD Î½Î­Î¿ Î¼Î­Î»Î¿Ï‚: Ï€ÏÏŒÏƒÎ¸ÎµÏƒÎµ Î½Î­Î¿ <tr> ÏƒÏ„Î¿Î½ Ï€Î¯Î½Î±ÎºÎ±
        var tbody = document.getElementById('members-list');
        // Î”Î¹Î­Î³ÏÎ±ÏˆÎµ Ï„Î¿ "Î”ÎµÎ½ Î­Ï‡Î¿Ï…Î½ Ï€ÏÎ¿ÏƒÏ„ÎµÎ¸ÎµÎ¯ Î¼Î­Î»Î·." Î±Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹
        var emptyRow = tbody.querySelector('tr > td.text-muted');
        if (emptyRow) emptyRow.parentNode.remove();

        // Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¯Î·ÏƒÎµ Ï„Î¿ id Î±Ï€ÏŒ Ï„Î¿ response (Ï€Î¿Ï… ÏƒÏ„Î­Î»Î½ÎµÎ¹ Ï„Î¿ backend)
        var newId = res.id;
        var tr = document.createElement('tr');
        tr.setAttribute('data-memberid', newId);

        var td = document.createElement('td');
        td.innerHTML =
          '<div class="d-flex justify-content-left align-items-center flex-wrap gap-1 mb-0" style="gap:6px;">' +
            '<i class="fa fa-user-friends text-secondary"></i> <strong>' + data.name + '</strong>' +
            '<span class="text-muted">(' + data.age + ' ÎµÏ„ÏÎ½)</span>' +
            '<button class="btn btn-outline-primary btn-sm ms-1" title="Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î±" onclick="editMember(' + newId + ', this)">' +
              '<i class="fa fa-pen"></i>' +
            '</button>' +
            '<button type="button" class="btn btn-outline-danger btn-sm ms-1" title="Î”Î¹Î±Î³ÏÎ±Ï†Î®" onclick="deleteMember(' + newId + ', this)">' +
              '<i class="fa fa-trash"></i>' +
            '</button>' +
          '</div>' +
          (data.allergies
            ? '<div class="mt-1 text-start" style="width:100%;"><span class="badge bg-warning" title="Î‘Î»Î»ÎµÏÎ³Î¯ÎµÏ‚"><i class="fa fa-exclamation-triangle"></i> ' + data.allergies + '</span></div>'
            : ''
          );

        tr.appendChild(td);
        tbody.appendChild(tr);
      }
      bootstrap.Modal.getInstance(document.getElementById('memberModal')).hide();
      form.reset();
      document.getElementById('member-allergies-other').style.display = 'none';
    }
  });
};

document.getElementById('member-allergies-select').onchange = function() {
  var sel = this;
  var show = false;
  for (var i=0; i<sel.options.length; ++i)
    if (sel.options[i].selected && sel.options[i].value == '__other__') show = true;
  document.getElementById('member-allergies-other').style.display = show ? '' : 'none';
};

function editCookingTimes() {
  var modal = new bootstrap.Modal(document.getElementById('editCookTimesModal'));
  modal.show();
}

document.getElementById('cook-times-form').onsubmit = function(e) {
  e.preventDefault();
  var data = {};
  var days = ['mon','tue','wed','thu','fri','sat','sun'];
  days.forEach(function(d) {
    data['cooktime_' + d] = document.getElementById('cooktime-' + d + '-input').value;
  });

  fetch('/edit_cooking_times', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(data)
  }).then(function(r){ return r.json(); }).then(function(res){
    if(res.status === 'ok') {
      days.forEach(function(d) {
        document.getElementById('cooktime-' + d + '-display').textContent = 
          (data['cooktime_' + d] || '-') + ' Î».';
      });

      // ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿ modal
      bootstrap.Modal.getInstance(document.getElementById('editCookTimesModal')).hide();

      // âœ… Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· completion bar
      updateProfileCompletionBar();
    }
  });
};

function editProfileInfo() {
  var modal = new bootstrap.Modal(document.getElementById('editProfileModal'));
  modal.show();
}

window.addEventListener('DOMContentLoaded', function() {
  if (window.choicesCooking) {
    window.choicesCooking.destroy();
  }

  window.choicesCooking = new Choices('#cooking-methods-select', {
    removeItemButton: true,
    searchEnabled: false,
    placeholderValue: 'Î•Ï€Î¯Î»ÎµÎ¾Îµ Ï„ÏÏŒÏ€Î¿... ÎœÏ€Î¿ÏÎµÎ¯Ï‚ Î½Î± ÎµÏ€Î¹Î»Î­Î¾ÎµÎ¹Ï‚ ÏŒÏƒÎ¿Ï…Ï‚ Î¸ÎµÏ‚!',
    shouldSort: false,
    duplicateItemsAllowed: false,
    maxItemCount: 10
  });

  // Î ÎµÏÎ¹Î¼Î­Î½Î¿Ï…Î¼Îµ Î»Î¯Î³Î¿ Î½Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î·Î¸ÎµÎ¯ Ï„Î¿ cloned input
  setTimeout(() => {
    const clonedInput = document.querySelector('.choices__input--cloned');
    if (clonedInput) {
      clonedInput.disabled = true;
      clonedInput.setAttribute('tabindex', '-1');
      clonedInput.style.pointerEvents = 'none';
      clonedInput.style.userSelect = 'none';
      clonedInput.style.caretColor = 'transparent';
    }
  }, 50);

  window.choicesCooking.passedElement.element.addEventListener('addItem', function(e) {
    window.choicesCooking.hideDropdown();
  });
});

document.getElementById('profile-info-form').onsubmit = function(e) {
  e.preventDefault();
  var form = e.target;

  var cookingVals = window.choicesCooking.getValue(true);
  if (Array.isArray(cookingVals)) cookingVals = cookingVals.join(',');

  var data = {
    first_name: form.first_name.value.trim(),
    family_name: form.family_name.value.trim(),
    address: form.address.value.trim(),
//    alt_address: form.alt_address.value.trim(),
    chef: form.chef.value.trim(),
    menu_day: form.menu_day.value.trim(),
    menu_hour: form.menu_hour.value.trim(),
    cooking_method: cookingVals
  };

  fetch('/edit_profile_info', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(data)
  }).then(function(r){return r.json();}).then(function(res){
    

    if(res.status === 'ok') {
      // ÎŒÎ½Î¿Î¼Î± Ï€ÏÎ¿Ï†Î¯Î»
      let nameEl = document.getElementById('profile-name');
      if (nameEl) {
        nameEl.innerHTML = '<i class="fa fa-user-circle fa-lg me-2"></i> ' + data.first_name + ' ' + data.family_name;
      }

      // Î”Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ·
      let addrEl = document.getElementById('profile-address');
      if (addrEl) addrEl.textContent = data.address;

      // Î£ÎµÏ†
      let chefEl = document.getElementById('profile-chef');
      if (chefEl) {
		  chefEl.textContent = (data.chef && data.chef !== '-- Î•Ï€Î¹Î»Î­Î¾Ï„Îµ --') ? data.chef : '-';
		}

      // Î—Î¼Î­ÏÎ± ÎºÎ±Î¹ ÏÏÎ± Î¼ÎµÎ½Î¿Ï
		let dayEl = document.getElementById('profile-menu-day');
		let hourEl = document.getElementById('profile-menu-hour');

		if (dayEl) {
		  dayEl.textContent = (data.menu_day && data.menu_day !== '-- ÎœÎ­ÏÎ± --') ? data.menu_day : '';
		}

		if (hourEl) {
		  hourEl.textContent = (data.menu_hour && data.menu_hour !== '-- ÎÏÎ± --') ? data.menu_hour : '';
		}

      // ÎœÎ­Î¸Î¿Î´Î¿Î¹ Î¼Î±Î³ÎµÎ¹ÏÎ­Î¼Î±Ï„Î¿Ï‚ Ï‰Ï‚ badges
      var cookingDiv = document.getElementById('profile-cooking-method');
      if (cookingDiv) {
        var html = "";
        if (data.cooking_method && data.cooking_method.length > 0) {
          html = data.cooking_method.split(',').map(function(m){
            return '<span class="badge bg-warning text-dark me-1"><i class="fa fa-fire"></i> ' + m.trim() + '</span>';
          }).join(' ');
        } else {
          html = '<span class="text-muted">-</span>';
        }
        cookingDiv.innerHTML = html;
      } else {
      }

      // Î•Î½Î±Î»Î»Î±ÎºÏ„Î¹ÎºÎ® Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ·
      var altSpan = document.getElementById('profile-alt-address');
      if (altSpan) {
        if (data.alt_address) {
          altSpan.textContent = data.alt_address;
          altSpan.parentElement.style.display = '';
        } else {
          altSpan.parentElement.style.display = 'none';
        }
      }
      // ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿ modal
      var modal = document.getElementById('editProfileModal');
      if (modal) {
        var bsModal = bootstrap.Modal.getInstance(modal);
        if (bsModal) {
		bsModal.hide();
        }
		else console.warn('Bootstrap modal not found!');
      } else {
        console.warn('editProfileModal not found!');
      }
    } else {
      console.error('Profile update failed:', res);
    }
	updateProfileCompletionBar();
  });
};

window.addEventListener('DOMContentLoaded', function() {
  window.choicesAllergies = new Choices('#member-allergies-select', {
    removeItemButton: true,
    placeholderValue: 'Î•Ï€Î¯Î»ÎµÎ¾Îµ...',
    searchPlaceholderValue: 'Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ·...',
    noResultsText: 'Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ Î±Î»Î»ÎµÏÎ³Î¯ÎµÏ‚',
    itemSelectText: 'Î•Ï€Î¹Î»Î¿Î³Î®',
    shouldSort: false,
    duplicateItemsAllowed: false,
    maxItemCount: 15
  });

  // ÎšÎ»ÎµÎ¯Î½ÎµÎ¹ Ï„Î¿ drop-down ÏŒÏ„Î±Î½ ÎµÏ€Î¹Î»Î­Î³ÎµÏ„Î±Î¹ ÎºÎ¬Ï„Î¹!
  window.choicesAllergies.passedElement.element.addEventListener('addItem', function(e) {
    window.choicesAllergies.hideDropdown();
  });
});

function showTooltipCenteredAbove(step, tooltipId, targetId = null, nextStep = null) {
  if (window.profileOnboarding.step > step) return;

  document.querySelectorAll(".onboarding-tooltip").forEach(t => {
    t.style.display = "none";
    t.style.visibility = "hidden";
  });

  const tooltip = document.getElementById(tooltipId);
  const target = targetId ? document.getElementById(targetId) : null;
  if (!tooltip) return;

  tooltip.style.visibility = "hidden";
  tooltip.style.display = "block";

  if (step === 6) {
    tooltip.style.position = "fixed";
    tooltip.style.width = "60vw";
    tooltip.style.bottom = "80px";
    tooltip.style.left = "90px";
    tooltip.style.top = "";
  } else if (target) {
    const rect = target.getBoundingClientRect();
    const tipWidth = tooltip.offsetWidth;
    const tipHeight = tooltip.offsetHeight;

    let left = rect.left + window.scrollX + (rect.width - tipWidth) / 2;
    let top = rect.top + window.scrollY - tipHeight - 15;

    const padding = 50;
    const maxX = window.innerWidth - tipWidth - padding;
    if (left < padding) left = padding;
    if (left > maxX) left = maxX;
    if (top < padding) top = rect.bottom + window.scrollY + 10;

    tooltip.style.position = "absolute";
    tooltip.style.left = `${left}px`;
    tooltip.style.top = `${top}px`;
    tooltip.style.bottom = "";
  }

  tooltip.style.visibility = "visible";

  if (target) {
    target.classList.add("onboarding-highlight");
    target.style.zIndex = "2001";
    target.style.position = "relative";

    const handler = () => {
      tooltip.style.display = "none";
      updateProfileOnboardingStep(step + 1);

      target.classList.remove("onboarding-highlight");
      target.style.zIndex = "";
      target.style.position = "";

      if (nextStep) {
        setTimeout(nextStep, 300);
      } else if (step === 6) {
        markProfileOnboardingComplete();
      }

      target.removeEventListener("click", handler);
    };

    target.addEventListener("click", handler);
  }
}

function runProfileOnboarding() {

  const step = getNextOnboardingStep();
  const profileModal = document.getElementById("editProfileModal");
  const cookModal = document.getElementById("editCookTimesModal");
  const memberModal = document.getElementById("memberModal");
  const goalModal = document.getElementById("addGoalModal");
  const backdrop = document.getElementById("onboardingBackdrop");
  const menuLink = document.querySelector('nav.navbar.fixed-bottom a[href="/menu"]');

  if (!step) return;

	  // STEP 2
	if (step === 2) {
	  const editBtn = document.getElementById("edit-profile-button");
	  
	  if (editBtn) {	
		if (!window.profileOnboarding.lightMode) {
		  backdrop.style.display = "block";
		}	
		document.body.classList.add("onboarding-step-2");

		showTooltipCenteredAbove(2, "onboardingTooltip2", "edit-profile-button", null);

		editBtn.addEventListener("click", function () {
		  document.body.classList.remove("onboarding-step-2");
		  document.getElementById("onboardingTooltip2").style.display = "none";

		  if (profileModal) {
			profileModal.addEventListener("hidden.bs.modal", () => {
			  // STEP 3
			  showTooltipCenteredAbove(3, "onboardingTooltip3", "edit-cook-times", () => {

				const waitAndShowStep4 = () => {
				  // STEP 4
				  showTooltipCenteredAbove(4, "onboardingTooltip4", "add-member", () => {

					const waitAndShowStep5 = () => {
					  // STEP 5
					  showTooltipCenteredAbove(5, "onboardingTooltip5", "add-goal-btn", () => {

						const waitAndShowStep6 = () => {
						  // STEP 6
						  backdrop.style.display = "none";
						  showTooltipCenteredAbove(6, "onboardingTooltip6", "menu-btn", null);
						};

						if (goalModal && goalModal.classList.contains("show")) {
						  goalModal.addEventListener("hidden.bs.modal", waitAndShowStep6, { once: true });
						} else {
						  waitAndShowStep6();
						}
					  });
					};

					if (memberModal && memberModal.classList.contains("show")) {
					  memberModal.addEventListener("hidden.bs.modal", waitAndShowStep5, { once: true });
					} else {
					  waitAndShowStep5();
					}

				  });
				};

				if (cookModal && cookModal.classList.contains("show")) {
				  cookModal.addEventListener("hidden.bs.modal", waitAndShowStep4, { once: true });
				} else {
				  waitAndShowStep4();
				}
			  });
			}, { once: true });
		  }
		}, { once: true });
	  }
	}

	if (step === 3) {
	  if (!window.profileOnboarding.lightMode) {
		  backdrop.style.display = "block";
		}
	  showTooltipCenteredAbove(3, "onboardingTooltip3", "edit-cook-times", () => {
		const waitAndShowStep4 = () => {
		  showTooltipCenteredAbove(4, "onboardingTooltip4", "add-member", () => {
			showTooltipCenteredAbove(5, "onboardingTooltip5", "add-goal-btn", () => {
			  if (goalModal && goalModal.classList.contains("show")) {
				goalModal.addEventListener("hidden.bs.modal", () => {
				  backdrop.style.display = "none";
				  showTooltipCenteredAbove(6, "onboardingTooltip6", "menu-btn", null);
				}, { once: true });
			  } else {
				backdrop.style.display = "none";
				showTooltipCenteredAbove(6, "onboardingTooltip6", "menu-btn", null);
			  }
			});
		  });
		};

		if (cookModal && cookModal.classList.contains("show")) {
		  cookModal.addEventListener("hidden.bs.modal", waitAndShowStep4, { once: true });
		} else {
		  waitAndShowStep4();
		}
	  });
	}

	if (step === 4) {
	  if (!window.profileOnboarding.lightMode) {
		  backdrop.style.display = "block";
		}
	  const waitAndShowStep5 = () => {
		showTooltipCenteredAbove(5, "onboardingTooltip5", "add-goal-btn", () => {
		  if (goalModal && goalModal.classList.contains("show")) {
			goalModal.addEventListener("hidden.bs.modal", () => {
			  backdrop.style.display = "none";
			  showTooltipCenteredAbove(6, "onboardingTooltip6", "menu-btn", null);
			}, { once: true });
		  } else {
			backdrop.style.display = "none";
			showTooltipCenteredAbove(6, "onboardingTooltip6", "menu-btn", null);
		  }
		});
	  };

	  showTooltipCenteredAbove(4, "onboardingTooltip4", "add-member", () => {
		if (memberModal && memberModal.classList.contains("show")) {
		  memberModal.addEventListener("hidden.bs.modal", waitAndShowStep5, { once: true });
		} else {
		  waitAndShowStep5();
		}
	  });
	}

	if (step === 5) {
	  if (!window.profileOnboarding.lightMode) {
		  backdrop.style.display = "block";
		}
	  showTooltipCenteredAbove(5, "onboardingTooltip5", "add-goal-btn", () => {
		if (goalModal && goalModal.classList.contains("show")) {
		  goalModal.addEventListener("hidden.bs.modal", () => {
			backdrop.style.display = "none";
			showTooltipCenteredAbove(6, "onboardingTooltip6", "menu-btn", null);
		  }, { once: true });
		} else {
		  backdrop.style.display = "none";
		  showTooltipCenteredAbove(6, "onboardingTooltip6", "menu-btn", null);
		}
	  });
	}

  if (step === 6) {
    backdrop.style.display = "none";
	document.getElementById("onboardingTooltip6").style.display = "none";
	document.getElementById("onboardingTooltip6").visibility = "hidden";
    showTooltipCenteredAbove(6, "onboardingTooltip6", "menu-btn", null);
  }

  // ÎŒÏ„Î±Î½ Ï€Î±Ï„Î·Î¸ÎµÎ¯ Ï„Î¿ ÎºÎ¿Ï…Î¼Ï€Î¯ "ÎœÎµÎ½Î¿Ï", ÎºÏÏÏˆÎµ tooltip6 ÎºÎ±Î¹ backdrop ÎºÎ±Î¹ Ï„ÎµÎ»ÎµÎ¯Ï‰ÏƒÎµ
  
  if (menuLink) {
    menuLink.addEventListener("click", function () {
      document.getElementById("onboardingTooltip6").style.display = "none";
      updateProfileOnboardingStep(7);
      markProfileOnboardingComplete();
    });
  }
}

window.profileOnboarding = {
  step: null,
  completed: false,
  initialized: false
};

window.addEventListener("DOMContentLoaded", function () {
  fetch("/api/onboarding_progress")
    .then(res => res.json())
    .then(data => {
      const profileData = data["profile"];
      const backdrop = document.getElementById("onboardingBackdrop");

      // Î‘Î½ Î´ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ ÎºÎ±Î¸ÏŒÎ»Î¿Ï… ÎµÎ³Î³ÏÎ±Ï†Î® onboarding, ÎµÎ¯Î½Î±Î¹ Î· Î Î¡Î©Î¤Î— Î¦ÎŸÎ¡Î‘ â†’ ÎºÎ±Î½Î¿Î½Î¹ÎºÏŒ onboarding
      if (!profileData) {
        return fetch("/api/onboarding_create_if_needed", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ page: "profile" })
        }).then(() => {
          window.profileOnboarding.step = 2;
          window.profileOnboarding.completed = false;
          window.profileOnboarding.initialized = true;
          window.profileOnboarding.lightMode = false; // âœ… Î Î»Î®ÏÎ·Ï‚ ÏÎ¿Î®

          localStorage.removeItem("profileOnboardingLightMode");
          runProfileOnboarding();
        });
      }

      const backendStep = profileData.step ?? 0;
      const completed = profileData.completed === true;

      // âœ… Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚ lightMode
      let lightMode = true;

      
	  if (backendStep === 0) {
        localStorage.setItem("profileOnboardingLightMode", "1");
        if (backdrop) backdrop.style.display = "none";  // ÎšÎ±Î¼Î¯Î± ÎµÏ€Î¹ÎºÎ¬Î»Ï…ÏˆÎ·
      } 
//	  lightMode=localStorage.getItem("profileOnboardingLightMode");
      window.profileOnboarding.step = backendStep === 0 ? 2 : backendStep;
      window.profileOnboarding.completed = completed;
      window.profileOnboarding.initialized = true;
      window.profileOnboarding.lightMode = lightMode;

      if (!lightMode) restrictNavIfNeeded(!completed);
      runProfileOnboarding();
    })
    .catch(err => {
      console.error("Error loading onboarding progress", err);
    });
});


function restrictNavIfNeeded(completed) {
  if (completed) return;

  const allowedPaths = ["/menu"];

  document.querySelectorAll("nav.navbar.fixed-bottom a").forEach(link => {
    const href = link.getAttribute("href");
    const isAllowed = allowedPaths.includes(href);

    if (!isAllowed) {
      link.classList.add("nav-disabled");
      link.style.pointerEvents = "none";
      link.style.opacity = "0.4";
    }
  });
}

function updateProfileOnboardingStep(step) {
  window.profileOnboarding.step = step;
  fetch("/api/onboarding_update_step", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ page: "profile", step })
  });
}

function markProfileOnboardingComplete() {
  window.profileOnboarding.completed = true;
  localStorage.removeItem("profileOnboardingLightMode");
  fetch("/api/onboarding_mark_completed", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ page: "profile" })
  });
}

function getNextOnboardingStep() {
  if (!window.profileOnboarding.initialized || window.profileOnboarding.completed) return null;
  return window.profileOnboarding.step;
}

</script>

{% endblock %}
