{% extends "base.html" %}
{% block title %}{{ recipe.title }} • Family Food{% endblock %}
{% block content %}


<!-- =================== Topbar =================== -->
<style>
  .recipe-topbar {
    position: sticky; top: 0; left: 0; right: 0; z-index: 99;
    background: #fff;
    border-bottom: 1.5px solid var(--outline);
    min-height: 56px; height: 56px;
    display: flex; align-items: center; justify-content: space-between;
    padding: 0 12px 0 8px;
    box-shadow: 0 2px 9px rgba(33,142,70,0.06);
  }
  .recipe-topbar .icon-btn {
    width: 40px; height: 40px; margin: 0;
    border-radius: 50%; border: none;
    display: flex; align-items: center; justify-content: center;
    background: none; color: var(--brand);
    font-size: 1.4rem; cursor: pointer;
    transition: background 0.13s;
  }
  .recipe-topbar .icon-btn:active { background: #f4f4f4; }
  .topbar-actions { display: flex; align-items: center; gap: 8px; }
  .topbar-title {
    flex: 1;
    margin-left: 8px;
    font-size: 1.25rem; font-weight: 700; color: var(--text);
    letter-spacing: -0.3px;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    opacity: 0; pointer-events: none;
    transition: opacity 0.23s;
    text-align: left;
  }
  .recipe-topbar.show-compact-title .topbar-title { opacity: 1; pointer-events: auto; }
</style>

<!-- =================== Titles & Description =================== -->
<style>
  .recipe-title-main {
    font-size: 2.4rem; font-weight: 900; color: var(--text);
    margin: 22px 0 0 0; padding: 0 24px;
    letter-spacing: -1.1px; line-height: 1.12;
    transition: opacity 0.2s;
  }
  .hide-main-title { opacity: 0; pointer-events: none; height: 0; margin: 0; padding: 0; }
  .recipe-description-main {
    color: var(--text-dim); font-size: 1.2rem; line-height: 1.6;
  }
</style>

<!-- =================== Hero =================== -->
<style>
  .recipe-hero {
    width: 100vw; max-width: 640px; margin: 0 auto;
    aspect-ratio: 1.05/1;
    border-bottom-left-radius: 2.4rem; border-bottom-right-radius: 2.4rem;
    background: #eee; overflow: hidden;
    display: flex; align-items: flex-end; justify-content: center;
    position: relative;
  }
  .recipe-hero img {
    width: 100%; height: 100%; min-height: 240px;
    object-fit: cover;
    border-bottom-left-radius: 2.4rem; border-bottom-right-radius: 2.4rem;
  }
  .hero-play-btn {
    position: absolute; left: 50%; top: 50%; transform: translate(-50%,-50%);
    width: 64px; height: 64px;
    border-radius: 50%; border: none; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    font-size: 2.3rem;
    background: var(--pink); color: #fff;
    box-shadow: 0 3px 18px rgba(0,0,0,0.15);
    opacity: 0.96; z-index: 1;
  }
  .hero-play-btn:active { background: #de2861; }
</style>

<!-- =================== Chef Signature =================== -->
<style>
.chef-signature2 {
  display: inline-flex;
  align-items: center;
  font-size: 1rem;
  font-family: 'Indie Flower', cursive, sans-serif;
  margin: 0 10px;
}
.chef-signature2 .chef-name {
  margin-left: 4px;
  margin-right: 8px;
}
.chef-avatar-inline {
  width: 28px; height: 28px;
  border-radius: 50%;
  object-fit: cover;
  background: #fff;
  margin-left: 4px;
  box-shadow: 0 2px 8px rgba(67,185,106,0.1);
}
</style>

<!-- =================== Time label =================== -->
<style>
.cooktime-bar {
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--text-dim);
  font-size: 1.25rem;
  margin: 14px 0;
  padding: 6px 0;
  border-top: 1.5px solid #e4e5e7;
  border-bottom: 1.5px solid #e4e5e7;
  background: transparent;
  font-weight: 500;
  gap: 10px;
}
.cooktime-bar i {
  color: var(--brand, #43b96a);
  font-size: 1.2em;
}
.cooktime-value {
  color: var(--brand-hover, #43b96a);
  font-weight: 600;
}
</style>

<!-- =================== Info Badges =================== -->
<style>
  .recipe-info-badges {
    margin: 16px 0 10px 0; padding: 0 22px;
    display: flex; flex-wrap: wrap; align-items: center; gap: 10px;
  }
  .info-badge {
    padding: 8px 14px;
    border-radius: 16px;
    font-size: 1rem;
    display: flex; align-items: center; gap: 6px;
    background: var(--bg-badge); color: var(--brand-hover);
  }
  .info-badge i { font-size: 1em; opacity: 0.9; }
</style>

<!-- =================== Ingredients =================== -->
<style>
  .ingredients-card {
    max-width: 580px;
    padding: 20px 14px 14px 14px;
    border-radius: 22px;
    background: #fff;
    box-shadow: var(--shadow);
  }
  .ingredients-header-row {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 8px;
  }
  .ingredients-title {
    display: flex; align-items: center; gap: 7px;
    font-size: 1.35rem; font-weight: 800;
    color: var(--brand-hover); 
  }
  .servings-tasty-box {
    display: flex; align-items: center; gap: 8px;
    padding: 4px 11px;
    border: 1.6px solid var(--servings-border); border-radius: 14px;
    background: var(--servings-bg);
    font-size: 1.25rem; font-weight: 500;
  }
  .servings-btn {
    width: 32px; height: 32px;
    border-radius: 50%; border: none; cursor: pointer;
    background: none; color: var(--brand-hover);
    font-size: 1.3em; font-weight: bold;
  }
  .ingredients-list { list-style: none; margin: 0; padding: 0; }
  .ingredients-list li {
	  display: flex; align-items: center;
	  padding: 8px 10px;
	  border-radius: 10px;
	  transition: background 0.15s;
	}
  .ingredients-list li:nth-child(odd) { background: #fafafa; }
  .ingredients-list li:hover { background: #f4fdf7; }
  
  .ingredient-checkbox {
	  width: 22px;
	  height: 22px;
	  min-width: 22px;
	  min-height: 22px;
	  margin-right: 18px;
	  accent-color: var(--brand);
	  opacity: 1 !important;
	  pointer-events: auto !important;
	  appearance: auto;
	  vertical-align: middle;
	}

  
  .ingredient-qty { font-size: 1.25rem; color: var(--brand); font-weight: 600; }
  .ingredient-fulltext { font-size: 1.2rem; }
  
.ingredients-tip {
  max-width: 580px;
  margin: 0 auto 14px auto;
  padding: 12px 12px 12px 5px;
  border-radius: 16px;
  background: #f9f9f9;
  border: 1.5px solid var(--outline);
  font-size: 0.95rem;
  color: var(--text-dim);
  line-height: 1.5;
  display: flex;
  align-items: center;   /* κάθετο κεντράρισμα */
  gap: 10px;
  text-align: justify;   /* justified text */
}
.tip-label {
  display: inline-block;
  font-size: 0.8rem;
  font-weight: 600;
  color: var(--text-dim);
  border: 1px solid var(--outline);
  border-radius: 50px;   /* πιο στρογγυλεμένο */
  padding: 3px 8px;
  background: #fff;
  flex-shrink: 0;        /* να μη τεντώνει */
}  
</style>

 <!--=================== Instructions =================== -->
<style>
  .instructions-card {
    max-width: 580px; margin: 20px auto 0 auto;
    padding: 20px 16px 16px 16px;
    border-radius: 22px;
    background: #fff;
    box-shadow: var(--shadow);
  }
  .instructions-time-badge {
    padding: 9px 10px;
    border: 1.3px solid #e5eee5; border-radius: 16px;
    background: #e8f7eb; color: var(--brand-hover);
    font-size: 1rem; font-weight: 600;
    display: flex; align-items: center; gap: 9px;
  }
  .instructions-title {
    margin: 22px 0 12px 0;
    font-size: 1.35rem; font-weight: 800; color: var(--brand-hover);
  }
	.instructions-list {
	  counter-reset: step;
	  margin: 0; padding: 0;
	}
	.instructions-list li {
	  list-style: none;
	  position: relative;
	  padding: 9px 0 9px 42px;
	  font-size: 1.2rem;
	  line-height: 1.6;
	}
	
    .instructions-list li:nth-child(odd) { background: #fafafa; }
    .instructions-list li:hover { background: #f4fdf7; }
  
	.instructions-list li::before {
	  counter-increment: step;
	  content: counter(step);
	  position: absolute;
	  left: 0; top: 9px;
	  width: 28px; height: 28px;
	  border-radius: 50%;
	  background: var(--brand);
	  color: #fff;
	  font-weight: 700;
	  font-size: 0.95rem;
	  display: flex; align-items: center; justify-content: center;
	  box-shadow: 0 2px 6px rgba(33,142,70,0.15);
	}
</style>

<!-- =================== Comments =================== -->
<style>
.comments-card {
  max-width: 580px;
  margin: 22px auto 36px auto;
  padding: 18px 15px 16px 15px;
  border-radius: 20px;
  background: #fff;
  box-shadow: var(--shadow);
}
.comments-card h3 {
  font-size: 1.25rem;
  font-weight: 700;
  color: var(--brand-hover);
  margin: 0 0 12px 0;   /* μηδέν top */
}
.comment {
  display: flex; gap: 10px;
  margin-bottom: 14px;
}
.comment-avatar {
  width: 36px; height: 36px;
  border-radius: 50%;
  object-fit: cover;
  border: 1.5px solid var(--outline);
}
.comment-author {
  font-size: 0.95rem;
  font-weight: 600;
  color: var(--text);
}
.comment-text {
  font-size: 0.95rem;
  color: var(--text-dim);
  margin-top: 2px;
  line-height: 1.45;
}
.comment-form textarea {
  width: 100%; min-height: 60px;
  border: 1.5px solid var(--outline);
  border-radius: 12px;
  padding: 8px 10px;
  resize: vertical;
  font-size: 0.95rem;
  margin-bottom: 8px;
}
.comment-form textarea:focus {
  outline: none;
  border-color: var(--brand);
  box-shadow: 0 0 0 2px rgba(33,142,70,0.15);
}
.comment-form button {
  background: var(--brand);
  color: #fff;
  border: none;
  border-radius: 12px;
  padding: 8px 14px;
  font-size: 0.95rem;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.15s;
}
.comment-form button:hover { background: var(--brand-hover); }
</style>

<!-- =================== Similar Recipes =================== -->
<style>
.similar-card {
    max-width: 580px; margin: 24px auto 36px auto;
    padding: 20px 15px 12px 15px;
    border-radius: 20px;
    background: #fff;
    box-shadow: var(--shadow);
  }
.similar-title-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
.similar-title { font-size: 1.25rem; font-weight: 700; color: var(--brand-hover); }


.similar-btn {
  width: 36px;
  height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  border: 2px solid var(--brand, #218e46);
  background: var(--surface, #fffaf5);
  border-radius: 50%;
  cursor: pointer;
  box-shadow: 0 2px 10px rgba(33,142,70,0.09);
  transition: border-color 0.22s, box-shadow 0.22s, background 0.22s;
  margin-left: 7px;
  outline: none;
  padding: 0;
}

.similar-btn i {
  font-size: 1.24rem;
  color: var(--brand, #218e46);
  transition: transform 0.33s cubic-bezier(.39,1.56,.56,1.01), color 0.18s;
}

.similar-btn:hover,
.similar-btn:focus {
  border-color: var(--brand-hover, #1a6e38);
  background: #eafbe7;
  box-shadow: 0 4px 18px rgba(33,142,70,0.13);
}

.similar-btn:hover i,
.similar-btn:focus i {
  color: var(--brand-hover, #1a6e38);
  transform: rotate(180deg);
}

.fa-rotate-right, .fa-solid {
  color: var(--brand, #218e46) !important;
}
</style>

<!-- =================== Responsive =================== -->
<style>
  @media (max-width: 600px) {
    .recipe-hero { max-width: 100vw; border-radius: 0 0 20px 20px; }
    .recipe-hero img { border-radius: 0 0 20px 20px; }
    .ingredients-card, .instructions-card, .similar-card, .comments-card { margin-left: 4vw; margin-right: 4vw; }
    .recipe-title-main, .recipe-description-main { padding-left: 18px; padding-right: 18px; }
    .recipe-info-badges { padding-left: 12px; padding-right: 12px; }
  }
</style>

<!-- =================== Toast =================== -->
<style>
.excluded-toast {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%,-50%);
  background: var(--brand, #218e46);
  color: #fff;
  padding: 12px 28px;
  border-radius: 16px;
  min-width: 90px;
  width: 85vw;
  font-size: 1.1rem;
  box-shadow: var(--shadow, 0 3px 14px rgba(33,142,70,0.10));
  opacity: 0;
  transition: opacity 0.2s;
  z-index: 9999;
  text-align: center;
  pointer-events: none;
  letter-spacing: 0.01em;
  border: 1.5px solid var(--brand-hover, #1a6e38);
}
.excluded-toast.show {
  opacity: 1;
}

.toast-ing {
  font-size: 1.3em;
  font-style: italic;
  font-weight: 500;
  color: var(--surface, #fffaf5);
  background: var(--brand-hover);
  border-radius: 10px;
  padding: 4px 12px 4px 12px;
  margin: 0 2px;
  display: inline-block;
  box-shadow: 0 1px 7px rgba(33,142,70,0.08);
  letter-spacing: 0.01em;
}


</style>

<!-- =================== Rating =================== -->
<style>
.recipe-rating {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  gap: 4px;
  padding: 6px 20px;
  margin: 8px 0 4px 0;
  font-size: 1.05rem;
  font-weight: 500;
  color: var(--text);
}
.stars {
  display: flex; gap: 3px;
}
.star-full {
  color: #f5c518;   /* γεμάτο κίτρινο */
  font-size: 1.3em;
}
.star-empty {
  color: #f5c518;   /* κίτρινο περίγραμμα */
  font-size: 1.3em;
}
.rating-value {
  font-weight: 600;
  color: var(--text);
}
.rating-count {
  font-size: 0.9rem;
  color: var(--text-dim);
}


.user-rating-row {
  display: flex;
  align-items: center;
  gap: 9px;
  
}
.user-rating-label {
  font-size: 1rem;
  font-weight: 600;
  color: var(--brand-hover);
  min-width: 132px;
  white-space: nowrap;
}
.user-stars {
  display: flex;
  align-items: center;
  gap: 2.5px;
}
.user-stars i {
  color: var(--brand-hover);
  font-size: 1.7em;
  transition: color 0.16s, transform 0.11s;
  cursor: pointer;
}
.user-stars i.user-star-empty {
  color: var(--brand-hover);
  font-weight: normal;
}
.user-stars i.user-star-selected {
  color: var(--brand-hover);
  font-weight: bold;
}
.user-stars i.user-star-hover {
  color: var(--brand);
  transform: scale(1.13);
}
.user-rating-hint {
  font-size: 0.99rem;
  color: #666;
  font-style: italic;
  margin: 1px 0 0 0;
  white-space: normal;
}

.user-stars .fa-star,
.user-stars .fa-star.user-star-empty,
.user-stars .far.fa-star,
.user-stars .fa-regular.fa-star {
  color: var(--brand-hover) !important;
  opacity: 1;
  font-weight: normal;
}

.stars i,
.stars .fa-star,
.stars .fas.fa-star {
  color: #f5c518 !important;
  font-size: 1.3em;
}
.stars i.star-empty,
.stars .fa-star.star-empty,
.stars .far.fa-star.star-empty {
  color: #f5c518  !important;
}
.stars .fa-star-half-stroke {
  color: #f5c518 !important;
  font-size: 1.45em;
  transform: scale(0.897) translateY(-1.3px);
  margin-left: -2px;
  margin-right: -2px;
}



</style>




<!-- =================== CONTENT =================== -->

<div class="recipe-topbar" id="topBar">
  <button class="icon-btn" id="backBtn"><i class="fa fa-arrow-left"></i></button>
  <div class="topbar-title" id="compactTitle">{{ recipe.title }}</div>
  <div class="topbar-actions">
    <button class="icon-btn" title="Κοινοποίηση"><i class="fa fa-share-alt"></i></button>
    <button class="icon-btn" title="Αγαπημένο" id="favBtnTopBar">
      <i class="{{ 'fas' if is_favorite else 'far' }} fa-heart"></i>
    </button>
  </div>
</div>

<div class="recipe-title-main" id="mainTitle">{{ recipe.title }}</div>
<div class="recipe-description-main">{{ recipe.description }}</div>

<!-- ======= Rating Block με Average & User Rating ======= -->
<div class="recipe-rating">

  <!-- Μέσος όρος -->
  <div style="display: flex; align-items: center; gap: 7px;">
    <div class="stars" id="avgStars">
      <!-- JS will render avg stars -->
    </div>
    <span class="rating-value" id="avgRatingNum">-</span>
    <span class="rating-count" id="ratingCount" style="margin-left: 3px;">(0 αξιολογήσεις)</span>
  </div>

  <!-- User rating -->
	<div class="user-rating-row mt-3">
	  <span class="user-rating-label">Η δική σας βαθμολογία:</span>
	  <div class="user-stars" id="userStars"></div>
	</div>
	<div id="userRatingHint" class="user-rating-hint"></div>

</div>

<div class="recipe-hero">
  <img src="{{ image_url }}" alt="{{ recipe.title }}">
  {% if recipe.url %}
    <a href="{{ recipe.url }}" target="_blank" class="hero-play-btn">
      <i class="fa fa-play"></i>
    </a>
  {% endif %}
</div>

<div style="display:flex; justify-content:flex-end;">
	<div class="chef-signature2">
	  by <span class="chef-name">{{ recipe.chef }}</span>
	  <img class="chef-avatar-inline"
		   src="{{ url_for('static', filename='images/avatars/' ~ chef_avatar) }}"
		   alt="Chef">
	</div>
</div>

<div class="cooktime-bar">
  <i class="fa fa-clock"></i>
  Έτοιμο σε <span class="cooktime-value">{{ recipe.total_time }} λεπτά</span>
</div>

<div class="ingredients-card">
  <div class="ingredients-header-row">
    <div class="ingredients-title">
      Υλικά για <span id="servingsVal">{{ recipe.servings or 4 }}</span> <i class="fa fa-user"></i>
    </div>
    <div class="servings-tasty-box">
      <button class="servings-btn" id="btnMinus"><i class="fa fa-minus"></i></button>
      <span class="servings-qty" id="servingsQty">{{ recipe.servings or 4 }}</span>
      <button class="servings-btn" id="btnPlus"><i class="fa fa-plus"></i></button>
    </div>
  </div>
  
  <div class="ingredients-tip">
	  <span class="tip-label">TIP</span>
	  Ξε-τσέκαρε όσα υλικά δεν έχεις διαθέσιμα, αυτόματα θα αποκλειστούν από άλλες συνταγές που θα σου προτείνουμε για σήμερα!
	</div>
  
	<ul class="ingredients-list" id="ingredientsList">
	  {% for ing in ingredients %}
	  <li>
		<input type="checkbox" class="ingredient-checkbox" data-ing="{{ ing }}">
		<span class="ingredient-fulltext">{{ ing }}</span>
	  </li>
	  {% endfor %}
	</ul>
	
</div>

<div class="instructions-card">
  <div class="instructions-time-badge">
    <span><i class="fa fa-clock"></i> <b>Προετοιμασία:</b> {{ recipe.prep_time }}′</span>
    &nbsp;|&nbsp;
    <span><i class="fa fa-fire"></i> <b>Μαγείρεμα:</b> {{ recipe.cook_time }}′</span>
  </div>

	<div class="recipe-info-badges">
	  {% if recipe.dish_tags %}<span class="info-badge"><i class="fa fa-utensils"></i> {{ recipe.dish_tags }}</span>{% endif %}
	  {% if recipe.method %}<span class="info-badge"><i class="fa fa-fire"></i> {{ recipe.method }}</span>{% endif %}
	</div>

</div> 






<div class="comments-card">
  <h3>Σχόλια</h3>
  <div class="comment">
    <img src="/static/images/avatars/user1.jpg" class="comment-avatar">
    <div>
      <div class="comment-author">Μαρία • 12/9/2025</div>
      <div class="comment-text">Τέλεια συνταγή, πέτυχε με την πρώτη!</div>
    </div>
  </div>
  <form class="comment-form">
    <textarea placeholder="Γράψτε το σχόλιό σας..."></textarea>
    <button>Υποβολή</button>
  </form>
</div>

<div class="similar-card">
  <div class="similar-title-row">
    <span class="similar-title">Παρόμοιες συνταγές</span>
	<button class="similar-btn" id="refreshSimilar" title="Ανανέωση">
	  <i class="fa-solid fa-rotate-right"></i>
	</button>


  </div>
  <div class="chat-carousel-row" id="similarSwiper"></div>
</div>


{% endblock %}




{% block scripts %}

<script>
  // --- Constants που περνάνε από το backend
  const RECIPE_ID = {{ recipe.id }};
  const USER_ID = {{ user_id }};
  const BASE_SERVINGS = {{ recipe.servings or 4 }};
</script>

<script>
  // ------------------ Helpers ------------------

  function parseFraction(str) {
    str = str.replace(',', '.').trim();
    const fractions = {'½': 0.5, '¼': 0.25, '¾': 0.75, '⅓': 1/3, '⅔': 2/3, '⅛': 0.125, '⅜': 0.375, '⅝': 0.625, '⅞': 0.875};
    if (fractions[str]) return fractions[str];
    if (str.match(/^\d+\/\d+$/)) {
      let [n, d] = str.split('/').map(Number);
      return n/d;
    }
    if (str.match(/^\d+\-\d+$/)) {
      let [n, d] = str.split('-').map(Number);
      return n;
    }
    if (!isNaN(parseFloat(str))) return parseFloat(str);
    let m = str.match(/^([0-9\.]+)/);
    if (m) return parseFloat(m[1]);
    return NaN;
  }

  function formatQty(qty) {
    if (Math.abs(qty - Math.round(qty)) < 0.01) return Math.round(qty);
    return qty.toFixed(2).replace(/\.00$/, '');
  }

  function toCookingFraction(num) {
    const fracMap = {
      0.125: '⅛', 0.25: '¼', 0.33: '⅓', 0.5: '½', 0.66: '⅔',
      0.75: '¾', 0.375: '⅜', 0.625: '⅝', 0.875: '⅞'
    };
    let intPart = Math.floor(num);
    let frac = +(num - intPart).toFixed(3);
    let fracStr = '';
    let closest = Object.keys(fracMap).reduce((prev, curr) => Math.abs(curr-frac) < Math.abs(prev-frac) ? curr : prev, 0);
    if (frac > 0.01) {
      fracStr = fracMap[closest];
      if (fracStr && Math.abs(frac-closest) < 0.02) {
        return intPart > 0 ? intPart + ' ' + fracStr : fracStr;
      } else {
        return num.toFixed(2).replace(/\.00$/,'');
      }
    } else {
      return intPart;
    }
  }

  function splitQtyUnit(str) {
    let m = str.match(/^([-0-9½¼¾⅓⅔⅛⅜⅝⅞\/\.]+)\s*([a-zA-Zα-ωΑ-Ω\.]*)$/u);
    if (m) return {qty: m[1], unit: m[2]};
    return {qty: str, unit: ''};
  }

  // --------- DOMContentLoaded ensures all elements exist! ----------
  document.addEventListener("DOMContentLoaded", function() {

    // ---------- Play Button -------------
    const playBtn = document.getElementById('playBtn');
    if (playBtn) {
      playBtn.onclick = function() {
        const url = playBtn.dataset.url;
        if (url) window.open(url, '_blank');
      };
    }

    // ---------- Back Button -------------
    const backBtn = document.getElementById('backBtn');
    if (backBtn) {
      backBtn.onclick = function() {
        window.location.href = '/main';
      };
    }


    // ---------- Compact Title on Scroll -------------
    const mainTitle = document.getElementById('mainTitle');
    const topBar = document.getElementById('topBar');
    if (mainTitle && topBar) {
      window.addEventListener('scroll', function() {
        const rect = mainTitle.getBoundingClientRect();
        if (window.scrollY < 10 || rect.top >= 0) {
          topBar.classList.remove('show-compact-title');
          mainTitle.classList.remove('hide-main-title');
        } else {
          topBar.classList.add('show-compact-title');
          mainTitle.classList.add('hide-main-title');
        }
      });
    }

    // ---------- Ingredients Split and Scaling -------------
	document.querySelectorAll('.ingredients-list li').forEach(li => {
	  const span = li.querySelector('.ingredient-fulltext');
	  let txt = span.textContent.trim();
	  let m = txt.match(/^([-0-9½¼¾⅓⅔⅛⅜⅝⅞\/\.]+(?:\s*[a-zA-Zα-ωΑ-Ω\.]*)?)\s+(.+)$/u);
	  let ingredientName;
	  if (m && !isNaN(parseFraction(m[1]))) {
		ingredientName = m[2].trim();
		span.innerHTML =
		  '<span class="ingredient-qty" data-qty="' + m[1].trim() + '">' + m[1].trim() + '</span> ' +
		  '<span class="ingredient-fulltext">' + ingredientName + '</span>';
	  } else {
		ingredientName = txt;
		span.innerHTML = '<span class="ingredient-fulltext">' + txt + '</span>';
	  }
	  // Βάζεις ΜΟΝΟ το υλικό σαν data-ing στο checkbox
	  let cb = li.querySelector('input[type="checkbox"]');
	  if (cb) cb.setAttribute('data-ing', ingredientName);
	});

    let currentServings = BASE_SERVINGS;
    const minusBtn = document.getElementById('btnMinus');
    const plusBtn = document.getElementById('btnPlus');
    if (minusBtn) {
      minusBtn.onclick = function() {
        if (currentServings > 1) updateServings(currentServings - 1);
      };
    }
    if (plusBtn) {
      plusBtn.onclick = function() {
        updateServings(currentServings + 1);
      };
    }

    function updateServings(newServings) {
      if (newServings < 1) return;
      currentServings = newServings;
      document.getElementById('servingsQty').textContent = currentServings;
      document.getElementById('servingsVal').textContent = currentServings;
      document.querySelectorAll('.ingredient-qty').forEach(span => {
        let base = splitQtyUnit(span.getAttribute('data-qty'));
        let parsed = parseFraction(base.qty);
        if (!isNaN(parsed)) {
          let newQty = parsed * (currentServings / BASE_SERVINGS);
          span.textContent = toCookingFraction(newQty) + (base.unit ? ' ' + base.unit : '');
        }
      });
    }

  }); // END DOMContentLoaded

</script>


<!------------- Similars Carousel Handling ------------->
<script>
function renderDishCards(dishes, containerId) {
  const container = document.getElementById(containerId);
  if (!container) return;
  container.innerHTML = '';

  const wrapper = document.createElement("div");
  wrapper.className = "similar-swiper";
  container.appendChild(wrapper);

  dishes.forEach(dish => {
    const item = document.createElement('div');
    item.className = 'similar-card-item';
    item.setAttribute('data-recipe-id', dish.id);
    item.style.position = "relative";
    item.onclick = function() {
      window.location = '/recipe_page/' + dish.id;
    };

    var imgSrc = dish.image_url
    var html = ''
      + '<img class="card-main-img" src="' + imgSrc + '" alt="' + dish.title + '" onerror="this.src=\'/static/images/placeholder.jpg\'">'
      + '<div class="similar-card-item-title">' + dish.title + '</div>'
      + '<div class="similar-card-item-meta">'
        + '<i class="fa fa-clock"></i>'
        + '<span class="similar-card-item-time-val">' + (dish.total_time ? dish.total_time + "'" : "-") + '</span>'
        + '<span class="chef-by-label">by</span>'
        + '<img class="chef-avatar-inline" src="' + (dish.chef_avatar || '/static/images/avatars/default.jpg') + '" alt="Chef">'
      + '</div>';

    item.innerHTML = html;

    const favWrapper = document.createElement("span");
    favWrapper.style.position = "absolute";
    favWrapper.style.top = "7px";
    favWrapper.style.right = "11px";
    favWrapper.style.zIndex = "10";
    favWrapper.style.cursor = "pointer";
    favWrapper.innerHTML =
      '<i class="' + (isFavorite(dish.id) ? 'fas' : 'far') + ' fa-heart" style="color: #1a6e38; font-size: 20px; filter: drop-shadow(0 2px 5px #fff2);"></i>';
    favWrapper.onclick = function(e) {
      e.stopPropagation();
      toggleFavorite(favWrapper, dish.id);
    };
    item.appendChild(favWrapper);

    wrapper.appendChild(item);
  });

  setTimeout(() => {
    container.scrollLeft = container.scrollWidth;
  }, 10);
}

async function loadSimilar(recipeId) {
  try {
    const res = await fetch(`/api/similar?recipe_id=${recipeId}`);
    const data = await res.json();
    if (data.success && data.recipes.length > 0) {
      renderDishCards(data.recipes, "similarSwiper");
    } else {
      document.getElementById('similarSwiper').innerHTML = '<p style="color:#666;">Δεν βρέθηκαν παρόμοιες συνταγές.</p>';
    }
  } catch (err) {
    console.error("[ERROR] Failed to load similar recipes:", err);
  }
   setTimeout(function() {
    document.getElementById('similarSwiper').scrollLeft = 0;
  }, 10);
}

loadSimilar(RECIPE_ID);

const refreshSimilar = document.getElementById('refreshSimilar');
if (refreshSimilar) {
  refreshSimilar.onclick = () => loadSimilar(RECIPE_ID);
}



</script>

<!------------- Fanorites Handling ------------->
<script>
function isFavorite(recipe_id) {
  recipe_id = Number(recipe_id);
  try {
    const favIds = JSON.parse(localStorage.getItem('favorite_recipe_ids') || '[]');
    return favIds.map(x => Number(x)).includes(recipe_id);
  } catch (e) {
    return false;
  }
}

function toggleFavorite(wrapper, recipe_id) {
  recipe_id = Number(recipe_id);

  // Πάρε το array από localStorage
  let favIds = [];
  try {
    favIds = JSON.parse(localStorage.getItem('favorite_recipe_ids') || '[]');
  } catch (e) {}

  fetch('/toggle_favorite_recipe', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ recipe_id: recipe_id })
  })
  .then(r => r.json())
  .then(data => {
    const isAdded = data.status === "added";

    // === Ενημέρωσε το localStorage (ως αριθμοί!) ===
    let idx = favIds.findIndex(x => Number(x) === recipe_id);
    if (isAdded && idx === -1) {
      favIds.push(recipe_id);
    } else if (!isAdded && idx !== -1) {
      favIds.splice(idx, 1);
    }
    localStorage.setItem('favorite_recipe_ids', JSON.stringify(favIds));

    // === Ενημέρωσε το εικονίδιο ===
    wrapper.innerHTML =
      '<i class="' + (isAdded ? 'fas' : 'far') + ' fa-heart" style="color:#218e46;font-size:18px;vertical-align:-2px;cursor:pointer;"></i>';
    const icon = wrapper.querySelector("i");
    if (icon) {
      icon.onclick = function(e) {
        e.stopPropagation();
        toggleFavorite(wrapper, recipe_id);
      };
    }
  });
}

// ---- Στο recipes page ----
var favBtn = document.getElementById('favBtnTopBar');
if (favBtn) {
  favBtn.onclick = function(e) {
    e.stopPropagation();
    toggleFavorite(favBtn, RECIPE_ID);
  };
  // --- Sync το state και αν κάνεις refresh/αλλαγή tab! 
  function updateFavBtnState() {
    const fav = isFavorite(RECIPE_ID);
    favBtn.innerHTML =
      '<i class="' + (fav ? 'fas' : 'far') + ' fa-heart" style="color:#218e46;font-size:18px;vertical-align:-2px;cursor:pointer;"></i>';
    const icon = favBtn.querySelector("i");
    if (icon) {
      icon.onclick = function(e) {
        e.stopPropagation();
        toggleFavorite(favBtn, RECIPE_ID);
      };
    }
  }
  updateFavBtnState();

  // Αυτόματο sync όταν αλλάζει το localStorage (άλλο tab, κλπ)
  window.addEventListener('storage', function(e) {
    if (e.key === 'favorite_recipe_ids') {
      updateFavBtnState();
    }
  });
}
</script>

<!------------- Ingredients Handling ------------->
<script>
document.addEventListener('DOMContentLoaded', function() {
  console.log('[ING] DOM ready');

  var list = document.getElementById('ingredientsList');
  if (!list) { console.warn('[ING] #ingredientsList not found'); return; }

  var raw = localStorage.getItem('excluded');
  var excluded = [];
  try {
    var parsed = JSON.parse(raw);
    excluded = Array.isArray(parsed) ? parsed : [];
  } catch(e) {
    excluded = [];
  }
  console.log('[ING] excluded from LS:', excluded);

  var boxes = list.querySelectorAll('input.ingredient-checkbox');

  function showToast(msg) {
    let toast = document.createElement('div');
    toast.className = 'excluded-toast';
    toast.innerHTML = msg;
    document.body.appendChild(toast);
    setTimeout(() => {
      toast.classList.add('show');
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 350);
      }, 1600);
    }, 10);
  }

  async function getNormalizedIngredient(rawIng) {
    const resp = await fetch('/api/normalize_ingredient', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({text: rawIng})
    });
    const data = await resp.json();
    return data.core;
  }

  boxes.forEach(function(cb, idx) {
    var ing = cb.dataset.ing || (cb.nextElementSibling && cb.nextElementSibling.textContent || '').trim();
    cb.dataset.ing = ing;

    cb.style.appearance = 'auto';
    cb.style.webkitAppearance = 'auto';
    cb.style.MozAppearance = 'auto';

    var shouldBeChecked = ing ? excluded.indexOf(ing) === -1 : true;
    cb.checked = shouldBeChecked;

    var cs = window.getComputedStyle(cb);

    cb.addEventListener('click', function(e){
      console.log('[ING][click]', idx, 'target=', e.target.tagName, 'preChecked=', cb.checked);
    });

    cb.addEventListener('change', async function() {
      console.log('[ING][change]', ing, 'now', cb.checked);
      const core = await getNormalizedIngredient(ing);
      if (cb.checked) {
        excluded = excluded.filter(function(x){ return x !== core; });
        showToast('✅ Το υλικό <span class="toast-ing">' + core + '</span> προστέθηκε ξανά');
      } else {
        if (excluded.indexOf(core) === -1) excluded.push(core);
        showToast('⛔ Αποκλείστηκε για σήμερα το υλικό: <span class="toast-ing">' + core + '</span>');
      }
      localStorage.setItem('excluded', JSON.stringify(excluded));
      console.log('[ING] excluded now:', excluded);
    });
  });

  var anyHidden = Array.from(boxes).some(function(b){ return getComputedStyle(b).display === 'none'; });
  if (anyHidden) console.warn('[ING] Warning: κάποιο CSS έχει display:none σε checkbox');
});
</script>


<!------------- Rating Handling ------------->
<script>


// ------- Render Average Rating (read-only) -------
async function renderAvgRating() {
  const avgStars = document.getElementById('avgStars');
  const avgNum = document.getElementById('avgRatingNum');
  const ratingCount = document.getElementById('ratingCount');
  avgStars.innerHTML = '<i class="fa fa-spinner fa-spin"></i>';
  try {
    const res = await fetch('/api/get_recipe_avg_rating?recipe_id=' + RECIPE_ID);
    const data = await res.json();
    let avg = data.avg_rating ? Number(data.avg_rating) : 0;
    let count = data.count || 0;
    avg = Math.round(avg * 10) / 10;
    avgNum.textContent = avg > 0 ? avg : '-';
    ratingCount.textContent = '(' + count + ' αξιολογήσεις)';
    avgStars.innerHTML = '';
    for (let i = 1; i <= 5; i++) {
		if (avg >= i) {
		  avgStars.innerHTML += '<i class="fas fa-star"></i>';
		} else if (avg >= i - 0.5) {
		  avgStars.innerHTML += '<i class="fas fa-star-half-stroke"></i>';
		} else {
		  avgStars.innerHTML += '<i class="far fa-star star-empty"></i>';
		}
    }
  } catch (e) {
    avgStars.innerHTML = '<i class="fa fa-question"></i>';
    avgNum.textContent = '-';
    ratingCount.textContent = '(?)';
  }
}


// ------- Render User Rating (editable) -------
let userRating = 0;
let hoverRating = 0;

async function renderUserRating() {
  const starsEl = document.getElementById('userStars');
  const hintEl = document.getElementById('userRatingHint');
  starsEl.innerHTML = '';
  for (let i = 1; i <= 5; i++) {
    let icon = document.createElement('i');
    if ((hoverRating || userRating) >= i) {
      icon.className = 'fas fa-star user-star-selected';
    } else {
      icon.className = 'far fa-star user-star-empty';
    }
    icon.dataset.val = i;
    if (hoverRating >= i) {
      icon.classList.add('user-star-hover');
    }
    starsEl.appendChild(icon);
  }
  if (!userRating) {
    hintEl.textContent = "Το μαγείρεψες; Αξιολόγησέ το!";
  } else {
    hintEl.textContent = '';
  }
}


async function fetchUserRating() {
  const starsEl = document.getElementById('userStars');
  if (!USER_ID) { userRating = 0; renderUserRating(); return; }
  try {
    const res = await fetch('/api/get_recipe_rating?recipe_id=' + RECIPE_ID + '&user_id=' + USER_ID);
    const data = await res.json();
    userRating = data.rating ? Number(data.rating) : 0;
    renderUserRating();
  } catch (e) {
    userRating = 0;
    renderUserRating();
  }
}

function setupUserRatingEvents() {
  const starsEl = document.getElementById('userStars');
  if (!starsEl) return;
  starsEl.addEventListener('mouseover', function(e){
    if (e.target.matches('i')) {
      hoverRating = Number(e.target.dataset.val);
      renderUserRating();
    }
  });
  starsEl.addEventListener('mouseleave', function(e){
    hoverRating = 0;
    renderUserRating();
  });
	starsEl.addEventListener('click', async function(e){
	  // Δέχεται είτε <i> είτε <svg>
	  let val = e.target.dataset.val || (e.target.closest('[data-val]') && e.target.closest('[data-val]').dataset.val);
	  if (val) {
		console.log("USER_STAR_CLICK", val, "USER_ID=", USER_ID);
		userRating = Number(val);
		renderUserRating();
		if (USER_ID) {
		  await fetch('/api/rate_recipe', {
			method: 'POST',
			headers: { 'Content-Type': 'application/json' },
			body: JSON.stringify({
			  recipe_id: RECIPE_ID,
			  user_id: USER_ID,
			  rating: userRating
			})
		  });
		  renderAvgRating();
		}
	  }
	});

}

document.addEventListener('DOMContentLoaded', function(){
  renderAvgRating();
  fetchUserRating();
  setupUserRatingEvents();
});
</script>


{% endblock %}
