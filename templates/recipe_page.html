{% extends "base.html" %}
{% block title %}{{ recipe.title }} • Family Food{% endblock %}
{% block content %}




<!-- =================== Design Tokens =================== -->
<style>
  :root {
    --brand: #218e46;
    --brand-hover: #1a6e38;
    --surface: #fffaf5;
    --text: #1b1b1b;
    --text-dim: #666;
    --outline: #ddd;
    --bg-badge: #f0f9f2;
    --servings-bg: #fff;
    --servings-border: #e2e3e4;
    --pink: #ef2d6a;
    --time-bg: #f4f7f6;
    --shadow: 0 2px 14px rgba(33,142,70,0.08);
  }
  body {
    background: var(--surface);
    color: var(--text);
    font-family: 'Roboto', sans-serif;
    margin: 0; padding: 0;
  }
</style>

<!-- =================== Topbar =================== -->
<style>
  .recipe-topbar {
    position: sticky; top: 0; left: 0; right: 0; z-index: 99;
    background: #fff;
    border-bottom: 1.5px solid var(--outline);
    min-height: 54px; height: 54px;
    display: flex; align-items: center; justify-content: space-between;
    padding: 0 10px 0 6px;
    box-shadow: 0 1px 8px rgba(33,142,70,0.05);
    transition: box-shadow 0.16s;
  }
  .recipe-topbar .icon-btn {
    width: 38px; height: 38px; margin: 0;
    border-radius: 50%; border: none;
    display: flex; align-items: center; justify-content: center;
    background: none; color: var(--brand);
    font-size: 1.32rem; cursor: pointer;
    transition: background 0.13s;
  }
  .recipe-topbar .icon-btn:active { background: #f4f4f4; }
  .topbar-actions { display: flex; align-items: center; gap: 7px; }
  .topbar-title {
    flex: 1;
    margin-left: 7px;
    font-size: 1.2rem; font-weight: 700; color: var(--text);
    letter-spacing: -0.2px;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    opacity: 0; pointer-events: none;
    transition: opacity 0.23s;
    text-align: left;
  }
  .recipe-topbar.show-compact-title .topbar-title { opacity: 1; pointer-events: auto; }
</style>

<!-- =================== Titles & Description =================== -->
<style>
  .recipe-title-main {
    font-size: 2.08rem; font-weight: 900; color: var(--text);
    margin: 18px 0 0 0; padding: 0 24px;
    letter-spacing: -1px; line-height: 1.1;
    transition: opacity 0.2s;
  }
  .hide-main-title { opacity: 0; pointer-events: none; height: 0; margin: 0; padding: 0; }
  .recipe-description-main {
    color: var(--text-dim); font-size: 1.07rem; line-height: 1.55;
    padding: 0 24px 10px 24px;
  }
</style>

<!-- =================== Hero =================== -->
<style>
  .recipe-hero {
    width: 100vw; max-width: 600px; margin: 0 auto;
    aspect-ratio: 1.1/1;
    border-bottom-left-radius: 2.2rem; border-bottom-right-radius: 2.2rem;
    background: #eee; overflow: hidden;
    display: flex; align-items: flex-end; justify-content: center;
    position: relative;
  }
  .recipe-hero img {
    width: 100%; height: 100%; min-height: 220px;
    object-fit: cover;
    border-bottom-left-radius: 2.2rem; border-bottom-right-radius: 2.2rem;
  }
  .hero-play-btn {
    position: absolute; left: 50%; top: 50%; transform: translate(-50%,-50%);
    width: 58px; height: 58px;
    border-radius: 50%; border: none; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    font-size: 2.1rem;
    background: var(--pink); color: #fff;
    box-shadow: 0 3px 16px rgba(0,0,0,0.13);
    opacity: 0.95; z-index: 1;
    transition: background 0.13s;
  }
  .hero-play-btn:active { background: #de2861; }
  .hero-play-btn:hover { background: #43b96a; color: #fff; }
</style>

<!-- =================== Info Badges & Chef =================== -->
<style>
  .recipe-info-badges {
    margin: 15px 0 8px 0; padding: 0 20px;
    display: flex; flex-wrap: wrap; align-items: center; gap: 9px;
  }
  .info-badge {
    padding: 7px 13px 7px 11px;
    border-radius: 16px;
    font-size: 0.99rem; font-weight: 500;
    display: flex; align-items: center; gap: 5px;
    background: var(--bg-badge); color: var(--brand-hover);
  }
  .info-badge i { font-size: 1.06em; opacity: 0.86; }
  .recipe-chef {
    margin: 2px 0 7px 0; padding: 0 20px;
    color: var(--text-dim);
    font-size: 1.01rem; font-weight: 500;
  }
</style>

<!-- =================== Ingredients =================== -->
<style>
  .ingredients-card {
    max-width: 560px;
    padding: 18px 12px 12px 12px;
    border-radius: 20px;
    background: #fff;
    box-shadow: var(--shadow);
  }
  .ingredients-title-row,
  .ingredients-header-row {
    display: flex; align-items: center; justify-content: space-between;
    gap: 8px; margin-bottom: 7px;
  }
  .ingredients-title-col { display: flex; flex-direction: column; align-items: flex-start; gap: 2px; }
  .ingredients-title {
    display: flex; align-items: center; gap: 7px;
    margin-bottom: 2px;
    font-size: 1.15rem; font-weight: 800;
    color: var(--brand-hover); letter-spacing: -0.3px;
  }
  .ingredients-title i { font-size: 1.09em; margin-left: 2px; }
  .servings-cookpad-row { display: flex; align-items: center; gap: 11px; margin-top: 1px; }
  .servings-user-icon { font-size: 1em; margin-right: 4px; }
  .servings-label { font-size: 0.8em; font-weight: 500; margin-right: 1px; }
  .servings-tasty-box {
    display: flex; align-items: center; gap: 8px;
    padding: 3.5px 10px;
    border: 1.5px solid var(--servings-border); border-radius: 13px;
    background: var(--servings-bg);
    font-size: 1.08rem; font-weight: 500;
  }
  .servings-btn {
    width: 30px; height: 30px; margin: 0;
    border-radius: 50%; border: none; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    background: none; color: var(--brand-hover);
    font-size: 1.28em; font-weight: bold;
    transition: background 0.13s;
  }
  .servings-btn:active { background: #f4f4f4; }
  .servings-qty {
    min-width: 24px; text-align: center;
    font-size: 1.1em; font-weight: bold;
    color: var(--text);
  }
  .servings-unit { font-size: 0.99em; color: var(--text-dim); margin-left: 1px; }
  .ingredients-list {
    list-style: none; margin: 0; padding: 0;
    font-size: 1.05rem;
  }
  .ingredients-list li {
    display: flex; align-items: center; gap: 8px;
    min-height: 27px; margin-bottom: 8px;
  }
  .ingredient-checkbox {
    width: 1.17em; height: 1.17em; margin-right: 2px;
    accent-color: var(--brand); cursor: pointer;
  }
  .ingredient-qty { color: var(--brand); font-weight: 600; margin-right: 2px; }
  .ingredient-fulltext { color: var(--text); }
</style>

<!-- =================== Instructions =================== -->
<style>
  .instructions-card {
    max-width: 560px; margin: 17px 13px 0 13px;
    padding: 18px 14px 13px 14px;
    border-radius: 20px;
    background: #fff;
    box-shadow: var(--shadow);
  }
  .instructions-time-badge {
    width: fit-content;
    margin: 2px 0 10px 0;
    padding: 8px 18px 8px 14px;
    border: 1.2px solid #e5eee5; border-radius: 15px;
    background: #e8f7eb; color: var(--brand-hover);
    font-size: 1.02rem; font-weight: 600;
    display: flex; align-items: center; gap: 8px;
  }
  .instructions-time-badge i { font-size: 1.13em; margin-right: 4px; opacity: 0.84; }
  .instructions-times-row {
    display: flex; align-items: center; justify-content: flex-start;
    gap: 11px; margin-bottom: 8px;
  }
  .time-badge {
    padding: 6px 13px 6px 11px;
    border: 1.2px solid #e5eee5; border-radius: 15px;
    background: var(--time-bg); color: var(--brand-hover);
    font-size: 0.98rem; font-weight: 600;
    display: flex; align-items: center; gap: 4px;
  }
  .time-badge i { font-size: 1.1em; opacity: 0.82; }
  .instructions-title {
    margin: 20px 0 10px 0;
    font-size: 1.11rem; font-weight: 700; color: var(--brand-hover);
  }
  .instructions-list {
    list-style: decimal inside;
    margin: 0; padding: 0;
    color: var(--text);
    font-size: 1.04rem;
  }
  .instructions-list li { margin-bottom: 7px; line-height: 1.58; padding-left: 1px; }
</style>

<!-- =================== Similar Recipes =================== -->
<style>
  .similar-card {
    max-width: 560px; margin: 21px 12px 34px 12px;
    padding: 18px 13px 11px 13px;
    border-radius: 18px;
    background: #fff;
    box-shadow: var(--shadow);
    overflow: hidden;
  }
  .similar-title-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
  .similar-title { font-size: 1.12rem; font-weight: 700; color: var(--brand-hover); letter-spacing: -0.3px; }
  .similar-swiper { display: flex; align-items: center; gap: 9px; overflow-x: auto; scroll-snap-type: x mandatory; }
  .similar-btns-row { display: flex; align-items: center; gap: 2px; }
  .similar-btn {
    width: 34px; height: 34px; margin: 0;
    border-radius: 50%; border: 1.4px solid var(--outline); cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    background: var(--surface); color: var(--brand-hover);
    font-size: 1.11rem;
    transition: background 0.13s;
    box-shadow: none;
  }
  .similar-btn:active { background: #f6f6f6; }
  .similar-card-item {
    height: 170px;        /* ή όσο σου ταιριάζει */
    min-height: 170px;
    max-height: 170px;
    min-width: 132px; max-width: 155px; margin-right: 2px;
    padding: 9px 7px 5px 7px;
    border-radius: 16px; border: 1.4px solid #eee;
    background: #fcfcfc;
    display: flex; flex-direction: column; align-items: center; cursor: pointer;
    justify-content: center;
	box-shadow: 0 2px 8px rgba(33,142,70,0.06);
    scroll-snap-align: start;
    transition: border-color 0.13s;
  }
  .similar-card-item:hover { border-color: var(--brand-hover); }
  .similar-card-item img {
    width: 70px; height: 70px; margin-bottom: 7px;
    border-radius: 11px;
    object-fit: cover;
  }
  .similar-card-item-title {
    max-width: 120px; margin-bottom: 4px;
    font-size: 0.96em; font-weight: 600; line-height: 1.25;
    text-align: center; color: var(--text);
    white-space: normal; overflow: hidden; text-overflow: ellipsis;
  }
  .similar-card-item-chef { font-size: 0.88em; font-weight: 500; color: var(--text-dim); text-align: center; }
</style>

<!-- =================== Responsive =================== -->
<style>
  @media (max-width: 600px) {
    .recipe-hero { max-width: 100vw; border-radius: 0 0 18px 18px; }
    .recipe-hero img { border-radius: 0 0 18px 18px; }
    .ingredients-card, .instructions-card, .similar-card { margin-left: 2vw; margin-right: 2vw; }
    .recipe-title-main, .recipe-description-main { padding-left: 15px; padding-right: 15px; }
    .recipe-info-badges, .recipe-chef { padding-left: 10px; padding-right: 10px; }
  }
</style>


  <!-- Sticky Top Bar -->
  <div class="recipe-topbar" id="topBar">
    <button class="icon-btn" id="backBtn"><i class="fa fa-arrow-left"></i></button>
    <div class="topbar-title" id="compactTitle">{{ recipe.title }}</div>
	<div class="topbar-actions">
	  <button class="icon-btn" title="Κοινοποίηση"><i class="fa fa-share-alt"></i></button>
		<button class="icon-btn" title="Αγαπημένο" id="favBtnTopBar">
		  <i class="{{ 'fas' if is_favorite else 'far' }} fa-heart"></i>
		</button>
	</div>
  </div>

  <!-- Main Title -->
  <div class="recipe-title-main" id="mainTitle">{{ recipe.title }}</div>
  <div class="recipe-description-main">{{ recipe.description }}</div>

  <!-- Hero -->
  <div class="recipe-hero">
    <img src="{{ image_url }}" alt="{{ recipe.title }}">
    {% if recipe.url %}
		<a href="{{ recipe.url }}" target="_blank" class="hero-play-btn">
		  <i class="fa fa-play"></i>
		</a>
	{% endif %}
  </div>

  <!-- Info badges -->
  <div class="recipe-info-badges">
    {% if recipe.total_time %}<span class="info-badge"><i class="fa fa-clock"></i> {{ recipe.total_time }}′</span>{% endif %}
    {% if recipe.method %}<span class="info-badge"><i class="fa fa-fire"></i> {{ recipe.method }}</span>{% endif %}
    {% if recipe.dish_category %}<span class="info-badge"><i class="fa fa-utensils"></i> {{ recipe.dish_category }}</span>{% endif %}
    {% if recipe.chef %}<span class="info-badge"><i class="fa fa-user"></i> {{ recipe.chef }}</span>{% endif %}
  </div>

  <!-- Ingredients -->
  <div class="ingredients-card">
    <div class="ingredients-header-row">
      <div class="ingredients-title">
        Υλικά για <span id="servingsVal">{{ recipe.servings or 4 }}</span> <i class="fa fa-user"></i>
      </div>
      <div class="servings-tasty-box">
        <button class="servings-btn" id="btnMinus"><i class="fa fa-minus"></i></button>
        <span class="servings-qty" id="servingsQty">{{ recipe.servings or 4 }}</span>
        <button class="servings-btn" id="btnPlus"><i class="fa fa-plus"></i></button>
      </div>
    </div>
	<ul class="ingredients-list">
	  {% for ing in ingredients %}
	  <li>
		<input type="checkbox" class="ingredient-checkbox">
		<span class="ingredient-fulltext">{{ ing }}</span>
	  </li>
	  {% endfor %}
	</ul>
  </div>

  <!-- Instructions -->
  <div class="instructions-card">
  
	<div class="instructions-time-badge">
	  <span title="Χρόνος προετοιμασίας">
		<i class="fa fa-clock"></i>
		<b>Προετοιμασία:</b> {{ recipe.prep_time }}′
	  </span>
	  &nbsp;|&nbsp;
	  <span title="Χρόνος μαγειρέματος">
		<i class="fa fa-fire"></i>
		<b>Μαγείρεμα:</b> {{ recipe.cook_time }}′
	  </span>
	</div>

  
    <div class="instructions-title">Οδηγίες</div>
	<ol class="instructions-list">
	  {% for step in instructions %}
	  <li>{{ step }}</li>
	  {% endfor %}
	</ol>
  </div>

<!-- Similar recipes -->
<div class="similar-card">
  <div class="similar-title-row">
    <span class="similar-title">Παρόμοιες συνταγές</span>
    <button class="similar-btn" id="refreshSimilar"><i class="fa fa-refresh"></i></button>
  </div>
  <div class="similar-swiper" id="similarSwiper">
    <!-- γεμίζει με JS -->
  </div>
</div>

<script>
  const RECIPE_ID = {{ recipe.id }};
</script>

{% endblock %}

{% block scripts %}

<script> 

let servings = 4;
function updateServings(val) {
  servings = val;
  document.getElementById('servingsVal').textContent = servings;
  document.getElementById('servingsQty').textContent = servings;
  // (Εδώ μπορείς να βάλεις και scaling υλικών αν χρειαστεί)
}
document.getElementById('btnMinus').onclick = function() {
  if (servings > 1) updateServings(servings - 1);
};
document.getElementById('btnPlus').onclick = function() {
  if (servings < 16) updateServings(servings + 1);
};
document.getElementById('backBtn').onclick = function() {
  window.location.href = '/main';
};

document.addEventListener("DOMContentLoaded", function() {
  var favBtn = document.getElementById('favBtnTopBar');
  if (favBtn) {
    favBtn.onclick = function(e) {
      e.stopPropagation();
      // Το wrapper εδώ είναι το ίδιο το button (ή το εσωτερικό <i>)
      toggleFavorite(favBtn, RECIPE_ID);
    };
  }
});

  
// Compact title logic
const mainTitle = document.getElementById('mainTitle');
const topBar = document.getElementById('topBar');
const compactTitle = document.getElementById('compactTitle');

window.addEventListener('scroll', function() {
  const threshold = 65;  // όταν περάσει αυτό, compact
  const rect = mainTitle.getBoundingClientRect();

  // ➤ Αν το top του mainTitle είναι ακόμα ψηλά, δείξε μεγάλο τίτλο
  if (window.scrollY < 10 || rect.top >= 0) {
    topBar.classList.remove('show-compact-title');
    mainTitle.classList.remove('hide-main-title');
  } else {
    topBar.classList.add('show-compact-title');
    mainTitle.classList.add('hide-main-title');
  }
});


// Play button: άνοιγμα συνταγής (url)
document.getElementById('playBtn').onclick = function() {
  window.open('https://www.argiro.gr/recipe/mpiftekia-kotopoulou/', '_blank');
};

// Similar recipes "carousel" logic (basic horizontal scroll)
const swiper = document.getElementById('similarSwiper');
document.getElementById('similarPrev').onclick = () => { swiper.scrollBy({left: -155, behavior: 'smooth'}); };
document.getElementById('similarNext').onclick = () => { swiper.scrollBy({left: +155, behavior: 'smooth'}); };
</script>

<script>
async function loadSimilar(recipeId) {
  try {
    const res = await fetch(`/api/similar?recipe_id=${recipeId}`);
    const data = await res.json();
    const swiper = document.getElementById('similarSwiper');
    swiper.innerHTML = '';

	if (data.success && data.recipes.length > 0) {
	  data.recipes.forEach(function(r) {
		var item = document.createElement('div');
		item.className = 'similar-card-item';
		item.onclick = function() { window.location = '/recipe_page/' + r.id; };

		var html = ''
		  + '<img src="' + r.image_url + '" alt="' + r.title + '">'
		  + '<div class="similar-card-item-title">' + r.title + '</div>';

		if (r.chef) {
		  html += '<div class="similar-card-item-chef">' + r.chef + '</div>';
		}

		item.innerHTML = html;
		swiper.appendChild(item);
	  });
	} else {
	  swiper.innerHTML = '<p style="color:#666;">Δεν βρέθηκαν παρόμοιες συνταγές.</p>';
	}

  } catch (err) {
    console.error("[ERROR] Failed to load similar recipes:", err);
  }
}

// Αρχικό φόρτωμα
loadSimilar({{ recipe.id }});

// Refresh button
document.getElementById('refreshSimilar').onclick = () => loadSimilar({{ recipe.id }});
</script>

<script>
function toggleFavorite(wrapper, recipe_id) {
  fetch('/toggle_favorite_recipe', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ recipe_id: recipe_id })
  })
  .then(r => r.json())
  .then(data => {
    const isAdded = data.status === "added";
    // Ενημέρωσε το εικονίδιο
    wrapper.innerHTML =
      '<i class="' + (isAdded ? 'fas' : 'far') + ' fa-heart" style="color:' + (isAdded ? '#218e46' : '#218e46') + ';font-size:18px;vertical-align:-2px;cursor:pointer;"></i>';

    // Ξαναδέσε το click event (γιατί αντικατέστησες το innerHTML!)
    const icon = wrapper.querySelector("i");
    if (icon) {
      icon.onclick = function(e) {
        e.stopPropagation();
        toggleFavorite(wrapper, recipe_id);
      };
    }
  });
}
</script>

<script>
document.querySelectorAll('.ingredients-list .ingredient-fulltext').forEach(span => {
  let txt = span.textContent.trim();
  console.log('[DEBUG] Επεξεργασία:', txt);
  // Regex: Πιάνει ποσότητα + υλικό
  let m = txt.match(/^([0-9½¼¾\-\/\.\s\w]+)\s+(.*)$/);
  if (m) {
    console.log('[DEBUG] Βρέθηκε ποσότητα:', m[1], '| Υλικό:', m[2]);
    span.innerHTML =
      '<span class="ingredient-qty">' + m[1].trim() + '</span> ' +
      '<span class="ingredient-fulltext">' + m[2].trim() + '</span>';
  } else {
    console.log('[DEBUG] Δεν βρέθηκε ποσότητα, όλο ως υλικό:', txt);
    span.innerHTML = '<span class="ingredient-fulltext">' + txt + '</span>';
  }
});
</script>

{% endblock %}
