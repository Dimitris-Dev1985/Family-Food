<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8">
  <title>AI Reply Tester</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto&display=swap">
  <style>
    body {
      font-family: Roboto, sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 2rem;
      display: flex;
      justify-content: center;
    }
    #container {
      background: #fff;
      border-radius: 12px;
      padding: 2rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      max-width: 700px;
      width: 100%;
    }
    h1 {
      font-size: 1.8rem;
      margin-bottom: 1rem;
      text-align: center;
      color: #333;
    }
    textarea {
      width: 100%;
      height: 100px;
      padding: 0.75rem;
      margin-bottom: 1rem;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 1rem;
    }
    .buttons {
      display: flex;
      gap: 0.75rem;
      margin-bottom: 1.5rem;
    }
    button {
      flex: 1;
      padding: 0.75rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: bold;
      transition: background 0.3s;
    }
    #sendBtn {
      background: #6200ee;
      color: white;
    }
    #sendBtn:hover {
      background: #3700b3;
    }
    #micBtn {
      background: #018786;
      color: white;
    }
    #micBtn.active {
      background: #00c4b4;
      animation: pulse 1s infinite;
    }
    #resetBtn {
      background: #b00020;
      color: white;
    }
    #resetBtn:hover {
      background: #7a0015;
    }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(0, 196, 180, 0.4); }
      100% { box-shadow: 0 0 0 12px rgba(0, 196, 180, 0); }
    }
    .section {
      margin-top: 2rem;
    }
    .section h3 {
      margin-bottom: 0.5rem;
      font-size: 1.2rem;
      color: #444;
      border-left: 4px solid #6200ee;
      padding-left: 0.5rem;
    }
    pre {
      background: #fafafa;
      padding: 1rem;
      border-radius: 6px;
      border: 1px solid #ddd;
      font-size: 0.9rem;
      overflow-x: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
  </style>
</head>
<body>
  <div id="container">
    <h1>AI Reply Tester</h1>

    <textarea id="userInput" placeholder="Î“ÏÎ¬ÏˆÎµ Ï„Î¿ Î¼Î®Î½Ï…Î¼Î¬ ÏƒÎ¿Ï… ÎµÎ´Ï..."></textarea>

    <div class="buttons">
      <button id="sendBtn">Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î®</button>
      <button id="micBtn">ğŸ¤ ÎœÎ¯Î»Î±</button>
      <button id="resetBtn">Reset LocalStorage</button>
    </div>

    <div class="section">
      <h3>AI Response:</h3>
      <pre id="aiResponse">---</pre>
    </div>

    <div class="section">
      <h3>LocalStorage Variables:</h3>
      <pre id="localVars">---</pre>
    </div>

    <div class="section">
      <h3>AI Suggestion:</h3>
      <pre id="aiSuggest">---</pre>
    </div>
  </div>

<script src="/static/js/utils.js"></script>

<script>
function refreshLocalVarsView() {
  const vars = {
    max_time: getStorageItem(StorageKeys.MAX_TIME),
    main_ingredient: getStorageItem(StorageKeys.MAIN_INGREDIENT),
    aux_ingredients: getStorageItem(StorageKeys.AUX_INGREDIENTS),
    preferred_methods: getStorageItem(StorageKeys.METHOD_PREFS),
    excluded_keywords: getStorageItem(StorageKeys.EXCLUDED)
  };
  document.getElementById("localVars").textContent = JSON.stringify(vars, null, 2);
}

document.getElementById("sendBtn").addEventListener("click", async () => {
  const text = document.getElementById("userInput").value.trim();
  if (!text) return;

  const payload = {
    message: text,
    max_time: getStorageItem(StorageKeys.MAX_TIME, null),
    main_ingredient: getStorageItem(StorageKeys.MAIN_INGREDIENT, null),
    aux_ingredients: getStorageItem(StorageKeys.AUX_INGREDIENTS, []),
    preferred_methods: getStorageItem(StorageKeys.METHOD_PREFS, []),
    excluded: getStorageItem(StorageKeys.EXCLUDED, [])
  };

  console.log("[DEBUG] ğŸš€ Sending payload to /ai_reply:", payload);

  try {
    const res = await fetch("/ai_reply", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const data = await res.json();
    console.log("[DEBUG] ğŸ“¦ Response from backend:", data);

    document.getElementById("aiResponse").textContent =
      data.reply || JSON.stringify(data, null, 2);

    if (data.filters) {
      updateFiltersFromAIResponse(data.filters);
    }

    document.getElementById("userInput").value = "";
    refreshLocalVarsView();

    // ğŸ”¥ Î‘ÎœÎ•Î£Î‘ ÎœÎ•Î¤Î‘: ÎšÎ¬Î»ÎµÏƒÎµ Ï„Î·Î½ AI_suggest_dish
    await callAISuggest();

  } catch (err) {
    console.error("[ERROR] âŒ Failed to fetch /ai_reply:", err);
    document.getElementById("aiResponse").textContent = "âŒ Error connecting to backend";
  }
});

function updateFiltersFromAIResponse(filters) {
  if (!filters || typeof filters !== "object") return;

  const keys = Object.keys(filters);
  for (let key of keys) {
    console.log(`[DEBUG] ğŸ”„ Updating filter '${key}' â†’`, filters[key]);

    switch (key) {
      case "max_time":
        setStorageItem(StorageKeys.MAX_TIME, filters[key]);
        break;
      case "main_ingredient":
        setStorageItem(StorageKeys.MAIN_INGREDIENT, filters[key]);
        break;
      case "aux_ingredients":
        setStorageItem(StorageKeys.AUX_INGREDIENTS, filters[key]);
        break;
      case "cooking_method":
        setStorageItem(StorageKeys.METHOD_PREFS, filters[key]);
        break;
      case "excluded_keywords":
        setStorageItem(StorageKeys.EXCLUDED, filters[key]);
        break;
    }
  }
}

// ğŸ”¹ ÎÎ•Î‘ Î£Î¥ÎÎ‘Î¡Î¤Î—Î£Î— Î³Î¹Î± ÎºÎ¬Î»ÎµÏƒÎ¼Î± ÏƒÏ„Î¿ /ai_suggest_dish
async function callAISuggest() {
  const filters = {
    max_time: getStorageItem(StorageKeys.MAX_TIME),
    main_ingredient: getStorageItem(StorageKeys.MAIN_INGREDIENT),
	aux_ingredients: getStorageItem(StorageKeys.AUX_INGREDIENTS, []),
    excluded: getStorageItem(StorageKeys.EXCLUDED, []),
    preferredMethod: getStorageItem(StorageKeys.METHOD_PREFS, []),
    chef: null
  };

  const payload = { step: 3, filters };
  console.log("[DEBUG] ğŸš€ Sending payload to /ai_suggest_dish:", payload);

  try {
    const res = await fetch("/ai_suggest_dish", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const data = await res.json();
    console.log("[DEBUG] ğŸ“¦ Response from /ai_suggest_dish:", data);

    document.getElementById("aiSuggest").textContent =
      JSON.stringify(data, null, 2);

  } catch (err) {
    console.error("[ERROR] âŒ Failed to fetch /ai_suggest_dish:", err);
    document.getElementById("aiSuggest").textContent = "âŒ Error connecting to backend";
  }
}

// â¤ Reset button
document.getElementById("resetBtn").addEventListener("click", () => {
  console.log("[DEBUG] ğŸ—‘ï¸ Resetting localStorage keys...");
  setStorageItem(StorageKeys.MAX_TIME, 200);
  setStorageItem(StorageKeys.MAIN_INGREDIENT, null);
  setStorageItem(StorageKeys.METHOD_PREFS, ['Î¦Î¿ÏÏÎ½Î¿Ï‚','ÎšÎ±Ï„ÏƒÎ±ÏÏŒÎ»Î±','Î§ÏÏ„ÏÎ±','Î¤Î·Î³Î¬Î½Î¹','Î£Ï‡Î¬ÏÎ±','Air-fryer']);
  setStorageItem(StorageKeys.EXCLUDED, []);
  setStorageItem(StorageKeys.AUX_INGREDIENTS, []);
  refreshLocalVarsView();
});

// â¤ Î‘ÏÏ‡Î¹ÎºÎ¿Ï€Î¿Î¯Î·ÏƒÎ· view
refreshLocalVarsView();

// ğŸ¤ Voice Recognition (Web Speech API)
const micBtn = document.getElementById("micBtn");
let recognition;
if ('webkitSpeechRecognition' in window) {
  recognition = new webkitSpeechRecognition();
  recognition.lang = 'el-GR';
  recognition.continuous = false;
  recognition.interimResults = false;

  recognition.onstart = () => {
    console.log("[DEBUG] ğŸ™ï¸ Recognition started");
    micBtn.classList.add("active");
    micBtn.textContent = "ğŸ¤ Î‘ÎºÎ¿ÏÎµÎ¹...";
  };

  recognition.onresult = (event) => {
    const transcript = event.results[0][0].transcript;
    console.log("[DEBUG] ğŸ—£ï¸ Transcript:", transcript);
    document.getElementById("userInput").value = transcript;
  };

  recognition.onerror = (event) => {
    console.warn("[WARN] âŒ Speech error:", event.error);
  };

  recognition.onend = () => {
    console.log("[DEBUG] ğŸ›‘ Recognition ended");
    micBtn.classList.remove("active");
    micBtn.textContent = "ğŸ¤ ÎœÎ¯Î»Î±";
  };

  micBtn.addEventListener("click", () => {
    recognition.start();
  });

} else {
  micBtn.disabled = true;
  micBtn.textContent = "ğŸ¤ ÎœÎ· Ï…Ï€Î¿ÏƒÏ„Î·ÏÎ¹Î¶ÏŒÎ¼ÎµÎ½Î¿";
}
</script>

</body>
</html>
