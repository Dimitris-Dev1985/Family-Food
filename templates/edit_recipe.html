{% extends "base.html" %}
{% block title %}Επεξεργασία Συνταγής • Family Food{% endblock %}
{% block content %}

<style>
/* ===== Container ===== */
.edit-recipe-container {
  max-width: 580px;
  margin: 0 2vw 40px 2vw;
  background: #fff;
  border-radius: 2.3rem;
  box-shadow: 0 2px 9px rgba(33,142,70,0.07);
  padding: 24px 16px 30px 16px;
  margin-top: 22px;
}
/* ===== Ενότητα/Τίτλοι ===== */
.edit-section-label {
  font-size: 1.14rem;
  font-weight: 700;
  color: var(--brand-hover,#218e46);
  margin-bottom: 7px;
  margin-top: 21px;
}
/* ===== Φωτογραφία ===== */
.edit-recipe-photo-picker { width: 100%; text-align: center; margin-bottom: 18px; }
.edit-recipe-photo-preview { width: 155px; height: 155px; border-radius: 18px; object-fit: cover; border: 2px solid #e2e7e3; background: #f3faf7; margin-bottom: 9px; box-shadow: 0 2px 8px #d5ebdf33; }
.edit-recipe-photo-btn { background: var(--brand,#218e46); color: #fff; border: none; border-radius: 13px; font-size: 1rem; padding: 8px 18px; margin-bottom: 4px; font-weight: 600; cursor: pointer; transition: background 0.13s; box-shadow: 0 2px 8px rgba(33,142,70,0.08); }
.edit-recipe-photo-btn:hover { background: #1a6e38; }
/* ===== Inputs & textarea ===== */
.edit-input, .edit-textarea {
  width: 100%;
  font-size: 1.09rem;
  padding: 9px 12px;
  border-radius: 12px;
  border: 1.1px solid #dbe7df;
  background: #f8faf8;
  color: #1d2820;
  font-family: inherit;
  transition: border 0.13s;
}
.edit-input:focus, .edit-textarea:focus {
  border: 1.2px solid var(--brand);
  outline: none;
  background: #f3faf7;
}
.edit-textarea {
  min-height: 38px;
  line-height: 1.33;
  resize: vertical;
  overflow-wrap: break-word;
  white-space: pre-line;
  box-sizing: border-box;
}
/* ===== Λίστες ===== */
.edit-ingredients-list, .edit-instructions-list {
  list-style: none;
  margin: 0 0 8px 0;
  padding: 0;
}
.edit-instructions-list { list-style: decimal inside; margin: 0 0 16px 0; }
/* ===== Rows για υλικά & οδηγίες ===== */
.edit-ingredient-row, .edit-instruction-row {
  display: flex;
  align-items: flex-start;
  gap: 9px;
  margin-bottom: 8px;
}
/* ===== Κουμπί αφαίρεσης ===== */
.edit-ingredient-remove-btn, .edit-instruction-remove-btn {
  background: #f7e7ea;
  color: #ea3b3b;
  border: none;
  border-radius: 9px;
  font-size: 1.25em;
  width: 38px; height: 38px;
  display: flex; align-items: center; justify-content: center;
  margin-left: 2px;
  transition: background 0.13s, color 0.13s;
  cursor: pointer;
}
.edit-ingredient-remove-btn:hover, .edit-instruction-remove-btn:hover {
  background: #efc2c7;
  color: #c71637;
}
/* ===== Κουμπιά προσθήκης ===== */
.edit-add-ingredient-btn, .edit-add-instruction-btn {
  background: #eafbe7;
  color: #218e46;
  border: 1px solid #bee7c9;
  border-radius: 12px;
  padding: 8px 13px;
  font-size: 1.04rem;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.13s, color 0.13s;
}
.edit-add-ingredient-btn:hover, .edit-add-instruction-btn:hover {
  background: #d1f3d9;
  color: #1a6e38;
}
/* ===== Save Button ===== */
.edit-save-btn {
  width: 100%;
  margin-top: 18px;
  background: var(--brand,#218e46);
  color: #fff;
  border: none;
  border-radius: 15px;
  padding: 12px 0;
  font-size: 1.16rem;
  font-weight: 700;
  cursor: pointer;
  box-shadow: 0 2px 10px #a7e2c880;
  transition: background 0.13s;
}
.edit-save-btn:hover { background: #1a6e38; }
/* ===== Time fields & labels ===== */
.edit-times-row {
  display: flex;
  gap: 14px;
  margin-bottom: 8px;
}
.edit-time-field { flex: 1; }
.edit-time-label {
  font-size: 0.98em;
  font-weight: 500;
  color: #229c57;
  margin-bottom: 3px;
  display: block;
}
/* ===== Σημειώσεις ===== */
.edit-notes-row { margin: 0 0 18px 0; }
.edit-notes-input {
  width: 100%;
  font-size: 1.04rem;
  border-radius: 10px;
  border: 1px solid #dbe7df;
  padding: 8px 12px;
  background: #f8faf8;
  margin-bottom: 3px;
}
.edit-notes-input:focus { border: 1.2px solid var(--brand); background: #f5faf6; }
/* ===== Servings ===== */
.edit-servings-row { display: flex; align-items: center; gap: 7px; margin-bottom: 16px; }
.edit-servings-label { font-weight: 600; color: var(--brand,#218e46); font-size: 1.04rem; margin-right: 6px; }
/* ===== Methods chips ===== */
.edit-methods-chips-row { margin-bottom: 14px; margin-top: 2px; display: flex; flex-wrap: wrap; gap: 8px 10px; }
.method-chip {
  display: inline-flex;
  align-items: center;
  background: #f5f5f5;
  border: 1.2px solid #e0e0e0;
  border-radius: 16px;
  font-weight: 500;
  color: var(--brand);
  font-size: 1.03rem;
  padding: 5px 16px 5px 11px;
  gap: 8px;
  margin-top: 2px;
  margin-bottom: 2px;
  box-shadow: 0 1px 2px rgba(33,142,70,0.06);
  cursor: pointer;
  user-select: none;
  transition: background 0.15s, border 0.15s, color 0.13s;
}
.method-chip.selected,
.method-chip.selected:focus {
  background: #e4f6e8;
  border: 1.8px solid #218e46;
  color: #1a6e38;
}
.method-chip:active { transform: scale(0.98); }
/* ===== Mobile Responsive ===== */
@media (max-width: 600px) {
  .edit-recipe-container { padding: 13px 2vw 26px 2vw; }
  .edit-section-label { font-size: 1.04rem; }
  .edit-input, .edit-textarea { font-size: 0.99rem; }
  .edit-save-btn { font-size: 1rem; }
  .edit-add-ingredient-btn, .edit-add-instruction-btn { font-size: 0.97rem; }
}
</style>

<!-- =========== TOPBAR =========== -->
<div class="recipe-topbar" id="topBar">
  <button class="icon-btn" id="backBtn"><i class="fa fa-arrow-left"></i></button>
  <div class="topbar-title" id="editTitle">Επεξεργασία συνταγής</div>
  <div style="width:36px;"></div>
</div>

<form id="editRecipeForm" class="edit-recipe-container" enctype="multipart/form-data" method="post" autocomplete="off">

  <!-- === Φωτογραφία === -->
  <div class="edit-recipe-photo-picker">
    <img id="recipePhotoPreview"
         src="/static/images/recipes/{{ recipe.image_path or 'placeholder.jpg' }}"
         class="edit-recipe-photo-preview"
         alt="Φωτογραφία πιάτου">
    <br>
    <label class="edit-recipe-photo-btn">
      Επίλεξε/Βγάλε φωτογραφία!
      <input type="file" name="image" id="recipePhotoInput" accept="image/*" capture="environment" style="display:none;">
    </label>
  </div>

  <!-- === Τίτλος & Περιγραφή === -->
  <div class="edit-section-label">Τίτλος συνταγής</div>
  <input type="text" name="title" class="edit-input" id="recipeTitleInput" maxlength="90"
       value="{{ recipe.title }}" required placeholder="Τίτλος πιάτου"
       data-oldtitle="{{ recipe.title }}">

  <div class="edit-section-label">Περιγραφή</div>
  <textarea name="description" class="edit-textarea" id="recipeDescInput" maxlength="600" required placeholder="Περιγραφή...">{{ recipe.description }}</textarea>

  <!-- === Cooking Methods (chips) === -->
  <div class="edit-section-label">Μέθοδος μαγειρέματος</div>
  <div class="edit-methods-chips-row" id="methodChipsRow">
    {% for m in method_list %}
      <div class="method-chip{% if m in selected_methods %} selected{% endif %}"
           data-value="{{ m }}" tabindex="0">{{ m }}</div>
    {% endfor %}
  </div>
  <input type="hidden" name="method" id="methodInput" value="{{ recipe.method or '' }}">

  <!-- === Χρόνοι === -->
  <div class="edit-section-label">Χρόνος προετοιμασίας & μαγειρέματος</div>
  <div class="edit-times-row">
    <div class="edit-time-field">
      <label class="edit-time-label" for="prepTimeInput">Προετοιμασία (λεπτά)</label>
      <input type="number" name="prep_time" id="prepTimeInput" class="edit-input" min="0" max="500"
        value="{{ recipe.prep_time or 0 }}">
    </div>
    <div class="edit-time-field">
      <label class="edit-time-label" for="cookTimeInput">Μαγείρεμα (λεπτά)</label>
      <input type="number" name="cook_time" id="cookTimeInput" class="edit-input" min="0" max="1000"
        value="{{ recipe.cook_time or 0 }}">
    </div>
  </div>

  <!-- === Σημειώσεις === -->
  <div class="edit-section-label">Σημειώσεις (προαιρετικό)</div>
  <div class="edit-notes-row">
    <input type="text" name="dish_tags" id="dishNotesInput" class="edit-notes-input"
      value="" placeholder="π.χ. Χωρίς αλάτι, family edition, δοκιμή για τη νηστεία, κλπ.">
  </div>

  <!-- === Μερίδες === -->
  <div class="edit-section-label" style="margin-top:22px;">Μερίδες</div>
  <div class="edit-servings-row">
    <span class="edit-servings-label">Αριθμός μερίδων:</span>
    <input type="number" name="servings" id="recipeServingsInput" class="edit-input" value="{{ recipe.servings or 4 }}" min="1" max="24" style="width:80px;" required>
  </div>

  <!-- === Υλικά === -->
  <div class="edit-section-label">Υλικά & Ποσότητες</div>
  <ul class="edit-ingredients-list" id="ingredientsList">
    {% for ing in recipe.ingredients.split('\n') if ing.strip() %}
    <li class="edit-ingredient-row">
      <textarea name="ingredients" class="edit-textarea" maxlength="100" required rows="1">{{ ing.strip() }}</textarea>
      <button type="button" class="edit-ingredient-remove-btn" title="Αφαίρεση" onclick="removeIngredientRow(this)">
        <i class="fa fa-trash"></i>
      </button>
    </li>
    {% endfor %}
  </ul>
  <button type="button" class="edit-add-ingredient-btn" onclick="addIngredientRow()">+ Προσθήκη υλικού</button>

  <!-- === Οδηγίες (Βήματα) === -->
  <div class="edit-section-label">Οδηγίες βήμα-βήμα</div>
  <ol class="edit-instructions-list" id="instructionsList">
    {% for step in (recipe.instructions or '').split('\n') if step.strip() %}
    <li class="edit-instruction-row">
      <textarea name="instructions" class="edit-textarea" maxlength="400" required rows="1">{{ step.strip() }}</textarea>
      <button type="button" class="edit-instruction-remove-btn" title="Αφαίρεση" onclick="removeInstructionRow(this)">
        <i class="fa fa-trash"></i>
      </button>
    </li>
    {% endfor %}
  </ol>
  <button type="button" class="edit-add-instruction-btn" onclick="addInstructionRow()">+ Προσθήκη βήματος</button>

  <!-- === Actions === -->
  <div class="d-flex gap-4 justify-content-center actions-row mt-5">
    <button type="button" class="onboarding-back-btn" style="padding-left:10px; padding-right:10px;" id="cancelEditRecipeBtn">Ακύρωση</button>
    <button type="submit" class="onboarding-next-btn" style="padding-left:10px; padding-right:10px;" >Αποθήκευση νέας συνταγής</button>
  </div></form>

{% endblock %}

{% block scripts %}
<script>
// --- Auto-resize για όλα τα textarea (υλικά & οδηγίες) ---
function autoResizeTextarea(textarea) {
  textarea.style.height = "auto";
  textarea.style.height = (textarea.scrollHeight+2) + "px";
}
// --- Εφαρμόζεται σε όλα τα υπάρχοντα textarea μετά το render ---
document.querySelectorAll('.edit-textarea').forEach(function(ta) {
  autoResizeTextarea(ta);
  ta.addEventListener('input', function() {
    autoResizeTextarea(this);
  });
});
// --- Button πίσω ---
document.getElementById('backBtn').onclick = function() { window.history.back(); };
// --- Photo preview (camera/gallery) ---
document.getElementById('recipePhotoInput').addEventListener('change', function(e) {
  if (!e.target.files || !e.target.files[0]) return;
  const reader = new FileReader();
  reader.onload = function(ev) {
    document.getElementById('recipePhotoPreview').src = ev.target.result;
  };
  reader.readAsDataURL(e.target.files[0]);
});
// --- Προσθήκη/Αφαίρεση υλικού ---
function addIngredientRow(val='') {
  const ul = document.getElementById('ingredientsList');
  const li = document.createElement('li');
  li.className = 'edit-ingredient-row';
  li.innerHTML =
    '<textarea name="ingredients" class="edit-textarea" maxlength="100" required rows="1" style="resize:vertical;"></textarea>' +
    '<button type="button" class="edit-ingredient-remove-btn" title="Αφαίρεση" onclick="removeIngredientRow(this)"><i class="fa fa-trash"></i></button>';
  if (val) li.querySelector('textarea').value = val;
  ul.appendChild(li);
  const ta = li.querySelector('textarea');
  autoResizeTextarea(ta);
  ta.addEventListener('input', function() {
    autoResizeTextarea(this);
  });
}
function removeIngredientRow(btn) {
  const li = btn.closest('li');
  if (li) li.remove();
}
// --- Προσθήκη/Αφαίρεση οδηγίας (βήματος) ---
function addInstructionRow(val='') {
  const ol = document.getElementById('instructionsList');
  const li = document.createElement('li');
  li.className = 'edit-instruction-row';
  li.innerHTML =
    '<textarea name="instructions" class="edit-textarea" maxlength="400" required rows="1" style="resize:vertical;"></textarea>' +
    '<button type="button" class="edit-instruction-remove-btn" title="Αφαίρεση" onclick="removeInstructionRow(this)"><i class="fa fa-trash"></i></button>';
  if (val) li.querySelector('textarea').value = val;
  ol.appendChild(li);
  const ta = li.querySelector('textarea');
  autoResizeTextarea(ta);
  ta.addEventListener('input', function() {
    autoResizeTextarea(this);
  });
}
function removeInstructionRow(btn) {
  const li = btn.closest('li');
  if (li) li.remove();
}
// --- Cooking methods: πολλαπλή επιλογή με chips ---
document.querySelectorAll('.method-chip').forEach(function(chip){
  chip.addEventListener('click', function() {
    chip.classList.toggle('selected');
    // Πάρε ΟΛΕΣ τις επιλεγμένες
    const selected = Array.from(document.querySelectorAll('.method-chip.selected')).map(x => x.dataset.value);
    document.getElementById('methodInput').value = selected.join(', ');
  });
  chip.addEventListener('keydown', function(e) {
    if (e.key === "Enter" || e.key === " ") chip.click();
  });
});

// --- Κατά το submit: συγκεντρώνει υλικά & οδηγίες σε hidden inputs ---
document.getElementById('editRecipeForm').addEventListener('submit', function(e) {
  
  // Έλεγχος τίτλου
  const titleInput = document.getElementById('recipeTitleInput');
  const oldTitle = titleInput.getAttribute('data-oldtitle') || '';
  if (titleInput.value.trim() === oldTitle.trim()) {
    alert("Ο τίτλος της συνταγής πρέπει να αλλάξει!");
    titleInput.focus();
    e.preventDefault();
    return false;
  }
  
  // Υλικά
  let all = Array.from(document.querySelectorAll('textarea[name="ingredients"]'))
      .map(x => x.value.trim()).filter(x => x.length > 0);
  document.querySelectorAll('textarea[name="ingredients"]').forEach(x => x.remove());
  const hidden = document.createElement('input');
  hidden.type = 'hidden';
  hidden.name = 'all_ingredients';
  hidden.value = all.join('\n');
  this.appendChild(hidden);
  // Οδηγίες
  let steps = Array.from(document.querySelectorAll('textarea[name="instructions"]'))
    .map(x => x.value.trim()).filter(x => x.length > 0);
  document.querySelectorAll('textarea[name="instructions"]').forEach(x => x.remove());
  const instInput = document.createElement('input');
  instInput.type = 'hidden';
  instInput.name = 'all_instructions';
  instInput.value = steps.join('\n');
  this.appendChild(instInput);
  // Αυτόματος υπολογισμός συνολικού χρόνου
  let prep = parseInt(document.getElementById('prepTimeInput').value) || 0;
  let cook = parseInt(document.getElementById('cookTimeInput').value) || 0;
  let total = prep + cook;
  let tinput = document.createElement('input');
  tinput.type = 'hidden';
  tinput.name = 'total_time';
  tinput.value = total;
  this.appendChild(tinput);
});
</script>
{% endblock %}
