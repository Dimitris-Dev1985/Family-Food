{% extends "base.html" %}
{% block title %}Εγκατάσταση Family Food{% endblock %}
{% block content %}

<style>
.install-container {
  max-width: 500px;
  margin: 0 auto;
  text-align: center;
  padding: 2rem 1rem;
}
.install-logo {
  max-width: 220px;
  margin-bottom: 20px;
  box-shadow: 0 6px 20px rgba(0,0,0,0.1);
  border-radius: 16px;
}
.install-title {
  font-size: 2.3em;
  font-weight: bold;
}
.install-description {
  font-size: 1.15em;
  margin-top: 1rem;
  color: #555;
}
#installBtn {
  font-size: 1.1em;
  padding: 10px 20px;
  margin-top: 2rem;
}
.pulse-ring {
  position: relative;
  display: inline-block;
}
.pulse-ring::before {
  content: "";
  position: absolute;
  top: -10px;
  left: -10px;
  width: 100%;
  height: 100%;
  border: 2px solid #28a745;
  border-radius: 50%;
  animation: pulse 1.8s infinite;
  opacity: 0.6;
}
@keyframes pulse {
  0% { transform: scale(1); opacity: 0.6; }
  50% { transform: scale(1.3); opacity: 0.2; }
  100% { transform: scale(1); opacity: 0.6; }
}
.spinner-border {
  display: none;
  width: 1.8rem;
  height: 1.8rem;
  margin-left: 10px;
  vertical-align: middle;
}
</style>

<div class="install-container">
  <img src="{{ url_for('static', filename='image.png') }}" alt="Family Food Icon" class="install-logo">
  <h1 class="install-title">Family Food</h1>
  <p class="install-description">🍽️ Κάνε εγκατάσταση για άμεση πρόσβαση στην κουζίνα σου!<br>Χωρίς browser, σαν κανονική εφαρμογή!</p>

  <div class="pulse-ring">
    <button id="installBtn" class="btn btn-success btn-lg" style="display:none;">
      📲 Εγκατάσταση Εφαρμογής
    </button>
    <div id="spinner" class="spinner-border text-success" role="status"></div>
  </div>
</div>

<!-- Modal επιβεβαίωσης -->
<div class="modal fade" id="installSuccessModal" tabindex="-1" aria-labelledby="installSuccessModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-success">
      <div class="modal-header">
        <h5 class="modal-title text-success" id="installSuccessModalLabel">
          <i class="fa fa-check-circle me-2"></i> Εγκατάσταση Ολοκληρώθηκε!
        </h5>
      </div>
      <div class="modal-body">
        🎉 Η εφαρμογή Family Food εγκαταστάθηκε με επιτυχία στη συσκευή σου!<br>
        Καλά Μαγειρέματα!!!
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary w-100" id="continueBtn">Συνέχεια</button>
      </div>
    </div>
  </div>
</div>

<script>
  let deferredPrompt;
  const installBtn = document.getElementById('installBtn');
  const spinner = document.getElementById('spinner');
  const successModal = new bootstrap.Modal(document.getElementById('installSuccessModal'));
  const continueBtn = document.getElementById('continueBtn');

  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    installBtn.style.display = 'inline-block';

    installBtn.addEventListener('click', () => {
      installBtn.disabled = true;
      spinner.style.display = 'inline-block';

      deferredPrompt.prompt();
      deferredPrompt.userChoice.then((choiceResult) => {
        spinner.style.display = 'none';
        if (choiceResult.outcome === 'accepted') {
          localStorage.setItem("ff_installed_once", "1");
          successModal.show();
        } else {
          installBtn.disabled = false;
        }
        deferredPrompt = null;
      });
    });
  });

  continueBtn.addEventListener('click', () => {
    successModal.hide();
    if (localStorage.getItem("ff_installed_once") === "1") {
      window.location.href = "/welcome";
    } else {
      window.location.href = "/login";
    }
  });

  // Αν μπήκε χειροκίνητα και είναι standalone
  window.addEventListener('DOMContentLoaded', function() {
    if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true) {
      if (!localStorage.getItem("ff_installed_once")) {
        localStorage.setItem("ff_installed_once", "1");
        window.location.href = "/login";
      } else {
        window.location.href = "/welcome";
      }
    }
  });
</script>

{% endblock %}
