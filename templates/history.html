{% extends "base.html" %}
{% block content %}

{% macro format_ddmmyyyy(datestr) -%}
  {%- set y, m, d = datestr.split('-') -%}
  {{ d }}/{{ m }}/{{ y }}
{%- endmacro %}

{% macro greek_date(datestr) %}
  {%- set days = ['Î”ÎµÏ…Ï„Î­ÏÎ±', 'Î¤ÏÎ¯Ï„Î·', 'Î¤ÎµÏ„Î¬ÏÏ„Î·', 'Î Î­Î¼Ï€Ï„Î·', 'Î Î±ÏÎ±ÏƒÎºÎµÏ…Î®', 'Î£Î¬Î²Î²Î±Ï„Î¿', 'ÎšÏ…ÏÎ¹Î±ÎºÎ®'] -%}
  {%- set months = ['', 'Î™Î±Î½Î¿Ï…Î±ÏÎ¯Î¿Ï…', 'Î¦ÎµÎ²ÏÎ¿Ï…Î±ÏÎ¯Î¿Ï…', 'ÎœÎ±ÏÏ„Î¯Î¿Ï…', 'Î‘Ï€ÏÎ¹Î»Î¯Î¿Ï…', 'ÎœÎ±ÎÎ¿Ï…', 'Î™Î¿Ï…Î½Î¯Î¿Ï…', 'Î™Î¿Ï…Î»Î¯Î¿Ï…', 'Î‘Ï…Î³Î¿ÏÏƒÏ„Î¿Ï…', 'Î£ÎµÏ€Ï„ÎµÎ¼Î²ÏÎ¯Î¿Ï…', 'ÎŸÎºÏ„Ï‰Î²ÏÎ¯Î¿Ï…', 'ÎÎ¿ÎµÎ¼Î²ÏÎ¯Î¿Ï…', 'Î”ÎµÎºÎµÎ¼Î²ÏÎ¯Î¿Ï…'] -%}
  {%- set y, m, d = datestr.split('-') %}
  {%- set date_obj = (y ~ '-' ~ m ~ '-' ~ d)|todate %}
  {{ days[date_obj.weekday()] }}, {{ d|int }} {{ months[m|int] }} {{ y }}
{% endmacro %}

<div class="d-flex justify-content-center mb-3">
  <h2 class="fw-bold mb-1" style="font-size:2em;">Î™ÏƒÏ„Î¿ÏÎ¹ÎºÏŒ Î Î¹Î¬Ï„Ï‰Î½</h2>
</div>

{% set shown_weeks = namespace(seen=[]) %}
{% for row in history %}
  {% set dt = row['date']|todate %}
  {% set week = dt.isocalendar()[1] %}
  {% set year = dt.year %}
  {% set current_week = year ~ '-' ~ week %}
  {% set collapse_id = 'week-' ~ current_week.replace('-', '_') %}
  {% if current_week not in shown_weeks.seen %}
    {% set week_dates = [] %}
    {% for r in history if (r['date']|todate).isocalendar()[1] == week and (r['date']|todate).year == year %}
      {% set _ = week_dates.append(r['date']) %}
    {% endfor %}
    {% set week_first_date = week_dates | last %}
    {% set week_last_date = week_dates | first %}
    <div class="card my-2 shadow-sm">
      <div class="card-header bg-info-subtle d-flex justify-content-between align-items-center"
           role="button"
           data-bs-toggle="collapse"
           href="#{{ collapse_id }}"
           aria-expanded="false"
           aria-controls="{{ collapse_id }}">
        <span>
          <i class="fa fa-calendar-week me-2 text-primary"></i>
            Î•Î²Î´Î¿Î¼Î¬Î´Î± {{ week }} ({{ format_ddmmyyyy(week_first_date) }} â€“ {{ format_ddmmyyyy(week_last_date) }})
        </span>
        <span>
          <i class="fa fa-chevron-down small"></i>
        </span>
      </div>
      <div class="collapse" id="{{ collapse_id }}">
        <div class="row g-3 mb-3 pt-2 px-2">
    {% set _ = shown_weeks.seen.append(current_week) %}
  {% endif %}

  <div class="col-12">
    <div class="card shadow-sm h-100">
      <div class="card-header bg-light d-flex justify-content-between align-items-center">
        <span>
          <i class="fa fa-calendar-alt text-primary me-2"></i>
          {{ greek_date(row['date']) }}
        </span>
        <button class="btn btn-outline-danger btn-sm" title="Î”Î¹Î±Î³ÏÎ±Ï†Î®" onclick="deleteHistoryEntry({{ row['id'] }})">
          <i class="fa fa-trash"></i>
        </button>
      </div>
      <div class="card-body py-3 d-flex flex-column align-items-stretch justify-content-center">
        <div class="d-flex align-items-center mb-2">
          <span class="fw-bold" style="font-size:1.14em;">
            {{ row['title'] }}
          </span>
          {% if row.recipe_id %}
            <a href="javascript:void(0);" class="favorite-btn ms-1 d-inline-block" data-recipeid="{{ row.recipe_id }}">
               <i class="fa{{ 's' if row.is_favorite else 'r' }} fa-heart"
				 onclick="toggleFavorite(this, {{ row.recipe_id }})"
                 style="color: {{ 'gray' if not row.is_favorite else '#c33' }}; font-size:18px; cursor:pointer; vertical-align:-2px;"></i>
            </a>
			
          {% endif %}
        </div>
        <div class="small text-muted mb-1">
          <span class="me-2"><i class="fa fa-user"></i> {{ row['chef'] or '-' }}</span>
          <span class="me-2"><i class="fa fa-tag"></i> {{ row['basic_category'] or '-' }}</span>
        </div>
      </div>
    </div>
  </div>

  {% set next_row = history[loop.index] if not loop.last else None %}
  {% if loop.last or (
    next_row and (
      (next_row['date']|todate).isocalendar()[1] != week or
      (next_row['date']|todate).year != year
    )
  ) %}
        </div>
      </div>
    </div>
  {% endif %}
{% endfor %}

<div class="row g-3">
  <div class="col-12" style="padding-top: 20px;">
    <div class="card shadow-sm h-auto">
      <div class="card-header" style="background:#f8fafc;">
        <i class="fa fa-bullseye me-2 text-info"></i> Î•Î²Î´Î¿Î¼Î±Î´Î¹Î±Î¯Î¿Î¹ Î£Ï„ÏŒÏ‡Î¿Î¹ (Ï„ÎµÎ»ÎµÏ…Ï„Î±Î¯ÎµÏ‚ 7 Î·Î¼Î­ÏÎµÏ‚)
      </div>
      <div class="card-body p-0">
        <table class="table mb-0 table-sm align-middle" id="weekly-goals-table">
          <thead>
            <tr>
              <th>ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î±</th>
              <th>Î£Ï„ÏŒÏ‡Î¿Ï‚</th>
              <th>Î•Ï€Î¯Ï„ÎµÏ…Î¾Î·</th>
            </tr>
          </thead>
          <tbody>
            <!-- JS generated -->
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

{% endblock %}


{% block modals %}
<!-- Modal Î³Î¹Î± ÎµÎ»Î»ÎµÎ¯Ï€Î¿Ï…ÏƒÎµÏ‚ Î¼Î­ÏÎµÏ‚ -->
<div class="modal fade" id="missingDaysModal" tabindex="-1" aria-labelledby="missingDaysModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-warning bg-opacity-10">
        <h5 class="modal-title" id="missingDaysModalLabel">Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· Î™ÏƒÏ„Î¿ÏÎ¹ÎºÎ¿Ï</h5>
      </div>
      <div class="modal-body">
        <p>Î”ÎµÎ½ Î­Ï‡ÎµÎ¹Ï‚ ÎºÎ±Ï„Î±Ï‡Ï‰ÏÎ®ÏƒÎµÎ¹ Ï€Î¹Î¬Ï„Î± Î³Î¹Î± Ï„Î¹Ï‚ Ï€Î±ÏÎ±ÎºÎ¬Ï„Ï‰ Î¼Î­ÏÎµÏ‚:</p>
        <ul id="missingDaysList" class="list-group list-group-flush mb-2"></ul>
        <div id="manualEntryPrompt">
          <p>Î˜Î­Î»ÎµÎ¹Ï‚ Î½Î± Ï€ÏÎ¿ÏƒÎ¸Î­ÏƒÎµÎ¹Ï‚ Ï„Î¹ Î­Ï†Î±Î³ÎµÏ‚ Î±Ï…Ï„Î­Ï‚ Ï„Î¹Ï‚ Î¼Î­ÏÎµÏ‚;</p>
          <button class="btn btn-success" id="yesManualBtn"><i class="fa fa-check"></i> ÎÎ±Î¹</button>
          <button class="btn btn-secondary" data-bs-dismiss="modal"><i class="fa fa-times"></i> ÎŒÏ‡Î¹</button>
        </div>
        <div id="manualEntryBox" style="display:none;">
          <label>Î“ÏÎ¬ÏˆÎµ Ï„Î¹ ÎºÎ±Î»ÏŒ Î­Ï†Î±Î³ÎµÏ‚ Ï„Î·(Î½) <b id="currentDay"></b></label>
			<div class="d-flex align-items-center gap-2 mb-2">
			  <input type="text" id="manualDishTitle" class="form-control" autocomplete="off" placeholder="Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ·..." style="max-width: 300px;">
			  <button class="btn btn-secondary" onclick="startSpeechForManual()">ğŸ¤</button>
			  <span id="manualVoiceFeedback" style="font-weight:bold; color:#c00;"></span>
			</div>
			<div id="manual-autocomplete" class="autocomplete-list"></div>
          <button class="btn btn-primary" onclick="submitManualDish()">ÎšÎ±Ï„Î±Ï‡ÏÏÎ·ÏƒÎ·</button>
          <button class="btn btn-secondary" type="button" onclick="cancelManualEntry()">Î†ÎºÏ…ÏÎ¿</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Î³Î¹Î± ÎµÏ€Î¹Î²ÎµÎ²Î±Î¯Ï‰ÏƒÎ· Ï€ÏÎ¿ÏƒÎ¸Î®ÎºÎ·Ï‚ ÏƒÏ„Î± Î±Î³Î±Ï€Î·Î¼Î­Î½Î± ÎºÎ±Î¹ ÏƒÏ…Î¼Ï€Î»Î®ÏÏ‰ÏƒÎ· -->
<div class="modal fade" id="favDetailsModal" tabindex="-1" aria-labelledby="favDetailsModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-info bg-opacity-10">
        <h5 class="modal-title" id="favDetailsModalLabel">ÎÎ­Î± Î£Ï…Î½Ï„Î±Î³Î®</h5>
      </div>
      <div class="modal-body" id="favDetailsModalBody">
        <!-- JS content -->
      </div>
      <div class="modal-footer" id="favDetailsModalFooter">
        <!-- JS buttons -->
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let missingDays = {{ missing_days|tojson }};
let manualDayIdx = 0;
let allRecipes = [];

fetch('/get_recipes_for_autocomplete')
  .then(function(r) { return r.json(); })
  .then(function(data) { allRecipes = data; });

function removeTonos(str) {
  if (!str) return "";
  return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
}
function greekDate(dateStr) {
  var days = ['Î”ÎµÏ…Ï„Î­ÏÎ±', 'Î¤ÏÎ¯Ï„Î·', 'Î¤ÎµÏ„Î¬ÏÏ„Î·', 'Î Î­Î¼Ï€Ï„Î·', 'Î Î±ÏÎ±ÏƒÎºÎµÏ…Î®', 'Î£Î¬Î²Î²Î±Ï„Î¿', 'ÎšÏ…ÏÎ¹Î±ÎºÎ®'];
  var months = ['', 'Î™Î±Î½Î¿Ï…Î±ÏÎ¯Î¿Ï…', 'Î¦ÎµÎ²ÏÎ¿Ï…Î±ÏÎ¯Î¿Ï…', 'ÎœÎ±ÏÏ„Î¯Î¿Ï…', 'Î‘Ï€ÏÎ¹Î»Î¯Î¿Ï…', 'ÎœÎ±ÎÎ¿Ï…', 'Î™Î¿Ï…Î½Î¯Î¿Ï…', 'Î™Î¿Ï…Î»Î¯Î¿Ï…', 'Î‘Ï…Î³Î¿ÏÏƒÏ„Î¿Ï…', 'Î£ÎµÏ€Ï„ÎµÎ¼Î²ÏÎ¯Î¿Ï…', 'ÎŸÎºÏ„Ï‰Î²ÏÎ¯Î¿Ï…', 'ÎÎ¿ÎµÎ¼Î²ÏÎ¯Î¿Ï…', 'Î”ÎµÎºÎµÎ¼Î²ÏÎ¯Î¿Ï…'];
  var [y, m, d] = dateStr.split('-').map(Number);
  var date = new Date(y, m - 1, d);
  return days[date.getDay() === 0 ? 6 : date.getDay() - 1] + ', ' + d + ' ' + months[m] + ' ' + y;
}

function toggleFavorite(icon, recipe_id) {
	
  fetch('/toggle_favorite_recipe', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({recipe_id: recipe_id})
  })
  .then(r => r.json())
  .then(data => {
    if(data.status === "added") {
      icon.classList.remove('far');
      icon.classList.add('fas');
      icon.style.color = '#c33';
    } else if(data.status === "removed") {
      icon.classList.remove('fas');
      icon.classList.add('far');
      icon.style.color = 'gray';
    }
  });
}


function updateWeeklyGoalsTable() {
  fetch('/get_weekly_goals_status')
    .then(function(r){return r.json();})
    .then(function(data) {
      var tbody = document.querySelector("#weekly-goals-table tbody");
      tbody.innerHTML = "";

      if (!data || data.length === 0) {
        tbody.innerHTML = `<tr><td colspan="3" class="text-muted text-center">Î”ÎµÎ½ Î­Ï‡ÎµÎ¹Ï‚ Î¿ÏÎ¯ÏƒÎµÎ¹ ÎµÎ²Î´Î¿Î¼Î±Î´Î¹Î±Î¯Î¿Ï…Ï‚ ÏƒÏ„ÏŒÏ‡Î¿Ï…Ï‚.</td></tr>`;
        return;
      }

      data.forEach(function(g) {
        var cat = g.category.charAt(0).toUpperCase() + g.category.slice(1);

        var target = '';
        if (g.min_times != g.max_times) {
          target = 'Î‘Ï€ÏŒ ' + g.min_times + ' Î­Ï‰Ï‚ ' + g.max_times + ' Ï†Î¿ÏÎ­Ï‚';
        } else {
          target = 'Î‘ÎºÏÎ¹Î²ÏÏ‚ ' + g.min_times + (g.min_times == 1 ? ' Ï†Î¿ÏÎ¬' : ' Ï†Î¿ÏÎ­Ï‚');
        }

        var reached = '';
        if (!g.count || g.count == 0) {
          reached = 'ÎºÎ±Î¼Î¯Î± Ï†Î¿ÏÎ¬';
        } else if (g.count == 1) {
          reached = '1 Ï†Î¿ÏÎ¬';
        } else {
          reached = g.count + ' Ï†Î¿ÏÎ­Ï‚';
        }
        var ok = (g.count >= g.min_times && g.count <= g.max_times);
        var statusIcon = ok
          ? '<span class="text-success fw-bold">âœ”ï¸</span>'
          : '<span class="text-danger fw-bold">âŒ</span>';

        var tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${cat}</td>
          <td>${target}</td>
          <td>${reached} ${statusIcon}</td>
        `;
        tbody.appendChild(tr);
      });
    });
}

window.addEventListener('DOMContentLoaded', function() {
  updateWeeklyGoalsTable()
  if (missingDays.length > 0) {
    let list = document.getElementById('missingDaysList');
    list.innerHTML = '';
    missingDays.forEach(function(d) {
      var li = document.createElement("li");
      li.className = "list-group-item";
      li.textContent = greekDate(d);
      list.appendChild(li);
    });
    var modal = new bootstrap.Modal(document.getElementById('missingDaysModal'));
    modal.show();

    document.getElementById('yesManualBtn').onclick = function() {
      document.getElementById('manualEntryPrompt').style.display = 'none';
      document.getElementById('manualEntryBox').style.display = 'block';
      manualDayIdx = 0;
      document.getElementById('currentDay').innerText = greekDate(missingDays[manualDayIdx]);
      document.getElementById('manualDishTitle').focus();
    };

    // AUTOCOMPLETE Î³Î¹Î± manualDishTitle
    let manualInput = document.getElementById("manualDishTitle");
    let manualAutocompleteDiv = document.getElementById("manual-autocomplete");
    manualInput.addEventListener('input', function() {
      let val = removeTonos(manualInput.value.trim());
      if (val.length < 2) {
        manualAutocompleteDiv.innerHTML = "";
        return;
      }
      let found = allRecipes.filter(function(r) {
        return removeTonos(r.title).includes(val)
          || removeTonos(r.tags || "").includes(val)
          || removeTonos(r.ingredients || "").includes(val)
          || removeTonos(r.main_dish_tag || "").includes(val);
      }).slice(0, 10);
      manualAutocompleteDiv.innerHTML = "";
      found.forEach(function(r) {
        let opt = document.createElement("div");
        opt.className = "autocomplete-option";
        opt.textContent = r.title;
        opt.onclick = function() {
          manualInput.value = r.title;
          manualAutocompleteDiv.innerHTML = "";
        };
        manualAutocompleteDiv.appendChild(opt);
      });
    });
    manualInput.addEventListener('blur', function() {
      setTimeout(function() { manualAutocompleteDiv.innerHTML = ""; }, 200);
    });
  }
});

function submitManualDish() {
  let title = document.getElementById('manualDishTitle').value.trim();
  let day = missingDays[manualDayIdx];
  if (!title) {
    document.getElementById('manualEntryFeedback').innerHTML = "<span class='text-danger'>Î“ÏÎ¬ÏˆÎµ Î­Î½Î± Ï€Î¹Î¬Ï„Î¿!</span>";
    return;
  }
  fetch('/add_manual_recipe', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({title: title, date: day})
  })
  .then(function(r) { return r.json(); })
  .then(function(data) {
    manualDayIdx++;
    document.getElementById('manualDishTitle').value = '';
    document.getElementById('manualEntryFeedback').innerHTML = "<span class='text-success'>ÎšÎ±Ï„Î±Ï‡Ï‰ÏÎ®Î¸Î·ÎºÎµ!</span>";

    if (data.id && data.date && data.title) {
      addDishToTable(data.id, data.date, data.title, data.chef, data.basic_category);
    }

    // ---- Î‘Î½ Î­Ï‡ÎµÎ¹ Ï€ÏÎ¿Ï„Î±Î¸ÎµÎ¯ modal Î³Î¹Î± Î±Î³Î±Ï€Î·Î¼Î­Î½Î± ----
    if (data.recipe_id) {
      // ÎšÎ»ÎµÎ¯ÏƒÎµ Ï„Î¿ missingDaysModal Ï€ÏÏÏ„Î±
      var modal = bootstrap.Modal.getInstance(document.getElementById('missingDaysModal'));
      if (modal) modal.hide();

      // Î†ÎºÎ¿Ï… Ï„Î¿ event hidden Ï„Î¿Ï… missingDaysModal, Î¼ÎµÏ„Î¬ Î¬Î½Î¿Î¹Î¾Îµ Ï„Î¿ favDetailsModal
      document.getElementById('missingDaysModal').addEventListener('hidden.bs.modal', function handler() {
        this.removeEventListener('hidden.bs.modal', handler);
        showAddFavoriteDialog(data.recipe_id, title); // <-- Î¼ÏŒÎ½Î¿ Î±Ï…Ï„ÏŒ
      });
    } else if (manualDayIdx < missingDays.length) {
      // Î•Ï€Î±Î½Î­Ï†ÎµÏÎµ Ï„Î¿ modal Î³Î¹Î± Ï„Î·Î½ ÎµÏ€ÏŒÎ¼ÎµÎ½Î· Î¼Î­ÏÎ± Î‘ÎœÎ•Î£Î©Î£ (Î´ÎµÎ½ Î­Ï‡ÎµÎ¹ ÎµÎ½Î´Î¹Î¬Î¼ÎµÏƒÎ¿ modal)
      showNextMissingDayModal();
    } else {
      var modal = bootstrap.Modal.getInstance(document.getElementById('missingDaysModal'));
      if (modal) modal.hide();
    }
  });
}

function showAddFavoriteDialog(recipe_id, title) {
  var modalEl = document.getElementById('favDetailsModal');
  var modal = bootstrap.Modal.getOrCreateInstance(modalEl);

  // Î‘Ï…Ï„ÏŒ ÎµÎ¯Î½Î±Î¹ Ï„Î¿ callback Ï€Î¿Ï… Î¸Î± ÎºÎ±Î»Î­ÏƒÎµÎ¹ Ï„Î¿ modal Ï„Î·Ï‚ ÎµÏ€ÏŒÎ¼ÎµÎ½Î·Ï‚ Î¼Î­ÏÎ±Ï‚ Î±Ï†Î¿Ï ÎºÎ»ÎµÎ¯ÏƒÎµÎ¹ Ï„Î¿ favDetailsModal
  function afterFavModalClosed() {
    modalEl.removeEventListener('hidden.bs.modal', afterFavModalClosed);
    if (typeof manualDayIdx !== "undefined" && typeof missingDays !== "undefined") {
      if (manualDayIdx < missingDays.length) {
        // Î¤ÏÏÎ± Î±Î½Î¿Î¯Î³ÎµÎ¹ Ï„Î¿ modal Î³Î¹Î± Ï„Î·Î½ ÎµÏ€ÏŒÎ¼ÎµÎ½Î· Î¼Î­ÏÎ±!
        showNextMissingDayModal();
      }
    }
  }
  modalEl.addEventListener('hidden.bs.modal', afterFavModalClosed);

  function showEditPrompt(add_to_favorites) {
    document.getElementById('favDetailsModalBody').innerHTML =
      "Î˜Î­Î»ÎµÎ¹Ï‚ Î½Î± ÏƒÏ…Î¼Ï€Î»Î·ÏÏÏƒÎµÎ¹Ï‚ Ï€ÎµÏÎ¹ÏƒÏƒÏŒÏ„ÎµÏÎµÏ‚ Î»ÎµÏ€Ï„Î¿Î¼Î­ÏÎµÎ¹ÎµÏ‚ Î³Î¹Î± Ï„Î· ÏƒÏ…Î½Ï„Î±Î³Î®;";
    document.getElementById('favDetailsModalFooter').innerHTML =
      '<button class="btn btn-primary" id="favEditYesBtn" type="button">ÎÎ±Î¹</button>' +
      '<button class="btn btn-secondary" type="button" data-bs-dismiss="modal">ÎŒÏ‡Î¹</button>';
    document.getElementById('favEditYesBtn').onclick = function() {
      modal.hide();
      window.location.href = "/favorites/edit/" + recipe_id + "?add_to_favorites=" + (add_to_favorites ? "1" : "0");
    };
    // "ÎŒÏ‡Î¹": Î±Ï€Î»Î¬ hide (Ï‡Ï‰ÏÎ¯Ï‚ redirect)
  }

  document.getElementById('favDetailsModalLabel').innerText = "ÎÎ­Î± Î£Ï…Î½Ï„Î±Î³Î®";
  document.getElementById('favDetailsModalBody').innerHTML =
    'Î— Î½Î­Î± ÏƒÏ…Î½Ï„Î±Î³Î® "<b>' + title + '</b>" ÎºÎ±Ï„Î±Ï‡Ï‰ÏÎ®Î¸Î·ÎºÎµ.<br>Î˜Î­Î»ÎµÎ¹Ï‚ Î½Î± Ï„Î·Î½ Ï€ÏÎ¿ÏƒÎ¸Î­ÏƒÎµÎ¹Ï‚ ÏƒÏ„Î± Î±Î³Î±Ï€Î·Î¼Î­Î½Î± ÏƒÎ¿Ï…;';
  document.getElementById('favDetailsModalFooter').innerHTML =
    '<button class="btn btn-success" id="favAddYesBtn" type="button">ÎÎ±Î¹</button>' +
    '<button class="btn btn-secondary" id="favAddNoBtn" type="button">ÎŒÏ‡Î¹</button>';

  modal.show();

  document.getElementById('favAddYesBtn').onclick = function() {
    fetch('/add_favorite_recipe', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({recipe_id: recipe_id})
    })
    .then(function(r){return r.json();})
    .then(function(){
      showEditPrompt(true);
    });
  };

  document.getElementById('favAddNoBtn').onclick = function() {
    showEditPrompt(false);
  };
}

function addDishToTable(row_id, date_str, title, chef, basic_category) {
  // format Î·Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±Ï‚ (client)
  let niceDate = greekDate(date_str);
  let tbody = document.querySelector('table.table tbody');
  let tr = document.createElement('tr');
  tr.id = 'row' + row_id;
  tr.innerHTML =
    '<td data-date="' + date_str + '">' + niceDate + '</td>' +
    '<td>' + title + '</td>' +
    '<td>' + (chef || '-') + '</td>' +
    '<td>' + (basic_category || '-') + '</td>' +
    '<td>' +
      '<button class="btn btn-outline-danger btn-sm" title="Î”Î¹Î±Î³ÏÎ±Ï†Î®" onclick="deleteHistoryEntry(' + row_id + ')">' +
        '<i class="fa fa-trash"></i>' +
      '</button>' +
    '</td>';
  tbody.appendChild(tr);
  sortHistoryTableByDate(); // â† ÎÎ­Î± Î³ÏÎ±Î¼Î¼Î®, Ï€Î¬Î½Ï„Î± Ï„Î±Î¾Î¹Î½Î¿Î¼Î·Î¼Î­Î½Î±!
}

function showNextMissingDayModal() {
  // Î•Ï€Î±Î½ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎµ Ï„Î¿ prompt/box, ÎµÎ½Î·Î¼Î­ÏÏ‰ÏƒÎµ Î·Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±, ÎºÎ±Î¸Î¬ÏÎ¹ÏƒÎµ feedback, Î¾Î±Î½Î±Î´ÎµÎ¯Î¾Îµ Ï„Î¿ modal
  document.getElementById('manualEntryPrompt').style.display = 'none';
  document.getElementById('manualEntryBox').style.display = 'block';
  document.getElementById('manualEntryFeedback').innerHTML = '';
  document.getElementById('currentDay').innerText = greekDate(missingDays[manualDayIdx]);
  document.getElementById('manualDishTitle').focus();

  // Î¾Î±Î½Î±ÎµÎ¼Ï†Î±Î½Î¹ÏƒÎµ Ï„Î¿ modal
  var modal = new bootstrap.Modal(document.getElementById('missingDaysModal'));
  modal.show();
}

function sortHistoryTableByDate() {
  let tbody = document.querySelector('table.table tbody');
  // ÎœÎ¬Î¶ÎµÏˆÎµ ÏŒÎ»Î± Ï„Î± <tr> Ï€Î¿Ï… Î­Ï‡Î¿Ï…Î½ Î·Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î± ÏƒÏ„Î·Î½ Ï€ÏÏÏ„Î· ÏƒÏ„Î®Î»Î·
  let rows = Array.from(tbody.querySelectorAll('tr')).filter(tr => tr.children.length && tr.children[0]);
  // Sort Ï†Î¸Î¯Î½Î¿Ï…ÏƒÎ± Î²Î¬ÏƒÎ· Ï„Î·Ï‚ Î·Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±Ï‚ (Ï€ÏÏÏ„Î· ÏƒÏ„Î®Î»Î·)
  rows.sort(function(a, b) {
    // Î Î±Î¯ÏÎ½ÎµÎ¹Ï‚ Ï„Î¿ date string Î±Ï€ÏŒ Ï„Î¿ hidden attribute data-date Î® Î±Ï€ÏŒ Ï„Î¿ textContent (Î´ÎµÏ‚ Ï€Î±ÏÎ±ÎºÎ¬Ï„Ï‰)
    let dateA = a.children[0].getAttribute('data-date') || a.children[0].textContent.trim();
    let dateB = b.children[0].getAttribute('data-date') || b.children[0].textContent.trim();
    // Î‘Î½ Î­Ï‡ÎµÎ¹Ï‚ ÎºÏÎ±Ï„Î®ÏƒÎµÎ¹ Ï„Î¿ raw yyyy-mm-dd ÏƒÎµ data-date, ÎºÎ¬Î½Îµ ÏƒÏÎ³ÎºÏÎ¹ÏƒÎ· Ï‰Ï‚ string
    // Î±Î»Î»Î¹ÏÏ‚ Î±Î½ ÎµÎ¯Î½Î±Î¹ ÏƒÎµ Î¼Î¿ÏÏ†Î® ÎµÎ»Î»Î·Î½Î¹ÎºÎ®Ï‚ Î·Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±Ï‚, Î¼ÎµÏ„Î±Ï„ÏÎ¿Ï€Î® ÏƒÎµ Date:
    // Î¥Ï€Î¿Î¸Î­Ï„Î¿Ï…Î¼Îµ ÏŒÏ„Î¹ data-date Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ ÎºÎ±Î¹ ÎµÎ¯Î½Î±Î¹ YYYY-MM-DD
    if (dateA > dateB) return -1;
    if (dateA < dateB) return 1;
    return 0;
  });
  // ÎÎ±Î½Î±Î²Î¬Î»Îµ Ï„Î± rows Î¼Îµ Ï„Î· Î½Î­Î± ÏƒÎµÎ¹ÏÎ¬!
  rows.forEach(tr => tbody.appendChild(tr));
  updateWeeklyGoalsTable();
}

function cancelManualEntry() {
  document.getElementById('manualEntryBox').style.display = 'none';
  document.getElementById('manualEntryPrompt').style.display = '';
  document.getElementById('manualEntryFeedback').innerHTML = '';
}

function deleteHistoryEntry(id) {
  if (!confirm('Î˜Î­Î»ÎµÎ¹Ï‚ ÏƒÎ¯Î³Î¿Ï…ÏÎ± Î½Î± Î´Î¹Î±Î³ÏÎ¬ÏˆÎµÎ¹Ï‚ Î±Ï…Ï„ÏŒ Ï„Î¿ Ï€Î¹Î¬Ï„Î¿ Î±Ï€ÏŒ Ï„Î¿ Î¹ÏƒÏ„Î¿ÏÎ¹ÎºÏŒ;')) return;
  fetch('/delete_history_entry', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ id: id })
  })
  .then(function(r) { return r.json(); })
  .then(function(data) {
    if (data.status === 'ok') {
      let row = document.getElementById('row' + id);
      if (row) row.remove();
	  updateWeeklyGoalsTable();
    } else {
      alert('ÎšÎ¬Ï„Î¹ Ï€Î®Î³Îµ ÏƒÏ„ÏÎ±Î²Î¬. Î ÏÎ¿ÏƒÏ€Î¬Î¸Î·ÏƒÎµ Î¾Î±Î½Î¬!');
    }
  });
}

function startSpeechForManual() {
  if (!('webkitSpeechRecognition' in window)) {
    alert("ÎŸ browser ÏƒÎ¿Ï… Î´ÎµÎ½ Ï…Ï€Î¿ÏƒÏ„Î·ÏÎ¯Î¶ÎµÎ¹ Ï†Ï‰Î½Î·Ï„Î¹ÎºÎ® Î±Î½Î±Î³Î½ÏÏÎ¹ÏƒÎ·.");
    return;
  }

  const recognition = new webkitSpeechRecognition();
  recognition.lang = 'el-GR';
  recognition.continuous = false;
  recognition.interimResults = false;

  const feedbackSpan = document.getElementById('manualVoiceFeedback');
  if (feedbackSpan) feedbackSpan.textContent = "ğŸ™ï¸ Î‘ÎºÎ¿ÏÏ‰...";

	recognition.onresult = function(event) {
	  const transcript = event.results[0][0].transcript.trim();
	  const input = document.getElementById('manualDishTitle');
	  input.value = transcript;
	  input.dispatchEvent(new Event('input')); // <--- Î‘Ï…Ï„ÏŒ ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¹ÎµÎ¯ Ï„Î¿ autosearch!
	};


  recognition.onerror = function(event) {
    alert("Î£Ï†Î¬Î»Î¼Î± Î¼Î¹ÎºÏÎ¿Ï†ÏÎ½Î¿Ï…: " + event.error);
  };

  recognition.onend = function() {
    if (feedbackSpan) feedbackSpan.textContent = "";
  };

  recognition.start();
}


</script>
{% endblock %}
