{% extends "base.html" %}
{% block title %}Ιστορικό Πιάτων • Family Food{% endblock %}
{% block content %}


<style>
.glass-date-subtitle {
  font-size:1.2em;
  color:var(--brand);
  font-weight:600;
  letter-spacing:0.01em;
  margin-bottom:-10px;
  margin-left:12px;
  margin-top:16px;
  display:flex;
  align-items:center;
  gap:7px;
  justify-content: center
}
</style>

<style>
.glass-history-card {
  background: linear-gradient(120deg, #f0fff4 60%, #c8f1d7 100%);
  border-radius: 26px;
  box-shadow: 0 3px 22px #218e4621, 0 1.5px 7px #1a6e3833;
  padding: 0;
  margin: 24px auto 32px auto;
  max-width: 410px;
  position: relative;
  display: flex;
  align-items: stretch;
  justify-content: center;
}
.glass-img-hero-wrap {
  width: 100%;
  position: relative;
  overflow: visible;
  border-radius: 24px;
  margin: 0 auto;
  display: flex;
  justify-content: center;
}
.glass-hero-img {
  width: 100%;
  max-width: 410px;
  height: 220px;
  object-fit: cover;
  border-radius: 24px;
  display: block;
  box-shadow: 0 6px 36px #1a6e3833;
}
.glass-content-overlay {
  position: absolute;
  left: 0; top: 0; right: 0; bottom: 0;
  display: flex;
  flex-direction: column;
  justify-content: flex-end;
  border-radius: 24px;
  background: linear-gradient(135deg, rgba(255, 255, 255, 0.07) 0%, rgb(18 129 56 / 76%) 100%);
  pointer-events: none;
}
.glass-inner-info {
  position: absolute;
  z-index: 3;
  padding: 20px 20px 14px 20px;
  display: flex;
  flex-direction: column;
  align-items: center;
  pointer-events: auto;
}
.glass-title {
  color: #fff;
  font-size: 1.43rem;
  font-weight: 800;
  text-shadow: 0 2px 16px #15471a99, 0 1px 2px #1a6e384d;
  line-height: 1.13;
  margin-bottom: 14px;
  letter-spacing: 0.04em;
  max-width: 90vw;
  text-align: center;
  text-overflow: ellipsis;
  overflow: hidden;
}
.glass-meta-bar {
  top: 163px;
  position: absolute;
  display: flex;
  align-items: center;
  gap: 9px;
  background: rgba(250,255,250,0.5);
  backdrop-filter: blur(6px);
  border-radius: 18px;
  padding: 6px 17px 6px 10px;
  box-shadow: 0 2px 7px #18381a33;
  margin-top: 8px;
}
.glass-meta-icon {
  color: var(--brand);
  font-size: 1.1em;
  margin-right: 1px;
  line-height: 1;
  text-shadow: 0 2px 8px #18381a33;
}
.glass-meta-time {
  color: #fff;
  font-weight: 700;
  font-size: 1.08em;
  margin-right: 7px;
}
.glass-meta-by {
  font-family: 'Indie Flower', cursive;
  color: #eafbe7;
  font-size: 0.98em;
  margin-right: 9px;
  margin-left: 10px;
  letter-spacing: 0.1em;
}
.glass-meta-chef {
  width: 27px; height: 27px;
  border-radius: 50%;
  object-fit: cover;
  border: 2px solid #fff;
  background: #fff;
  box-shadow: 0 2px 8px #eafbe766;
  display: inline-block;
}
.glass-methods {
  display: flex;
  gap: 9px;
  margin: 0 0 15px 0;
  flex-wrap: wrap;
}
.glass-method-badge {
  background: rgba(234, 255, 240, 0.76);
  color: #218e46;
  border-radius: 13px;
  padding: 3px 14px 3px 14px;
  font-size: 1em;
  font-weight: 700;
  letter-spacing: 0.01em;
  border: 1.2px solid #b8eec9;
  box-shadow: 0 2px 6px #b2f0cc33;
  backdrop-filter: blur(2px);
  white-space: nowrap;
}
.glass-cat {
  background: rgba(255,255,255,0.79);
  color: #187b40;
  border-radius: 10px;
  font-weight: 700;
  font-size: 1em;
  letter-spacing: 0.01em;
  padding: 2px 16px;
  margin-bottom: 13px;
  border: 1.1px solid #d1ead6;
  box-shadow: 0 1px 4px #e6ffe661;
  display: inline-block;
}
.glass-notes {
  color: #226d39;
  background: #f2fff6cc;
  border-radius: 11px;
  font-size: 1.04em;
  padding: 10px 14px;
  box-shadow: 0 2px 8px #eafbe766;
  text-align: center;
  min-height: 24px;
  font-style: italic;
  font-weight: 500;
}
.weekly-group { margin-bottom: 26px; border-radius: 21px; box-shadow: 0 2px 20px #d1ead633; background: none;}
.weekly-group-title {
  font-size: 1.05em; font-weight: 700; color: #166b34; margin: 19px 0 6px 12px;
  letter-spacing: 0.01em; display: flex; align-items: center; gap: 8px;
  cursor: pointer; user-select: none;
  padding: 12px 12px 11px 2px;
  border-radius: 16px;
  background: linear-gradient(120deg,#eafbe7 60%,#dbf8e6 100%);
  box-shadow: 0 1px 6px #eafbe799;
  transition: background .16s;
}
.weekly-group-title.collapsed { background: #f7fdf8; color: #9bc3ad; }
.weekly-group-body { display: none; animation: fadein .25s; }
.weekly-group-body.active { display: block; }
@keyframes fadein { from { opacity: 0; transform: translateY(13px);} to { opacity: 1; transform: none;}}
.no-history {
  margin: 40px 0 0 0;
  text-align: center;
  color: #92bfa8;
  font-size: 1.15rem;
  font-weight: 500;
}
.glass-filter-row, .profile-search-row, .glass-filter-chip, .glass-chip-dropdown, .dropdown-item {
  /* Δες το style από τις favorites, μπορείς να τα αντιγράψεις για ίδια εμπειρία */
}
</style>





<div class="recipe-topbar" id="topBar">
  <button class="icon-btn" id="backBtn"><i class="fa fa-arrow-left"></i></button>
  <div class="topbar-title">Ιστορικό Πιάτων</div>
  <div style="width:44px;"></div>
</div>

<div id="history-filters-section" style="margin: 24px 2vw 10px 2vw;">
  <div class="glass-filter-row" id="glassFilterRow"></div>
  <div class="d-flex profile-search-row">
    <input type="text" id="search-term" class="form-control form-control-sm voice-enabled" placeholder="Αναζήτησε... ή πάτα το μικρόφωνο:">
    <button class="btn btn-outline-secondary btn-sm ms-2" id="reset-filters-btn" type="button">
      <i class="fa fa-rotate-left"></i>
    </button>
    <button class="btn btn-light btn-sm ms-2" type="button" id="voice-search-btn" title="Αναζήτηση με φωνή">
      <i class="fa fa-microphone"></i>
    </button>
  </div>
</div>

<div id="history-list"></div>
<div id="noHistoryMsg" class="no-history" style="display:none;">Δεν έχεις καταχωρήσει κανένα πιάτο ακόμα!</div>

{% endblock %}

{% block scripts %}
<script>
window.cooked_history = {{ history|tojson }};
</script>
<script>
function normalize(str) {
  if (!str) return "";
  return str.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, "").replace(/[·.,;!?]/g, "").trim();
}
function getUnique(arr, key) {
  return [...new Set(arr.map(x => (x[key] || '').trim()).filter(x => x && x !== "None"))];
}
function getUniqueMethods(arr) {
  let all = [];
  arr.forEach(x => {
    if (x.recipe_method && x.recipe_method !== "None") {
      x.recipe_method.split(",").forEach(m => { m = m.trim(); if (m) all.push(m); });
    }
  });
  return [...new Set(all)];
}
function getUniqueCategories(arr) {
  let all = [];
  arr.forEach(x => {
    if (x.dish_category && x.dish_category !== "None") {
      x.dish_category.split(",").forEach(cat => { cat = cat.trim(); if (cat) all.push(cat); });
    }
  });
  return [...new Set(all)];
}
function getUniqueTimes(arr) {
  return arr
    .map(x => parseInt(String(x.total_time).replace(/[^0-9]/g,"")))
    .filter(x => !isNaN(x));
}
function getUniqueChefs(arr) {
  return getUnique(arr, "chef");
}


function getIsoWeekYearAndNumber(date) {
  const d = new Date(date);
  d.setHours(0,0,0,0);
  // Thursday in current week decides the year
  d.setDate(d.getDate() + 3 - ((d.getDay() + 6) % 7));
  const week1 = new Date(d.getFullYear(),0,4);
  // Adjust to Thursday in week 1 and count number of weeks from date to week1
  return {
    year: d.getFullYear(),
    week: 1 + Math.round(((d.getTime() - week1.getTime()) / 86400000 - 3 + ((week1.getDay() + 6) % 7)) / 7)
  };
}
function groupByWeek(arr) {
  let out = {};
  arr.forEach(item => {
    if (!item.date) return;
    const {year, week} = getIsoWeekYearAndNumber(item.date);
    let key = year + "-W" + String(week).padStart(2, "0");
    if (!out[key]) out[key] = [];
    out[key].push(item);
  });
  return Object.fromEntries(Object.entries(out).sort((a, b) => b[0].localeCompare(a[0])));
}



let filterValues = { chef: "", category: "", time: "", method: "" };
function filterHistory() {
  const chef = filterValues.chef;
  const category = filterValues.category;
  const method = filterValues.method;
  const time = filterValues.time;
  const term = document.getElementById("search-term").value.trim();

  let filtered = window.cooked_history.filter(function(rec) {
    if (chef && rec.chef !== chef) return false;
    if (category) {
      const categories = (rec.dish_category || "").split(",").map(x => x.trim());
      if (!categories.includes(category)) return false;
    }
    if (method) {
      if (!rec.recipe_method || !rec.recipe_method.split(",").map(x=>x.trim()).includes(method)) return false;
    }
    if (time) {
      const tval = parseInt(String(rec.total_time).replace(/[^0-9]/g,""));
      if (time === "Άνω των 120'") {
        if (!tval || tval <= 120) return false;
      } else {
        let max = parseInt(time.replace(/[^0-9]/g, ""));
        if (!tval || tval > max) return false;
      }
    }
    if (term) {
      let inTitle = normalize(rec.title).includes(normalize(term));
      let inNotes = normalize(rec.notes || "").includes(normalize(term));
      let inTags = normalize(rec.tags || "").includes(normalize(term));
      let inChef = normalize(rec.chef || "").includes(normalize(term));
      let inCat = normalize(rec.dish_category || "").includes(normalize(term));
      let inMethod = normalize(rec.recipe_method || "").includes(normalize(term));
      if (!(inTitle || inNotes || inTags || inChef || inCat || inMethod)) return false;
    }
    return true;
  });
  renderHistoryCards(filtered);
}

function greekDateLong(dateStr) {
  // dateStr = '2025-09-22'
  const days = ['Κυριακή', 'Δευτέρα', 'Τρίτη', 'Τετάρτη', 'Πέμπτη', 'Παρασκευή', 'Σάββατο'];
  const months = ['', 'Ιανουαρίου', 'Φεβρουαρίου', 'Μαρτίου', 'Απριλίου', 'Μαΐου', 'Ιουνίου', 'Ιουλίου', 'Αυγούστου', 'Σεπτεμβρίου', 'Οκτωβρίου', 'Νοεμβρίου', 'Δεκεμβρίου'];
  const [y, m, d] = dateStr.split('-').map(Number);
  const date = new Date(y, m - 1, d);
  const dayName = days[date.getDay()];
  return `${dayName} - ${d} ${months[m]}`;
}

function renderHistoryCards(entries) {
  const wrapper = document.getElementById('history-list');
  wrapper.innerHTML = "";
  if (!entries || entries.length === 0) {
    document.getElementById('noHistoryMsg').style.display = "";
    return;
  }
  document.getElementById('noHistoryMsg').style.display = "none";
  const byWeek = groupByWeek(entries);
  let first = true;
  Object.entries(byWeek).forEach(([weekKey, dishes]) => {
    let dates = dishes.map(x => x.date).sort();
    let weekLabel = `Εβδομάδα ${weekKey.split("-W")[1]} (${dates[0].split("-").reverse().join("/")} – ${dates[dates.length-1].split("-").reverse().join("/")})`;
    const weekDiv = document.createElement("div");
    weekDiv.className = "weekly-group";
    const weekTitle = document.createElement("div");
    weekTitle.className = "weekly-group-title" + (first ? "" : " collapsed");
    weekTitle.innerHTML = `<i class="fa fa-calendar-week me-2 text-primary"></i> ${weekLabel}
      <span style="margin-left:auto;display:inline-block;"><i class="fa fa-chevron-down"></i></span>`;
    weekTitle.style.cursor = "pointer";
    weekTitle.addEventListener("click", function() {
      groupBody.classList.toggle("active");
      weekTitle.classList.toggle("collapsed");
      let icon = weekTitle.querySelector(".fa-chevron-down");
      icon.style.transform = groupBody.classList.contains("active") ? "rotate(0deg)" : "rotate(-90deg)";
    });
    weekDiv.appendChild(weekTitle);

    const groupBody = document.createElement("div");
    groupBody.className = "weekly-group-body" + (first ? " active" : "");
    dishes.sort((a,b) => (b.date + (b.cooked_at || "")).localeCompare(a.date + (a.cooked_at || "")));
    dishes.forEach(row => {
      // === Glass DATE subtitle ===
      const dateSubtitle = document.createElement('div');
      dateSubtitle.className = 'glass-date-subtitle';
      dateSubtitle.innerHTML = '<i class="fa fa-calendar-alt me-1"></i>' + greekDateLong(row.date);
      groupBody.appendChild(dateSubtitle);

      // === Glass card χωρίς ημερομηνία στη meta-bar ===
      const card = document.createElement('div');
      card.className = 'glass-history-card';
      card.style.position = "relative";
      const heroWrap = document.createElement('div');
      heroWrap.className = "glass-img-hero-wrap";
      heroWrap.innerHTML =
        '<img src="/static/images/recipes/' + (row.image_path || 'placeholder.jpg') + '"' +
          ' class="glass-hero-img"' +
          ' alt="' + (row.title || 'πιάτο') + '"' +
          ' onerror="this.onerror=null;this.src=\'/static/images/recipes/placeholder.jpg\';">' +
        '<div class="glass-content-overlay"></div>' +
        '<div class="glass-inner-info">' +
          '<div class="glass-title">' + (row.title || '[Άγνωστο πιάτο]') + '</div>' +
          ((row.recipe_method && row.recipe_method !== "None")
            ? '<div class="glass-methods">' +
                row.recipe_method.split(",").map(function(m) {
                  return m.trim() ? '<span class="glass-method-badge">' + m.trim() + '</span>' : "";
                }).join("") +
              '</div>'
            : ""
          ) +
          '<div class="glass-cat">' + (row.dish_category || '-') + '</div>' +
          '<div class="glass-meta-bar">' +
            (row.total_time ? `<span class="glass-meta-icon"><i class="fa fa-clock"></i></span>
            <span class="glass-meta-time">${row.total_time}'</span>` : "") +
            (row.chef ? `<span class="glass-meta-by">by</span>
            <img class="glass-meta-chef" src="${row.chef_avatar || '/static/images/avatars/default.jpg'}" alt="Chef">` : "") +
          '</div>' +
        '</div>';
      card.appendChild(heroWrap);
      if (row.notes) {
        const notes = document.createElement('div');
        notes.className = 'glass-notes';
        notes.innerHTML = `<i class="fa fa-comment-dots me-2"></i>${row.notes}`;
        card.appendChild(notes);
      }
      const actions = document.createElement('div');
      actions.className = "activity-action-btns";
      actions.innerHTML = `
        <button class="action-btn" title="Προβολή" onclick="window.location.href='/recipe_page/${row.recipe_id}'; event.stopPropagation();">
          <i class="fa fa-eye"></i>
        </button>
        <button class="action-btn" title="Διαγραφή" onclick="event.stopPropagation(); openHistoryDeleteModal(${row.id});">
          <i class="fa fa-trash"></i>
        </button>
      `;
      card.appendChild(actions);
      card.addEventListener('click', function(e) {
        if (e.target.closest('.action-btn')) return;
        actions.classList.toggle('active');
      });
      groupBody.appendChild(card);
    });
    weekDiv.appendChild(groupBody);
    wrapper.appendChild(weekDiv);
    if (first) first = false;
  });
}

const FILTERS = [
  { key: "chef", label: "Σεφ", icon: "fa-user-tie", default: "Όλοι οι σεφ" },
  { key: "category",label:"Κατηγορία",icon:"fa-utensils",default:"Όλες οι κατηγορίες" },
  { key: "time", label: "Χρόνοι", icon: "fa-clock", default: "Όλοι οι χρόνοι" },
  { key: "method", label: "Μέθοδοι", icon: "fa-fire", default: "Όλες οι μέθοδοι" }
];
function createChipDropdown(items, key, current) {
  const dd = document.createElement("div");
  dd.className = "glass-chip-dropdown";
  items.forEach(item => {
    const div = document.createElement("div");
    div.className = "dropdown-item" + (item == current ? " selected" : "");
    div.textContent = item;
    div.onclick = function(e) {
      e.stopPropagation();
      filterValues[key] = item === FILTERS.find(f=>f.key==key).default ? "" : item;
      document.querySelectorAll('.glass-chip-dropdown').forEach(x => x.style.display = "none");
      renderFilterChips();
      filterHistory();
    }
    dd.appendChild(div);
  });
  return dd;
}
function renderFilterChips() {
  const row = document.getElementById("glassFilterRow");
  row.innerHTML = "";
  FILTERS.forEach(filt => {
    let allVals;
    if (filt.key == "chef") allVals = getUniqueChefs(window.cooked_history);
    else if (filt.key == "category") allVals = getUniqueCategories(window.cooked_history);
    else if (filt.key == "method") allVals = getUniqueMethods(window.cooked_history);
    else if (filt.key == "time") {
      let times = getUniqueTimes(window.cooked_history);
      let vals = [];
      if (times.some(x => x <= 30)) vals.push("Έως 30'");
      if (times.some(x => x > 30 && x <= 60)) vals.push("Έως 60'");
      if (times.some(x => x > 60 && x <= 90)) vals.push("Έως 90'");
      if (times.some(x => x > 90 && x <= 120)) vals.push("Έως 120'");
      if (times.some(x => x > 120)) vals.push("Άνω των 120'");
      allVals = vals;
    } else {
      allVals = [];
    }
    let vals = [filt.default, ...allVals.filter(v=>!!v)];
    const chip = document.createElement("div");
    chip.className = "glass-filter-chip" + (filterValues[filt.key] ? " selected" : "");
    chip.innerHTML = `<span class="chip-icon fa ${filt.icon}"></span>${filterValues[filt.key] || filt.default}`;
    chip.onclick = function(e) {
      e.stopPropagation();
      document.querySelectorAll('.glass-chip-dropdown').forEach(x => {
        if (x !== chip.querySelector('.glass-chip-dropdown')) x.style.display = "none";
      });
      let dd = chip.querySelector('.glass-chip-dropdown');
      if (!dd) {
        dd = createChipDropdown(vals, filt.key, filterValues[filt.key] || filt.default);
        chip.appendChild(dd);
      }
      if (dd.style.display === "flex") {
        dd.style.display = "none";
        return;
      }
      dd.style.display = "flex";
      setTimeout(function() {
        const rect = dd.getBoundingClientRect();
        if (rect.right > (window.innerWidth-10)) {
          dd.style.left = "auto";
          dd.style.right = "0";
        } else {
          dd.style.left = "0";
          dd.style.right = "auto";
        }
      }, 1);
    };
    row.appendChild(chip);
  });
  document.body.onclick = function(e) {
    if (!e.target.classList.contains('glass-filter-chip') && !e.target.classList.contains('dropdown-item')) {
      document.querySelectorAll('.glass-chip-dropdown').forEach(x => x.style.display = "none");
    }
  }
}
document.addEventListener("DOMContentLoaded", function () {
  renderFilterChips();
  renderHistoryCards(window.cooked_history);
  document.getElementById("search-term").addEventListener("input", function() {
    if (this.value.trim().length === 0 || this.value.trim().length >= 2) {
      filterHistory();
    }
  });
  var resetBtn = document.getElementById("reset-filters-btn");
  if (resetBtn) resetBtn.addEventListener("click", function() {
    filterValues = { chef:"", time:"", category:"", method:"" };
    renderFilterChips();
    var s = document.getElementById("search-term");
    if(s) s.value="";
    filterHistory();
  });
});
function openHistoryDeleteModal(id) {
  if (!confirm("Να διαγραφεί αυτό το πιάτο από το ιστορικό;")) return;
  fetch("/delete_history_entry", {
    method: "POST",
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ id: id })
  }).then(() => window.location.reload());
}
</script>
<script>
document.addEventListener('DOMContentLoaded', function () {
  var voiceBtn = document.getElementById("voice-search-btn");
  var input = document.getElementById("search-term");
  if (voiceBtn && input && 'webkitSpeechRecognition' in window) {
    voiceBtn.addEventListener("click", function () {
      try {
        var recognition = new webkitSpeechRecognition();
        recognition.lang = 'el-GR';
        recognition.continuous = false;
        recognition.interimResults = false;
        recognition.onaudiostart = function () {
          input.classList.add('listening');
          input.placeholderBackup = input.placeholder;
          input.placeholder = "🎙️ Μιλήστε τώρα…";
        };
        recognition.onresult = function (event) {
          var transcript = event.results[0][0].transcript.trim();
          input.value = transcript;
          input.classList.remove('listening');
          if (input.placeholderBackup) {
            input.placeholder = input.placeholderBackup;
            delete input.placeholderBackup;
          }
          filterHistory();
        };
        recognition.onend = function () {
          input.classList.remove('listening');
          if (input.placeholderBackup) {
            input.placeholder = input.placeholderBackup;
            delete input.placeholderBackup;
          }
        };
        recognition.start();
      } catch (e) {
        alert("Το μικρόφωνο δεν υποστηρίζεται σε αυτόν τον browser.");
      }
    });
  }
});
document.addEventListener("DOMContentLoaded", function() {
  const backBtn = document.getElementById('backBtn');
  if (backBtn) {
    backBtn.onclick = function() { window.history.back(); };
  }
});
</script>
{% endblock %}
