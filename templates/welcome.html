{% extends "base.html" %}
{% block title %}ÎšÎ±Î»Ï‰ÏƒÏŒÏÎ¹ÏƒÎ¼Î±{% endblock %}
{% block content %}

<style>
.main-welcome-container {
  max-width: 600px;
  margin: 0 auto;
  padding: 1.5rem 0.7rem 0.7rem 0.7rem;
}
.chatbox {
  background: #fff;
  border: 1px solid #eee;
  min-height: 90px;
  padding: 12px 10px;
  font-size: 1.12rem;
  line-height: 1.5;
  max-height: 40vh;
  overflow-y: auto;
  box-shadow: 0 1px 7px rgba(0,0,0,0.07);
  border-radius: 15px;
}
.chat-line {
  margin-bottom: 7px;
}
.chat-assistant { color: #2078b6; font-weight: 600; }
.chat-user { color: #198754; font-weight: 600; }
#welcome-main-actions .btn, #choicesRow .btn, #afterMenuBtns .btn {
  min-width: 170px;
  margin-bottom: 0.2em;
  font-size: 1.08em;
}
@media (max-width: 480px) {
  .main-welcome-container { padding: 0.7rem 0.2rem 0.2rem 0.2rem; }
  .display-5, .display-4 { font-size: 1.35rem; }
  .chatbox { font-size: 1.01rem; }
  #welcome-main-actions, #choicesRow, #afterMenuBtns {
    flex-direction: column !important;
    gap: 0 !important;
    align-items: stretch;
  }
  #welcome-main-actions .btn, #choicesRow .btn, #afterMenuBtns .btn {
    width: 100% !important;
    min-width: 0;
    margin-bottom: 7px;
    font-size: 1.09em;
  }
}
</style>

<style>
#onboardingBackdrop {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
  z-index: 999;
}
#onboardingTooltip {
  position: fixed;
  bottom: 90px;
  right: 12px;
  background: #fff9db;
  padding: 10px 14px;
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.3);
  z-index: 1000;
  max-width: 230px;
  font-size: 14px;
  text-align: center;
  animation: pulse 1.5s infinite;
  transform: translate(0, 0);
  position: fixed;
}
#onboardingTooltip::after {
  content: "";
  position: absolute;
  bottom: -7px;
  right: 16px;
  width: 14px;
  height: 14px;
  background: #fff9db;
  transform: rotate(45deg);
  border-bottom: 1px solid rgba(0,0,0,0.1);
  border-right: 1px solid rgba(0,0,0,0.1);
  box-shadow: 1px 1px 3px rgba(0,0,0,0.08);
  z-index: 0;
}



/* Î Î±Î»Î¼ÏŒÏ‚ (Î±Î½Î±Î²ÏŒÏƒÎ²Î·Î¼Î±) */
@keyframes pulse {
  0%   { transform: scale(1); box-shadow: 0 0 10px rgba(255, 255, 255, 0.6); }
  50%  { transform: scale(1.03); box-shadow: 0 0 20px rgba(255, 255, 255, 0.9); }
  100% { transform: scale(1); box-shadow: 0 0 10px rgba(255, 255, 255, 0.6); }
}

/* ÎšÎ¬Î½Îµ ÎŸÎ›Î‘ Ï„Î± ÎºÎ¿Ï…Î¼Ï€Î¹Î¬ Ï„Î¿Ï… bottom nav Î±Î½ÎµÎ½ÎµÏÎ³Î¬ */
body.onboarding-active nav.navbar.fixed-bottom a.nav-link {
  pointer-events: none;
  opacity: 0.3;
}

/* Î•Î½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎµ ÎœÎŸÎÎŸ Ï„Î¿ ÎºÎ¿Ï…Î¼Ï€Î¯ Î ÏÎ¿Ï†Î¯Î» */
body.onboarding-active nav.navbar.fixed-bottom a[href="/profile"] {
  pointer-events: auto;
  opacity: 1;
}


</style>


<div class="main-welcome-container">

  <h1 class="display-5 text-center mb-3">{{ greeting }}, {{ user_name }}!</h1>
  <p class="lead text-center mb-3">
    ÎˆÏ„Î¿Î¹Î¼Î¿Î¹ Î½Î± Î¼Î±Î³ÎµÎ¹ÏÎ­ÏˆÎ¿Ï…Î¼Îµ ÎºÎ¬Ï„Î¹ Ï…Ï€Î­ÏÎ¿Ï‡Î¿ ÏƒÎ®Î¼ÎµÏÎ±; ğŸ½ï¸
  </p>
  <div class="d-flex justify-content-center mb-3" id="welcome-main-actions">
    <button class="btn btn-outline-secondary btn-sm" onclick="restartChat()">â†» Î•Ï€Î±Î½Î±Ï†Î¿ÏÎ¬ Chat</button>
  </div>
  <div class="chatbox rounded shadow-sm mb-3" id="chatbox">
    <div class="chat-line">
      <span class="chat-assistant">ğŸ‘©â€ğŸ³ Family Food:</span> {{ day_name }} ÏƒÎ®Î¼ÎµÏÎ±, Ï„Î¹ Î¸Î± Î¼Î±Î³ÎµÎ¹ÏÎ­ÏˆÎ¿Ï…Î¼Îµ;
    </div>
  </div>
  <div id="ai-chat-controls"></div>
</div>

<!-- Onboarding overlay -->
<div id="onboardingOverlay" style="display:none;">
  <div id="onboardingBackdrop"></div>
  <div id="onboardingTooltip">
    ğŸ‘‰ Î£Ï…Î¼Ï€Î»Î®ÏÏ‰ÏƒÎµ Ï„Î¿ Ï€ÏÎ¿Ï†Î¯Î» ÏƒÎ¿Ï… Î³Î¹Î± Î½Î± Î¾ÎµÎºÎ¹Î½Î®ÏƒÎµÎ¹Ï‚!
    <div class="arrow-down"></div>
  </div>
</div>




{% endblock %}


{% block modals %}
<!-- Pop-up modal Î³Î¹Î± Ï…Î»Î¹ÎºÎ¬ -->
<div class="modal fade" id="ingredientsModal" tabindex="-1" aria-labelledby="modalRecipeTitle" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalRecipeTitle"></h5>
      </div>
      <div class="modal-body" id="modalIngredients">
        <!-- Î¤Î± Ï…Î»Î¹ÎºÎ¬ Ï‰Ï‚ checkbox Î¸Î± Î¼Ï€Î±Î¯Î½Î¿Ï…Î½ ÎµÎ´Ï -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-success" onclick="saveMissingIngredients()">Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Î†ÎºÏ…ÏÎ¿</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal ÎµÎ¼Ï†Î¬Î½Î¹ÏƒÎ·Ï‚ ÏƒÏ…Î½Ï„Î±Î³Î®Ï‚ -->
<div class="modal fade" id="viewRecipeModal" tabindex="-1" aria-labelledby="viewRecipeLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="viewRecipeLabel">Î£Ï…Î½Ï„Î±Î³Î®</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="modalRecipeBody">
        <!-- Î•Î´Ï Î¸Î± Î¼Ï€Î±Î¯Î½Î¿Ï…Î½ Ï„Î± Î´ÎµÎ´Î¿Î¼Î­Î½Î± -->
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let todayMenu = "{{ today_menu|safe }}";
let todayMenuId = "{{ today_menu_id }}";
let tomorrowMenu = "{{ tomorrow_menu|safe }}";
let tomorrowMenuId = "{{ tomorrow_menu_id }}";
let cookingDay = "today"; // default: ÏƒÎ®Î¼ÎµÏÎ±

function startSpeechRecognition() {
  if (!('webkitSpeechRecognition' in window)) {
    alert("ÎŸ browser ÏƒÎ¿Ï… Î´ÎµÎ½ Ï…Ï€Î¿ÏƒÏ„Î·ÏÎ¯Î¶ÎµÎ¹ Ï†Ï‰Î½Î·Ï„Î¹ÎºÎ® Î±Î½Î±Î³Î½ÏÏÎ¹ÏƒÎ·.");
    return;
  }

  const recognition = new webkitSpeechRecognition();
  recognition.lang = 'el-GR';
  recognition.continuous = false;
  recognition.interimResults = false;

  const feedbackSpan = document.createElement('span');
  feedbackSpan.id = "voiceFeedback";
  feedbackSpan.textContent = "ğŸ™ï¸ Î‘ÎºÎ¿ÏÏ‰...";
  feedbackSpan.style.marginLeft = "10px";
  feedbackSpan.style.fontWeight = "bold";
  feedbackSpan.style.color = "#c00";

  const parentDiv = document.querySelector('#ai_ingredient')?.parentNode;
  if (parentDiv && !document.getElementById("voiceFeedback")) {
    parentDiv.appendChild(feedbackSpan);
  }

  recognition.onresult = function(event) {
    const transcript = event.results[0][0].transcript.trim();
    document.getElementById('ai_ingredient').value = transcript;
  };

  recognition.onerror = function(event) {
    alert("Î£Ï†Î¬Î»Î¼Î± Î¼Î¹ÎºÏÎ¿Ï†ÏÎ½Î¿Ï…: " + event.error);
  };

  recognition.onend = function() {
    const f = document.getElementById("voiceFeedback");
    if (f) f.remove();
  };

  recognition.start();
}


// ---- Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·/restore chat Î¹ÏƒÏ„Î¿ÏÎ¹ÎºÎ¿Ï ÎºÎ±Î¹ controls ----
function saveChatHistory() {
  localStorage.setItem('chatHistory', document.getElementById('chatbox').innerHTML);
}
function restoreChatHistory() {
  let hist = localStorage.getItem('chatHistory');
  if (hist) {
    document.getElementById('chatbox').innerHTML = hist;
    document.getElementById('chatbox').scrollTop = document.getElementById('chatbox').scrollHeight;
  }
}
function clearChatHistory() {
  localStorage.removeItem('chatHistory');
  document.getElementById('chatbox').innerHTML = '';
}
function setChatControls(html) {
  document.getElementById('ai-chat-controls').innerHTML = html;
  localStorage.setItem('chatControls', html);
}
function clearChatControls() {
  document.getElementById('ai-chat-controls').innerHTML = "";
  localStorage.removeItem('chatControls');
}
function restoreChatControls() {
  let controls = localStorage.getItem('chatControls');
  if (controls) document.getElementById('ai-chat-controls').innerHTML = controls;
}

// ---- Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· Î³ÏÎ±Î¼Î¼Î®Ï‚ chat ----
function addChatLine(who, text) {
  let chatbox = document.getElementById('chatbox');
  let whoClass = '';
  if (who === 'assistant') {
    whoClass = 'chat-assistant';
  } else if (who === 'user') {
    whoClass = 'chat-user';
  }
  let line = '';
  if (who === 'controls') {
    line = text;
  } else {
    let icon = '';
    if (who === 'assistant') {
      icon = "ğŸ‘©â€ğŸ³";
    } else if (who === 'user') {
      icon = "ğŸ™‹â€â™‚ï¸";
    }
    line = '<div class="chat-line"><span class="' + whoClass + '">' + icon + '</span> ' + text + '</div>';
  }
  chatbox.insertAdjacentHTML('beforeend', line);
  chatbox.scrollTop = chatbox.scrollHeight;
  saveChatHistory();
}

// ----------- Main ÎºÎ¿Ï…Î¼Ï€Î¹Î¬ ----------- //
function showMainChoices() {
  if (document.querySelector('#chatbox #choicesRow')) return;
  let html = '<div class="d-flex justify-content-center gap-2 my-3" id="choicesRow">' +
    '<button class="btn btn-outline-primary" onclick="replyAndHideBtns(\'ÎŒ,Ï„Î¹ Î­Ï‡ÎµÎ¹ Ï„Î¿ Ï€ÏÏŒÎ³ÏÎ±Î¼Î¼Î±\', \'\', false, \'program\')">ğŸ“‹ ÎŒ,Ï„Î¹ Î­Ï‡ÎµÎ¹ Ï„Î¿ Ï€ÏÏŒÎ³ÏÎ±Î¼Î¼Î±</button>' +
    '<button class="btn btn-outline-success" onclick="replyAndHideBtns(\'Î”ÏÏƒÎµ ÎºÎ±Î¼Î¹Î¬ Î¹Î´Î­Î±!\', \'\', false, \'ai\')">ğŸ’¡ Î”ÏÏƒÎµ ÎºÎ±Î¼Î¹Î¬ Î¹Î´Î­Î±!</button>' +
    '<button class="btn btn-outline-warning" onclick="replyAndHideBtns(\'Î˜Î­Î»Ï‰ Î½Î± Î¼Î±Î³ÎµÎ¹ÏÎ­ÏˆÏ‰ Î³Î¹Î± Î±ÏÏÎ¹Î¿\', \'\', false, \'tomorrow\')">Î˜Î­Î»Ï‰ Î½Î± Î¼Î±Î³ÎµÎ¹ÏÎ­ÏˆÏ‰ Î³Î¹Î± Î±ÏÏÎ¹Î¿</button>' +
    '</div>';
  addChatLine('controls', html);
}

// Restart chat
function restartChat() {
  if (!confirm("Î˜Î­Î»ÎµÎ¹Ï‚ Î½Î± Î´Î¹Î±Î³ÏÎ¬ÏˆÎµÎ¹Ï‚ Ï„Î¿ Î¹ÏƒÏ„Î¿ÏÎ¹ÎºÏŒ ÏƒÏ…Î½Î¿Î¼Î¹Î»Î¯Î±Ï‚;")) return;
  clearChatHistory();
  clearChatControls();
  document.getElementById('chatbox').innerHTML = '<div class="chat-line"><span class="chat-assistant">ğŸ‘©â€ğŸ³ Family Food:</span> {{ day_name }} ÏƒÎ®Î¼ÎµÏÎ±, Ï„Î¹ Î¸Î± Î¼Î±Î³ÎµÎ¹ÏÎ­ÏˆÎ¿Ï…Î¼Îµ;</div>';
  saveChatHistory();
  showMainChoices();
}

function showActionsAfterMenu(menuId, menuTitle) {
  let html = '<div class="d-flex justify-content-center gap-2 my-3" id="afterMenuBtns">' +
    '<button class="btn btn-success" onclick="replyAndHideBtns(\'Î¤Î¿ Î¼Î±Î³ÎµÎ¹ÏÎµÏÏ‰\', \'\', false, \'cook_' + menuId + '_' + escapeHtml(menuTitle) + '\')">Î¤Î¿ Î¼Î±Î³ÎµÎ¹ÏÎµÏÏ‰</button>' +
    '<button class="btn btn-info" onclick="replyAndHideBtns(\'Î¤Î¿ Ï€Î±ÏÎ±Î³Î³Î­Î»Î½Ï‰!\', \'ÎˆÎ³Î¹Î½Îµ! Î˜Î± Î²ÏÎ¿ÏÎ¼Îµ Î´Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î¿ delivery ÏƒÎµ ÎµÏ€ÏŒÎ¼ÎµÎ½Î¿ Î²Î®Î¼Î±.\')">Î¤Î¿ Ï€Î±ÏÎ±Î³Î³Î­Î»Î½Ï‰</button>' +
    '<button class="btn btn-secondary" onclick="replyAndHideBtns(\'Î”ÎµÎ¯Î¾Îµ Î¼Î¿Ï… ÎºÎ¬Ï„Î¹ Î¬Î»Î»Î¿\', \'\', true)">Î”ÎµÎ¯Î¾Îµ Î¼Î¿Ï… ÎºÎ¬Ï„Î¹ Î¬Î»Î»Î¿</button>' +
    '</div>';
  addChatLine('controls', html);
}

// Î‘Î½Ï„Î¹ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ· ÎºÎ¿Ï…Î¼Ï€Î¹ÏÎ½ ÎºÏ„Î»
function replyAndHideBtns(userText, botText, isAI, nextAction) {
  clearChatControls();
  let btns = document.getElementById('afterMenuBtns');
  if (btns) btns.remove();
  let mainBtns = document.getElementById('choicesRow');
  if (mainBtns) mainBtns.remove();
  addChatLine('user', userText);

  if (nextAction === 'program') {
    cookingDay = "today";
    showTodayMenu();
  } else if (nextAction === 'ai') {
    cookingDay = "today";
    startAIChat();
  } else if (nextAction === 'tomorrow') {
    cookingDay = "tomorrow";
    showTomorrow();
  } else if (nextAction && nextAction.startsWith("cook_")) {
    let params = nextAction.split('_');
    recordCookedDish(params[1], params[2]);
  } else if (isAI) {
    startAIChat();
  } else if (botText) {
    setTimeout(() => addChatLine('assistant', botText), 500);
  }
}

function showTodayMenu() {
  // Î¥Ï€Î¿Î»ÏŒÎ³Î¹ÏƒÎµ Ï„Î¯Ï„Î»Î¿ ÎºÎ±Î¹ Ï‡ÏÏŒÎ½Î¿ Î±Ï€ÏŒ todayMenu (Î±Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹)
  var dishTitle = todayMenu;
  var dishTime = '';
  var m = todayMenu.match(/^(.*?)\s*[â€“-]\s*Ï‡ÏÏŒÎ½Î¿Ï‚(?:\s*Î¼Î±Î³ÎµÎ¹ÏÎ­Î¼Î±Ï„Î¿Ï‚)?[: ]*([\d]+)â€²/i);
  if (m) {
    dishTitle = m[1].trim();
    dishTime = m[2].trim();
  }
  var msg = 'Î£Î®Î¼ÎµÏÎ± Ï„Î¿ Ï€ÏÏŒÎ³ÏÎ±Î¼Î¼Î± Î­Ï‡ÎµÎ¹: <b>' + dishTitle + '</b>';
  if (dishTime) msg += ' (Ï‡ÏÏŒÎ½Î¿Ï‚: ' + dishTime + 'â€²)';
  msg +=
    '<div class="mt-2 mb-2">' +
      '<button class="btn btn-info btn-sm me-2" onclick="showIngredientsFromId(' + todayMenuId + ')">Î”ÎµÏ‚ Ï„Î± Ï…Î»Î¹ÎºÎ¬</button>' +
      '<button class="btn btn-primary btn-sm" onclick="showRecipeUrl(' + todayMenuId + ')">Î”ÎµÏ‚ Ï„Î· ÏƒÏ…Î½Ï„Î±Î³Î®</button>' +
    '</div>' +
    '<div class="mb-2 mt-2">Î¤Î¹ Î¸Î± Î®Î¸ÎµÎ»ÎµÏ‚ Î½Î± ÎºÎ¬Î½ÎµÎ¹Ï‚;</div>';
  addChatLine('assistant', msg);
  showActionsAfterMenu(todayMenuId, dishTitle);
}

function showTomorrow() {
  // Î¥Ï€Î¿Î»ÏŒÎ³Î¹ÏƒÎµ Ï„Î¯Ï„Î»Î¿ ÎºÎ±Î¹ Ï‡ÏÏŒÎ½Î¿ Î±Ï€ÏŒ tomorrowMenu (Î±Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹)
  var dishTitle = tomorrowMenu;
  var dishTime = '';
  var m = tomorrowMenu.match(/^(.*?)\s*[â€“-]\s*Ï‡ÏÏŒÎ½Î¿Ï‚(?:\s*Î¼Î±Î³ÎµÎ¹ÏÎ­Î¼Î±Ï„Î¿Ï‚)?[: ]*([\d]+)â€²/i);
  if (m) {
    dishTitle = m[1].trim();
    dishTime = m[2].trim();
  }
  var msg = 'Î‘ÏÏÎ¹Î¿ Ï„Î¿ Ï€ÏÏŒÎ³ÏÎ±Î¼Î¼Î± Î­Ï‡ÎµÎ¹: <b>' + dishTitle + '</b>';
  if (dishTime) msg += ' (Ï‡ÏÏŒÎ½Î¿Ï‚: ' + dishTime + 'â€²)';
  msg +=
    '<div class="mt-2 mb-2">' +
      '<button class="btn btn-info btn-sm me-2" onclick="showIngredientsFromId(' + tomorrowMenuId + ')">Î”ÎµÏ‚ Ï„Î± Ï…Î»Î¹ÎºÎ¬</button>' +
      '<button class="btn btn-primary btn-sm" onclick="showRecipeUrl(' + tomorrowMenuId + ')">Î”ÎµÏ‚ Ï„Î· ÏƒÏ…Î½Ï„Î±Î³Î®</button>' +
    '</div>' +
    '<div class="mb-2 mt-2">Î¤Î¹ Î¸Î± Î®Î¸ÎµÎ»ÎµÏ‚ Î½Î± ÎºÎ¬Î½ÎµÎ¹Ï‚;</div>';
  addChatLine('assistant', msg);
  showActionsAfterMenu(tomorrowMenuId, dishTitle);
}

// ----------- AI CHAT ----------- //
let aiChatStep = 1;
let aiChatFilters = {};

function startAIChat() {
  aiChatStep = 1;
  aiChatFilters = {};
  addChatLine('assistant', 'Î Î¬Î¼Îµ Î½Î± Î²ÏÎ¿ÏÎ¼Îµ Ï„Î·Î½ Ï„Î­Î»ÎµÎ¹Î± ÏƒÏ…Î½Ï„Î±Î³Î®!');
  nextAIChatStep('');
}

function submitAIAnswer() {
  let val = '';
  if (aiChatStep === 2) val = document.getElementById('ai_time').value;
  if (aiChatStep === 3) val = document.getElementById('ai_ingredient').value;
  clearChatControls();
  nextAIChatStep(val);
}

function nextAIChatStep(userAnswer) {
  clearChatControls();
  fetch('/ai_suggest_dish', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      step: aiChatStep,
      answer: userAnswer,
      filters: aiChatFilters
    })
  })
  .then(function(r) { return r.json(); })
  .then(function(data) {
    if (data.dishes && data.dishes.length > 0) {
      var html = "<div class='mb-2'><b>AI:</b> " + data.question + "</div>";
      html += "<ul>";
      for (var i = 0; i < data.dishes.length; i++) {
        var dish = data.dishes[i];
		html += "<li><b>" + dish.title + "</b> (Ï‡ÏÏŒÎ½Î¿Ï‚: " + dish.total_time + "â€²) " +
		  "<button type='button' class='btn btn-info btn-sm me-2' " +
			"onclick=\"showIngredients('" + escapeHtml(dish.title) + "', '" + escapeHtml(dish.ingredients) + "')\">" +
			"Î”ÎµÏ‚ Ï„Î± Ï…Î»Î¹ÎºÎ¬</button> ";

		if (dish.link && dish.link.startsWith("http")) {
		  html += "<button type='button' class='btn btn-primary btn-sm' " +
			"onclick=\"window.open('" + dish.link + "', '_blank')\">" +
			"Î”ÎµÏ‚ Ï„Î· ÏƒÏ…Î½Ï„Î±Î³Î®</button>";
		} else {
		  // Î•Î½Î±Î»Î»Î±ÎºÏ„Î¹ÎºÎ¬, Î±Î½ Î´ÎµÎ½ Î­Ï‡ÎµÎ¹ url, Î¼Ï€Î¿ÏÎµÎ¯Ï‚ Î½Î± Î²Î¬Î»ÎµÎ¹Ï‚ Î­Î½Î± disabled ÎºÎ¿Ï…Î¼Ï€Î¯ Î® Î½Î± Î´ÎµÎ¯Î¾ÎµÎ¹Ï‚ Ï„Î¿ modal!
		  html += "<button type='button' class='btn btn-sm btn-outline-primary ms-1' " +
			"onclick=\"showRecipeUrl('" + dish.id + "')\">" +
			"Î”ÎµÏ‚ Ï„Î· ÏƒÏ…Î½Ï„Î±Î³Î®</button>";
		}
		html += "</li>";
      }
      html += "</ul>";
      addChatLine('assistant', html);
    } else {
      addChatLine('assistant', data.question.replace(/\n/g, "<br>"));
    }

    if (data.step === 2) {
      var html2 = '<label>Î›ÎµÏ€Ï„Î¬: <input id="ai_time" type="number" min="10" max="180" step="5" value="60" class="form-control d-inline" style="width:100px"></label>' +
        '<button onclick="submitAIAnswer()" class="btn btn-primary ms-2">OK</button>';
      setChatControls(html2);
    }
	else if (data.step === 3) {
	  var html3 = `
		<label>Î¥Î»Î¹ÎºÏŒ Ï€ÏÎ¿Ï„Î¯Î¼Î·ÏƒÎ·Ï‚:</label>
		<div class="d-flex align-items-center gap-2">
		  <input id="ai_ingredient" type="text" placeholder="Ï€.Ï‡. ÎºÎ¿Ï„ÏŒÏ€Î¿Ï…Î»Î¿" class="form-control d-inline" style="width:150px">
		  <button onclick="startSpeechRecognition()" class="btn btn-secondary">ğŸ¤</button>
		  <button onclick="submitAIAnswer()" class="btn btn-primary">OK</button>
		</div>
	  `;
	  setChatControls(html3);
	}
    else if (data.step === 0) {
      var html0 = "";
      if (data.dishes && data.dishes.length > 0) {
        for (var i = 0; i < data.dishes.length; i++) {
          var dish2 = data.dishes[i];
          html0 += '<button class="btn btn-success me-2 mb-2" ' +
            'onclick="recordCookedDish(\'' + dish2.id + '\', \'' + escapeHtml(dish2.title) + '\')">' +
            'ÎœÎ±Î³ÎµÎ¹ÏÎµÏÏ‰ ' + escapeHtml(dish2.title) +
            '</button>';
        }
        html0 += '<button class="btn btn-info mb-2" ' +
          'onclick="addChatLine(\'user\',\'Î˜Î± Ï€Î±ÏÎ±Î³Î³ÎµÎ¯Î»Ï‰!\'); addChatLine(\'assistant\',\'ÎˆÎ³Î¹Î½Îµ! Î˜Î± Î²ÏÎ¿ÏÎ¼Îµ Î´Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î¿ delivery ÏƒÎµ ÎµÏ€ÏŒÎ¼ÎµÎ½Î¿ Î²Î®Î¼Î±.\')">' +
          'Î˜Î± Ï€Î±ÏÎ±Î³Î³ÎµÎ¯Î»Ï‰' +
          '</button>';
        html0 += '<button class="btn btn-secondary ms-2 mb-2" onclick="startAIChat()">Î”ÏÏƒÎµ Î¼Î¿Ï… ÎºÎ¬Ï€Î¿Î¹Î± Î¬Î»Î»Î· Î¹Î´Î­Î±</button>';
        setChatControls(html0);
      } else {
        html0 = '<button class="btn btn-secondary" onclick="startAIChat()">Î”ÏÏƒÎµ Î¼Î¿Ï… ÎºÎ¬Ï€Î¿Î¹Î± Î¬Î»Î»Î· Î¹Î´Î­Î±</button>';
        setChatControls(html0);
      }
    }
    aiChatStep = data.step;
    aiChatFilters = data.filters || {};
  });
}

function updateCookedDish(recipe_id, title, date) {
  fetch('/update_cooked_dish', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ recipe_id: recipe_id, title: title, date: date })
  })
  .then(r => r.json())
  .then(data => {
    if (data.success) {
      addChatLine('user', 'ÎÎ±Î¹, Î¸Î­Î»Ï‰ Î½Î± Ï„Î¿ Î±Î»Î»Î¬Î¾Ï‰');
      addChatLine('assistant', 'Î¤Î¿ Ï€Î¹Î¬Ï„Î¿ ÎµÎ½Î·Î¼ÎµÏÏÎ¸Î·ÎºÎµ ÎµÏ€Î¹Ï„Ï…Ï‡ÏÏ‚! ğŸ²');
      // Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· ÎµÏ€Î¹Ï€Î»Î­Î¿Î½ Î¼Î·Î½ÏÎ¼Î±Ï„Î¿Ï‚:
      if (cookingDay === "today") {
        addChatLine('assistant', 'Î£Î®Î¼ÎµÏÎ± Î¸Î± Ï†Î¬Î¼Îµ <b>' + title + '</b>.');
      } else {
        addChatLine('assistant', 'Î‘ÏÏÎ¹Î¿ Î¸Î± Ï†Î¬Î¼Îµ <b>' + title + '</b>.');
      }
      clearChatControls();
    } else {
      addChatLine('assistant', 'Î ÏÎ¿Î­ÎºÏ…ÏˆÎµ Ï€ÏÏŒÎ²Î»Î·Î¼Î±! Î”Î¿ÎºÎ¯Î¼Î±ÏƒÎµ Î¾Î±Î½Î¬.');
    }
  });
}

// ---- Show ÏƒÏ…Î½Ï„Î±Î³Î®/URL Î® custom modal ----
function showRecipeUrl(recipe_id) {
  fetch('/get_recipe/' + recipe_id)
    .then(r => r.json())
    .then(data => {
      if (data.url && data.url.trim() && data.url.startsWith("http")) {
        window.open(data.url, '_blank');
      } else {
        // Î‘Î½ Î´ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ url, ÎµÎ¼Ï†Î¬Î½Î¹ÏƒÎµ modal Î¼Îµ Ï„Î¯Ï„Î»Î¿, Ï…Î»Î¹ÎºÎ¬ ÎºÎ±Î¹ Î¿Î´Î·Î³Î¯ÎµÏ‚
        let html = "<h5>" + (data.title || "Î£Ï…Î½Ï„Î±Î³Î®") + "</h5>";
        html += "<strong>Î¥Î»Î¹ÎºÎ¬:</strong><br><div style='white-space: pre-wrap;'>" + (data.ingredients || "-") + "</div><hr>";
        html += "<strong>ÎŸÎ´Î·Î³Î¯ÎµÏ‚:</strong><br><div style='white-space: pre-wrap;'>" + (data.instructions || "-") + "</div>";
        document.getElementById('modalRecipeBody').innerHTML = html;
        var modal = new bootstrap.Modal(document.getElementById('viewRecipeModal'));
        modal.show();
      }
    });
}

// ---- Î›Î¿Î¹Ï€Î¬ helpers ---- //
function refuseChange(old_title) {
  addChatLine('user', `ÎŒÏ‡Î¹, Î¸Î± Ï€Î±ÏÎ±Î¼ÎµÎ¯Î½Ï‰ ÏƒÏ„Î¿ ${old_title}`);
  let btnDiv = document.getElementById('replaceBtns');
  if (btnDiv) btnDiv.remove();
  clearChatControls();
}

function showIngredientsFromId(recipe_id) {
  fetch(`/get_recipe/${recipe_id}`)
    .then(r => r.json())
    .then(data => {
      showIngredients(data.title, data.ingredients);
    });
}

// ---- Modal Î¼Îµ Ï…Î»Î¹ÎºÎ¬ ---- //
let lastIngredients = [];

function showIngredients(title, ingredients) {
  document.getElementById('modalRecipeTitle').innerText = "Î¥Î»Î¹ÎºÎ¬ Î³Î¹Î± " + title;
  let items = ingredients.split(',').map(function(i) { return i.trim(); });
  lastIngredients = items;
  let html = "<ul style='list-style:none;padding:0;'>";
  for (let idx = 0; idx < items.length; idx++) {
    let item = items[idx];
    html += "<li>" +
              "<input type='checkbox' id='ing" + idx + "' value='" + item + "'>" +
              "<label for='ing" + idx + "'>" + item + "</label>" +
            "</li>";
  }
  html += "</ul>";
  document.getElementById('modalIngredients').innerHTML = html;
  var modal = new bootstrap.Modal(document.getElementById('ingredientsModal'));
  modal.show();
}

function saveMissingIngredients() {
  let missing = [];
  lastIngredients.forEach((item, idx) => {
    let cb = document.getElementById('ing'+idx);
    if (cb && !cb.checked) missing.push(item);
  });
  fetch('/save_missing_ingredients', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({missing: missing})
  }).then(r=>r.json()).then(data=>{
    var modal = bootstrap.Modal.getInstance(document.getElementById('ingredientsModal'));
    modal.hide();
    if(missing.length) alert('Î‘Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎ±Î½: Î»ÎµÎ¯Ï€Î¿Ï…Î½ Ï„Î± Ï…Î»Î¹ÎºÎ¬: '+missing.join(', '));
  });
}

// ---- ÎšÎŸÎ¥ÎœÎ Î™: ÎœÎ±Î³ÎµÎ¹ÏÎµÏÏ‰ ---- //
function recordCookedDish(recipe_id, title) {
  var date;
  if (cookingDay === "today") {
    var now = new Date();
    date = now.getFullYear() + "-" +
           String(now.getMonth()+1).padStart(2,'0') + "-" +
           String(now.getDate()).padStart(2,'0');
  } else {
    var d = new Date();
    d.setDate(d.getDate() + 1);
    date = d.getFullYear() + "-" +
           String(d.getMonth()+1).padStart(2,'0') + "-" +
           String(d.getDate()).padStart(2,'0');
  }
  fetch('/cook_dish', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ recipe_id: String(recipe_id), title: title, date: date })
  })
  .then(function(r) { return r.json(); })
  .then(function(data) {
    clearChatControls();
    var controls = document.getElementById('ai-chat-controls');
    if (data.exists) {
      if (data.already) {
        addChatLine('assistant', 'Î¤Î¿ Ï€Î¹Î¬Ï„Î¿ <b>' + title + '</b> ÎµÎ¯Î½Î±Î¹ Î®Î´Î· ÎºÎ±Ï„Î±Ï‡Ï‰ÏÎ·Î¼Î­Î½Î¿ Î³Î¹Î± Î±Ï…Ï„Î® Ï„Î· Î¼Î­ÏÎ±!');
        var html = '<button class="btn btn-info btn-sm me-2" onclick="showIngredientsFromId(\'' + recipe_id + '\')">Î”ÎµÏ‚ Ï„Î± Ï…Î»Î¹ÎºÎ¬</button>' +
                   '<button class="btn btn-primary btn-sm" onclick="showRecipeUrl(\'' + recipe_id + '\')">Î”ÎµÏ‚ Ï„Î· ÏƒÏ…Î½Ï„Î±Î³Î®</button>';
        setChatControls(html);
      } else {
        addChatLine('assistant', 'Î¥Ï€Î¬ÏÏ‡ÎµÎ¹ Î®Î´Î· ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Î¿ Ï€Î¹Î¬Ï„Î¿ Î³Î¹Î± Î±Ï…Ï„Î® Ï„Î· Î¼Î­ÏÎ±: <b>' + data.old_title + '</b>. Î˜Î­Î»ÎµÎ¹Ï‚ Î½Î± Ï„Î¿ Î±Î»Î»Î¬Î¾ÎµÎ¹Ï‚;');
        var html2 = '<div id="replaceBtns">' +
          '<button class="btn btn-danger me-2" onclick="updateCookedDish(\'' + recipe_id + '\', \'' + escapeHtml(title) + '\', \'' + date + '\')">ÎÎ±Î¹, Î¸Î­Î»Ï‰ Î½Î± Ï„Î¿ Î±Î»Î»Î¬Î¾Ï‰</button>' +
          '<button class="btn btn-secondary" onclick="refuseChange(\'' + escapeHtml(data.old_title) + '\')">ÎŒÏ‡Î¹, Î¸Î± Ï€Î±ÏÎ±Î¼ÎµÎ¯Î½Ï‰ ÏƒÏ„Î¿ ' + escapeHtml(data.old_title) + '</button>' +
        '</div>';
        setChatControls(html2);
      }
    } else {
      addChatLine('assistant', 'ÎœÎ±Î³ÎµÎ¹ÏÎµÏÏ‰: ' + title);
      var html3 = '<button class="btn btn-info btn-sm me-2" onclick="showIngredientsFromId(\'' + recipe_id + '\')">Î”ÎµÏ‚ Ï„Î± Ï…Î»Î¹ÎºÎ¬</button>';
      setChatControls(html3);
      addChatLine('assistant', 'ÎšÎ±Î»Î® ÏŒÏÎµÎ¾Î·! ğŸ˜‹');
    }
  });
}

function escapeHtml(text) {
  return text
    .replace(/&/g, "&amp;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;");
}

// --- Î†Î»Î»ÎµÏ‚ ÎµÎºÎºÎ¹Î½Î®ÏƒÎµÎ¹Ï‚ Î¼ÎµÏ„Î¬ Ï„Î¿ DOM ---
window.onload = function() {
  restoreChatHistory();
  restoreChatControls();
};

window.addEventListener('DOMContentLoaded', function() {
  restoreChatHistory();
  restoreChatControls();
  if (!document.getElementById('choicesRow') && !localStorage.getItem('chatHistory')) {
    showMainChoices();
  }
});



function getNextOnboardingStep() {
  if (localStorage.getItem("onboarding_done") === "1") return null;

  for (let i = 1; i <= 5; i++) {
    if (!localStorage.getItem(`onboarding_step${i}_shown`)) {
      return i;
    }
  }
  return null;
}

window.addEventListener("DOMContentLoaded", function () {
  const step = getNextOnboardingStep();

  if (step === 1 && window.location.pathname === "/welcome") {
    document.body.classList.add("onboarding-active");
    document.getElementById("onboardingOverlay").style.display = "block";

    const profileLink = document.querySelector('nav.navbar.fixed-bottom a[href="/profile"]');
    if (profileLink) {
      profileLink.addEventListener("click", function (e) {
        e.preventDefault();
        localStorage.setItem("onboarding_step1_shown", "1");
        document.body.classList.remove("onboarding-active");
        document.getElementById("onboardingOverlay").style.display = "none";
        window.location.href = "/profile";
      });
    }
  }
});


</script>
{% endblock %}