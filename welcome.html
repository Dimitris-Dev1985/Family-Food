{% extends "base.html" %}
{% block title %}ÎšÎ±Î»Ï‰ÏƒÏŒÏÎ¹ÏƒÎ¼Î±{% endblock %}
{% block content %}

<style>
  body { background: linear-gradient(to bottom right, #fff, #ddd8d8); }
</style>

<style>

/* Backdrop ÎœÎŸÎÎŸ ÏƒÏ„Î· navbar (fixed-bottom) */
#onboardingNavBackdrop {
  position: fixed;
  left: 0;
  right: 0;
  bottom: 0;
  height: 65px;  /* Ï€ÏÎ¿ÏƒÎ±ÏÎ¼ÏŒÎ¶ÎµÎ¹Ï‚ ÏŒÏƒÎ¿ ÏˆÎ·Î»Î® ÎµÎ¯Î½Î±Î¹ Î· nav-bar ÏƒÎ¿Ï… */
  background: rgba(0,0,0,0.47);
  z-index: 999;
  pointer-events: none; /* Î­Ï„ÏƒÎ¹ Î´ÎµÎ½ Î¼Ï€Î»Î¿ÎºÎ¬ÏÎµÎ¹ Ï„Î± ÎºÎ¿Ï…Î¼Ï€Î¹Î¬, Î±Î»Î»Î¬ Î¸Î± Ï„Î¿ Î±Î»Î»Î¬Î¾Î¿Ï…Î¼Îµ Ï€Î±ÏÎ±ÎºÎ¬Ï„Ï‰ Î³Î¹Î± Ï„Î± nav-link */
}

/* Tooltip styling */
#onboardingTooltip {
  font-family: 'Indie Flower', cursive, Arial, sans-serif;
  position: fixed;
  bottom: 80px;
  right: 18px;
  background: #fbc6d7;
  padding: 12px 15px 13px 15px;
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.24);
  z-index: 1001;
  max-width: 230px;
  font-size: 15px;
  text-align: center;
  animation: pulse 1.5s infinite;
}
#onboardingTooltip .arrow-down {
  content: "";
  display: block;
  position: absolute;
  bottom: -7px;
  right: 16px;
  width: 15px;
  height: 15px;
  background: #fbc6d7;
  transform: rotate(45deg);
  border-bottom: 1px solid rgba(0,0,0,0.09);
  border-right: 1px solid rgba(0,0,0,0.09);
  box-shadow: 1px 1px 3px rgba(0,0,0,0.08);
  z-index: 0;
}

/* Î‘Ï€ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¹ÎµÎ¯ nav-bar ÎºÎ¿Ï…Î¼Ï€Î¹Î¬, ÎµÎºÏ„ÏŒÏ‚ Î±Ï€ÏŒ Ï„Î¿ Ï€ÏÎ¿Ï†Î¯Î» */
body.onboarding-active nav.navbar.fixed-bottom a.nav-link {
  pointer-events: none;
  opacity: 0.34;
  filter: grayscale(0.6);
}
body.onboarding-active nav.navbar.fixed-bottom a[href="/profile"] {
  pointer-events: auto;
  opacity: 1;
  filter: none;
}
</style>

<style>
/* ÎšÏÎ±Ï„Î¬Î¼Îµ Ï„Î¿ Ï…Ï€Î¬ÏÏ‡Î¿Î½ ÏƒÏ„Ï…Î» chatbox, Î±Î»Î»Î¬ Ï„Î¿ ÎºÎ¬Î½Î¿Ï…Î¼Îµ Ï€Î¹Î¿ â€œÎµÎ»Î±Ï†ÏÏâ€ */
.chatbox {
  background: #fffdfa;
  border: 1px solid #ffe6b5;
  flex: 1 1 auto;
  display: flex;
  flex-direction: column;
  min-height: 0;
  max-height: calc(100vh - 130px);
  padding: 15px 12px;
  font-size: 0.95rem;
  line-height: 1.5;
  overflow-y: auto;
  box-shadow: 0 2px 12px rgba(254, 148, 65, 0.07);
  border-radius: 15px;
  font-family: 'Quicksand', Arial, sans-serif;
}
.chat-line {
  text-align: justify;
  margin-top: 0.5rem;
  margin-bottom: 0.5rem;
}
.chat-assistant { color: #fe9441; font-weight: 700; }
.chat-user { color: #2078b6; font-weight: 600; }


</style>

<style>
.main-welcome-container {
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}

.welcome-hero {
  background: linear-gradient(135deg, #ffffff  0%, #cdffd8 80%);
  border-radius: 2.5rem;
  box-shadow: 0 8px 40px rgba(222, 174, 120, 0.15);
  margin: 10px auto 32px auto;
  max-width: 520px;
  padding: 48px 26px 36px 26px;
  position: relative;
}
.welcome-hero img {
  width: 80px;
  margin-bottom: 18px;
}
.welcome-hero h1 {
  font-family: 'Montserrat', 'Arial', sans-serif;
  font-weight: 700;
  font-size: 2.2rem;
  color: #2078b6;
}
.welcome-hero .lead {
  font-family: 'Quicksand', 'Arial', sans-serif;
  color: #7d5623;
  font-size: 1.18rem;
  font-weight: 400;
  margin-bottom: 30px;
}
.welcome-actions .btn {
  min-width: 180px;
  font-size: 1.12em;
  border-radius: 2rem !important;
  padding: 0.75em 2em;
  margin-right: 12px;
  margin-left: 12px;
  box-shadow: 0 2px 12px rgba(32,120,182,0.09);
  transition: transform 0.11s;
}
.welcome-actions .btn-primary {
  background: linear-gradient(90deg, #fe9441 0%, #ffe15f 90%);
  position: sticky;
  color: #444;
  border: none;
  font-weight: 700;
}
.welcome-actions .btn-primary:hover {
  background: linear-gradient(90deg, #ffc375 0%, #ffe080 90%);
  transform: scale(1.03);
}
.welcome-actions .btn-outline-secondary {
  border: 2px solid #ffd28c;
  color: #b1762c;
  background: #fff9f1;
  font-weight: 500;
}
.welcome-actions .btn-outline-secondary:hover {
  background: #fff3e0;
  border-color: #ffd28c;
  transform: scale(1.03);
}
@media (max-width: 600px) {
  .welcome-hero { padding: 18px 4vw 18px 4vw; max-width: 98vw; }
  .welcome-hero h1 { font-size: 1.3rem; }
  .welcome-actions .btn { min-width: 90px; padding: 0.67em 0.7em; font-size: 1em;}
}

#chatRestartOnScroll {
  transition: opacity 0.3s ease;
  position: absolute;
  z-index: 1010;
  text-align: center;
}

#chatRestartOnScroll button {
  background: linear-gradient(90deg, #fe9441 0%, #ffe15f 90%);
  color: #444;
  padding: 0.3rem 0.5rem;
  border-radius: 12px;
  border: none;
  font-weight: 700;
}


</style>

<div class="welcome-hero text-center">
  <img src="{{ url_for('static', filename='image.png') }}" alt="Family Food" />
  <h1>ğŸ‘‹ ÎšÎ±Î»Ï‰ÏƒÎ®ÏÎ¸ÎµÏ‚, <span style="color:#2078b6;">{{ user_name or ''}}</span>!</h1>
  <p class="lead" id="welcomeLead">
	Î•Î´Ï, Ï„Î¿ <b>â€œÎ¤Î¹ Î¸Î± Ï†Î¬Î¼Îµ ÏƒÎ®Î¼ÎµÏÎ±;â€</b> Î²ÏÎ¯ÏƒÎºÎµÎ¹ Ï€Î¬Î½Ï„Î± Î±Ï€Î¬Î½Ï„Î·ÏƒÎ·!<br><br>ÎˆÏ„Î¿Î¹Î¼Î¿Î¹ Î½Î± Ï†Ï„Î¹Î¬Î¾Î¿Ï…Î¼Îµ Ï…Ï€Î­ÏÎ¿Ï‡ÎµÏ‚ Î¿Î¹ÎºÎ¿Î³ÎµÎ½ÎµÎ¹Î±ÎºÎ­Ï‚ ÏƒÏ„Î¹Î³Î¼Î­Ï‚; ğŸ½ï¸</p>
  <div class="welcome-actions d-flex flex-wrap justify-content-center">
    <button id="startChatBtn" class="btn btn-primary" onclick="showChatbox()">ÎÎµÎºÎ¯Î½Î± Chat</button>
  </div>
</div>


<div id="onboardingNavBackdrop" style="display:none;"></div>

<div id="onboardingTooltip" style="display:none;">
  ğŸ‘‰ Î£Ï…Î¼Ï€Î»Î®ÏÏ‰ÏƒÎµ Ï„Î¿ Ï€ÏÎ¿Ï†Î¯Î» ÏƒÎ¿Ï… Î³Î¹Î± Î½Î± Î¾ÎµÎºÎ¹Î½Î®ÏƒÎµÎ¹Ï‚!
  <div class="arrow-down"></div>
</div>

<div id="chatbox-section" style="display:none; margin:0 auto; position: relative;">
  <div class="chatbox rounded shadow-sm mb-3" id="chatbox">
  
    <div class="chat-line">
      <span class="chat-assistant">ğŸ‘©â€ğŸ³ Family Food:</span> {{ day_name }} ÏƒÎ®Î¼ÎµÏÎ±, Ï„Î¹ Î¸Î± Ï†Î¬Î¼Îµ;
    </div>
  </div>
  
  <div id="ai-chat-controls"></div>
  
</div>

{% endblock %}


{% block scripts %}

<script>

let todayMenu = "{{ today_menu|safe }}";
let todayMenuId = "{{ today_menu_id }}";
let tomorrowMenu = "{{ tomorrow_menu|safe }}";
let tomorrowMenuId = "{{ tomorrow_menu_id }}";
let cookingDay = "today"; // default: ÏƒÎ®Î¼ÎµÏÎ±
let aiChatFilters = {};
let allRecipesData = null;

function startSpeechRecognition() {
  if (!('webkitSpeechRecognition' in window)) {
    alert("ÎŸ browser ÏƒÎ¿Ï… Î´ÎµÎ½ Ï…Ï€Î¿ÏƒÏ„Î·ÏÎ¯Î¶ÎµÎ¹ Ï†Ï‰Î½Î·Ï„Î¹ÎºÎ® Î±Î½Î±Î³Î½ÏÏÎ¹ÏƒÎ·.");
    return;
  }

  const recognition = new webkitSpeechRecognition();
  recognition.lang = 'el-GR';
  recognition.continuous = false;
  recognition.interimResults = false;

  const feedbackSpan = document.createElement('span');
  feedbackSpan.id = "voiceFeedback";
  feedbackSpan.textContent = "ğŸ™ï¸ Î‘ÎºÎ¿ÏÏ‰...";
  feedbackSpan.style.marginLeft = "10px";
  feedbackSpan.style.fontWeight = "bold";
  feedbackSpan.style.color = "#c00";

  const parentDiv = document.querySelector('#ai_ingredient')?.parentNode;
  if (parentDiv && !document.getElementById("voiceFeedback")) {
    parentDiv.appendChild(feedbackSpan);
  }

  recognition.onresult = function(event) {
    const transcript = event.results[0][0].transcript.trim();
    document.getElementById('ai_ingredient').value = transcript;
  };

  recognition.onerror = function(event) {
    alert("Î£Ï†Î¬Î»Î¼Î± Î¼Î¹ÎºÏÎ¿Ï†ÏÎ½Î¿Ï…: " + event.error);
  };

  recognition.onend = function() {
    const f = document.getElementById("voiceFeedback");
    if (f) f.remove();
  };

  recognition.start();
}

// ----------- Main ÎºÎ¿Ï…Î¼Ï€Î¹Î¬ ----------- //
function showMainChoices() {
  if (document.querySelector('#chatbox #choicesRow')) return;
  let html = '<div class="d-flex justify-content-center gap-2" id="choicesRow" style="margin-top:10px">' +
    '<button class="btn btn-outline-primary btn-sm" onclick="replyAndHideBtns(\'ÎŒ,Ï„Î¹ Î­Ï‡ÎµÎ¹ Ï„Î¿ Ï€ÏÏŒÎ³ÏÎ±Î¼Î¼Î±\', \'\', false, \'program\')">ğŸ“‹ ÎŒ,Ï„Î¹ Î­Ï‡ÎµÎ¹ Ï„Î¿ Ï€ÏÏŒÎ³ÏÎ±Î¼Î¼Î±</button>' +
    '<button class="btn btn-outline-success btn-sm" onclick="replyAndHideBtns(\'Î”ÏÏƒÎµ ÎºÎ±Î¼Î¹Î¬ Î¹Î´Î­Î±!\', \'\', false, \'ai\')">ğŸ’¡ Î”ÏÏƒÎµ ÎºÎ±Î¼Î¹Î¬ Î¹Î´Î­Î±!</button>' +
    '<button class="btn btn-outline-warning btn-sm" onclick="replyAndHideBtns(\'Î˜Î­Î»Ï‰ Î½Î± Î´Ï‰ Î³Î¹Î± Î±ÏÏÎ¹Î¿\', \'\', false, \'tomorrow\')">Î˜Î­Î»Ï‰ Î½Î± Î´Ï‰ Î³Î¹Î± Î±ÏÏÎ¹Î¿</button>' +
    '</div>';
  addChatLine('controls', html);
}

function showActionsAfterMenu(menuId, menuTitle) {
  let html = '<div class="d-flex justify-content-center gap-2" id="afterMenuBtns">' +
    '<button class="btn btn-success btn-sm" onclick="replyAndHideBtns(\'Î¤Î¿ Î¼Î±Î³ÎµÎ¹ÏÎµÏÏ‰\', \'\', false, \'cook_' + menuId + '_' + escapeHtml(menuTitle) + '\')">Î¤Î¿ Î¼Î±Î³ÎµÎ¹ÏÎµÏÏ‰</button>' +
    '<button class="btn btn-info btn-sm" onclick="replyAndHideBtns(\'Î¤Î¿ Ï€Î±ÏÎ±Î³Î³Î­Î»Î½Ï‰!\', \'ÎˆÎ³Î¹Î½Îµ! Î˜Î± Î²ÏÎ¿ÏÎ¼Îµ Î´Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î¿ delivery ÏƒÎµ ÎµÏ€ÏŒÎ¼ÎµÎ½Î¿ Î²Î®Î¼Î±.\')">Î¤Î¿ Ï€Î±ÏÎ±Î³Î³Î­Î»Î½Ï‰</button>' +
    '<button class="btn btn-secondary btn-sm" onclick="replyAndHideBtns(\'Î”ÎµÎ¯Î¾Îµ Î¼Î¿Ï… ÎºÎ¬Ï„Î¹ Î¬Î»Î»Î¿\', \'\', true)">Î”ÎµÎ¯Î¾Îµ Î¼Î¿Ï… ÎºÎ¬Ï„Î¹ Î¬Î»Î»Î¿</button>' +
    '</div>';
  addChatLine('controls', html);
}

// Î‘Î½Ï„Î¹ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ· ÎºÎ¿Ï…Î¼Ï€Î¹ÏÎ½ ÎºÏ„Î»
function replyAndHideBtns(userText, botText, isAI, nextAction) {
  clearChatControls();
  let btns = document.getElementById('afterMenuBtns');
  if (btns) btns.remove();
  let mainBtns = document.getElementById('choicesRow');
  if (mainBtns) mainBtns.remove();
  addChatLine('user', userText);

  if (nextAction === 'program') {
    cookingDay = "today";
    showTodayMenu();
  } else if (nextAction === 'ai') {
    cookingDay = "today";
    startAIChat();
  } else if (nextAction === 'tomorrow') {
    cookingDay = "tomorrow";
    showTomorrow();
  } else if (nextAction && nextAction.startsWith("cook_")) {
    let params = nextAction.split('_');
    recordCookedDish(params[1], params[2]);
  } else if (isAI) {
    startAIChat();
  } else if (botText) {
    setTimeout(() => addChatLine('assistant', botText), 500);
  }
}

function showTodayMenu() {
// Î¥Ï€Î¿Î»ÏŒÎ³Î¹ÏƒÎµ Ï„Î¯Ï„Î»Î¿ ÎºÎ±Î¹ Ï‡ÏÏŒÎ½Î¿ Î±Ï€ÏŒ todayMenu (Î±Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹)
var dishTitle = todayMenu;
var dishTime = '';
var m = todayMenu.match(/^(.*?)\s*[â€“-]\s*Ï‡ÏÏŒÎ½Î¿Ï‚(?:\s*Î¼Î±Î³ÎµÎ¹ÏÎ­Î¼Î±Ï„Î¿Ï‚)?[: ]*([\d]+)â€²/i);
if (m) {
	dishTitle = m[1].trim();
	dishTime = m[2].trim();
	}
  
var msg = "<div class='mb-1'>ğŸ‘©â€ğŸ³ Î£Î®Î¼ÎµÏÎ± Ï„Î¿ Ï€ÏÏŒÎ³ÏÎ±Î¼Î¼Î± Î­Ï‡ÎµÎ¹:</div>";

msg += "<ul class='list-group mb-2'>";

msg += "<li class='list-group-item py-0 px-2 d-flex justify-content-between align-items-center'>";
msg += "<div class='me-1 text-start'>";
msg += "<div class='fw-bold'>" + dishTitle + "</div>";
if (dishTime) msg += "<small class='text-muted'>Î§ÏÏŒÎ½Î¿Ï‚: " + dishTime + "â€²</small>";
msg += "</div>";
msg += "<button class='btn btn-info btn-sm fixed-recipe-btn' onclick='showRecipeUrl(" + todayMenuId + ")'>Î”ÎµÏ‚ Ï„Î· ÏƒÏ…Î½Ï„Î±Î³Î®</button>";
msg += "</li>";

msg += "</ul>";

addChatLine('controls', msg);

msg = "<div class='chat-line'>ğŸ‘©â€ğŸ³ Î¤Î¹ Î¸Î± Î®Î¸ÎµÎ»ÎµÏ‚ Î½Î± ÎºÎ¬Î½ÎµÎ¹Ï‚;</div>";

addChatLine('controls', msg);

showActionsAfterMenu(todayMenuId, dishTitle);
}

function showTomorrow() {
  // Î¥Ï€Î¿Î»ÏŒÎ³Î¹ÏƒÎµ Ï„Î¯Ï„Î»Î¿ ÎºÎ±Î¹ Ï‡ÏÏŒÎ½Î¿ Î±Ï€ÏŒ tomorrowMenu (Î±Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹)
  var dishTitle = tomorrowMenu;
  var dishTime = '';
  var m = tomorrowMenu.match(/^(.*?)\s*[â€“-]\s*Ï‡ÏÏŒÎ½Î¿Ï‚(?:\s*Î¼Î±Î³ÎµÎ¹ÏÎ­Î¼Î±Ï„Î¿Ï‚)?[: ]*([\d]+)â€²/i);
  if (m) {
    dishTitle = m[1].trim();
    dishTime = m[2].trim();
  }
  var msg = 'Î‘ÏÏÎ¹Î¿ Ï„Î¿ Ï€ÏÏŒÎ³ÏÎ±Î¼Î¼Î± Î­Ï‡ÎµÎ¹: <b>' + dishTitle + '</b>';
  if (dishTime) msg += ' (Ï‡ÏÏŒÎ½Î¿Ï‚: ' + dishTime + 'â€²)';
  msg +=
    '<div class="mt-2 mb-2">' +
      '<button class="btn btn-info btn-sm" onclick="showRecipeUrl(' + tomorrowMenuId + ')">Î”ÎµÏ‚ Ï„Î· ÏƒÏ…Î½Ï„Î±Î³Î®</button>' +
    '</div>' +
    '<div class="mb-2 mt-2">Î¤Î¹ Î¸Î± Î®Î¸ÎµÎ»ÎµÏ‚ Î½Î± ÎºÎ¬Î½ÎµÎ¹Ï‚;</div>';
  addChatLine('assistant', msg);
  showActionsAfterMenu(tomorrowMenuId, dishTitle);
}

// ----------- AI CHAT ----------- //
let aiChatStep = 1;

function startAIChat() {
  aiChatStep = 1;
  addChatLine('assistant', 'Î Î¬Î¼Îµ Î½Î± Î²ÏÎ¿ÏÎ¼Îµ Ï„Î·Î½ Ï„Î­Î»ÎµÎ¹Î± ÏƒÏ…Î½Ï„Î±Î³Î®!');
  nextAIChatStep('');
}


function submitAIAnswer() {
  let val = '';

  if (aiChatStep === 2) {
    const inputs = document.querySelectorAll('#chatbox input[id^="ai_time_"]');
    val = inputs.length ? inputs[inputs.length - 1].value : '';
  }

  if (aiChatStep === 3) {
    const inputs = document.querySelectorAll('#chatbox input[id^="ai_ingredient_"]');
    val = inputs.length ? inputs[inputs.length - 1].value : '';
  }
  clearChatControls();
  nextAIChatStep(val);
}


function nextAIChatStep(userAnswer) {
  // ğŸ”’ Î‘Ï€ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎµ Ï„Î± ÎºÎ¿Ï…Î¼Ï€Î¹Î¬ Î¼Îµ .ai-ok-btn ÏƒÏ„Î¿ chat
  document.querySelectorAll('#chatbox .ai-ok-btn').forEach(btn => {
    btn.disabled = true;
    btn.classList.add('disabled');
  });

  clearChatControls();

  fetch('/ai_suggest_dish', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      step: aiChatStep,
      answer: userAnswer,
      filters: aiChatFilters
    })
  })
  .then(function(r) { return r.json(); })
  .then(function(data) {
    if (data.dishes && data.dishes.length > 0) {
		var html = "<div class='mb-2'>ğŸ‘©â€ğŸ³ " + data.question + "</div>";

		html += "<ul class='list-group'>";

		for (var i = 0; i < data.dishes.length; i++) {
		  var dish = data.dishes[i];
		  let heart = dish.favorite ? " â¤ï¸" : "";

		  html += "<li class='list-group-item py-0 px-2 d-flex justify-content-between align-items-center'>";
		  html += "<div class='me-1 text-start'>";
		  html += "<div class='fw-bold'>" + dish.title + heart + "</div>";
		  html += "<small class='text-muted'>Î§ÏÏŒÎ½Î¿Ï‚: " + dish.total_time + "â€²</small>";
		  html += "</div>";
		  html += "<button type='button' class='btn btn-info btn-sm fixed-recipe-btn' onclick=\"showRecipeUrl('" + dish.id + "')\">Î”ÎµÏ‚ Ï„Î· ÏƒÏ…Î½Ï„Î±Î³Î®</button>";
		  html += "</li>";
		}

		html += "</ul>";

		addChatLine('consoles', html);


    } else {
      addChatLine('assistant', data.question.replace(/\n/g, "<br>"));
    }
	
	const aiTimeId = `ai_time_${Date.now()}`;
	if (data.step === 2) {
	  var html2 = `
		  <div class="d-flex align-items-center gap-2">
			<span class="chat-assistant">ğŸ™‹â€â™‚ï¸</span>
			<label class="mb-0 me-2" for="${aiTimeId}">Î›ÎµÏ€Ï„Î¬:</label>
			<input id="${aiTimeId}" type="number" min="10" max="180" step="5" value="60"
				   class="form-control d-inline ai-ok-btn" style="width:80px; padding: 0.2rem;">
			<button onclick="submitAIAnswer()" class="btn btn-primary btn-sm ai-ok-btn">OK</button>
		  </div>
		`;
	  
	  addChatLine('controls', html2);
	
	} else if (data.step === 3) {
	  const ingredientId = `ai_ingredient_${Date.now()}`;

	  const html3 = `
		<div class="d-flex align-items-center gap-2">
		  <span class="chat-assistant">ğŸ™‹â€â™‚ï¸</span>
		  <label class="mb-0 me-2" for="${ingredientId}">Î¥Î»Î¹ÎºÏŒ Ï€ÏÎ¿Ï„Î¯Î¼Î·ÏƒÎ·Ï‚:</label>
		  <div class="position-relative" style="width: 90px;">
			<input id="${ingredientId}"
				   class="form-control d-inline ai-ok-btn"
				   autocomplete="off"
				   placeholder="Ï€.Ï‡. ÏˆÎ¬ÏÎ¹"
				   style="width: 100%;padding: 0.2rem;">
			<div id="${ingredientId}_autocomplete" class="autocomplete-list" style="display: none; position:absolute; width: max-content;"></div>
		  </div>
		  <button onclick="startSpeechRecognition()" class="btn btn-secondary btn-sm ai-ok-btn">ğŸ¤</button>
		  <button onclick="submitAIAnswer()" class="btn btn-primary btn-sm ai-ok-btn">OK</button>
		</div>
	  `;

	  addChatLine('controls', html3);

	  // â³ Î ÎµÏÎ¯Î¼ÎµÎ½Îµ Î¼Î­Ï‡ÏÎ¹ Î½Î± Ï†Î¿ÏÏ„Ï‰Î¸ÎµÎ¯ Ï„Î¿ input ÏƒÏ„Î¿ DOM
	  const waitForInputThenBind = () => {
		const input = document.getElementById(ingredientId);
		const list = document.getElementById(`${ingredientId}_autocomplete`);
		if (input && list) {
		  setupIngredientAutocomplete(allRecipesData, ingredientId);
		} else {
		  setTimeout(waitForInputThenBind, 50);
		}
	  };

	  // Î‘Î½ Î­Ï‡ÎµÎ¹Ï‚ Î®Î´Î· Ï„Î± Î´ÎµÎ´Î¿Î¼Î­Î½Î±:
	  if (allRecipesData) {
		waitForInputThenBind();
	  } else {
		fetch('/get_recipes_for_autocomplete')
		  .then(r => r.json())
		  .then(data => {
			allRecipesData = data;
			waitForInputThenBind();
		  });
	  }
	}


	



    if (data.step === 0) {
      var html0 = "";
      if (data.dishes && data.dishes.length > 0) {
        html0 += '<div class="d-flex flex-column gap-1 align-items-center">';
        for (var i = 0; i < data.dishes.length; i++) {
          var dish2 = data.dishes[i];
          html0 += '<button class="btn btn-success btn-sm py-0 px-1" style="width:fit-content"' +
            'onclick="recordCookedDish(\'' + dish2.id + '\', \'' + escapeHtml(dish2.title) + '\')">' +
            'ÎœÎ±Î³ÎµÎ¹ÏÎµÏÏ‰ ' + escapeHtml(dish2.title) +
            '</button>';
        }
        html0 += '<button class="btn btn-secondary btn-sm ai-ok-btn py-0 px-1" style="width:fit-content" onclick="startAIChat()">Î”ÏÏƒÎµ Î¼Î¿Ï… ÎºÎ¬Ï€Î¿Î¹Î± Î¬Î»Î»Î· Î¹Î´Î­Î±</button>';  
        html0 += '<button class="btn btn-warning btn-sm ai-ok-btn py-0 px-1" style="width:fit-content"' +
          'onclick="addChatLine(\'user\',\'Î˜Î± Ï€Î±ÏÎ±Î³Î³ÎµÎ¯Î»Ï‰!\'); addChatLine(\'assistant\',\'ÎˆÎ³Î¹Î½Îµ! Î˜Î± Î²ÏÎ¿ÏÎ¼Îµ Î´Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î¿ delivery ÏƒÎµ ÎµÏ€ÏŒÎ¼ÎµÎ½Î¿ Î²Î®Î¼Î±.\')">' +
          'Î˜Î± Ï€Î±ÏÎ±Î³Î³ÎµÎ¯Î»Ï‰' +
          '</button>';
        html0 += '</div>';  
        addChatLine('controls', html0);
      } else {
        html0 = '<div class="d-flex gap-2 my-2"><button class="btn btn-secondary ai-ok-btn px-1" style="width:fit-content" onclick="startAIChat()">Î”ÏÏƒÎµ Î¼Î¿Ï… ÎºÎ¬Ï€Î¿Î¹Î± Î¬Î»Î»Î· Î¹Î´Î­Î±</button></div>';
        addChatLine('controls', html0);
      }
    }

    aiChatStep = data.step;
    aiChatFilters = data.filters || {};
  });
}

function updateCookedDish(recipe_id, title, date) {
  fetch('/update_cooked_dish', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ recipe_id: recipe_id, title: title, date: date })
  })
  .then(r => r.json())
  .then(data => {
    if (data.success) {
      addChatLine('assistant', 'Î¤Î¿ Ï€Î¹Î¬Ï„Î¿ ÎµÎ½Î·Î¼ÎµÏÏÎ¸Î·ÎºÎµ ÎµÏ€Î¹Ï„Ï…Ï‡ÏÏ‚! ğŸ²');
      // Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· ÎµÏ€Î¹Ï€Î»Î­Î¿Î½ Î¼Î·Î½ÏÎ¼Î±Ï„Î¿Ï‚:
      if (cookingDay === "today") {
        addChatLine('assistant', 'Î£Î®Î¼ÎµÏÎ± Î¸Î± Ï†Î¬Î¼Îµ: <b>' + title + '</b>.');
      } else {
        addChatLine('assistant', 'Î‘ÏÏÎ¹Î¿ Î¸Î± Ï†Î¬Î¼Îµ: <b>' + title + '</b>.');
      }
      clearChatControls();
    } else {
      addChatLine('assistant', 'Î ÏÎ¿Î­ÎºÏ…ÏˆÎµ Ï€ÏÏŒÎ²Î»Î·Î¼Î±! Î”Î¿ÎºÎ¯Î¼Î±ÏƒÎµ Î¾Î±Î½Î¬.');
    }
  });
}

// ---- Show ÏƒÏ…Î½Ï„Î±Î³Î®/URL Î® custom modal ----
function showRecipeUrl(recipe_id) {
  fetch('/get_recipe/' + recipe_id)
    .then(r => r.json())
    .then(data => {
      // Î¦Ï„Î¹Î¬Î¾Îµ Ï€ÏÎ¿ÏƒÏ‰ÏÎ¹Î½ÏŒ element Ï„ÏÏ€Î¿Ï… card
      var tempCard = document.createElement('div');
      tempCard.setAttribute('data-title', data.title || '-');
      tempCard.setAttribute('data-chef', data.chef || '-');
      tempCard.setAttribute('data-method', data.method || '-');
      tempCard.setAttribute('data-category', data.category || '-');
      tempCard.setAttribute('data-tags', data.tags || '-');
      tempCard.setAttribute('data-url', data.url || '#');
      tempCard.setAttribute('data-prep', data.prep_time || '-');
      tempCard.setAttribute('data-cook', data.cook_time || '-');
      tempCard.setAttribute('data-ingredients', data.ingredients || '');
      tempCard.setAttribute('data-instructions', data.instructions || '');
      openRecipeModal(tempCard);
    });
}

// ---- Î›Î¿Î¹Ï€Î¬ helpers ---- //
function refuseChange(old_title) {
  addChatLine('user', `ÎŒÏ‡Î¹, Î¸Î± Ï€Î±ÏÎ±Î¼ÎµÎ¯Î½Ï‰ ÏƒÏ„Î¿ ${old_title}`);
  let btnDiv = document.getElementById('replaceBtns');
  if (btnDiv) btnDiv.remove();
  clearChatControls();
}

function showIngredientsFromId(recipe_id) {
  fetch(`/get_recipe/${recipe_id}`)
    .then(r => r.json())
    .then(data => {
      showIngredients(data.title, data.ingredients);
    });
}

// ---- ÎšÎŸÎ¥ÎœÎ Î™: ÎœÎ±Î³ÎµÎ¹ÏÎµÏÏ‰ ---- //
function recordCookedDish(recipe_id, title) {
  var date;
  if (cookingDay === "today") {
    var now = new Date();
    date = now.getFullYear() + "-" +
           String(now.getMonth()+1).padStart(2,'0') + "-" +
           String(now.getDate()).padStart(2,'0');
  } else {
    var d = new Date();
    d.setDate(d.getDate() + 1);
    date = d.getFullYear() + "-" +
           String(d.getMonth()+1).padStart(2,'0') + "-" +
           String(d.getDate()).padStart(2,'0');
  }
  fetch('/cook_dish', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ recipe_id: String(recipe_id), title: title, date: date })
  })
  .then(function(r) { return r.json(); })
  .then(function(data) {
    clearChatControls();
    var controls = document.getElementById('ai-chat-controls');
    if (data.exists) {
      if (data.already) {
        addChatLine('assistant', 'Î¤Î¿ Ï€Î¹Î¬Ï„Î¿ <b>' + title + '</b> ÎµÎ¯Î½Î±Î¹ Î®Î´Î· ÎºÎ±Ï„Î±Ï‡Ï‰ÏÎ·Î¼Î­Î½Î¿ Î³Î¹Î± Î±Ï…Ï„Î® Ï„Î· Î¼Î­ÏÎ±!');
        var html = '<button class="btn btn-info btn-sm" onclick="showRecipeUrl(\'' + recipe_id + '\')">Î”ÎµÏ‚ Ï„Î· ÏƒÏ…Î½Ï„Î±Î³Î®</button>';
        addChatLine('assistant', html);
      } else {
        addChatLine('assistant', 'Î¥Ï€Î¬ÏÏ‡ÎµÎ¹ Î®Î´Î· ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Î¿ Ï€Î¹Î¬Ï„Î¿ Î³Î¹Î± Î±Ï…Ï„Î® Ï„Î· Î¼Î­ÏÎ±: <b>' + data.old_title + '</b>. Î˜Î­Î»ÎµÎ¹Ï‚ Î½Î± Ï„Î¿ Î±Î»Î»Î¬Î¾ÎµÎ¹Ï‚;');
        var html2 = '<div id="replaceBtns">' +
          '<button class="btn btn-danger me-2 btn-sm ai-ok-btn py-0" onclick="updateCookedDish(\'' + recipe_id + '\', \'' + escapeHtml(title) + '\', \'' + date + '\')">ÎÎ±Î¹, Î¸Î­Î»Ï‰ Î½Î± Ï„Î¿ Î±Î»Î»Î¬Î¾Ï‰</button>' +
          '<button class="btn btn-secondary btn-sm ai-ok-btn py-0 mt-1" onclick="refuseChange(\'' + escapeHtml(data.old_title) + '\')">ÎŒÏ‡Î¹, Î¸Î± Ï€Î±ÏÎ±Î¼ÎµÎ¯Î½Ï‰ ÏƒÏ„Î¿ ' + escapeHtml(data.old_title) + '</button>' +
        '</div>';
        addChatLine('controls', html2);
      }
    } else {
      addChatLine('user', 'ÎœÎ±Î³ÎµÎ¹ÏÎµÏÏ‰: ' + title);
      var html3 = '<button class="btn btn-info btn-sm me-2" onclick="showRecipeUrl(\'' + recipe_id + '\')">Î”ÎµÏ‚ Ï„Î· ÏƒÏ…Î½Ï„Î±Î³Î®</button>';
      addChatLine('assistant', 'ÎšÎ±Î»Î® ÏŒÏÎµÎ¾Î·! ğŸ˜‹' + html3);
    }
  });
}

function escapeHtml(text) {
  return text
    .replace(/&/g, "&amp;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;");
}

function setupIngredientAutocomplete(allRecipes, ingredientInputId) {
  const input = document.getElementById(ingredientInputId);
  const listDiv = document.getElementById(`${ingredientInputId}_autocomplete`);
  const chatbox = document.getElementById("chatbox");

  if (!input || !listDiv || !chatbox) {
    console.warn("âš ï¸ Missing DOM elements", { input, listDiv, chatbox });
    return;
  }

  // Î›Î¯ÏƒÏ„Î± Ï…Î»Î¹ÎºÏÎ½ Ï‡Ï‰ÏÎ¯Ï‚ Î´Î¹Ï€Î»Î¬
  const allIngredientsSet = new Set();
  allRecipes.forEach(r => {
    (r.ingredients || "").split(',').forEach(ing => {
      const cleaned = ing.trim();
      if (cleaned) allIngredientsSet.add(cleaned);
    });
  });
  const allIngredients = Array.from(allIngredientsSet);

  input.addEventListener('input', function () {
    const val = removeTonos(input.value.trim().toLowerCase());
    listDiv.innerHTML = "";

    if (val.length < 1) {
      listDiv.style.display = "none";
      return;
    }

    const results = allIngredients.filter(ing =>
      removeTonos(ing).startsWith(val)
    ).slice(0, 20);

    if (results.length === 0) {
      listDiv.style.display = "none";
      return;
    }

    results.forEach(result => {
      const option = document.createElement("div");
      option.className = "autocomplete-option";
      option.textContent = result;
      option.onclick = function () {
        input.value = result;
        listDiv.innerHTML = "";
        listDiv.style.display = "none";
      };
      listDiv.appendChild(option);
    });

    listDiv.style.display = "block";
  });

  input.addEventListener('keydown', function (e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      submitAIAnswer();
    }
  });

  document.addEventListener('click', function (e) {
    if (!listDiv.contains(e.target) && e.target !== input) {
      listDiv.innerHTML = "";
      listDiv.style.display = "none";
    }
  });
}


</script>

<script>
  window.dayName = "{{ day_name }}";
</script>
<script src="{{ url_for('static', filename='JS/chat_history.js') }}"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
  fetch("/api/onboarding_progress")
    .then(res => res.json())
    .then(data => {
      const profile = data["profile"];
      const startChatBtn = document.getElementById("startChatBtn");

      if (!profile || !profile.completed) {
        document.body.classList.add("onboarding-active");

        const backdrop = document.getElementById("onboardingNavBackdrop");
        const tooltip = document.getElementById("onboardingTooltip");

        if (backdrop) backdrop.style.display = "block";
        if (tooltip) tooltip.style.display = "block";
        if (startChatBtn) startChatBtn.disabled = true;
      } else {
        if (startChatBtn) startChatBtn.disabled = false;
      }
    });	
});

document.addEventListener("DOMContentLoaded", function () {

	ensureRestartButtonExists(); // ğŸ‘ˆ Ï€Î¿Î»Ï ÏƒÎ·Î¼Î±Î½Ï„Î¹ÎºÏŒ Î½Î± Î­ÏÎ¸ÎµÎ¹ Ï€ÏÏÏ„Î¿

	let lastScrollTop = 0;
	const chatbox = document.getElementById('chatbox');
	const restartScrollBtn = document.getElementById('chatRestartOnScroll');

	chatbox.addEventListener('scroll', function () {
	  const st = chatbox.scrollTop;
	  const goingUp = st < lastScrollTop;

	  // Î‘Î½ Î¿ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚ Ï€Î¬ÎµÎ¹ Ï€ÏÎ¿Ï‚ Ï„Î± Ï€Î¬Î½Ï‰ ÎºÎ±Î¹ Î´ÎµÎ½ ÎµÎ¯Î½Î±Î¹ Î®Î´Î· ÏƒÏ„Î·Î½ ÎºÎ¿ÏÏ…Ï†Î®
	  if (goingUp && st > 60) {
		restartScrollBtn.style.display = 'block';
	  } else {
		restartScrollBtn.style.display = 'none';
	  }

	  lastScrollTop = st <= 0 ? 0 : st; // Î“Î¹Î± iOS bounce scroll fix
	});	
});

function ensureRestartButtonExists() {
  const section = document.getElementById('chatbox-section');
  if (!section || document.getElementById('chatRestartOnScroll')) return;

  const btnHtml = `
    <div id="chatRestartOnScroll"
         style="display:none; position: absolute; top: 50px; left: 0; right: 0; z-index: 10;"
         class="text-center">
      <button type="button" class="btn btn-primary" onclick="restartChat()">â†©ï¸ Î•Ï€Î±Î½ÎµÎºÎºÎ¯Î½Î·ÏƒÎ· Chat</button>
    </div>
  `;
  section.insertAdjacentHTML('afterbegin', btnHtml);
}

</script>





{% endblock %}